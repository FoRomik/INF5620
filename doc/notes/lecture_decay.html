<?xml version="1.0" encoding="utf-8" ?>
<!--
Automatically generated HTML file from Doconce source
(http://code.google.com/p/doconce/)
-->

<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Doconce: http://code.google.com/p/doconce/" />

<!--
Color definitions:  http://www.december.com/html/spec/color0.html
CSS examples:       http://www.w3schools.com/css/css_examples.asp
-->

<style type="text/css">
    body {
      margin-top: 1.0em;
      background-color: #ffffff;
      font-family: Helvetica, Arial, FreeSans, san-serif;
      color: #000000;
    }
    h1 { font-size: 1.8em; color: #1e36ce; }
    h2 { font-size: 1.5em; color: #1e36ce; }
    h3 { color: #1e36ce; }
    a { color: #1e36ce; text-decoration:none; }
    tt { font-family: "Courier New", Courier; }
    pre { background: #ededed; color: #000; padding: 15px;}
    p { text-indent: 0px; }
    hr { border: 0; width: 80%; border-bottom: 1px solid #aaa}
    p.caption { width: 80%; font-style: normal; text-align: left; }
    hr.figure { border: 0; width: 80%; border-bottom: 1px solid #aaa}

    .notice, .summary, .warning, .hint, .question {
    border: 1px solid; margin: 10px 0px; padding:15px 10px 15px 50px;
    background-repeat: no-repeat; background-position: 10px center;
    }
    .notice   { color: #00529B; background-color: #BDE5F8;
                background-image: url('https://doconce.googlecode.com/hg/lib/doconce/misc_software/html_images/Knob_Message.png'); }
    .summary  { color: #4F8A10; background-color: #DFF2BF;
                background-image:url('https://doconce.googlecode.com/hg/lib/doconce/misc_software/html_images/Knob_Valid_Green.png'); }
    .warning  { color: #9F6000; background-color: #FEEFB3;
                background-image: url('https://doconce.googlecode.com/hg/lib/doconce/misc_software/html_images/Knob_Attention.png'); }
    .hint     { color: #00529B; background-color: #BDE5F8;
                background-image: url('https://doconce.googlecode.com/hg/lib/doconce/misc_software/html_images/Knob_Info.png'); }
    .question { color: #4F8A10; background-color: #DFF2BF;
                background-image:url('https://doconce.googlecode.com/hg/lib/doconce/misc_software/html_images/Knob_Forward.png'); }

</style>

<!-- Use MathJax to render mathematics -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
     equationNumbers: {  autoNumber: "AMS"  },
     extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js"]
  }
});
</script>
<script type="text/javascript"
 src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- Fix slow MathJax rendering in IE8 -->
<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7">

</head>

<body>
    
<!-- newcommands_keep.tex -->
$$
\newcommand{\uex}{u_{\small\mbox{e}}}
\newcommand{\Aex}{A_{\small\mbox{e}}}
\newcommand{\half}{\frac{1}{2}}
\newcommand{\halfi}{{1/2}}

\newcommand{\Ddt}[1]{\frac{D #1}{dt}}

\newcommand{\xpoint}{\pmb{x}}
\newcommand{\normalvec}{\pmb{n}}

\newcommand{\x}{\pmb{x}}
\newcommand{\X}{\pmb{X}}
\renewcommand{\u}{\pmb{u}}
\renewcommand{\v}{\pmb{v}}
\newcommand{\w}{\pmb{w}}
\newcommand{\V}{\pmb{V}}
\newcommand{\e}{\pmb{e}}
\newcommand{\f}{\pmb{f}}
\newcommand{\F}{\pmb{F}}
\newcommand{\stress}{\pmb{\sigma}}
\newcommand{\strain}{\pmb{\varepsilon}}
\newcommand{\stressc}{{\sigma}}
\newcommand{\strainc}{{\varepsilon}}
\newcommand{\I}{\pmb{I}}
\newcommand{\T}{\pmb{T}}

% Unit vectors
\newcommand{\ii}{\pmb{i}}
\newcommand{\jj}{\pmb{j}}
\newcommand{\kk}{\pmb{k}}
\newcommand{\ir}{\pmb{i}_r}
\newcommand{\ith}{\pmb{i}_{\theta}}
\newcommand{\iz}{\pmb{i}_z}

% Finite elements
\newcommand{\basphi}{\varphi}
\newcommand{\refphi}{\tilde\basphi}
\newcommand{\phib}{\pmb{\varphi}}
\newcommand{\sinL}[1]{\sin\left((#1+1)\pi\frac{x}{L}\right)}
\newcommand{\xno}[1]{x_{#1}}
%\newcommand{\xno}[1]{x^{(#1)}}
\newcommand{\Xno}[1]{X_{(#1)}}
\newcommand{\yno}[1]{y_{#1}}
\newcommand{\Yno}[1]{Y_{(#1)}}
\newcommand{\xdno}[1]{\pmb{x}_{#1}}

% FEniCS commands
\newcommand{\dX}{\, \mathrm{d}X}
\newcommand{\dx}{\, \mathrm{d}x}
\newcommand{\ds}{\, \mathrm{d}s}
\newcommand{\Real}{\mathbb{R}}
\newcommand{\Integerp}{\mathbb{N}}
\newcommand{\Integer}{\mathbb{Z}}
$$



<!-- ------------------- main content ------------------------>

<title>INF5620 Lecture: Exponential Decay ODEs</title>

<center><h1>INF5620 Lecture: Exponential Decay ODEs</h1></center>  <! -- document title -->

<p>
<center><h4>September 6 and 13, 2012</h4></center> <!-- date -->
<p>

<h2>Table of contents</h2>

<p>

<a href="#___sec0"> Implementation </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec1"> Implementation in Python </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:py1"> Making a program </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec3"> Function for computing the numerical solution </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec4"> Integer division </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec5"> Doc strings </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec6"> Formatting of numbers </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec7"> Running the program </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec8"> Verifying the implementation </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec9"> Simplest method: run a few algorithmic steps by hand </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec10"> Comparison with an exact discrete solution </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:computing:error"> Computing the numerical error </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec12"> Plotting solutions </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec13"> Plotting with SciTools </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec14"> Creating user interfaces </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec15"> Reading a sequence of command-line arguments </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec16"> Working with an argument parser </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec17"> Computing convergence rates </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec18"> Estimating the convergence rate \( r \) </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec19"> Implementation </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec20"> Verification </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec21"> Debugging via convergence rates </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec22"> Memory-saving implementation </a><br>
<a href="#___sec23"> Software engineering </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec24"> Making a module </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec25"> Prefixing imported functions by the module name </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec26"> Doctests </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec27"> Unit testing with nose </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec28"> Basic use of nose </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec29"> Demonstrating nose </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec30"> Classical unit testing with unittest </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec31"> Basic use of unittest </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec32"> Demonstration of unittest </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec33"> Implementing simple problem and solver classes </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec34"> The problem class </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec35"> The solver class </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec36"> The visualizer class </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec37"> Combing the objects </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec38"> Implementing more advanced problem and solver classes </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec39"> A generic class for parameters </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec40"> The problem class </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec41"> The solver class </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec42"> The visualizer class </a><br>
<a href="#decay:experiments"> Performing scientific experiments </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec44"> Interpreting output from other programs </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:exper:report"> Making a report </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:exper:github"> Publishing a complete project </a><br>
<a href="#___sec47"> Model extensions </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec48"> Extension to a variable coefficient </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:source"> Extension to a source term </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec50"> Schemes </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:general"> Implementation of the generalized model problem </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec52"> The Python code </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec53"> Implementations of variable coefficients </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:verify:trivial"> Verification via trivial solutions </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:MMS"> Verification via manufactured solutions </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec56"> Extension to systems of ODEs </a><br>
<a href="#___sec57"> General first-order ODEs </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec58"> Generic form </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec59"> The Odespy software </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec60"> Example: Runge-Kutta methods  </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec61"> Example: Adaptive Runge-Kutta methods  </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec62"> Other schemes </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec63"> Implicit 2-step backward scheme </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec64"> The Leapfrog scheme </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec65"> The filtered Leapfrog scheme </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec66"> 2nd-order Runge-Kutta scheme </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec67"> 2nd-order Adams-Bashforth scheme </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec68"> 3rd-order Adams-Bashforth scheme </a><br>

<p>



<h2>Implementation  <a name="___sec0"></a></h2>
<p>
We address the differential equation problem
$$
u'(t) = -au(t),\quad t\in (0,T], \quad u(0)=I,
$$
where \( a>0 \) is a given constant.

<p>
The problem is solved by the numerical method

<p>
$$
u^{n+1} = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a\Delta t}u^n,
$$
for \( \theta\in [0,1] \). The classical Forward Euler, Backward Euler, and
Crank-Nicolson (midpoint) schemes are recovered through \( \theta=0,1,0.5 \) (resp.)

<p>
Tasks: Make a program that

<p>

<ul>
  <p><li> computes \( u^n \), \( n=1,2,\ldots,N \)</li>
  <p><li> displays the numerical and exact solution</li>
  <p><li> brings evidence to a correct implementation (<em>verification</em>)</li>
  <p><li> compares the numerical and the exact solution in a plot</li>
  <p><li> computes the error \( \uex (t_n) - u^n \)</li>
  <p><li> computes the convergence rate of the numerical scheme</li>
  <p><li> reads its input data from the command line</li>
</ul>

Tools to learn:

<p>

<ul>
  <p><li> Basic <a href="http://python.org">Python</a> programming</li>
  <p><li> Array computing with <a href="http://numpy.org/"><tt>numpy</tt></a></li>
  <p><li> Plotting with <a href="http://matplotlib.sourceforge.net/"><tt>matplotlib.pyplot</tt></a></li>
  <p><li> Plotting through <a href="http://code.google.com/p/scitools/"><tt>scitools</tt></a></li>
  <p><li> File writing and reading</li>
  <p><li> Making command-line user interface via <tt>argparse.ArgumentParser</tt></li>
</ul>

All programs are in the directory
<a href="https://github.com/hplgit/INF5620/tree/gh-pages/src/decay"><tt>src/decay</tt></a>.

<p>

<h4>Implementation in Python  <a name="___sec1"></a></h4>
<p>
Why Python?

<p>

<ul>
  <p><li> Python has a very clean, readable syntax (often known as
    "executable pseudo-code").</li>
  <p><li> Python code is very similar to MATLAB code (and MATLAB has a
    particularly widespread use for scientific computing).</li>
  <p><li> Python is similar to, but much simpler to work with and
    results in more reliable code than C++.</li>
  <p><li> Python is a full-fledged, very powerful programming language.</li>
  <p><li> Python has a rich set of modules for scientific computing, and its
    popularity in scientific computing is rapidly growing.</li>
  <p><li> Python was made for being combined with compiled languages
    (C, C++, Fortran) to reuse existing numerical software and to
    reach high computational performance of new implementations.</li>
  <p><li> Python has extensive support for administrative task
    needed when doing large-scale computational investigations.</li>
  <p><li> Python has extensive support for graphics (visualization,
    user interfaces, web applications).</li>
  <p><li> FEniCS, a very powerful tool for solving PDEs by
    the finite element method, is most human-efficient to operate
    from Python.</li>
</ul>

<h3>Making a program <a name="decay:py1"></a></h3>
<p>

<ul>
 <p><li> Store \( u^n \), \( n=0,1,\ldots,N \) in an array <tt>u</tt>.</li>
 <p><li> Algorithm:</li>

<ol>
  <p><li> initialize \( u^0 \)</li>
  <p><li> for \( t=t_n \), \( n=1,2,\ldots,N \): compute \( u_n \) using
     the \( \theta \)-rule formula</li>
</ol>

</ul>

<h4>Function for computing the numerical solution  <a name="___sec3"></a></h4>
<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, a, T, dt, theta):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.&quot;&quot;&quot;</span>
    N <span style="color: #666666">=</span> <span style="color: #008000">int</span>(T<span style="color: #666666">/</span>dt)            <span style="color: #408080; font-style: italic"># no of time intervals</span>
    T <span style="color: #666666">=</span> N<span style="color: #666666">*</span>dt                 <span style="color: #408080; font-style: italic"># adjust T to fit time step dt</span>
    u <span style="color: #666666">=</span> zeros(N<span style="color: #666666">+1</span>)           <span style="color: #408080; font-style: italic"># array of u[n] values</span>
    t <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, N<span style="color: #666666">+1</span>)  <span style="color: #408080; font-style: italic"># time mesh</span>

    u[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> I                 <span style="color: #408080; font-style: italic"># assign initial condition</span>
    <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">0</span>, N):    <span style="color: #408080; font-style: italic"># n=0,1,...,N-1</span>
        u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)<span style="color: #666666">*</span>u[n]
    <span style="color: #008000; font-weight: bold">return</span> u, t
</pre></div>
<p>

Note about the <tt>for</tt> loop: <tt>range(0, N, s)</tt> generates all integers
from <tt>0</tt> to <tt>N</tt> in steps of <tt>s</tt> (default 1), <em>but not including</em> <tt>N</tt> (!).

<p>
Sample call:
<p>

<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=1</span>, a<span style="color: #666666">=2</span>, T<span style="color: #666666">=8</span>, dt<span style="color: #666666">=0.8</span>, theta<span style="color: #666666">=1</span>)
</pre></div>
<p>


<h4>Integer division  <a name="___sec4"></a></h4>
<p>
Python applies integer division: <tt>1/2</tt> is 0, <tt>1./2</tt> or <tt>1.0/2</tt> or
<tt>1/2.</tt> or <tt>1/2.0</tt> or <tt>1.0/2.0</tt> gives 0.5.

<p>
A safer <tt>solver</tt> function:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, a, T, dt, theta):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.&quot;&quot;&quot;</span>
    dt <span style="color: #666666">=</span> <span style="color: #008000">float</span>(dt)           <span style="color: #408080; font-style: italic"># avoid integer division</span>
    N <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #008000">round</span>(T<span style="color: #666666">/</span>dt))     <span style="color: #408080; font-style: italic"># no of time intervals</span>
    T <span style="color: #666666">=</span> N<span style="color: #666666">*</span>dt                 <span style="color: #408080; font-style: italic"># adjust T to fit time step dt</span>
    u <span style="color: #666666">=</span> zeros(N<span style="color: #666666">+1</span>)           <span style="color: #408080; font-style: italic"># array of u[n] values</span>
    t <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, N<span style="color: #666666">+1</span>)  <span style="color: #408080; font-style: italic"># time mesh</span>

    u[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> I                 <span style="color: #408080; font-style: italic"># assign initial condition</span>
    <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">0</span>, N):    <span style="color: #408080; font-style: italic"># n=0,1,...,N-1</span>
        u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)<span style="color: #666666">*</span>u[n]
    <span style="color: #008000; font-weight: bold">return</span> u, t
</pre></div>
<p>


<h4>Doc strings  <a name="___sec5"></a></h4>
<p>

<ul>
 <p><li> First string after the function heading</li>
 <p><li> Used for documentation the function</li>
 <p><li> Automatic documentation tools can make fancy manuals</li>
 <p><li> Can be used for automatic testing</li>
</ul>

<p>

<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, a, T, dt, theta):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Solve</span>

<span style="color: #BA2121; font-style: italic">        u&#39;(t) = -a*u(t),</span>

<span style="color: #BA2121; font-style: italic">    with initial condition u(0)=I, for t in the time interval</span>
<span style="color: #BA2121; font-style: italic">    (0,T]. The time interval is divided into time steps of</span>
<span style="color: #BA2121; font-style: italic">    length dt.</span>

<span style="color: #BA2121; font-style: italic">    theta=1 corresponds to the Backward Euler scheme, theta=0</span>
<span style="color: #BA2121; font-style: italic">    to the Forward Euler scheme, and theta=0.5 to the Crank-</span>
<span style="color: #BA2121; font-style: italic">    Nicolson method.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #666666">...</span>
</pre></div>
<p>


<h4>Formatting of numbers  <a name="___sec6"></a></h4>
<p>
Can control formatting of reals and integers through the <em>printf</em> format:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;t=</span><span style="color: #BB6688; font-weight: bold">%6.3f</span><span style="color: #BA2121"> u=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> (t[i], u[i])
</pre></div>
<p>

Or the alternative <em>format string syntax</em>:
<p>

<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;t={t:6.3f} u={u:g}&#39;</span><span style="color: #666666">.</span>format(t<span style="color: #666666">=</span>t[i], u<span style="color: #666666">=</span>u[i])
</pre></div>
<p>


<h4>Running the program  <a name="___sec7"></a></h4>
<p>
Complete program file: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_v1.py"><tt>dc_v1.py</tt></a>.

<p>
How to run the program:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python dc_v1.py
</pre></div>
<p>

Can also run it as "normal" Unix programs: <tt>./programname</tt>:

<p>

<ol>
 <p><li> Insert first line <tt>#!/usr/bin/env python</tt> (program to interpret the file)</li>
 <p><li> Run <tt>chmod a+rx dc_v1.py</tt></li>
</ol>

Now, this works:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; ./dc_v1.py
</pre></div>
<p>


<h3>Verifying the implementation  <a name="___sec8"></a></h3>
<p>

<ul>
 <p><li> Verification = bring evidence that the program works</li>
 <p><li> Find suitable test problems</li>
 <p><li> Make function for each test problem</li>
 <p><li> Later: put the verification tests in a professional testing framework</li>
</ul>

<h4>Simplest method: run a few algorithmic steps by hand  <a name="___sec9"></a></h4>
<p>
Use a calculator:

<p>
$$ A\equiv \frac{1 - (1-\theta) a\Delta t}{1 + \theta a \Delta t} = 0.298245614035$$
$$
\begin{align*}
u^1 &= AI=0.0298245614035,\\
u^2 &= Au^1= 0.00889504462912,\\
u^3 &=Au^2= 0.00265290804728
\end{align*}
$$

<p>
Compare hand-calculated numbers with those from <tt>solver</tt>:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">verify_three_steps</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Compare three steps with known manual computations.&quot;&quot;&quot;</span>
    theta <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>; a <span style="color: #666666">=</span> <span style="color: #666666">2</span>; I <span style="color: #666666">=</span> <span style="color: #666666">0.1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>
    u_by_hand <span style="color: #666666">=</span> array([I,
                       <span style="color: #666666">0.0298245614035</span>,
                       <span style="color: #666666">0.00889504462912</span>,
                       <span style="color: #666666">0.00265290804728</span>])

    N <span style="color: #666666">=</span> <span style="color: #666666">3</span>  <span style="color: #408080; font-style: italic"># number of time steps</span>
    u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, T<span style="color: #666666">=</span>N<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)

    tol <span style="color: #666666">=</span> <span style="color: #666666">1E-15</span>  <span style="color: #408080; font-style: italic"># tolerance for comparing floats</span>
    difference <span style="color: #666666">=</span> <span style="color: #008000">abs</span>(u <span style="color: #666666">-</span> u_by_hand)<span style="color: #666666">.</span>max()
    success <span style="color: #666666">=</span> difference <span style="color: #666666">&lt;=</span> tol
    <span style="color: #008000; font-weight: bold">return</span> success
</pre></div>
<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>():
    u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=1</span>, a<span style="color: #666666">=2</span>, T<span style="color: #666666">=8</span>, dt<span style="color: #666666">=0.8</span>, theta<span style="color: #666666">=1</span>)
    <span style="color: #408080; font-style: italic"># Write out a table of t and u values:</span>
    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #008000">len</span>(t)):
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;t=</span><span style="color: #BB6688; font-weight: bold">%6.3f</span><span style="color: #BA2121"> u=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> (t[i], u[i])
        <span style="color: #408080; font-style: italic"># or print &#39;t={t:6.3f} u={u:g}&#39;.format(t=t[i], u=u[i])</span>
</pre></div>
<p>

Force the verification to be done before a real computation:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">if</span> verify_three_steps():
    main()
<span style="color: #008000; font-weight: bold">else</span>:
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Bug in the implementation!&#39;</span>
</pre></div>
<p>

Complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_verf1.py"><tt>dc_verf1.py</tt></a>.

<p>

<h4>Comparison with an exact discrete solution  <a name="___sec10"></a></h4>
<p>

<ul>
 <p><li> Better verification: comparison of \( u^n \) from <tt>solver</tt>
   with a closed-form <em>exact discrete solution</em> (if possible)</li>
</ul>

Define
$$ A = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a \Delta t}\thinspace . $$
Repeated use of the \( \theta \)-rule:
$$
\begin{align*}
u^0 &= I,\\
u^1 &= Au^0 = AI,\\
u^2 &= Au^1 = A^2I,\\
&\vdots\\
u^n &= A^nu^{n-1} = A^nI \thinspace .
\end{align*}
$$

<p>
The exact discrete solution as
$$
\begin{equation}
u^n = IA^n
\label{decay:un:exact}
\thinspace .
\end{equation}
$$

<p>
Implementation:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">verify_exact_discrete_solution</span>():

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_discrete_solution</span>(n, I, a, theta, dt):
        factor <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)
        <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>factor<span style="color: #666666">**</span>n

    theta <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>; a <span style="color: #666666">=</span> <span style="color: #666666">2</span>; I <span style="color: #666666">=</span> <span style="color: #666666">0.1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>
    N <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #666666">8/</span>dt)  <span style="color: #408080; font-style: italic"># no of steps</span>
    u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, T<span style="color: #666666">=</span>N<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)
    u_de <span style="color: #666666">=</span> array([exact_discrete_solution(n, I, a, theta, dt)
                  <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(N<span style="color: #666666">+1</span>)])
    difference <span style="color: #666666">=</span> <span style="color: #008000">abs</span>(u_de <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()  <span style="color: #408080; font-style: italic"># max deviation</span>
    tol <span style="color: #666666">=</span> <span style="color: #666666">1E-15</span>  <span style="color: #408080; font-style: italic"># tolerance for comparing floats</span>
    success <span style="color: #666666">=</span> difference <span style="color: #666666">&lt;=</span> tol
    <span style="color: #008000; font-weight: bold">return</span> success
</pre></div>
<p>

The complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_verf2.py"><tt>dc_verf2.py</tt></a>.

<p>


<h3>Computing the numerical error <a name="decay:computing:error"></a></h3>
<p>
Task: compute exact minus numerical solution, \( \uex(t_n) - u^n \)

<p>
Exact solution: \( \uex(t)=Ie^{-at} \), implemented as

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(t, I, a):
    <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>
<p>

Compute

<p>
$$
\begin{equation}
e_n = \uex(t_n) - u^n,\quad n=0,1,\ldots,N \thinspace .
\end{equation}
$$

<p>
by

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">u, t <span style="color: #666666">=</span> solver(I, a, T, dt, theta)  <span style="color: #408080; font-style: italic"># Numerical solution</span>
u_e <span style="color: #666666">=</span> exact_solution(t, I, a)
e <span style="color: #666666">=</span> u_e <span style="color: #666666">-</span> u
</pre></div>
<p>

Note: array arithmetics - we compute on entire arrays

<p>

<ul>
 <p><li> Array <tt>e</tt> is the problem's discrete <em>error function</em></li>
 <p><li> Sometimes convenient with a scalar error measure (one number)</li>
 <p><li> Can integrate \( e^n \)</li>
</ul>

The Trapezoidal rule:

<p>
$$ \hat E^2 = \Delta t\left(\frac{1}{2}e_0^2 + \frac{1}{2}e_N^2
+ \sum_{n=1}^{N-1} e_n^2\right) $$
Common approximation (ok if used consistently in all error computations):

<p>
$$ \hat E^2 \approx E^2 = \Delta t\sum_{n=0}^{N} e_n^2 $$

<p>
\( E \) is the \( L_2 \) norm of the discrete error function \( e^n \).

<p>
$$
\begin{equation}
E = \sqrt{\Delta t\sum_{n=0}^N e_n^2}
\label{decay:E}
\end{equation}
$$

<p>
Python:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">E <span style="color: #666666">=</span> sqrt(dt<span style="color: #666666">*</span><span style="color: #008000">sum</span>(e<span style="color: #666666">**2</span>))
</pre></div>
<p>

Similar element by element computation:
<p>

<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">m <span style="color: #666666">=</span> <span style="color: #008000">len</span>(u)     <span style="color: #408080; font-style: italic"># length of u array (alt: u.size)</span>
u_e <span style="color: #666666">=</span> zeros(m)
t <span style="color: #666666">=</span> <span style="color: #666666">0</span>
<span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(m):
    u_e[i] <span style="color: #666666">=</span> exact_solution(t, a, I)
    t <span style="color: #666666">=</span> t <span style="color: #666666">+</span> dt
e <span style="color: #666666">=</span> zeros(m)
<span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(m):
    e[i] <span style="color: #666666">=</span> u_e[i] <span style="color: #666666">-</span> u[i]
s <span style="color: #666666">=</span> <span style="color: #666666">0</span>  <span style="color: #408080; font-style: italic"># summation variable</span>
<span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(m):
    s <span style="color: #666666">=</span> s <span style="color: #666666">+</span> e[i]<span style="color: #666666">**2</span>
error <span style="color: #666666">=</span> sqrt(dt<span style="color: #666666">*</span>s)
</pre></div>
<p>
Such <em>scalar</em> computing

<p>

<ul>
 <p><li> takes more code</li>
 <p><li> is less readable</li>
 <p><li> runs much slower</li>
</ul>

Rule: Compute on entire arrays!

<p>

<h3>Plotting solutions  <a name="___sec12"></a></h3>
<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
plot(t, u)
show()
</pre></div>
<p>

Compare with \( \uex(t) \):

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">t_e <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, <span style="color: #666666">1001</span>)      <span style="color: #408080; font-style: italic"># fine mesh</span>
u_e <span style="color: #666666">=</span> exact_solution(t_e, I, a)
plot(t,   u,   <span style="color: #BA2121">&#39;r-&#39;</span>)            <span style="color: #408080; font-style: italic"># red  line for u</span>
plot(t_e, u_e, <span style="color: #BA2121">&#39;b-&#39;</span>)            <span style="color: #408080; font-style: italic"># blue line for u_e</span>
</pre></div>
<p>

<center> <! -- figure -->
<hr class="figure">
<center><p class="caption">Figure 1:  The Forward Euler scheme for two values of the time step. <a name="decay:fig:FE1"></a> </p></center>
<p><img src="fig-decay/FE1.png" align="bottom" width=800,></p>
</center>

<p>

How to include such decorations:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>

figure()                          <span style="color: #408080; font-style: italic"># create new plot</span>
t_e <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, <span style="color: #666666">1001</span>)        <span style="color: #408080; font-style: italic"># fine mesh for u_e</span>
u_e <span style="color: #666666">=</span> exact_solution(t_e, I, a)
plot(t,   u,   <span style="color: #BA2121">&#39;r--o&#39;</span>)            <span style="color: #408080; font-style: italic"># red dashes w/circles</span>
plot(t_e, u_e, <span style="color: #BA2121">&#39;b-&#39;</span>)              <span style="color: #408080; font-style: italic"># blue line for exact sol.</span>
legend([<span style="color: #BA2121">&#39;numerical&#39;</span>, <span style="color: #BA2121">&#39;exact&#39;</span>])
xlabel(<span style="color: #BA2121">&#39;t&#39;</span>)
ylabel(<span style="color: #BA2121">&#39;u&#39;</span>)
title(<span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, dt=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> (theta, dt))
savefig(<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (theta, dt))
show()
</pre></div>
<p>

Computation and plotting:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">explore</span>(I, a, T, dt, theta<span style="color: #666666">=0.5</span>, makeplot<span style="color: #666666">=</span><span style="color: #008000">True</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Run a case with the solver, compute error measure,</span>
<span style="color: #BA2121; font-style: italic">    and plot the numerical and exact solutions (if makeplot=True).</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    u, t <span style="color: #666666">=</span> solver(I, a, T, dt, theta)  <span style="color: #408080; font-style: italic"># Numerical solution</span>
    u_e <span style="color: #666666">=</span> exact_solution(t, I, a)
    e <span style="color: #666666">=</span> u_e <span style="color: #666666">-</span> u
    E <span style="color: #666666">=</span> sqrt(dt<span style="color: #666666">*</span><span style="color: #008000">sum</span>(e<span style="color: #666666">**2</span>))
    <span style="color: #008000; font-weight: bold">if</span> makeplot:
        figure()                         <span style="color: #408080; font-style: italic"># create new plot</span>
        t_e <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, <span style="color: #666666">1001</span>)       <span style="color: #408080; font-style: italic"># fine mesh for u_e</span>
        u_e <span style="color: #666666">=</span> exact_solution(t_e, I, a)
        plot(t,   u,   <span style="color: #BA2121">&#39;r--o&#39;</span>)           <span style="color: #408080; font-style: italic"># red dashes w/circles</span>
        plot(t_e, u_e, <span style="color: #BA2121">&#39;b-&#39;</span>)             <span style="color: #408080; font-style: italic"># blue line for exact sol.</span>
        legend([<span style="color: #BA2121">&#39;numerical&#39;</span>, <span style="color: #BA2121">&#39;exact&#39;</span>])
        xlabel(<span style="color: #BA2121">&#39;t&#39;</span>)
        ylabel(<span style="color: #BA2121">&#39;u&#39;</span>)
        title(<span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, dt=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> (theta, dt))
        theta2name <span style="color: #666666">=</span> {<span style="color: #666666">0</span>: <span style="color: #BA2121">&#39;FE&#39;</span>, <span style="color: #666666">1</span>: <span style="color: #BA2121">&#39;BE&#39;</span>, <span style="color: #666666">0.5</span>: <span style="color: #BA2121">&#39;CN&#39;</span>}
        savefig(<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (theta2name[theta], dt))
        savefig(<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">.pdf&#39;</span> <span style="color: #666666">%</span> (theta2name[theta], dt))
        savefig(<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">.eps&#39;</span> <span style="color: #666666">%</span> (theta2name[theta], dt))
        show()
    <span style="color: #008000; font-weight: bold">return</span> E
</pre></div>
<p>

Complete code: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_plot_mpl.py"><tt>dc_plot_mpl.py</tt></a>.

<p>

<center> <! -- figure -->
<hr class="figure">
<center><p class="caption">Figure 2:  The Backward Euler scheme for two values of the time step. <a name="decay:fig:BE1"></a> </p></center>
<p><img src="fig-decay/BE1.png" align="bottom" width=800></p>
</center>

<p>

<center> <! -- figure -->
<hr class="figure">
<center><p class="caption">Figure 3:  The Crank-Nicolson scheme for two values of the time step. <a name="decay:fig:CN1"></a> </p></center>
<p><img src="fig-decay/CN1.png" align="bottom" width=800></p>
</center>

<p>


<h3>Plotting with SciTools  <a name="___sec13"></a></h3>
<p>
<a href="http://code.google.com/p/scitools">SciTools</a> provides a
unified plotting interface (Easyviz) to many different plotting
packages: Matplotlib, Gnuplot, Grace, VTK, OpenDX, ...

<p>
Can use Matplotlib syntax, or a more compact <tt>plot</tt> function syntax:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">scitools.std</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>

plot(t,   u,   <span style="color: #BA2121">&#39;r--o&#39;</span>,           <span style="color: #408080; font-style: italic"># red dashes w/circles</span>
     t_e, u_e, <span style="color: #BA2121">&#39;b-&#39;</span>,             <span style="color: #408080; font-style: italic"># blue line for exact sol.</span>
     legend<span style="color: #666666">=</span>[<span style="color: #BA2121">&#39;numerical&#39;</span>, <span style="color: #BA2121">&#39;exact&#39;</span>],
     xlabel<span style="color: #666666">=</span><span style="color: #BA2121">&#39;t&#39;</span>,
     ylabel<span style="color: #666666">=</span><span style="color: #BA2121">&#39;u&#39;</span>,
     title<span style="color: #666666">=</span><span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, dt=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> (theta, dt),
     savefig<span style="color: #666666">=</span><span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (theta2name[theta], dt),
     show<span style="color: #666666">=</span><span style="color: #008000">True</span>)
</pre></div>
<p>

Complete code in <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_plot_st.py"><tt>dc_plot_st.py</tt></a>.

<p>
Change backend (plotting engine, Matplotlib by default):

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python dc_plot_st.py --SCITOOLS_easyviz_backend gnuplot
Terminal&gt; python dc_plot_st.py --SCITOOLS_easyviz_backend grace
</pre></div>
<p>


<h3>Creating user interfaces  <a name="___sec14"></a></h3>
<p>

<ul>
 <p><li> Read input from the command line!</li>
 <p><li> Or file if much input</li>
 <p><li> All command-line arguments are available in <tt>sys.argv</tt></li>
 <p><li> <tt>sys.argv[0]</tt> is the program</li>
 <p><li> <tt>sys.argv[1:]</tt> holds the command-line arguments</li>
 <p><li> Method 1: fixed sequence of parameters on the command line</li>
 <p><li> Method 2: <tt>--option value</tt> pairs on the command line (with default values)</li>
</ul>

<h4>Reading a sequence of command-line arguments  <a name="___sec15"></a></h4>
<p>
The program <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_plot_mpl.py"><tt>dc_plot_mpl.py</tt></a>
needs this input: \( I \), \( a \), \( T \), an option to
turn the plot on or off (<tt>makeplot</tt>), and a list of \( \Delta t \) values.
Give these on the command line:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">read_command_line</span>():
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(sys<span style="color: #666666">.</span>argv) <span style="color: #666666">&lt;</span> <span style="color: #666666">6</span>:
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Usage: </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> I a T on/off dt1 dt2 dt3 ...&#39;</span> <span style="color: #666666">%</span> \ 
              sys<span style="color: #666666">.</span>argv[<span style="color: #666666">0</span>]; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)  <span style="color: #408080; font-style: italic"># abort</span>

    I <span style="color: #666666">=</span> <span style="color: #008000">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>])
    a <span style="color: #666666">=</span> <span style="color: #008000">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">2</span>])
    T <span style="color: #666666">=</span> <span style="color: #008000">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">3</span>])
    makeplot <span style="color: #666666">=</span> sys<span style="color: #666666">.</span>argv[<span style="color: #666666">4</span>] <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #BA2121">&#39;on&#39;</span>, <span style="color: #BA2121">&#39;True&#39;</span>)
    dt_values <span style="color: #666666">=</span> [<span style="color: #008000">float</span>(arg) <span style="color: #008000; font-weight: bold">for</span> arg <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv[<span style="color: #666666">5</span>:]]

    <span style="color: #008000; font-weight: bold">return</span> I, a, T, makeplot, dt_values
</pre></div>
<p>

Note:

<p>

<ul>
  <p><li> <tt>sys.argv[i]</tt> is <em>always a string</em></li>
  <p><li> Must explicitly convert to (e.g.) <tt>float</tt> for computations</li>
  <p><li> List comprehensions make lists: <tt>[expression for e in somelist]</tt></li>
</ul>

Complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_cml.py"><tt>dc_cml.py</tt></a>.

<p>

<h4>Working with an argument parser  <a name="___sec16"></a></h4>
<p>
Example: give \( a \) as <tt>--a 2.5</tt> on the command line
if the default value is not suitable.

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>():
    <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">argparse</span>
    parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser()
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--I&#39;</span>, <span style="color: #BA2121">&#39;--initial_condition&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
                        default<span style="color: #666666">=1.0</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;initial condition, u(0)&#39;</span>,
                        metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;I&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--a&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
                        default<span style="color: #666666">=1.0</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;coefficient in ODE&#39;</span>,
                        metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;a&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--T&#39;</span>, <span style="color: #BA2121">&#39;--stop_time&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
                        default<span style="color: #666666">=1.0</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;end time of simulation&#39;</span>,
                        metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;T&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--makeplot&#39;</span>, action<span style="color: #666666">=</span><span style="color: #BA2121">&#39;store_true&#39;</span>,
                        help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;display plot or not&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--dt&#39;</span>, <span style="color: #BA2121">&#39;--time_step_values&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
                        default<span style="color: #666666">=</span>[<span style="color: #666666">1.0</span>], help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time step values&#39;</span>,
                        metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;dt&#39;</span>, nargs<span style="color: #666666">=</span><span style="color: #BA2121">&#39;+&#39;</span>, dest<span style="color: #666666">=</span><span style="color: #BA2121">&#39;dt_values&#39;</span>)
    <span style="color: #008000; font-weight: bold">return</span> parser
</pre></div>
<p>

Automatically generated help functionality:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python dc_argparse.py -h
  ...
  --I I, --initial_condition I
                        initial condition, u<span style="color: #666666">(</span>0<span style="color: #666666">)</span>
  ...
</pre></div>
<p>

Structure of this help output:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">  --I metavar, --initial_condition metavar
                        help-string
</pre></div>
<p>

How to read data from the command line:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">read_command_line</span>():
    parser <span style="color: #666666">=</span> define_command_line_options()
    args <span style="color: #666666">=</span> parser<span style="color: #666666">.</span>parse_args()
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;I={}, a={}, T={}, makeplot={}, dt_values={}&#39;</span><span style="color: #666666">.</span>format(
        args<span style="color: #666666">.</span>I, args<span style="color: #666666">.</span>a, args<span style="color: #666666">.</span>T, args<span style="color: #666666">.</span>makeplot, args<span style="color: #666666">.</span>dt_values)
    <span style="color: #008000; font-weight: bold">return</span> args<span style="color: #666666">.</span>I, args<span style="color: #666666">.</span>a, args<span style="color: #666666">.</span>T, args<span style="color: #666666">.</span>makeplot, args<span style="color: #666666">.</span>dt_values
</pre></div>
<p>

Complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_argparse.py"><tt>dc_argparse.py</tt></a>.

<p>


<h3>Computing convergence rates  <a name="___sec17"></a></h3>
<p>
Frequent assumption on the relation between the numerical error \( E \) and
some discretization parameter \( \Delta t \):

<p>
$$
\begin{equation}
E = C\Delta t^r,
\label{decay:E:dt}
\end{equation}
$$
Unknown: \( C \) and \( r \).

<p>

<h4>Estimating the convergence rate \( r \)  <a name="___sec18"></a></h4>
<p>
Perform numerical experiments: \( (\Delta t_i, E_i) \), \( i=0,\ldots,m-1 \).

<p>

<ol>
 <p><li> Take the logarithm of \eqref{decay:E:dt}, \( \ln E = r\ln \Delta t + \ln C \),
    and fit a straight line to the data points \( (\Delta t_i, E_i) \),
    \( i=0,\ldots,m-1 \).</li>
 <p><li> Consider two consecutive experiments, \( (\Delta t_i, E_i) \) and
    \( (\Delta t_{i-1}, E_{i-1}) \). Dividing the equation
    \( E_{i-1}=C\Delta t_{i-1}^r \) by \( E_{i}=C\Delta t_{i}^r \) and solving
    for \( r \) yields</li>
</ol>

$$
\begin{equation}
r_{i-1} = \frac{\ln (E_{i-1}/E_i)}{\ln (\Delta t_{i-1}/\Delta t_i)}
\label{decay:conv:rate}
\end{equation}
$$
for \( i=1,=\ldots,m-1 \).

<p>
Method 2 is best.

<p>

<h4>Implementation  <a name="___sec19"></a></h4>
<p>
Compute \( r_0, r_1, \ldots, r_{m-2} \):

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">math</span> <span style="color: #008000; font-weight: bold">import</span> log

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>():
    I, a, T, makeplot, dt_values <span style="color: #666666">=</span> read_command_line()
    r <span style="color: #666666">=</span> {}  <span style="color: #408080; font-style: italic"># estimated convergence rates</span>
    <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>:
        E_values <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> dt <span style="color: #AA22FF; font-weight: bold">in</span> dt_values:
            E <span style="color: #666666">=</span> explore(I, a, T, dt, theta, makeplot<span style="color: #666666">=</span><span style="color: #008000">False</span>)
            E_values<span style="color: #666666">.</span>append(E)

        <span style="color: #408080; font-style: italic"># Compute convergence rates</span>
        m <span style="color: #666666">=</span> <span style="color: #008000">len</span>(dt_values)
        r[theta] <span style="color: #666666">=</span> [log(E_values[i<span style="color: #666666">-1</span>]<span style="color: #666666">/</span>E_values[i])<span style="color: #666666">/</span>
                    log(dt_values[i<span style="color: #666666">-1</span>]<span style="color: #666666">/</span>dt_values[i])
                    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">1</span>, m, <span style="color: #666666">1</span>)]

    <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> r:
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">Pairwise convergence rates for theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">:&#39;</span> <span style="color: #666666">%</span> theta
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39; &#39;</span><span style="color: #666666">.</span>join([<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%.2f</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> r_ <span style="color: #008000; font-weight: bold">for</span> r_ <span style="color: #AA22FF; font-weight: bold">in</span> r[theta]])
    <span style="color: #008000; font-weight: bold">return</span> r
</pre></div>
<p>

Complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_convrate.py"><tt>dc_convrate.py</tt></a>.

<p>
Example on execution:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python dc_convrate.py --dt 0.5 0.25 0.1 0.05 0.025 0.01
...
Pairwise convergence rates <span style="color: #008000; font-weight: bold">for </span><span style="color: #19177C">theta</span><span style="color: #666666">=</span>0:
1.33 1.15 1.07 1.03 1.02

Pairwise convergence rates <span style="color: #008000; font-weight: bold">for </span><span style="color: #19177C">theta</span><span style="color: #666666">=</span>0.5:
2.14 2.07 2.03 2.01 2.01

Pairwise convergence rates <span style="color: #008000; font-weight: bold">for </span><span style="color: #19177C">theta</span><span style="color: #666666">=</span>1:
0.98 0.99 0.99 1.00 1.00
</pre></div>
<p>


<h4>Verification  <a name="___sec20"></a></h4>
<p>
Strong verification method: verify that \( r \) has the expected value!

<p>

<h4>Debugging via convergence rates  <a name="___sec21"></a></h4>
<p>
Potential bug: missing <tt>a</tt> in the denominator,

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt)<span style="color: #666666">*</span>u[n]
</pre></div>
<p>
Running <tt>dc_convrate.py</tt> gives same rates.

<p>
Why? The value of \( a \)... (\( a=1 \))

<p>
0 and 1 are <em>bad values</em> in tests!

<p>
Better:
<p>

<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python dc_convrate.py --a 2.1 --I 0.1  <span style="color: #BB6622; font-weight: bold">\</span>
          --dt 0.5 0.25 0.1 0.05 0.025 0.01
...
Pairwise convergence rates <span style="color: #008000; font-weight: bold">for </span><span style="color: #19177C">theta</span><span style="color: #666666">=</span>0:
1.49 1.18 1.07 1.04 1.02

Pairwise convergence rates <span style="color: #008000; font-weight: bold">for </span><span style="color: #19177C">theta</span><span style="color: #666666">=</span>0.5:
-1.42 -0.22 -0.07 -0.03 -0.01

Pairwise convergence rates <span style="color: #008000; font-weight: bold">for </span><span style="color: #19177C">theta</span><span style="color: #666666">=</span>1:
0.21 0.12 0.06 0.03 0.01
</pre></div>
<p>

Forward Euler works...because \( \theta=0 \) hides the bug.

<p>
This bug gives \( r\approx 0 \):

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> ((<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)<span style="color: #666666">*</span>u[n]
</pre></div>
<p>


<h3>Memory-saving implementation  <a name="___sec22"></a></h3>
<p>

<ul>
 <p><li> Note 1: we store the entire array <tt>u</tt>, i.e., \( u^n \) for \( n=0,1,\ldots,N \)</li>
 <p><li> Note 2: the formula for \( u^{n+1} \) needs \( u^n \) only, not \( u^{n-1} \), \( u^{n-2} \), ...</li>
 <p><li> No need to store more than \( u^{n+1} \) and \( u^{n} \)</li>
 <p><li> Extremely important when solving PDEs</li>
 <p><li> No practical importance here (much memory available)</li>
 <p><li> But let's illustrate how to do save memory!</li>
 <p><li> Idea 1: store \( u^{n+1} \) in <tt>u</tt>, \( u^n \) in <tt>u_1</tt> (<tt>float</tt>)</li>
 <p><li> Idea 2: store <tt>u</tt> in a file, read file later for plotting</li>
</ul>

<p>

<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver_memsave</span>(I, a, T, dt, theta, filename<span style="color: #666666">=</span><span style="color: #BA2121">&#39;sol.dat&#39;</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.</span>
<span style="color: #BA2121; font-style: italic">    Minimum use of memory. The solution is store on file</span>
<span style="color: #BA2121; font-style: italic">    (with name filename) for later plotting.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    dt <span style="color: #666666">=</span> <span style="color: #008000">float</span>(dt)        <span style="color: #408080; font-style: italic"># avoid integer division</span>
    N <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #008000">round</span>(T<span style="color: #666666">/</span>dt))  <span style="color: #408080; font-style: italic"># no of intervals</span>

    outfile <span style="color: #666666">=</span> <span style="color: #008000">open</span>(filename, <span style="color: #BA2121">&#39;w&#39;</span>)
    <span style="color: #408080; font-style: italic"># u: time level n+1, u_1: time level n</span>
    t <span style="color: #666666">=</span> <span style="color: #666666">0</span>
    u_1 <span style="color: #666666">=</span> I
    outfile<span style="color: #666666">.</span>write(<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%.16E</span><span style="color: #BA2121">  </span><span style="color: #BB6688; font-weight: bold">%.16E</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> (t, u_1))
    <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">1</span>, N<span style="color: #666666">+1</span>):
        u <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)<span style="color: #666666">*</span>u_1
        u_1 <span style="color: #666666">=</span> u
        t <span style="color: #666666">+=</span> dt
        outfile<span style="color: #666666">.</span>write(<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%.16E</span><span style="color: #BA2121">  </span><span style="color: #BB6688; font-weight: bold">%.16E</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> (t, u))
    outfile<span style="color: #666666">.</span>close()
    <span style="color: #008000; font-weight: bold">return</span> u, t
</pre></div>
<p>

Reading the computed data:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">read_file</span>(filename<span style="color: #666666">=</span><span style="color: #BA2121">&#39;sol.dat&#39;</span>):
    infile <span style="color: #666666">=</span> <span style="color: #008000">open</span>(filename, <span style="color: #BA2121">&#39;r&#39;</span>)
    u <span style="color: #666666">=</span> [];  t <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> line <span style="color: #AA22FF; font-weight: bold">in</span> infile:
        words <span style="color: #666666">=</span> line<span style="color: #666666">.</span>split()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(words) <span style="color: #666666">!=</span> <span style="color: #666666">2</span>:
            <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Found more than two numbers on a line!&#39;</span>, words
            sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)  <span style="color: #408080; font-style: italic"># abort</span>
        t<span style="color: #666666">.</span>append(<span style="color: #008000">float</span>(words[<span style="color: #666666">0</span>]))
        u<span style="color: #666666">.</span>append(<span style="color: #008000">float</span>(words[<span style="color: #666666">1</span>]))
    <span style="color: #008000; font-weight: bold">return</span> np<span style="color: #666666">.</span>array(t), np<span style="color: #666666">.</span>array(u)
</pre></div>
<p>

Simpler code with <tt>numpy</tt> functionality for reading/writing tabular data:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">read_file_numpy</span>(filename<span style="color: #666666">=</span><span style="color: #BA2121">&#39;sol.dat&#39;</span>):
    data <span style="color: #666666">=</span> np<span style="color: #666666">.</span>loadtxt(filename)
    t <span style="color: #666666">=</span> data[:,<span style="color: #666666">0</span>]
    u <span style="color: #666666">=</span> data[:,<span style="color: #666666">1</span>]
    <span style="color: #008000; font-weight: bold">return</span> t, u
</pre></div>
<p>

Similar function <tt>np.savetxt</tt>, but then we need all \( u^n \) and \( t^n \) values
in a two-dimensional array (which we try to prevent now!).

<p>
Usage:
<p>

<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">explore</span>(I, a, T, dt, theta<span style="color: #666666">=0.5</span>, makeplot<span style="color: #666666">=</span><span style="color: #008000">True</span>):
    filename <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;u.dat&#39;</span>
    u, t <span style="color: #666666">=</span> solver_minmem(I, a, T, dt, theta, filename)

    t, u <span style="color: #666666">=</span> read_file(filename)
    u_e <span style="color: #666666">=</span> exact_solution(t, I, a)
    e <span style="color: #666666">=</span> u_e <span style="color: #666666">-</span> u
    E <span style="color: #666666">=</span> np<span style="color: #666666">.</span>sqrt(dt<span style="color: #666666">*</span>np<span style="color: #666666">.</span>sum(e<span style="color: #666666">**2</span>))
    <span style="color: #008000; font-weight: bold">if</span> makeplot:
        plt<span style="color: #666666">.</span>figure()
        <span style="color: #666666">...</span>
</pre></div>
<p>

Complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_memsave.py"><tt>dc_memsave.py</tt></a>.

<p>


<h2>Software engineering  <a name="___sec23"></a></h2>
<p>
Goal: make more professional numerical software.

<p>
Topics:

<p>

<ul>
  <p><li> How to make modules (reusable libraries)</li>
  <p><li> Testing frameworks (doctest, nose, unittest)</li>
  <p><li> Implementation with classes</li>
</ul>

<h3>Making a module  <a name="___sec24"></a></h3>
<p>


<ul>
 <p><li> Previous programs: much repetitive code (esp. <tt>solver</tt>)</li>
 <p><li> DRY (Don' Repeat Yourself) principle: no copies of code</li>
 <p><li> A change needs to be done in one <em>and only one</em> place</li>
 <p><li> Module = just a file with functions (reused through <tt>import</tt>)</li>
 <p><li> Let's make a module of</li>

<ul>
   <p><li> <tt>solver</tt></li>
   <p><li> <tt>verify_three_steps</tt></li>
   <p><li> <tt>verify_discrete_solution</tt></li>
   <p><li> <tt>explore</tt></li>
   <p><li> <tt>define_command_line_options</tt></li>
   <p><li> <tt>read_command_line</tt></li>
   <p><li> <tt>main</tt> (with convergence rates)</li>
   <p><li> <tt>verify_convergence_rate</tt></li>
</ul>

</ul>

Module name: <tt>dc_mod</tt>, filename: <tt>dc_mod.py</tt>.

<p>
Sketch:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, a, T, dt, theta):
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">verify_three_steps</span>():
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">verify_exact_discrete_solution</span>():
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(t, I, a):
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">explore</span>(I, a, T, dt, theta<span style="color: #666666">=0.5</span>, makeplot<span style="color: #666666">=</span><span style="color: #008000">True</span>):
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>():
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">read_command_line</span>(use_argparse<span style="color: #666666">=</span><span style="color: #008000">True</span>):
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>():
    <span style="color: #666666">...</span>
</pre></div>
<p>
That is! It's a module <tt>dc_mod</tt> in file <tt>dc_mod.py</tt>.

<p>
Usage in some other program:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">dc_mod</span> <span style="color: #008000; font-weight: bold">import</span> solver
u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=1.0</span>, a<span style="color: #666666">=3.0</span>, T<span style="color: #666666">=3</span>, dt<span style="color: #666666">=0.01</span>, theta<span style="color: #666666">=0.5</span>)
</pre></div>
<p>

Test block:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    main()
</pre></div>
<p>

If <tt>dc_mod</tt> is imported, <tt>__name__</tt> is <tt>dc_mod</tt>.

<p>
If <tt>dc_mod.py</tt> is run, <tt>__name__</tt> is <tt>__main__</tt>.

<p>
Use test block for testing, demo, user interface, ...

<p>
Extended test block:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&#39;verify&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv:
        <span style="color: #008000; font-weight: bold">if</span> verify_three_steps() <span style="color: #AA22FF; font-weight: bold">and</span> verify_discrete_solution():
            <span style="color: #008000; font-weight: bold">pass</span> <span style="color: #408080; font-style: italic"># ok</span>
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Bug in the implementation!&#39;</span>
    <span style="color: #008000; font-weight: bold">elif</span> <span style="color: #BA2121">&#39;verify_rates&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv:
        sys<span style="color: #666666">.</span>argv<span style="color: #666666">.</span>remove(<span style="color: #BA2121">&#39;verify_rates&#39;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #BA2121">&#39;--dt&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv:
            <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Must assign several dt values&#39;</span>
            sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)  <span style="color: #408080; font-style: italic"># abort</span>
        <span style="color: #008000; font-weight: bold">if</span> verify_convergence_rate():
            <span style="color: #008000; font-weight: bold">pass</span>
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Bug in the implementation!&#39;</span>
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #408080; font-style: italic"># Perform simulations</span>
        main()
</pre></div>
<p>


<h3>Prefixing imported functions by the module name  <a name="___sec25"></a></h3>
<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
</pre></div>
<p>

This imports a large number of names (<tt>sin</tt>, <tt>exp</tt>, <tt>linspace</tt>, <tt>plot</tt>, ...).

<p>
Confusion: is a function from`numpy`? Or <tt>matplotlib.pyplot</tt>?
Or is it our own function?

<p>
Alternative (recommended) import:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span>
</pre></div>
<p>

Now we need to prefix functions with module name:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">t <span style="color: #666666">=</span> numpy<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, N<span style="color: #666666">+1</span>)
u_e <span style="color: #666666">=</span> I<span style="color: #666666">*</span>numpy<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
matplotlib<span style="color: #666666">.</span>pyplot<span style="color: #666666">.</span>plot(t, u_e)
</pre></div>
<p>

Common standard:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>

t <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, N<span style="color: #666666">+1</span>)
u_e <span style="color: #666666">=</span> I<span style="color: #666666">*</span>np<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
plt<span style="color: #666666">.</span>plot(t, u_e)
</pre></div>
<p>

Downside:
math line \( e^{-at}\sin(2\pi t) \) gets
cluttered with module names,
<p>

<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">numpy<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)<span style="color: #666666">*</span>numpy<span style="color: #666666">.</span>sin(<span style="color: #666666">2</span>(numpy<span style="color: #666666">.</span>pi<span style="color: #666666">*</span>t)
<span style="color: #408080; font-style: italic"># or</span>
np<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)<span style="color: #666666">*</span>np<span style="color: #666666">.</span>sin(<span style="color: #666666">2*</span>np<span style="color: #666666">.</span>pi<span style="color: #666666">*</span>t)
</pre></div>
<p>


<h3>Doctests  <a name="___sec26"></a></h3>
<p>

Doc strings can be equipped with interactive Python sessions for
demonstrating usage and <em>automatic testing</em> of functions.

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, a, T, dt, theta):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.</span>


<span style="color: #BA2121; font-style: italic">    &gt;&gt;&gt; u, t = solver(I=0.8, a=1.2, T=4, dt=0.5, theta=0.5)</span>
<span style="color: #BA2121; font-style: italic">    &gt;&gt;&gt; for t_n, u_n in zip(t, u):</span>
<span style="color: #BA2121; font-style: italic">    ...     print &#39;t=%.1f, u=%.14f&#39; % (t_n, u_n)</span>
<span style="color: #BA2121; font-style: italic">    t=0.0, u=0.80000000000000</span>
<span style="color: #BA2121; font-style: italic">    t=0.5, u=0.43076923076923</span>
<span style="color: #BA2121; font-style: italic">    t=1.0, u=0.23195266272189</span>
<span style="color: #BA2121; font-style: italic">    t=1.5, u=0.12489758761948</span>
<span style="color: #BA2121; font-style: italic">    t=2.0, u=0.06725254717972</span>
<span style="color: #BA2121; font-style: italic">    t=2.5, u=0.03621291001985</span>
<span style="color: #BA2121; font-style: italic">    t=3.0, u=0.01949925924146</span>
<span style="color: #BA2121; font-style: italic">    t=3.5, u=0.01049960113002</span>
<span style="color: #BA2121; font-style: italic">    t=4.0, u=0.00565363137770</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #666666">...</span>
</pre></div>
<p>

Automatic check that the code gives the same output as above:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal<span style="color: #666666">&gt;</span> python <span style="color: #666666">-</span>m doctest dc_mod_doctest<span style="color: #666666">.</span>py
</pre></div>
<p>

Report in case of failure:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python -m doctest dc_mod_doctest.py
********************************************************
File <span style="color: #BA2121">&quot;dc_mod_doctest.py&quot;</span>, line 12, in dc_mod_doctest....
Failed example:
    <span style="color: #008000; font-weight: bold">for </span>t_n, u_n in zip<span style="color: #666666">(</span>t, u<span style="color: #666666">)</span>:
        print <span style="color: #BA2121">&#39;t=%.1f, u=%.14f&#39;</span> % <span style="color: #666666">(</span>t_n, u_n<span style="color: #666666">)</span>
Expected:
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>0.0, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.80000000000000
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>0.5, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.43076923076923
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>1.0, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.23195266272189
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>1.5, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.12489758761948
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>2.0, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.06725254717972
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>2.5, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.03621291001985
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>3.0, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.01949925924146
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>3.5, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.01049960113002
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>4.0, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.00565363137770
Got:
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>0.0, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.80000000000000
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>0.5, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.43076923076923
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>1.0, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.23195266272189
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>1.5, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.12489758761948
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>2.0, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.06725254717972
********************************************************
1 items had failures:
   1 of   2 in dc_mod_doctest.solver
***Test Failed*** 1 failures.
</pre></div>
<p>

Limit the number of digits in the output in doctests! Otherwise,
round-off errors on a different machine may ruin the test.

<p>

Another example on using doctests:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">explore</span>(I, a, T, dt, theta<span style="color: #666666">=0.5</span>, makeplot<span style="color: #666666">=</span><span style="color: #008000">True</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Run a case with the solver, compute error measure,</span>
<span style="color: #BA2121; font-style: italic">    and plot the numerical and exact solutions (if makeplot=True).</span>

<span style="color: #BA2121; font-style: italic">    &gt;&gt;&gt; for theta in 0, 0.5, 1:</span>
<span style="color: #BA2121; font-style: italic">    ...    E = explore(I=1.9, a=2.1, T=5, dt=0.1, theta=theta,</span>
<span style="color: #BA2121; font-style: italic">    ...                makeplot=False)</span>
<span style="color: #BA2121; font-style: italic">    ...    print &#39;%.10E&#39; % E</span>
<span style="color: #BA2121; font-style: italic">    ...</span>
<span style="color: #BA2121; font-style: italic">    7.3565079236E-02</span>
<span style="color: #BA2121; font-style: italic">    2.4183893110E-03</span>
<span style="color: #BA2121; font-style: italic">    6.5013039886E-02</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #666666">...</span>
</pre></div>
<p>

Complete program: <a href="http://github.hplgit.com/INF5620/src/decay/dc_mod_doctest.py"><tt>dc_mod_doctest.py</tt></a>.

<p>

Avoid doctests in functions using <tt>sys.argv</tt> and <tt>print</tt> (possible,
but needs careful coding).

<p>

<h3>Unit testing with nose  <a name="___sec27"></a></h3>
<p>


<ul>
 <p><li> Nose is a very user-friendly testing framework</li>
 <p><li> Based on <em>unit testing</em></li>
 <p><li> Identify small units of code</li>
 <p><li> Test each unit</li>
 <p><li> Nose automates running all tests</li>
 <p><li> Good habit: make a small edit in a code, run all tests</li>
 <p><li> Even better habit: write tests before the code</li>
 <p><li> Unit testing in scientific computing is not well so established</li>
</ul>

<h4>Basic use of nose  <a name="___sec28"></a></h4>
<p>

<ol>
 <p><li> Implement tests in functions with names starting with <tt>test_</tt>.</li>
 <p><li> Test functions perform assertions on computed results
    using <tt>assert</tt> functions from the <tt>nose.tools</tt> module.</li>
 <p><li> Test functions can be in the source code files or be
    collected in separate files, usually with names starting with <tt>test_</tt>.</li>
</ol>

Very simple illustration of module <tt>mymod</tt>:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">double</span>(n):
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">2*</span>n
</pre></div>
<p>

Either in this file or in a separate file <tt>test_mymod.py</tt>, we
implement a test function for checking that
<tt>double</tt> works:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">nose.tools</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">nt</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_double</span>():
    result <span style="color: #666666">=</span> mymod<span style="color: #666666">.</span>double(<span style="color: #666666">4</span>)
    nt<span style="color: #666666">.</span>assert_equal(result, <span style="color: #666666">8</span>)
</pre></div>
<p>
(Need <tt>import mymod</tt> if the test is in <tt>test_mymod.py</tt>.)

<p>
Running

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; nosetests
</pre></div>
<p>
makes the <tt>nose</tt> tool look for Python files with <tt>test_*()</tt>
functions and run these functions.

<p>
Main point with a test function: raise <tt>AssertionError</tt> exception if the
test fails.

<p>
Alternative:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">if</span> result <span style="color: #666666">!=</span> <span style="color: #666666">8</span>:
    <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #D2413A; font-weight: bold">AssertionError</span>()
</pre></div>
<p>

Advantage of nose:

<p>

<ul>
  <p><li> tests are written and collected in a structured way</li>
  <p><li> large collections of tests, scattered throughout a tree of folders,
    can be executed with one command (<tt>nosetests</tt>).</li>
</ul>

<h4>Demonstrating nose  <a name="___sec29"></a></h4>
<p>
Back to the exponential decay problem and the <tt>solver</tt> function.

<p>
We design three unit tests:

<p>

<ol>
 <p><li> A comparison between the computed \( u^n \) values and the
    exact discrete solution.</li>
 <p><li> A comparison between the computed \( u^n \) values and precomputed,
    verified reference values.</li>
 <p><li> A comparison between observed and expected convergence rates.</li>
</ol>

These tests follow very closely the previous <tt>verify*</tt> functions.

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">nose.tools</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">nt</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">os</span>
sys<span style="color: #666666">.</span>path<span style="color: #666666">.</span>insert(<span style="color: #666666">0</span>, os<span style="color: #666666">.</span>pardir)
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">dc_mod_unittest</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">dc_mod</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_discrete_solution</span>(n, I, a, theta, dt):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return exact discrete solution of the theta scheme.&quot;&quot;&quot;</span>
    dt <span style="color: #666666">=</span> <span style="color: #008000">float</span>(dt)  <span style="color: #408080; font-style: italic"># avoid integer division</span>
    factor <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)
    <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>factor<span style="color: #666666">**</span>n

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_against_discrete_solution</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Compare result from solver against</span>
<span style="color: #BA2121; font-style: italic">    formula for the discrete solution.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    theta <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>; a <span style="color: #666666">=</span> <span style="color: #666666">2</span>; I <span style="color: #666666">=</span> <span style="color: #666666">0.1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>
    N <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #666666">8/</span>dt)  <span style="color: #408080; font-style: italic"># no of steps</span>
    u, t <span style="color: #666666">=</span> dc_mod<span style="color: #666666">.</span>solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, T<span style="color: #666666">=</span>N<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)
    u_de <span style="color: #666666">=</span> np<span style="color: #666666">.</span>array([exact_discrete_solution(n, I, a, theta, dt)
                     <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(N<span style="color: #666666">+1</span>)])
    diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u_de <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()
    nt<span style="color: #666666">.</span>assert_almost_equal(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)
</pre></div>
<p>

<tt>nt.assert_almost_equal</tt>: compare two floats and avoid
differences due to round-off errors.

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_solver</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Compare result from solver against</span>
<span style="color: #BA2121; font-style: italic">    precomputed arrays for theta=0, 0.5, 1.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    I<span style="color: #666666">=0.8</span>; a<span style="color: #666666">=1.2</span>; T<span style="color: #666666">=4</span>; dt<span style="color: #666666">=0.5</span>  <span style="color: #408080; font-style: italic"># fixed parameters</span>
    precomputed <span style="color: #666666">=</span> {
        <span style="color: #BA2121">&#39;t&#39;</span>: np<span style="color: #666666">.</span>array([ <span style="color: #666666">0.</span> ,  <span style="color: #666666">0.5</span>,  <span style="color: #666666">1.</span> ,  <span style="color: #666666">1.5</span>,  <span style="color: #666666">2.</span> ,  <span style="color: #666666">2.5</span>,
                        <span style="color: #666666">3.</span> ,  <span style="color: #666666">3.5</span>,  <span style="color: #666666">4.</span> ]),
        <span style="color: #666666">0.5</span>: np<span style="color: #666666">.</span>array(
            [ <span style="color: #666666">0.8</span>       ,  <span style="color: #666666">0.43076923</span>,  <span style="color: #666666">0.23195266</span>, <span style="color: #666666">0.12489759</span>,
              <span style="color: #666666">0.06725255</span>,  <span style="color: #666666">0.03621291</span>,  <span style="color: #666666">0.01949926</span>, <span style="color: #666666">0.0104996</span> ,
              <span style="color: #666666">0.00565363</span>]),
        <span style="color: #666666">0</span>: np<span style="color: #666666">.</span>array(
            [  <span style="color: #666666">8.00000000e-01</span>,   <span style="color: #666666">3.20000000e-01</span>,
               <span style="color: #666666">1.28000000e-01</span>,   <span style="color: #666666">5.12000000e-02</span>,
               <span style="color: #666666">2.04800000e-02</span>,   <span style="color: #666666">8.19200000e-03</span>,
               <span style="color: #666666">3.27680000e-03</span>,   <span style="color: #666666">1.31072000e-03</span>,
               <span style="color: #666666">5.24288000e-04</span>]),
        <span style="color: #666666">1</span>: np<span style="color: #666666">.</span>array(
            [ <span style="color: #666666">0.8</span>       ,  <span style="color: #666666">0.5</span>       ,  <span style="color: #666666">0.3125</span>    ,  <span style="color: #666666">0.1953125</span> ,
              <span style="color: #666666">0.12207031</span>,  <span style="color: #666666">0.07629395</span>,  <span style="color: #666666">0.04768372</span>,  <span style="color: #666666">0.02980232</span>,
              <span style="color: #666666">0.01862645</span>]),
        }
    <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>:
        u, t <span style="color: #666666">=</span> dc_mod<span style="color: #666666">.</span>solver(I, a, T, dt, theta<span style="color: #666666">=</span>theta)
        diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u <span style="color: #666666">-</span> precomputed[theta])<span style="color: #666666">.</span>max()
        <span style="color: #408080; font-style: italic"># Precomputed numbers are known to 8 decimal places</span>
        nt<span style="color: #666666">.</span>assert_almost_equal(diff, <span style="color: #666666">0</span>, places<span style="color: #666666">=8</span>,
                               msg<span style="color: #666666">=</span><span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> theta)
</pre></div>
<p>


<ul>
 <p><li> Testing for special type of input data that may cause trouble is important</li>
 <p><li> Here: the formula for \( u^{n+1} \) may involve integer division</li>
</ul>

Example:
<p>

<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">theta <span style="color: #666666">=</span> <span style="color: #666666">1</span>; a <span style="color: #666666">=</span> <span style="color: #666666">1</span>; I <span style="color: #666666">=</span> <span style="color: #666666">1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">2</span>
</pre></div>
<p>
lead to integer division:
<p>

<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">(<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)  <span style="color: #408080; font-style: italic"># becomes 1</span>
(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)      <span style="color: #408080; font-style: italic"># becomes 2</span>
(<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)  <span style="color: #408080; font-style: italic"># becomes 0 (!)</span>
</pre></div>
<p>

Unit test for this issue:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_potential_integer_division</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Choose variables that can trigger integer division.&quot;&quot;&quot;</span>
    theta <span style="color: #666666">=</span> <span style="color: #666666">1</span>; a <span style="color: #666666">=</span> <span style="color: #666666">1</span>; I <span style="color: #666666">=</span> <span style="color: #666666">1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">2</span>
    N <span style="color: #666666">=</span> <span style="color: #666666">4</span>
    u, t <span style="color: #666666">=</span> dc_mod<span style="color: #666666">.</span>solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, T<span style="color: #666666">=</span>N<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)
    u_de <span style="color: #666666">=</span> np<span style="color: #666666">.</span>array([exact_discrete_solution(n, I, a, theta, dt)
                     <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(N<span style="color: #666666">+1</span>)])
    diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u_de <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()
    nt<span style="color: #666666">.</span>assert_almost_equal(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)
</pre></div>
<p>

Test convergence rates:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_convergence_rates</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Compare empirical convergence rates to exact ones.&quot;&quot;&quot;</span>
    <span style="color: #408080; font-style: italic"># Set command-line arguments directly in sys.argv</span>
    sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>:] <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;--I 0.8 --a 2.1 --T 5 &#39;</span>\ 
                   <span style="color: #BA2121">&#39;--dt 0.4 0.2 0.1 0.05 0.025&#39;</span><span style="color: #666666">.</span>split()
    <span style="color: #408080; font-style: italic"># Suppress output from dc_mod.main()</span>
    stdout <span style="color: #666666">=</span> sys<span style="color: #666666">.</span>stdout  <span style="color: #408080; font-style: italic"># save standard output for later use</span>
    scratchfile <span style="color: #666666">=</span> <span style="color: #008000">open</span>(<span style="color: #BA2121">&#39;.tmp&#39;</span>, <span style="color: #BA2121">&#39;w&#39;</span>)  <span style="color: #408080; font-style: italic"># fake standard output</span>
    sys<span style="color: #666666">.</span>stdout <span style="color: #666666">=</span> scratchfile

    r <span style="color: #666666">=</span> dc_mod<span style="color: #666666">.</span>main()
    <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> r:
        nt<span style="color: #666666">.</span>assert_true(r[theta])  <span style="color: #408080; font-style: italic"># check for non-empty list</span>

    scratchfile<span style="color: #666666">.</span>close()
    sys<span style="color: #666666">.</span>stdout <span style="color: #666666">=</span> stdout  <span style="color: #408080; font-style: italic"># restore standard output</span>

    expected_rates <span style="color: #666666">=</span> {<span style="color: #666666">0</span>: <span style="color: #666666">1</span>, <span style="color: #666666">1</span>: <span style="color: #666666">1</span>, <span style="color: #666666">0.5</span>: <span style="color: #666666">2</span>}
    <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> r:
        r_final <span style="color: #666666">=</span> r[theta][<span style="color: #666666">-1</span>]
        <span style="color: #408080; font-style: italic"># Compare to 1 decimal place</span>
        nt<span style="color: #666666">.</span>assert_almost_equal(expected_rates[theta], r_final,
                               places<span style="color: #666666">=1</span>, msg<span style="color: #666666">=</span><span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> theta)

<span style="color: #408080; font-style: italic"># no need for any main</span>
</pre></div>
<p>

Complete program: <a href="http://github.hplgit.com/INF5620/src/decay/test/test_dc_nose.py"><tt>test_dc_nose.py</tt></a>.

<p>


<h3>Classical unit testing with unittest  <a name="___sec30"></a></h3>
<p>


<ul>
 <p><li> <tt>unittest</tt> is a Python module mimicing the classical JUnit
   class-based unit testing framework from Java</li>
 <p><li> This is how unit testing is normally done</li>
 <p><li> Requires knowledge of object-oriented programming</li>
</ul>

<h4>Basic use of unittest  <a name="___sec31"></a></h4>
<p>

Write file <tt>test_mymod.py</tt>:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">unittest</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">mymod</span>

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">TestMyCode</span>(unittest<span style="color: #666666">.</span>TestCase):
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_double</span>(<span style="color: #008000">self</span>):
        result <span style="color: #666666">=</span> mymod<span style="color: #666666">.</span>double(<span style="color: #666666">4</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>assertEqual(result, <span style="color: #666666">8</span>)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    unittest<span style="color: #666666">.</span>main()
</pre></div>
<p>


<h4>Demonstration of unittest  <a name="___sec32"></a></h4>
<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">unittest</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">dc_mod_unittest</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">decay</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_discrete_solution</span>(n, I, a, theta, dt):
    factor <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)
    <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>factor<span style="color: #666666">**</span>n

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">TestDecay</span>(unittest<span style="color: #666666">.</span>TestCase):

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_against_discrete_solution</span>(<span style="color: #008000">self</span>):
        <span style="color: #666666">...</span>
        diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u_de <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>assertAlmostEqual(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_solver</span>(<span style="color: #008000">self</span>):
        <span style="color: #666666">...</span>
        <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>:
            <span style="color: #666666">...</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>assertAlmostEqual(diff, <span style="color: #666666">0</span>, places<span style="color: #666666">=8</span>,
                                   msg<span style="color: #666666">=</span><span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> theta)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_potential_integer_division</span>():
        <span style="color: #666666">...</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>assertAlmostEqual(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_convergence_rates</span>(<span style="color: #008000">self</span>):
        <span style="color: #666666">...</span>
        <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> r:
            <span style="color: #666666">...</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>assertAlmostEqual(<span style="color: #666666">...</span>)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    unittest<span style="color: #666666">.</span>main()
</pre></div>
<p>

<!-- @@@CODE src-decay/test/test_dc_unittest.py fromto: def test_conv@ -->

<p>
Complete program: <a href="http://github.hplgit.com/INF5620/src/decay/test/test_dc_nose.py"><tt>test_dc_unittest.py</tt></a>.

<p>

<h3>Implementing simple problem and solver classes  <a name="___sec33"></a></h3>
<p>

<ul>
 <p><li> So far: programs are built of Python functions</li>
 <p><li> New focus: alternative implementations using classes</li>
 <p><li> Class-based implementations are very popular,
   especially in business/adm applications</li>
 <p><li> Class-based implementations scales better to large and
   compliex scientific applications</li>
</ul>

Tasks:

<p>

<ul>
 <p><li> Explain basic use of classes to build a differential equation solver</li>
 <p><li> Introduce concepts that make such programs easily scale to
   more complex applications</li>
 <p><li> Demonstrate the advantage of using classes</li>
 <p><li> Idea: classes for Problem, Solver, and Visualizer</li>
 <p><li> Problem: all the physics information about the problem</li>
 <p><li> Solver: all the numerics information + numerical computations</li>
 <p><li> Visualizer: plot the solution and other quantities</li>
</ul>

<h4>The problem class  <a name="___sec34"></a></h4>
<p>


<ul>
 <p><li> Model problem: \( u'=-au \), \( u(0)=I \), for \( t\in (0,T] \).</li>
 <p><li> Class <tt>Problem</tt> stores the physical parameters \( a \), \( I \), \( T \)</li>
 <p><li> May also offer other data, e.g., \( \uex(t)=Ie^{-at} \)</li>
</ul>

Implementation:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> exp

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Problem</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, I<span style="color: #666666">=1</span>, a<span style="color: #666666">=1</span>, T<span style="color: #666666">=10</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>T, <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a <span style="color: #666666">=</span> I, <span style="color: #008000">float</span>(a), T

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(<span style="color: #008000">self</span>, t):
        I, a <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a     <span style="color: #408080; font-style: italic"># extract local variables</span>
        <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>
<p>
Basic usage:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">problem <span style="color: #666666">=</span> Problem(T<span style="color: #666666">=5</span>)
problem<span style="color: #666666">.</span>T <span style="color: #666666">=</span> <span style="color: #666666">8</span>
problem<span style="color: #666666">.</span>dt <span style="color: #666666">=</span> <span style="color: #666666">1.5</span>
</pre></div>
<p>

Improvement: read data from the command line.

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Problem</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, I<span style="color: #666666">=1</span>, a<span style="color: #666666">=1</span>, T<span style="color: #666666">=10</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>T, <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a <span style="color: #666666">=</span> I, <span style="color: #008000">float</span>(a), T

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>(<span style="color: #008000">self</span>, parser<span style="color: #666666">=</span><span style="color: #008000">None</span>):
        <span style="color: #008000; font-weight: bold">if</span> parser <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
            <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">argparse</span>
            parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser()

        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--I&#39;</span>, <span style="color: #BA2121">&#39;--initial_condition&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
            default<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>I, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;initial condition, u(0)&#39;</span>,
            metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;I&#39;</span>)
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--a&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>, default<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>a,
            help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;coefficient in ODE&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;a&#39;</span>)
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--T&#39;</span>, <span style="color: #BA2121">&#39;--stop_time&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>, default<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>T,
            help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;end time of simulation&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;T&#39;</span>)
        <span style="color: #008000; font-weight: bold">return</span> parser

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">init_from_command_line</span>(<span style="color: #008000">self</span>, args):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a, <span style="color: #008000">self</span><span style="color: #666666">.</span>T <span style="color: #666666">=</span> args<span style="color: #666666">.</span>I, args<span style="color: #666666">.</span>a, args<span style="color: #666666">.</span>T

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(<span style="color: #008000">self</span>, t):
        I, a <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a
        <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>
<p>

Observe

<p>

<ul>
 <p><li> Can utilize user's <tt>ArgumentParser</tt>, or make one</li>
 <p><li> <tt>None</tt> is used to indicate an "empty" (non-initialized) variable</li>
</ul>

<h4>The solver class  <a name="___sec35"></a></h4>
<p>


<ul>
 <p><li> Store numerical data \( \Delta t \), \( \theta \)</li>
 <p><li> Compute solution and quantities derived from the solution</li>
</ul>

Implementation:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Solver</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, problem, dt<span style="color: #666666">=0.1</span>, theta<span style="color: #666666">=0.5</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>problem <span style="color: #666666">=</span> problem
        <span style="color: #008000">self</span><span style="color: #666666">.</span>dt, <span style="color: #008000">self</span><span style="color: #666666">.</span>theta <span style="color: #666666">=</span> <span style="color: #008000">float</span>(dt), theta

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>(<span style="color: #008000">self</span>, parser):
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--dt&#39;</span>, <span style="color: #BA2121">&#39;--time_step_value&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
            default<span style="color: #666666">=0.5</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time step value&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;dt&#39;</span>)
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--theta&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>, default<span style="color: #666666">=0.5</span>,
            help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time discretization parameter&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;dt&#39;</span>)
        <span style="color: #008000; font-weight: bold">return</span> parser

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">init_from_command_line</span>(<span style="color: #008000">self</span>, args):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>dt, <span style="color: #008000">self</span><span style="color: #666666">.</span>theta <span style="color: #666666">=</span> args<span style="color: #666666">.</span>dt, args<span style="color: #666666">.</span>theta

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solve</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">dc_mod</span> <span style="color: #008000; font-weight: bold">import</span> solver
        <span style="color: #008000">self</span><span style="color: #666666">.</span>u, <span style="color: #008000">self</span><span style="color: #666666">.</span>t <span style="color: #666666">=</span> solver(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>a, <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>T,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>dt, <span style="color: #008000">self</span><span style="color: #666666">.</span>theta)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">error</span>(<span style="color: #008000">self</span>):
        u_e <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>exact_solution(<span style="color: #008000">self</span><span style="color: #666666">.</span>t)
        e <span style="color: #666666">=</span> u_e <span style="color: #666666">-</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>u
        E <span style="color: #666666">=</span> sqrt(<span style="color: #008000">self</span><span style="color: #666666">.</span>dt<span style="color: #666666">*</span><span style="color: #008000">sum</span>(e<span style="color: #666666">**2</span>))
        <span style="color: #008000; font-weight: bold">return</span> E
</pre></div>
<p>

Note: reuse of the numerical algorithm from the <tt>dc_mod</tt> module.

<p>

<h4>The visualizer class  <a name="___sec36"></a></h4>
<p>


<ul>
 <p><li> Store data about what to plot (if any)</li>
 <p><li> Offer different types of plots</li>
 <p><li> Here: make just the same plot as in the previous <tt>explore</tt> function</li>
</ul>

Implementation:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Visualizer</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, problem, solver):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>problem, <span style="color: #008000">self</span><span style="color: #666666">.</span>solver <span style="color: #666666">=</span> problem, solver

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">plot</span>(<span style="color: #008000">self</span>, include_exact<span style="color: #666666">=</span><span style="color: #008000">True</span>, plt<span style="color: #666666">=</span><span style="color: #008000">None</span>):
        <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">        Add solver.u curve to scitools plotting object plt,</span>
<span style="color: #BA2121; font-style: italic">        and include the exact solution if include_exact is True.</span>
<span style="color: #BA2121; font-style: italic">        This plot function can be called several times (if</span>
<span style="color: #BA2121; font-style: italic">        the solver object has computed new solutions).</span>
<span style="color: #BA2121; font-style: italic">        &quot;&quot;&quot;</span>
        <span style="color: #008000; font-weight: bold">if</span> plt <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
            <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">scitools.std</span>
            plt <span style="color: #666666">=</span> scitools<span style="color: #666666">.</span>std

        plt<span style="color: #666666">.</span>plot(<span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>t, <span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>u, <span style="color: #BA2121">&#39;--o&#39;</span>)
        plt<span style="color: #666666">.</span>hold(<span style="color: #BA2121">&#39;on&#39;</span>)
        theta2name <span style="color: #666666">=</span> {<span style="color: #666666">0</span>: <span style="color: #BA2121">&#39;FE&#39;</span>, <span style="color: #666666">1</span>: <span style="color: #BA2121">&#39;BE&#39;</span>, <span style="color: #666666">0.5</span>: <span style="color: #BA2121">&#39;CN&#39;</span>}
        name <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>theta2name<span style="color: #666666">.</span>get(<span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>theta, <span style="color: #BA2121">&#39;&#39;</span>)
        plt<span style="color: #666666">.</span>legend(<span style="color: #BA2121">&#39;numerical </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> name)
        <span style="color: #008000; font-weight: bold">if</span> include_exact:
            t_e <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>T, <span style="color: #666666">1001</span>)
            u_e <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>exact_solution(t_e)
            plt<span style="color: #666666">.</span>plot(t_e, u_e, <span style="color: #BA2121">&#39;b-&#39;</span>)
            plt<span style="color: #666666">.</span>legend(<span style="color: #BA2121">&#39;exact&#39;</span>)
        plt<span style="color: #666666">.</span>xlabel(<span style="color: #BA2121">&#39;t&#39;</span>)
        plt<span style="color: #666666">.</span>ylabel(<span style="color: #BA2121">&#39;u&#39;</span>)
        plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, dt=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span>
                  (<span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>theta, <span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>dt))
        plt<span style="color: #666666">.</span>savefig(<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (name, <span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>dt))
        <span style="color: #008000; font-weight: bold">return</span> plt
</pre></div>
<p>

Note:

<ul>
  <p><li> The <tt>plt</tt> object in <tt>plot</tt> adds a new curve to a plot,
    which enables comparing different solutions from different
    runs of <tt>Solver.solve</tt></li>
  <p><li> Such different curves gets different colors</li>
</ul>

<h4>Combing the objects  <a name="___sec37"></a></h4>
<p>
Let <tt>Problem</tt>, <tt>Solver</tt>, and <tt>Visualizer</tt> play together:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>():
    problem <span style="color: #666666">=</span> Problem()
    solver <span style="color: #666666">=</span> Solver(problem)
    viz <span style="color: #666666">=</span> Visualizer(problem, solver)

    <span style="color: #408080; font-style: italic"># Read input from the command line</span>
    parser <span style="color: #666666">=</span> problem<span style="color: #666666">.</span>define_command_line_options()
    parser <span style="color: #666666">=</span> solver<span style="color: #666666">.</span> define_command_line_options(parser)
    args <span style="color: #666666">=</span> parser<span style="color: #666666">.</span>parse_args()
    problem<span style="color: #666666">.</span>init_from_command_line(args)
    solver<span style="color: #666666">.</span> init_from_command_line(args)

    <span style="color: #408080; font-style: italic"># Solve and plot</span>
    solver<span style="color: #666666">.</span>solve()
    plt <span style="color: #666666">=</span> viz<span style="color: #666666">.</span>plot()
    E <span style="color: #666666">=</span> solver<span style="color: #666666">.</span>error()
    <span style="color: #008000; font-weight: bold">if</span> E <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">None</span>:
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Error: </span><span style="color: #BB6688; font-weight: bold">%.4E</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> E
    plt<span style="color: #666666">.</span>show()
</pre></div>
<p>

Complete program: <a href="http://github.hplgit.com/INF5620/src/decay/dc_class.py"><tt>dc_class.py</tt></a>.

<p>


<h3>Implementing more advanced problem and solver classes  <a name="___sec38"></a></h3>
<p>

<ul>
 <p><li> The previous <tt>Problem</tt> and <tt>Solver</tt> classes soon contain
   much repetitive code when the number of parameters increases</li>
 <p><li> Much of such code can be parameterized and be made more compact</li>
 <p><li> Idea: collect all parameters in a dictionary <tt>self.prms</tt>,
   with two associated dictionaries <tt>self.types</tt> and
   <tt>self.help</tt> for holding associated object types and help strings</li>
 <p><li> Collect common code in class <tt>Parameters</tt></li>
 <p><li> Let <tt>Problem</tt>, <tt>Solver</tt>, and maybe <tt>Visualizer</tt> be subclasses
   of class <tt>Parameters</tt>, basically defining <tt>self.prms</tt>, <tt>self.types</tt>,
   <tt>self.help</tt></li>
</ul>

<h4>A generic class for parameters  <a name="___sec39"></a></h4>
<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Parameters</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">set</span>(<span style="color: #008000">self</span>, <span style="color: #666666">**</span>parameters):
        <span style="color: #008000; font-weight: bold">for</span> name <span style="color: #AA22FF; font-weight: bold">in</span> parameters:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>prms[name] <span style="color: #666666">=</span> parameters[name]

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">get</span>(<span style="color: #008000">self</span>, name):
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>prms[name]

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>(<span style="color: #008000">self</span>, parser<span style="color: #666666">=</span><span style="color: #008000">None</span>):
        <span style="color: #008000; font-weight: bold">if</span> parser <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
            <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">argparse</span>
            parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser()

        <span style="color: #008000; font-weight: bold">for</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>prms:
            tp <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>types[name] <span style="color: #008000; font-weight: bold">if</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>types <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000">str</span>
            help <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>help[name] <span style="color: #008000; font-weight: bold">if</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>help <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000">None</span>
            parser<span style="color: #666666">.</span>add_argument(
                <span style="color: #BA2121">&#39;--&#39;</span> <span style="color: #666666">+</span> name, default<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>get(name), metavar<span style="color: #666666">=</span>name,
                <span style="color: #008000">type</span><span style="color: #666666">=</span>tp, help<span style="color: #666666">=</span>help)

        <span style="color: #008000; font-weight: bold">return</span> parser

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">init_from_command_line</span>(<span style="color: #008000">self</span>, args):
        <span style="color: #008000; font-weight: bold">for</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>prms:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>prms[name] <span style="color: #666666">=</span> <span style="color: #008000">getattr</span>(args, name)
</pre></div>
<p>

Slightly more advanced version in <a href="http://github.hplgit.com/INF5620/src/decay/class_dc_verf1.py"><tt>class_dc_verf1.py</tt></a>.

<p>

<h4>The problem class  <a name="___sec40"></a></h4>
<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Problem</span>(Parameters):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Physical parameters for the problem u&#39;=-a*u, u(0)=I,</span>
<span style="color: #BA2121; font-style: italic">    with t in [0,T].</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>prms <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(I<span style="color: #666666">=1</span>, a<span style="color: #666666">=1</span>, T<span style="color: #666666">=10</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>types <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(I<span style="color: #666666">=</span><span style="color: #008000">float</span>, a<span style="color: #666666">=</span><span style="color: #008000">float</span>, T<span style="color: #666666">=</span><span style="color: #008000">float</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>help <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(I<span style="color: #666666">=</span><span style="color: #BA2121">&#39;initial condition, u(0)&#39;</span>,
                         a<span style="color: #666666">=</span><span style="color: #BA2121">&#39;coefficient in ODE&#39;</span>,
                         T<span style="color: #666666">=</span><span style="color: #BA2121">&#39;end time of simulation&#39;</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(<span style="color: #008000">self</span>, t):
        I, a <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;I&#39;</span>), <span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;a&#39;</span>)
        <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>np<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>
<p>


<h4>The solver class  <a name="___sec41"></a></h4>
<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Solver</span>(Parameters):
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, problem):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>problem <span style="color: #666666">=</span> problem
        <span style="color: #008000">self</span><span style="color: #666666">.</span>prms <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(dt<span style="color: #666666">=0.5</span>, theta<span style="color: #666666">=0.5</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>types <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(dt<span style="color: #666666">=</span><span style="color: #008000">float</span>, theta<span style="color: #666666">=</span><span style="color: #008000">float</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>help <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(dt<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time step value&#39;</span>,
                         theta<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time discretization parameter&#39;</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solve</span>(<span style="color: #008000">self</span>):
        <span style="color: #408080; font-style: italic">#from dc_mod import solver</span>
        <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">decay_theta</span> <span style="color: #008000; font-weight: bold">import</span> solver
        <span style="color: #008000">self</span><span style="color: #666666">.</span>u, <span style="color: #008000">self</span><span style="color: #666666">.</span>t <span style="color: #666666">=</span> solver(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;I&#39;</span>),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;a&#39;</span>),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;T&#39;</span>),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;dt&#39;</span>),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;theta&#39;</span>))

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">error</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">try</span>:
            u_e <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>exact_solution(<span style="color: #008000">self</span><span style="color: #666666">.</span>t)
            e <span style="color: #666666">=</span> u_e <span style="color: #666666">-</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>u
            E <span style="color: #666666">=</span> np<span style="color: #666666">.</span>sqrt(<span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;dt&#39;</span>)<span style="color: #666666">*</span>np<span style="color: #666666">.</span>sum(e<span style="color: #666666">**2</span>))
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">AttributeError</span>:
            E <span style="color: #666666">=</span> <span style="color: #008000">None</span>
        <span style="color: #008000; font-weight: bold">return</span> E
</pre></div>
<p>


<h4>The visualizer class  <a name="___sec42"></a></h4>
<p>


<ul>
 <p><li> No parameters needed (for this simple problem), no need to inherit
   class <tt>Parameters</tt></li>
 <p><li> Same code as previously shown class <tt>Visualizer</tt></li>
 <p><li> Same code as previously shown for combining <tt>Problem</tt>, <tt>Solver</tt>, and
   <tt>Visualizer</tt></li>
</ul>

<h2>Performing scientific experiments <a name="decay:experiments"></a></h2>
<p>

Goal: explore the behavior of a numerical
method for a differential equation and show how scientific experiments
can be set up and reported.

<p>
Tasks:

<p>

<ul>
  <p><li> Write scripts to automate experiments</li>
  <p><li> Generate scientific reports from scripts</li>
</ul>

Tools to learn:

<p>

<ul>
  <p><li> <tt>os.system</tt> for running other programs</li>
  <p><li> <tt>subprocess</tt> for running other programs and extracting the output</li>
  <p><li> List comprehensions</li>
  <p><li> Formats for scientific reports: HTML w/MathJax, LaTeX, Sphinx, Doconce</li>
</ul>

Problem:

<p>
$$
\begin{equation}
u'(t) = -au(t),\quad u(0)=I,\ 0< t \leq T,
\label{decay:experiments:model}
\end{equation}
$$

<p>
Solution method (\( \theta \)-rule):

<p>
$$
u^{n+1} = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a\Delta t}u^n,
\quad u^0=I\thinspace .
$$

<p>
Tasks:

<p>

<ul>
 <p><li> Plot \( u^n \) against \( \uex = Ie^{-at} \) for
   various choices of the parameters
   \( I \), \( a \), \( \Delta t \), and \( \theta \)</li>
 <p><li> How does the discrete solution compare with the exact solution
   when \( \Delta t \) is varied and \( \theta=0,0.5,1 \)?</li>
 <p><li> Use the <a href="http://github.hplgit.com/INF5620/src/decay/dc_mod.py"><tt>dc_mod.py</tt></a> module (little modification of the plotting, see <a href="http://github.hplgit.com/INF5620/src/decay/experiments/dc_mod.py"><tt>experiments/dc_mod.py</tt></a>)</li>
 <p><li> Make separate program for running (automating) the experiments (<em>script</em>)</li>

<ol>
   <p><li> <tt>python dc_mod.py --I 1 --a 2 --makeplot --T 5 --dt 0.5 0.25 0.1 0.05</tt></li>
   <p><li> Combine generated figures <tt>FE_*.png</tt>, <tt>BE_*.png</tt>, and <tt>CN_*.png</tt>
      to new figures with multiple plots</li>
   <p><li> Run script as <tt>python dc_exper0.py 0.5 0.25 0.1 0.05</tt> (\( \Delta t \) values on the command line)</li>
</ol>

</ul>

<center> <! -- figure -->
<hr class="figure">
<center><p class="caption">Figure 4:  Illustration of the Backward Euler method for four time step values. <a name="decay:experiments:fig:BE4a"></a> </p></center>
<p><img src="fig-decay/BE4a.png" align="bottom" width=800,></p>
</center>

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">os</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">sys</span>

<span style="color: #408080; font-style: italic"># The command line must contain dt values</span>
<span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(sys<span style="color: #666666">.</span>argv) <span style="color: #666666">&gt;</span> <span style="color: #666666">1</span>:
    dt_values <span style="color: #666666">=</span> [<span style="color: #008000">float</span>(arg) <span style="color: #008000; font-weight: bold">for</span> arg <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>:]]
<span style="color: #008000; font-weight: bold">else</span>:
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Usage: </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> dt1 dt2 dt3 ...&#39;</span>;  sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)  <span style="color: #408080; font-style: italic"># abort</span>

<span style="color: #408080; font-style: italic"># Fixed physical parameters</span>
I <span style="color: #666666">=</span> <span style="color: #666666">1</span>
a <span style="color: #666666">=</span> <span style="color: #666666">2</span>
T <span style="color: #666666">=</span> <span style="color: #666666">5</span>

<span style="color: #408080; font-style: italic"># Run module file as a stand-alone application</span>
cmd <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;python dc_mod.py --I </span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121"> --a </span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121"> --makeplot --T </span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> \
      (I, a, T)
dt_values_str <span style="color: #666666">=</span> <span style="color: #BA2121">&#39; &#39;</span><span style="color: #666666">.</span>join([<span style="color: #008000">str</span>(v) <span style="color: #008000; font-weight: bold">for</span> v <span style="color: #AA22FF; font-weight: bold">in</span> dt_values])
cmd <span style="color: #666666">+=</span> <span style="color: #BA2121">&#39; --dt </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> dt_values_str
<span style="color: #008000; font-weight: bold">print</span> cmd
failure <span style="color: #666666">=</span> os<span style="color: #666666">.</span>system(cmd)
<span style="color: #008000; font-weight: bold">if</span> failure:
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Command failed:&#39;</span>, cmd; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)

<span style="color: #408080; font-style: italic"># Combine images into rows with 2 plots in each row</span>
combine_image_commands <span style="color: #666666">=</span> []
<span style="color: #008000; font-weight: bold">for</span> method <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #BA2121">&#39;BE&#39;</span>, <span style="color: #BA2121">&#39;CN&#39;</span>, <span style="color: #BA2121">&#39;FE&#39;</span>:
    imagefiles <span style="color: #666666">=</span> <span style="color: #BA2121">&#39; &#39;</span><span style="color: #666666">.</span>join([<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">_</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.pdf&#39;</span> <span style="color: #666666">%</span> (method, dt)
                           <span style="color: #008000; font-weight: bold">for</span> dt <span style="color: #AA22FF; font-weight: bold">in</span> dt_values])
    combine_image_commands<span style="color: #666666">.</span>append(
        <span style="color: #BA2121">&#39;montage -background white -geometry 100%&#39;</span> <span style="color: #666666">+</span> \
        <span style="color: #BA2121">&#39; -tile 2x </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (imagefiles, method))
    combine_image_commands<span style="color: #666666">.</span>append(
        <span style="color: #BA2121">&#39;convert -trim </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.png </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (method, method))
    combine_image_commands<span style="color: #666666">.</span>append(
        <span style="color: #BA2121">&#39;pdftk </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> output tmp.pdf&#39;</span> <span style="color: #666666">%</span> imagefiles)
    num_rows <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #008000">round</span>(<span style="color: #008000">len</span>(dt_values)<span style="color: #666666">/2.0</span>))
    combine_image_commands<span style="color: #666666">.</span>append(
        <span style="color: #BA2121">&#39;pdfnup --nup 2x</span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121"> tmp.pdf&#39;</span> <span style="color: #666666">%</span> num_rows)
    combine_image_commands<span style="color: #666666">.</span>append(
        <span style="color: #BA2121">&#39;pdfcrop tmp-nup.pdf&#39;</span>)
    combine_image_commands<span style="color: #666666">.</span>append(
        <span style="color: #BA2121">&#39;mv -f tmp-nup-crop.pdf </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.pdf;&#39;</span>
        <span style="color: #BA2121">&#39;rm -f tmp.pdf tmp-nup.pdf&#39;</span> <span style="color: #666666">%</span> method)
    imagefiles <span style="color: #666666">=</span> <span style="color: #BA2121">&#39; &#39;</span><span style="color: #666666">.</span>join([<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">_</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (method, dt)
                           <span style="color: #008000; font-weight: bold">for</span> dt <span style="color: #AA22FF; font-weight: bold">in</span> dt_values])

<span style="color: #008000; font-weight: bold">for</span> cmd <span style="color: #AA22FF; font-weight: bold">in</span> combine_image_commands:
    <span style="color: #008000; font-weight: bold">print</span> cmd
    failure <span style="color: #666666">=</span> os<span style="color: #666666">.</span>system(cmd)
    <span style="color: #008000; font-weight: bold">if</span> failure:
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Command failed:&#39;</span>, cmd; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)

<span style="color: #408080; font-style: italic"># Remove the files generated by dc_mod.py</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">glob</span> <span style="color: #008000; font-weight: bold">import</span> glob
filenames <span style="color: #666666">=</span> glob(<span style="color: #BA2121">&#39;*_*.png&#39;</span>) <span style="color: #666666">+</span> glob(<span style="color: #BA2121">&#39;*_*.pdf&#39;</span>) <span style="color: #666666">+</span> glob(<span style="color: #BA2121">&#39;*_*.eps&#39;</span>)  <span style="color: #666666">+</span>\
            glob(<span style="color: #BA2121">&#39;tmp*.pdf&#39;</span>)
<span style="color: #008000; font-weight: bold">for</span> filename <span style="color: #AA22FF; font-weight: bold">in</span> filenames:
    os<span style="color: #666666">.</span>remove(filename)
</pre></div>
<p>

Complete program: <a href="http://github.hplgit.com/INF5620/src/decay/experiments/dc_exper0.py"><tt>experiments/dc_exper0.py</tt></a>.

<p>

Many useful constructs in the program above:

<p>

<ul>
 <p><li> <tt>[float(arg) for arg in sys.argv[1:]]</tt> builds a list of real numbers
   from all the command-line arguments</li>
 <p><li> <tt>failure = os.system(cmd)</tt> runs an operating system command
   (e.g., another program)</li>
 <p><li> <tt>sys.exit(1)</tt> aborts the program</li>
 <p><li> <tt>['%s_%s.png' % (method, dt) for dt in dt_values]</tt> builds a list of
   filenames from a list of numbers (<tt>dt_values</tt>)</li>
 <p><li> All <tt>montage</tt> commands for creating composite figures are stored in a
   list and thereafter executed in a loop</li>
 <p><li> <tt>glob.glob('*_*.png')</tt> returns a list of the names of all files in the
   current folder where the filename matches the <em>Unix wildcard notation</em>
   <tt>*_*.png</tt> (meaning "any text, underscore, any text, and then `.png`")</li>
 <p><li> <tt>os.remove(filename)</tt> removes the file with name <tt>filename</tt></li>
</ul>

<h3>Interpreting output from other programs  <a name="___sec44"></a></h3>
<p>
Programs that run other programs, like <tt>dc_exper0.py</tt> does, will often
need to interpret output from the other programs.
For example,

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python dc_plot_mpl.py
0.0   0.40:    2.105E-01
0.0   0.04:    1.449E-02
0.5   0.40:    3.362E-02
0.5   0.04:    1.887E-04
1.0   0.40:    1.030E-01
1.0   0.04:    1.382E-02
</pre></div>
<p>

Tasks:

<p>

<ul>
  <p><li> read the output from the <tt>dc_mod.py</tt> program</li>
  <p><li> interpret this output and store the \( E \) values in arrays for each
    \( \theta \) value</li>
  <p><li> plot \( E \) versus \( \Delta t \), for each \( \theta \), in a log-log plot</li>
</ul>

Must replace <tt>os.system(cmd)</tt> by use of the <tt>subprocess</tt> module:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">subprocess</span> <span style="color: #008000; font-weight: bold">import</span> Popen, PIPE, STDOUT
p <span style="color: #666666">=</span> Popen(cmd, shell<span style="color: #666666">=</span><span style="color: #008000">True</span>, stdout<span style="color: #666666">=</span>PIPE, stderr<span style="color: #666666">=</span>STDOUT)
output, dummy <span style="color: #666666">=</span> p<span style="color: #666666">.</span>communicate()
failure <span style="color: #666666">=</span> p<span style="color: #666666">.</span>returncode
<span style="color: #008000; font-weight: bold">if</span> failure:
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Command failed:&#39;</span>, cmd; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)
</pre></div>
<p>

Note: The command stored in <tt>cmd</tt> is run and all text that is written to
the standard output <em>and</em> the standard error is available in the
string <tt>output</tt>. The text in <tt>output</tt> is what appeared in the
terminal window while running <tt>cmd</tt>.

<p>
Next tasks:

<p>

<ul>
 <p><li> Run through the <tt>output</tt> string, line by line</li>
 <p><li> If the current line prints \( \theta \), \( \Delta t \), and \( E \),
   split the line into these three pieces and store the data</li>
 <p><li> Store data in a dictionary <tt>errors</tt> with keys <tt>dt</tt> and
   the three \( \theta \) values</li>
</ul>

<p>

<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">errors <span style="color: #666666">=</span> {<span style="color: #BA2121">&#39;dt&#39;</span>: dt_values, <span style="color: #666666">1</span>: [], <span style="color: #666666">0</span>: [], <span style="color: #666666">0.5</span>: []}
<span style="color: #008000; font-weight: bold">for</span> line <span style="color: #AA22FF; font-weight: bold">in</span> output<span style="color: #666666">.</span>splitlines():
    words <span style="color: #666666">=</span> line<span style="color: #666666">.</span>split()
    <span style="color: #008000; font-weight: bold">if</span> words[<span style="color: #666666">0</span>] <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #BA2121">&#39;0.0&#39;</span>, <span style="color: #BA2121">&#39;0.5&#39;</span>, <span style="color: #BA2121">&#39;1.0&#39;</span>):  <span style="color: #408080; font-style: italic"># line with E?</span>
        <span style="color: #408080; font-style: italic"># typical line: 0.0   1.25:    7.463E+00</span>
        theta <span style="color: #666666">=</span> <span style="color: #008000">float</span>(words[<span style="color: #666666">0</span>])
        E <span style="color: #666666">=</span> <span style="color: #008000">float</span>(words[<span style="color: #666666">2</span>])
        errors[theta]<span style="color: #666666">.</span>append(E)
</pre></div>
<p>


<ul>
 <p><li> Plot \( E \) versus \( \Delta t \) for \( \theta=0,0.5,1 \)</li>
</ul>

<p>

<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>
<span style="color: #408080; font-style: italic">#import scitools.std as plt</span>
plt<span style="color: #666666">.</span>loglog(errors[<span style="color: #BA2121">&#39;dt&#39;</span>], errors[<span style="color: #666666">0</span>], <span style="color: #BA2121">&#39;ro-&#39;</span>)
plt<span style="color: #666666">.</span>hold(<span style="color: #BA2121">&#39;on&#39;</span>)  <span style="color: #408080; font-style: italic"># MATLAB style...</span>
plt<span style="color: #666666">.</span>loglog(errors[<span style="color: #BA2121">&#39;dt&#39;</span>], errors[<span style="color: #666666">0.5</span>], <span style="color: #BA2121">&#39;b+-&#39;</span>)
plt<span style="color: #666666">.</span>loglog(errors[<span style="color: #BA2121">&#39;dt&#39;</span>], errors[<span style="color: #666666">1</span>], <span style="color: #BA2121">&#39;gx-&#39;</span>)
plt<span style="color: #666666">.</span>legend([<span style="color: #BA2121">&#39;FE&#39;</span>, <span style="color: #BA2121">&#39;CN&#39;</span>, <span style="color: #BA2121">&#39;BE&#39;</span>], loc<span style="color: #666666">=</span><span style="color: #BA2121">&#39;upper left&#39;</span>)
plt<span style="color: #666666">.</span>xlabel(<span style="color: #BA2121">&#39;log(time step)&#39;</span>)
plt<span style="color: #666666">.</span>ylabel(<span style="color: #BA2121">&#39;log(error)&#39;</span>)
plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&#39;Error vs time step&#39;</span>)
plt<span style="color: #666666">.</span>savefig(<span style="color: #BA2121">&#39;error_BE_CN_FE.png&#39;</span>)
</pre></div>
<p>
This is a log-log plot because we expect \( E\sim\Delta t^r \).

<p>

<center> <! -- figure -->
<hr class="figure">
<center><p class="caption">Figure 5:  Default plot (left) and manually adjusted plot (right). <a name="decay:exper:Evsdt"></a> </p></center>
<p><img src="fig-decay/error_plot_improvement.png" align="bottom" width=800,></p>
</center>

<p>

Complete program: <a href="http://github.hplgit.com/INF5620/src/decay/experiments/dc_exper1.py"><tt>experiments/dc_exper1.py</tt></a>.
Fine recipe for

<p>

<ul>
  <p><li> how to run other programs</li>
  <p><li> how to extract and interpret output from other programs</li>
  <p><li> how to automate many manual steps in creating simulations and figures</li>
</ul>

<h3>Making a report <a name="decay:exper:report"></a></h3>
<p>

<ul>
 <p><li> Scientific investigations are best documented in a report!</li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/sphinx-cloud/">A sample report</a></li>
 <p><li> How can we write such a report?</li>
 <p><li> First problem: what format should I write in?</li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report_html.html">Plain HTML</a>, generated by <a href="http://github.hplgit.com/INF5620/src/decay/experiments/dc_exper1_html.py"><tt>dc_exper1_html.py</tt></a></li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report_html_mathjax.html">HTML with MathJax</a>, generated by <a href="http://github.hplgit.com/INF5620/src/decay/experiments/dc_exper1_html.py"><tt>dc_exper1_mathjax.py</tt></a></li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report.pdf">LaTeX PDF</a>, based on <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report.tex.html">LaTeX source</a></li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/sphinx-cloud/index.html">Sphinx HTML</a>, based on <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report_sphinx.rst.html">reStructuredText</a></li>
 <p><li> Markdown, MediaWiki, ...</li>
 <p><li> <a href="http://code.google.com/p/doconce">Doconce</a> can generate LaTeX, HTML w/MathJax, Sphinx, Markdown, MediaWiki, ... (<a href="http://hplgit.github.com/INF5620/doc/writing_reports/report.do.txt.html">Doconce source</a> for the examples above, and Python program for <a href="http://github.hplgit.com/INF5620/src/decay/experiments/dc_exper1_do.py">generating the Doconce source</a>)</li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/">Examples on different report formats</a></li>
</ul>

<h3>Publishing a complete project <a name="decay:exper:github"></a></h3>
<p>

<ul>
 <p><li> Make folder (directory) tree</li>
 <p><li> Keep track of all files via a <em>version control system</em> (Mercurial, Git, ...)</li>
 <p><li> Publish as private or public repository</li>
 <p><li> Utilize Bitbucket, Googlecode, GitHub, or similar</li>
 <p><li> See the <a href="http://hplgit.github.com/teamods/bitgit/html/">intro to such tools</a></li>
</ul>

<h2>Model extensions  <a name="___sec47"></a></h2>
<p>

<h3>Extension to a variable coefficient  <a name="___sec48"></a></h3>
<p>
$$
\begin{equation}
u'(t) = -a(t)u(t),\quad t\in (0,T],\quad u(0)=I \thinspace .
\label{decay:problem:a}
\end{equation}
$$

<p>

The Forward Euler scheme:

<p>
$$
\begin{equation}
\frac{u^{n+1} - u^n}{\Delta t} = -a(t_n)u^n
\thinspace .
\end{equation}
$$

<p>
The Backward Euler scheme:
$$
\begin{equation}
\frac{u^{n} - u^{n-1}}{\Delta t} = -a(t_n)u^n
\thinspace .
\end{equation}
$$

<p>
The Crank-Nicolson scheme (evaluting \( a(t_{n+\frac{1}{2}}) \) and
using an average for \( u \)):
$$
\begin{equation}
\frac{u^{n+1} - u^{n}}{\Delta t} = -a(t_{n+\frac{1}{2}})\frac{1}{2}(u^n + u^{n+1})
\thinspace .
\end{equation}
$$

<p>
The Crank-Nicolson scheme (using
using an average for \( a \) and \( u \)):
$$
\begin{equation}
\frac{u^{n+1} - u^{n}}{\Delta t} = -\frac{1}{2}(a(t_n)u^n + a(t_{n+1})u^{n+1})
\thinspace .
\end{equation}
$$

<p>
The \( \theta \)-rule unifies the three mentioned schemes,

<p>
$$
\begin{equation}
\frac{u^{n+1} - u^{n}}{\Delta t} = -a((1-\theta)t_n + \theta t_{n+1})((1-\theta) u^n + \theta u^{n+1})
\thinspace .
\end{equation}
$$
or,
$$
\begin{equation}
\frac{u^{n+1} - u^{n}}{\Delta t} = -(1-\theta) a(t_n)u^n - \theta
a(t_{n+1})u^{n+1}
\thinspace .
\end{equation}
$$

<p>
Operator notation:

<p>
$$
\begin{align*}
\lbrack D^+_t u &= -au\rbrack^n,\\
\lbrack D^-_t u &= -au\rbrack^n,\\
\lbrack D_t u &= -a\overline{u}^t\rbrack^{n+\frac{1}{2}},\\
\lbrack D_t u &= -\overline{au}^t\rbrack^{n+\frac{1}{2}},\\
\lbrack D_t u &= -a\overline{u}^{t,\theta}\rbrack^{n+\theta},\\
\lbrack D_t u &= -\overline{au}^{t,\theta}\rbrack^{n+\theta}
\thinspace .
\end{align*}
$$

<p>


<h3>Extension to a source term <a name="decay:source"></a></h3>
<p>
$$
\begin{equation}
u'(t) = -a(t)u(t) + b(t),\quad t\in (0,T],\quad u(0)=I
\thinspace .
\label{decay:problem:ab}
\end{equation}
$$

<p>

<h4>Schemes  <a name="___sec50"></a></h4>
<p>
$$
\begin{align*}
\lbrack D^+_t u &= -au + b\rbrack^n,\\
\lbrack D^-_t u &= -au + b\rbrack^n,\\
\lbrack D_t u   &= -a\overline{u}^t + b\rbrack^{n+\frac{1}{2}},\\
\lbrack D_t u   &= \overline{-au+b}^t\rbrack^{n+\frac{1}{2}},\\
\lbrack D_t u   &= -a\overline{u}^{t,\theta} + b\rbrack^{n+\theta},\\
\lbrack D_t u   &= \overline{-au+b}^{t,\theta}\rbrack^{n+\theta}
\thinspace .
\end{align*}
$$

<p>

<h3>Implementation of the generalized model problem <a name="decay:general"></a></h3>
<p>
$$
\begin{equation}
u^{n+1} = ((1 - \Delta t(1-\theta)a^n)u^n
+ \Delta t(\theta b^{n+1} + (1-\theta)b^n))(1 + \Delta t\theta a^{n+1})^{-1}
\thinspace .
\end{equation}
$$

<p>

<h4>The Python code  <a name="___sec52"></a></h4>
<p>
Implementation where \( a(t) \) and \( b(t) \) are given as
Python functions (see file <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_vc.py"><tt>dc_vc.py</tt></a>):

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, a, b, T, dt, theta):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Solve u&#39;=-a(t)*u + b(t), u(0)=I,</span>
<span style="color: #BA2121; font-style: italic">    for t in (0,T] with steps of dt.</span>
<span style="color: #BA2121; font-style: italic">    a and b are Python functions of t.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    dt <span style="color: #666666">=</span> <span style="color: #008000">float</span>(dt)           <span style="color: #408080; font-style: italic"># avoid integer division</span>
    N <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #008000">round</span>(T<span style="color: #666666">/</span>dt))     <span style="color: #408080; font-style: italic"># no of time intervals</span>
    T <span style="color: #666666">=</span> N<span style="color: #666666">*</span>dt                 <span style="color: #408080; font-style: italic"># adjust T to fit time step dt</span>
    u <span style="color: #666666">=</span> zeros(N<span style="color: #666666">+1</span>)           <span style="color: #408080; font-style: italic"># array of u[n] values</span>
    t <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, N<span style="color: #666666">+1</span>)  <span style="color: #408080; font-style: italic"># time mesh</span>

    u[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> I                 <span style="color: #408080; font-style: italic"># assign initial condition</span>
    <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">0</span>, N):    <span style="color: #408080; font-style: italic"># n=0,1,...,N-1</span>
        u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> ((<span style="color: #666666">1</span> <span style="color: #666666">-</span> dt<span style="color: #666666">*</span>(<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a(t[n]))<span style="color: #666666">*</span>u[n] <span style="color: #666666">+</span> \ 
                  dt<span style="color: #666666">*</span>(theta<span style="color: #666666">*</span>b(t[n<span style="color: #666666">+1</span>]) <span style="color: #666666">+</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>b(t[n])))<span style="color: #666666">/</span>\ 
                  (<span style="color: #666666">1</span> <span style="color: #666666">+</span> dt<span style="color: #666666">*</span>theta<span style="color: #666666">*</span>a(t[n<span style="color: #666666">+1</span>]))
    <span style="color: #008000; font-weight: bold">return</span> u, t
</pre></div>
<p>


<h4>Implementations of variable coefficients  <a name="___sec53"></a></h4>
<p>
Plain functions:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">a</span>(t):
    <span style="color: #008000; font-weight: bold">return</span> a_0 <span style="color: #008000; font-weight: bold">if</span> t <span style="color: #666666">&lt;</span> tp <span style="color: #008000; font-weight: bold">else</span> k<span style="color: #666666">*</span>a_0

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">b</span>(t):
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">1</span>
</pre></div>
<p>

Better implementation: class with the parameters <tt>a0</tt>, <tt>tp</tt>, and <tt>k</tt>
as attributes and a <em>special method</em> <tt>__call__</tt> for evaluating \( a(t) \):

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">A</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, a0<span style="color: #666666">=1</span>, k<span style="color: #666666">=2</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>a0, <span style="color: #008000">self</span><span style="color: #666666">.</span>k <span style="color: #666666">=</span> a0, k

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__call__</span>(<span style="color: #008000">self</span>, t):
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>a0 <span style="color: #008000; font-weight: bold">if</span> t <span style="color: #666666">&lt;</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>tp <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>k<span style="color: #666666">*</span><span style="color: #008000">self</span><span style="color: #666666">.</span>a0

a <span style="color: #666666">=</span> A(a0<span style="color: #666666">=2</span>, k<span style="color: #666666">=1</span>)  <span style="color: #408080; font-style: italic"># a behaves as a function a(t)</span>
</pre></div>
<p>

Use one-liner <em>lambda function</em>:
<p>

<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">a <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">lambda</span> t: a_0 <span style="color: #008000; font-weight: bold">if</span> t <span style="color: #666666">&lt;</span> tp <span style="color: #008000; font-weight: bold">else</span> k<span style="color: #666666">*</span>a_0
</pre></div>
<p>
In general,
<p>

<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">f <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">lambda</span> arg1, arg2, <span style="color: #666666">...</span>: expressin
</pre></div>
<p>
is equivalent to
<p>

<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">f</span>(arg1, arg2, <span style="color: #666666">...</span>):
    <span style="color: #008000; font-weight: bold">return</span> expression
</pre></div>
<p>

One can use lambda functions directly in calls:
<p>

<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">u, t <span style="color: #666666">=</span> solver(<span style="color: #666666">1</span>, <span style="color: #008000; font-weight: bold">lambda</span> t: <span style="color: #666666">1</span>, <span style="color: #008000; font-weight: bold">lambda</span> t: <span style="color: #666666">1</span>, T, dt, theta)
</pre></div>
<p>
for a problem \( u'=-u+1 \), \( u(0)=1 \).

<p>
A lambda function can appear anywhere where a variable can appear.

<p>

<h3>Verification via trivial solutions <a name="decay:verify:trivial"></a></h3>
<p>

<ul>
 <p><li> Start debugging of a new code with trying a problem
   where \( u=\hbox{const} \neq 0 \).</li>
 <p><li> Choose \( u=C \) (a constant). Choose any \( a(t) \) and set
   \( b=a(t)C \) and
   \( I=C \).</li>
 <p><li> "All" numerical methods will reproduce \( u=_{\hbox{const}} \)
   exactly (machine precision).</li>
 <p><li> Often \( u=C \) eases debugging.</li>
 <p><li> In this example: <em>any error</em> in the formula for \( u^{n+1} \)
   make \( u\neq C \)!</li>
</ul>

Verification function as a nose test:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">nose.tools</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">nt</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_constant_solution</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Test problem where u=u_const is the exact solution, to be</span>
<span style="color: #BA2121; font-style: italic">    reproduced (to machine precision) by any relevant method.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(t):
        <span style="color: #008000; font-weight: bold">return</span> u_const

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">a</span>(t):
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">2.5*</span>(<span style="color: #666666">1+</span>t<span style="color: #666666">**3</span>)  <span style="color: #408080; font-style: italic"># can be arbitrary</span>

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">b</span>(t):
        <span style="color: #008000; font-weight: bold">return</span> a(t)<span style="color: #666666">*</span>u_const

    u_const <span style="color: #666666">=</span> <span style="color: #666666">2.15</span>
    theta <span style="color: #666666">=</span> <span style="color: #666666">0.4</span>; I <span style="color: #666666">=</span> u_const; dt <span style="color: #666666">=</span> <span style="color: #666666">4</span>
    N <span style="color: #666666">=</span> <span style="color: #666666">4</span>  <span style="color: #408080; font-style: italic"># enough with a few steps</span>
    u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, b<span style="color: #666666">=</span>b, T<span style="color: #666666">=</span>N<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)
    <span style="color: #008000; font-weight: bold">print</span> u
    u_e <span style="color: #666666">=</span> exact_solution(t)
    difference <span style="color: #666666">=</span> <span style="color: #008000">abs</span>(u_e <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()  <span style="color: #408080; font-style: italic"># max deviation</span>
    nt<span style="color: #666666">.</span>assert_almost_equal(difference, <span style="color: #666666">0</span>, places<span style="color: #666666">=14</span>)
</pre></div>
<p>


<h3>Verification via manufactured solutions <a name="decay:MMS"></a></h3>
<p>


<ul>
 <p><li> Choose <em>any</em> formula for \( u(t) \).</li>
 <p><li> Fit I, \( a(t) \), and \( b(t) \) in \( u'=-au+b \), \( u(0)=I \),
   to make the chosen formula a solution of the ODE problem.</li>
 <p><li> Then we can always have an analytical solution (!).</li>
 <p><li> Ideal for verification: testing convergence rates.</li>
 <p><li> Called the <em>method of manufactured solutions</em> (MMS)</li>
 <p><li> Special case: \( u \) linear in \( t \), because all sound numerical
   methods will reproduce a linear \( u \) exactly (machine precision).</li>
 <p><li> \( u(t) = ct + d \). \( u(0)=0 \) means \( d=I \).</li>
 <p><li> ODE implies \( c = -a(t)u + b(t) \).</li>
 <p><li> Choose \( a(t) \) and \( c \), and set \( b(t) = c + a(t)(ct + I) \).</li>
 <p><li> Any error in the formula for \( u^{n+1} \) makes \( u\neq ct+I \)!</li>
</ul>

We can easily show that a linear \( u^n = ct_n+I \) fulfills the discrete
equations for the Forward Euler, Backward Euler, and Crank-Nicolson
schemes. First,

<p>
$$
\begin{align}
\lbrack D_t^+ t\rbrack^n = \frac{t_{n+1}-t_n}{\Delta t}=\frac{(n+1)\Delta t - n\Delta t}{\Delta t}=1,\label{decay:fd2:Dop:tn:fw}\\
\lbrack D_t^- t\rbrack^n = \frac{t_{n}-t_{n-1}}{\Delta t}=\frac{n\Delta t - (n-1)\Delta t}{\Delta t}=1,\label{decay:fd2:Dop:tn:bw}\\
\lbrack D_t t\rbrack^n = \frac{t_{n+\frac{1}{2}}-t_{n-\frac{1}{2}}{\Delta t}=\frac{(n+\frac{1}{2})\Delta t - (n-\frac{1}{2})\Delta t}{\Delta t}=1\label{decay:fd2:Dop:tn:cn}
\thinspace .
\end{align}
$$
The difference equation for the Forward Euler scheme

<p>
$$ [D_^+ u = -au + b]^n, $$
with \( a^n=a(t_n) \), \( b^n=c + a(t_n)(ct_n + I) \), and \( u^n=ct_n + I \)
then results in

<p>
$$ c = -a(t_n)(ct_n+I) + c + a(t_n)(ct_n + I) = c $$

<p>
Verification function as a nose test:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_linear_solution</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Test problem where u=c*t+I is the exact solution, to be</span>
<span style="color: #BA2121; font-style: italic">    reproduced (to machine precision) by any relevant method.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(t):
        <span style="color: #008000; font-weight: bold">return</span> c<span style="color: #666666">*</span>t <span style="color: #666666">+</span> I

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">a</span>(t):
        <span style="color: #008000; font-weight: bold">return</span> t<span style="color: #666666">**0.5</span>  <span style="color: #408080; font-style: italic"># can be arbitrary</span>

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">b</span>(t):
        <span style="color: #008000; font-weight: bold">return</span> c <span style="color: #666666">+</span> a(t)<span style="color: #666666">*</span>exact_solution(t)

    theta <span style="color: #666666">=</span> <span style="color: #666666">0.4</span>; I <span style="color: #666666">=</span> <span style="color: #666666">0.1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">0.1</span>; c <span style="color: #666666">=</span> <span style="color: #666666">-0.5</span>
    T <span style="color: #666666">=</span> <span style="color: #666666">4</span>
    N <span style="color: #666666">=</span> <span style="color: #008000">int</span>(T<span style="color: #666666">/</span>dt)  <span style="color: #408080; font-style: italic"># no of steps</span>
    u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, b<span style="color: #666666">=</span>b, T<span style="color: #666666">=</span>N<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)
    u_e <span style="color: #666666">=</span> exact_solution(t)
    difference <span style="color: #666666">=</span> <span style="color: #008000">abs</span>(u_e <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()  <span style="color: #408080; font-style: italic"># max deviation</span>
    <span style="color: #008000; font-weight: bold">print</span> difference
    <span style="color: #408080; font-style: italic"># No of decimal places for comparison depend on size of c</span>
    nt<span style="color: #666666">.</span>assert_almost_equal(difference, <span style="color: #666666">0</span>, places<span style="color: #666666">=14</span>)
</pre></div>
<p>


<h3>Extension to systems of ODEs  <a name="___sec56"></a></h3>
<p>
Sample system:

<p>
$$
\begin{align}
u' &= -a_u u + a_vv,\\
v' &= -a_vv + a_uu,
\end{align}
$$
for constants \( a_u, a_v>0 \).

<p>
The Forward Euler method:

<p>
$$
\begin{align}
u^{n+1} &= u^n + \Delta t (-a_u u^n + a_vv^n),\\
v^{n+1} &= u^n + \Delta t (-a_vv^n + a_uu^n)
\thinspace .
\end{align}
$$

<p>
The Backward Euler scheme:
$$
\begin{align}
u^{n+1} &= u^n + \Delta t (-a_u u^{n+1} + a_vv^{n+1}),\\
v^{n+1} &= v^n + \Delta t (-a_vv^{n+1} + a_uu^{n+1}),
\thinspace .
\end{align}
$$
which is a \( 2\times 2 \) linear system:
in
$$
\begin{align}
(1 + \Delta t a_u)u^{n+1} + a_vv^{n+1}) &= u^n ,\\
a_uu^{n+1} + (1 + \Delta t a_v) v^{n+1} &= v^n
\thinspace .
\end{align}
$$

<p>


<h2>General first-order ODEs  <a name="___sec57"></a></h2>
<p>

<h3>Generic form  <a name="___sec58"></a></h3>
<p>
The standard form for ODEs:
$$
\begin{equation}
u' = f(u,t),\quad u(0)=I,
\label{decay:ode:general}
\end{equation}
$$

<p>
\( u \) and \( f \): scalar or vector.

<p>
Vectors in case of ODE systems:
$$ u(t) = (u^{(0)}(t),u^{(1)}(t),\ldots,u^{(m-1)}(t)) \thinspace . $$

<p>
$$
\begin{align*}
f(u, t) = ( & f^{(0)}(u^{(0)}(t),\ldots,u^{(m-1)}(t)),\\
            & f^{(1)}(u^{(0)}(t),\ldots,u^{(m-1)}(t)),\\
            & \vdots\\
            & f^{(m-1)}(u^{(0)}(t),\ldots,u^{(m-1)}(t)))
\thinspace .
\end{align*}
$$

<p>
Higher-order ODEs are most often expressed as first-order systems.

<p>

<h3>The Odespy software  <a name="___sec59"></a></h3>
<p>
<a href="https://github.com/hplgit/odespy">Odespy</a>
features simple Python implementations of the most fundamental
schemes as well as Python interfaces to several famous packages for
solving ODEs: <a href="https://computation.llnl.gov/casc/odepack/odepack_home.html">ODEPACK</a>,
<a href="https://computation.llnl.gov/casc/odepack/odepack_home.html">Vode</a>,
<a href="http://www.netlib.org/ode/rkc.f">rkc.f</a>,
<a href="http://www.netlib.org/ode/rkf45.f">rkf45.f</a>,
<a href="http://www.unige.ch/~hairer/software.html">Radau5</a>, as well
as the ODE solvers in
<a href="http://docs.scipy.org/doc/scipy/reference/generated/scipy.integrate.ode.html">SciPy</a>,
<a href="http://docs.sympy.org/dev/modules/mpmath/calculus/odes.html">SymPy</a>, and
<a href="http://olivierverdier.github.com/odelab/">odelab</a>.

<p>
Typical usage:

<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">def f(u, t):
    return -a*u

import odespy
import numpy as np

I = 1; a = 2; T = 6; dt = 1

solver = odespy.RK4(f)
solver.set_initial_condition(I)

t_mesh = np.linspace(0, T, N+1)

u, t = solver.solve(t_mesh)
</pre></div>
<p>


<h3>Example: Runge-Kutta methods   <a name="___sec60"></a></h3>
<p>


<!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">solvers <span style="color: #666666">=</span> [odespy<span style="color: #666666">.</span>RK2(f),
           odespy<span style="color: #666666">.</span>RK3(f),
           odespy<span style="color: #666666">.</span>RK4(f),
           odespy<span style="color: #666666">.</span>BackwardEuler(f, nonlinear_solver<span style="color: #666666">=</span><span style="color: #BA2121">&#39;Newton&#39;</span>)]

<span style="color: #008000; font-weight: bold">for</span> solver <span style="color: #AA22FF; font-weight: bold">in</span> solvers:
    solver<span style="color: #666666">.</span>set_initial_condition(I)
    u, t <span style="color: #666666">=</span> solver<span style="color: #666666">.</span>solve(t)

<span style="color: #408080; font-style: italic"># + lots of plot code...</span>
</pre></div>
<p>

<center> <! -- figure -->
<hr class="figure">
<center><p class="caption">Figure 6:  Behavior of different schemes for the decay equation. <a name="decay:odespy:fig1"></a> </p></center>
<p><img src="fig-decay/decay_odespy1_png.png" align="bottom" width=800></p>
</center>

<p>

The 4-th order Runge-Kutta method (<tt>RK4</tt>) is the method of choice!

<p>


<h3>Example: Adaptive Runge-Kutta methods   <a name="___sec61"></a></h3>
<p>

<ul>
 <p><li> Adaptive methods find "optimal" locations of the mesh points
   to ensure that the error is less than a given tolerance.</li>
 <p><li> Downside: approximate error estimation, not always optimal
   location of points.</li>
 <p><li> "Industry standard ODE solver": Dormand-Prince 4/5-th order
   Runge-Kutta (MATLAB's famous <tt>ode45</tt>).</li>
</ul>

<center> <! -- figure -->
<hr class="figure">
<center><p class="caption">Figure 7:  Choice of adaptive time mesh by the Dormand-Prince method for difference tolerances. <a name="decay:odespy:fig2"></a> </p></center>
<p><img src="fig-decay/decay_DormandPrince_adaptivity.png" align="bottom" width=800></p>
</center>

<p>



<h3>Other schemes  <a name="___sec62"></a></h3>
<p>


<h4>Implicit 2-step backward scheme  <a name="___sec63"></a></h4>
<p>
$$ u'(t_{n+1}) \approx \frac{3u^{n+1} - 4u^{n} + u^{n-1}}{2\Delta t},$$

<p>
Scheme:
$$ u^{n+1} = \frac{4}{3}u^n - \frac{1}{3}u^{n-1} +
\frac{2}{3}\Delta t f(u^{n+1}, t_{n+1})
\thinspace .
\label{decay:fd2:bw:2step}
$$

<p>


<h4>The Leapfrog scheme  <a name="___sec64"></a></h4>
<p>
$$
\begin{equation}
u'(t_n)\approx \frac{u^{n+1}-u^{n-1}}{2\Delta t} = [D_{2t} u]^n,
\end{equation}
$$

<p>
Scheme:

<p>
$$ [D_{2t} u = -a + b]^n,$$
or, if we write out and solve for the unknown \( u^{n+1} \),
$$
\begin{equation}
u^{n+1} = u^{n-1} + \Delta t f(u^n, t_n)
\thinspace .
\label{decay:fd2:leapfrog}
\end{equation}
$$

<p>

<ul>
 <p><li> Some other scheme must be used as starter (\( u^1 \)).</li>
 <p><li> Leapfrog is an explicit scheme - a nonlinear \( f \) (in \( u \)) is trivial
   to handle.</li>
 <p><li> Leapfrog is unstable after some time.</li>
</ul>

<h4>The filtered Leapfrog scheme  <a name="___sec65"></a></h4>
<p>
After computing \( u^{n+1} \), stabilize Leapfrog by
$$
\begin{equation}
u^n\ \leftarrow\ u^n + \gamma (u^{n-1} - 2u^n + u^{n+1})
\label{decay:fd2:leapfrog:filtered}
\thinspace .
\end{equation}
$$

<p>


<h4>2nd-order Runge-Kutta scheme  <a name="___sec66"></a></h4>
<p>
Forward-Euler + approximate Crank-Nicolson:
$$
\begin{align}
u^* &= u^n + \Delta t f(u^n, t_n),
\label{decay:fd2:RK2:s1}\\
u^{n+1} &= u^n + \Delta t \frac{1}{2} \left( f(u^n, t_n) + f(u^*, t_{n+1})
\right),
\label{decay:fd2:RK2:s2}
\end{align}
$$

<p>


<h4>2nd-order Adams-Bashforth scheme  <a name="___sec67"></a></h4>
<p>
$$
\begin{equation}
u^{n+1} = u^n + \frac{1}{2}\Delta t\left( 3f(u^n, t_n) - f(u^{n-1}, t_{n-1})
\right)
\thinspace .
\label{decay:fd2:AB2}
\end{equation}
$$

<p>


<h4>3rd-order Adams-Bashforth scheme  <a name="___sec68"></a></h4>
<p>
$$
\begin{equation}
u^{n+1} = u^n + \frac{1}{12}\left( 23f(u^n, t_n) - 16 f(u^{n-1},t_{n-1})
+ 5f(u^{n-2}, t_{n-2})\right)
\thinspace .
\label{decay:fd2:AB3}
\end{equation}
$$

<!-- ------------------- end of main content ----------------->
</body>
</html>
    

