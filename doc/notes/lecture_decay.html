<?xml version="1.0" encoding="utf-8" ?>
<!--
Automatically generated HTML file from Doconce source
(http://code.google.com/p/doconce/)
-->

<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Doconce: http://code.google.com/p/doconce/" />

<!--
Color definitions:  http://www.december.com/html/spec/color0.html
CSS examples:       http://www.w3schools.com/css/css_examples.asp
-->

<style type="text/css">
    body {
      margin-top: 1.0em;
      background-color: #ffffff;
      font-family: Helvetica, Arial, FreeSans, san-serif;
      color: #000000;
    }
    h1 { font-size: 1.8em; color: #1e36ce; }
    h2 { font-size: 1.5em; color: #1e36ce; }
    h3 { color: #1e36ce; }
    a { color: #1e36ce; text-decoration:none; }
    tt { font-family: "Courier New", Courier; }
    pre { background: #ededed; color: #000; padding: 15px;}
    p { text-indent: 0px; }
    hr { border: 0; width: 80%; border-bottom: 1px solid #aaa}
    p.caption { width: 80%; font-style: normal; text-align: left; }
    hr.figure { border: 0; width: 80%; border-bottom: 1px solid #aaa}

</style>

<!-- Use MathJax to render mathematics -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
     equationNumbers: {  autoNumber: "AMS"  },
     extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js"]
  }
});
</script>
<script type="text/javascript"
 src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- Fix slow MathJax rendering in IE8 -->
<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7">

</head>

<body>
    
<!-- newcommands_keep.tex -->
$$
\newcommand{\uex}{u_{\small\mbox{e}}}
\newcommand{\Aex}{A_{\small\mbox{e}}}
\newcommand{\half}{\frac{1}{2}}
$$



<!-- ------------------- main content ------------------------>

<title>INF5620 Lecture: Exponential Decay</title>

<center><h1>INF5620 Lecture: Exponential Decay</h1></center>  <! -- document title -->

<center><h4>Sep 6, 2012</h4></center> <!-- date -->
<p>

<p>

<h2>Implementation  <a name="___sec0"></a></h2>
<p>
We address the differential equation problem
$$
u'(t) = -au(t),\quad t\in (0,T], \quad u(0)=I,
$$
where \( a>0 \) is a given constant.

<p>
The problem is solved by the numerical method

<p>
$$
u^{n+1} = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a\Delta t}u^n,
$$
for \( \theta\in [0,1] \). The classical Forward Euler, Backward Euler, and
Crank-Nicolson (midpoint) schemes are recovered through \( \theta=0,1,0.5 \) (resp.)

<p>
Tasks: Make a program that

<p>

<ul>
  <p><li> computes \( u^n \), \( n=1,2,\ldots,N \)
  <p><li> displays the numerical and exact solution
  <p><li> brings evidence to a correct implementation (<em>verification</em>)
  <p><li> compares the numerical and the exact solution in a plot
  <p><li> computes the error \( \uex (t_n) - u^n \)
  <p><li> computes the convergence rate of the numerical scheme
  <p><li> reads its input data from the command line
</ul>

Tools to learn:

<p>

<ul>
  <p><li> Basic <a href="http://python.org">Python</a> programming
  <p><li> Array computing with <a href="http://numpy.org/"><tt>numpy</tt></a>
  <p><li> Plotting with <a href="http://matplotlib.sourceforge.net/"><tt>matplotlib.pyplot</tt></a>
  <p><li> Plotting through <a href="http://code.google.com/p/scitools/"><tt>scitools</tt></a>
  <p><li> File writing and reading
  <p><li> Making command-line user interface via <tt>argparse.ArgumentParser</tt>
</ul>

All programs are in the directory
<a href="https://github.com/hplgit/INF5620/tree/gh-pages/src/decay"><tt>src/decay</tt></a>.

<p>

<h4>Implementation in Python  <a name="___sec1"></a></h4>
<p>
Why Python?

<p>

<ul>
  <p><li> Python has a very clean, readable syntax (often known as
    "executable pseudo-code").
  <p><li> Python code is very similar to MATLAB code (and MATLAB has a
    particularly widespread use for scientific computing).
  <p><li> Python is similar to, but much simpler to work with and
    results in more reliable code than C++.
  <p><li> Python is a full-fledged, very powerful programming language.
  <p><li> Python has a rich set of modules for scientific computing, and its
    popularity in scientific computing is rapidly growing.
  <p><li> Python was made for being combined with compiled languages
    (C, C++, Fortran) to reuse existing numerical software and to
    reach high computational performance of new implementations.
  <p><li> Python has extensive support for administrative task
    needed when doing large-scale computational investigations.
  <p><li> Python has extensive support for graphics (visualization,
    user interfaces, web applications).
  <p><li> FEniCS, a very powerful tool for solving PDEs by
    the finite element method, is most human-efficient to operate
    from Python.
</ul>

<h3>Making a program <a name="decay:py1"></a></h3>
<p>

<p>

<ul>
 <p><li> Store \( u^n \), \( n=0,1,\ldots,N \) in an array <tt>u</tt>.
 <p><li> Algorithm:

<ol>
  <p><li> initialize \( u^0 \)
  <p><li> for \( t=t_n \), \( n=1,2,\ldots,N \): compute \( u_n \) using
     the \( \theta \)-rule formula
</ol>

</ul>

<h4>Function for computing the numerical solution  <a name="___sec3"></a></h4>
<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #666666">*</span>

<span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">solver</span>(I, a, T, dt, theta):
    <span style="color: #BB4444; font-style: italic">&quot;&quot;&quot;Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.&quot;&quot;&quot;</span>
    N <span style="color: #666666">=</span> <span style="color: #AA22FF">int</span>(T<span style="color: #666666">/</span>dt)            <span style="color: #008800; font-style: italic"># no of time intervals</span>
    T <span style="color: #666666">=</span> N<span style="color: #666666">*</span>dt                 <span style="color: #008800; font-style: italic"># adjust T to fit time step dt</span>
    u <span style="color: #666666">=</span> zeros(N<span style="color: #666666">+1</span>)           <span style="color: #008800; font-style: italic"># array of u[n] values</span>
    t <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, N<span style="color: #666666">+1</span>)  <span style="color: #008800; font-style: italic"># time mesh</span>

    u[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> I                 <span style="color: #008800; font-style: italic"># assign initial condition</span>
    <span style="color: #AA22FF; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #AA22FF">range</span>(<span style="color: #666666">0</span>, N):    <span style="color: #008800; font-style: italic"># n=0,1,...,N-1</span>
        u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)<span style="color: #666666">*</span>u[n]
    <span style="color: #AA22FF; font-weight: bold">return</span> u, t
</pre></div>
<p>

<p>
Note about the <tt>for</tt> loop: <tt>range(0, N, s)</tt> generates all integers
from <tt>0</tt> to <tt>N</tt> in steps of <tt>s</tt> (default 1), <em>but not including</em> <tt>N</tt> (!).

<p>
Sample call:
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=1</span>, a<span style="color: #666666">=2</span>, T<span style="color: #666666">=8</span>, dt<span style="color: #666666">=0.8</span>, theta<span style="color: #666666">=1</span>)
</pre></div>
<p>

<p>

<h4>Integer division  <a name="___sec4"></a></h4>
<p>
Python applies integer division: <tt>1/2</tt> is 0, <tt>1./2</tt> or <tt>1.0/2</tt> or
<tt>1/2.</tt> or <tt>1/2.0</tt> or <tt>1.0/2.0</tt> gives 0.5.

<p>
A safer <tt>solver</tt> function:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #666666">*</span>

<span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">solver</span>(I, a, T, dt, theta):
    <span style="color: #BB4444; font-style: italic">&quot;&quot;&quot;Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.&quot;&quot;&quot;</span>
    dt <span style="color: #666666">=</span> <span style="color: #AA22FF">float</span>(dt)           <span style="color: #008800; font-style: italic"># avoid integer division</span>
    N <span style="color: #666666">=</span> <span style="color: #AA22FF">int</span>(<span style="color: #AA22FF">round</span>(T<span style="color: #666666">/</span>dt))     <span style="color: #008800; font-style: italic"># no of time intervals</span>
    T <span style="color: #666666">=</span> N<span style="color: #666666">*</span>dt                 <span style="color: #008800; font-style: italic"># adjust T to fit time step dt</span>
    u <span style="color: #666666">=</span> zeros(N<span style="color: #666666">+1</span>)           <span style="color: #008800; font-style: italic"># array of u[n] values</span>
    t <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, N<span style="color: #666666">+1</span>)  <span style="color: #008800; font-style: italic"># time mesh</span>

    u[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> I                 <span style="color: #008800; font-style: italic"># assign initial condition</span>
    <span style="color: #AA22FF; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #AA22FF">range</span>(<span style="color: #666666">0</span>, N):    <span style="color: #008800; font-style: italic"># n=0,1,...,N-1</span>
        u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)<span style="color: #666666">*</span>u[n]
    <span style="color: #AA22FF; font-weight: bold">return</span> u, t
</pre></div>
<p>

<p>

<p>

<h4>Doc strings  <a name="___sec5"></a></h4>
<p>

<ul>
 <p><li> First string after the function heading
 <p><li> Used for documentation the function
 <p><li> Automatic documentation tools can make fancy manuals
 <p><li> Can be used for automatic testing
</ul>

<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">solver</span>(I, a, T, dt, theta):
    <span style="color: #BB4444; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BB4444; font-style: italic">    Solve</span>

<span style="color: #BB4444; font-style: italic">        u&#39;(t) = -a*u(t),</span>

<span style="color: #BB4444; font-style: italic">    with initial condition u(0)=I, for t in the time interval</span>
<span style="color: #BB4444; font-style: italic">    (0,T]. The time interval is divided into time steps of</span>
<span style="color: #BB4444; font-style: italic">    length dt.</span>

<span style="color: #BB4444; font-style: italic">    theta=1 corresponds to the Backward Euler scheme, theta=0</span>
<span style="color: #BB4444; font-style: italic">    to the Forward Euler scheme, and theta=0.5 to the Crank-</span>
<span style="color: #BB4444; font-style: italic">    Nicolson method.</span>
<span style="color: #BB4444; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #666666">...</span>
</pre></div>
<p>

<p>

<h4>Formatting of numbers  <a name="___sec6"></a></h4>
<p>
Can control formatting of reals and integers through the <em>printf</em> format:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">print</span> <span style="color: #BB4444">&#39;t=</span><span style="color: #BB6688; font-weight: bold">%6.3f</span><span style="color: #BB4444"> u=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BB4444">&#39;</span> <span style="color: #666666">%</span> (t[i], u[i])
</pre></div>
<p>

<p>
Or the alternative <em>format string syntax</em>:
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">print</span> <span style="color: #BB4444">&#39;t={t:6.3f} u={u:g}&#39;</span><span style="color: #666666">.</span>format(t<span style="color: #666666">=</span>t[i], u<span style="color: #666666">=</span>u[i])
</pre></div>
<p>

<p>

<h4>Running the program  <a name="___sec7"></a></h4>
<p>
Complete program file: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_v1.py"><tt>dc_v1.py</tt></a>.

<p>
How to run the program:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python dc_v1.py
</pre></div>
<p>

<p>
Can also run it as "normal" Unix programs: <tt>./programname</tt>:

<p>

<ol>
 <p><li> Insert first line <tt>#!/usr/bin/env python</tt> (program to interpret the file)
 <p><li> Run <tt>chmod a+rx dc_v1.py</tt>
</ol>

Now, this works:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; ./dc_v1.py
</pre></div>
<p>

<p>

<h3>Verifying the implementation  <a name="___sec8"></a></h3>
<p>

<ul>
 <p><li> Verification = bring evidence that the program works
 <p><li> Find suitable test problems
 <p><li> Make function for each test problem
 <p><li> Later: put the verification tests in a professional testing framework
</ul>

<h4>Simplest method: run a few algorithmic steps by hand  <a name="___sec9"></a></h4>
<p>
Use a calculator:

<p>
$$ A\equiv \frac{1 - (1-\theta) a\Delta t}{1 + \theta a \Delta t} = 0.298245614035$$
$$
\begin{align*}
u^1 &= AI=0.0298245614035,\\
u^2 &= Au^1= 0.00889504462912,\\
u^3 &=Au^2= 0.00265290804728
\end{align*}
$$

<p>
Compare hand-calculated numbers with those from <tt>solver</tt>:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">verify_three_steps</span>():
    <span style="color: #BB4444; font-style: italic">&quot;&quot;&quot;Compare three steps with known manual computations.&quot;&quot;&quot;</span>
    theta <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>; a <span style="color: #666666">=</span> <span style="color: #666666">2</span>; I <span style="color: #666666">=</span> <span style="color: #666666">0.1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>
    u_by_hand <span style="color: #666666">=</span> array([I,
                       <span style="color: #666666">0.0298245614035</span>,
                       <span style="color: #666666">0.00889504462912</span>,
                       <span style="color: #666666">0.00265290804728</span>])

    N <span style="color: #666666">=</span> <span style="color: #666666">3</span>  <span style="color: #008800; font-style: italic"># number of time steps</span>
    u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, T<span style="color: #666666">=</span>N<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)

    tol <span style="color: #666666">=</span> <span style="color: #666666">1E-15</span>  <span style="color: #008800; font-style: italic"># tolerance for comparing floats</span>
    difference <span style="color: #666666">=</span> <span style="color: #AA22FF">abs</span>(u <span style="color: #666666">-</span> u_by_hand)<span style="color: #666666">.</span>max()
    success <span style="color: #666666">=</span> difference <span style="color: #666666">&lt;=</span> tol
    <span style="color: #AA22FF; font-weight: bold">return</span> success
</pre></div>
<p>

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">main</span>():
    u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=1</span>, a<span style="color: #666666">=2</span>, T<span style="color: #666666">=8</span>, dt<span style="color: #666666">=0.8</span>, theta<span style="color: #666666">=1</span>)
    <span style="color: #008800; font-style: italic"># Write out a table of t and u values:</span>
    <span style="color: #AA22FF; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #AA22FF">range</span>(<span style="color: #AA22FF">len</span>(t)):
        <span style="color: #AA22FF; font-weight: bold">print</span> <span style="color: #BB4444">&#39;t=</span><span style="color: #BB6688; font-weight: bold">%6.3f</span><span style="color: #BB4444"> u=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BB4444">&#39;</span> <span style="color: #666666">%</span> (t[i], u[i])
        <span style="color: #008800; font-style: italic"># or print &#39;t={t:6.3f} u={u:g}&#39;.format(t=t[i], u=u[i])</span>
</pre></div>
<p>

<p>
Force the verification to be done before a real computation:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">if</span> verify_three_steps():
    main()
<span style="color: #AA22FF; font-weight: bold">else</span>:
    <span style="color: #AA22FF; font-weight: bold">print</span> <span style="color: #BB4444">&#39;Bug in the implementation!&#39;</span>
</pre></div>
<p>

<p>
Complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_verf1.py"><tt>dc_verf1.py</tt></a>.

<p>

<h4>Comparison with an exact discrete solution  <a name="___sec10"></a></h4>
<p>

<ul>
 <p><li> Better verification: comparison of \( u^n \) from <tt>solver</tt>
   with a closed-form <em>exact discrete solution</em> (if possible)
</ul>

Define
$$ A = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a \Delta t}\thinspace . $$
Repeated use of the \( \theta \)-rule:
$$
\begin{align*}
u^0 &= I,\\
u^1 &= Au^0 = AI,\\
u^2 &= Au^1 = A^2I,\\
&\vdots\\
u^n &= A^nu^{n-1} = A^nI \thinspace .
\end{align*}
$$

<p>
The exact discrete solution as
$$
\begin{equation}
u^n = IA^n
\label{decay:un:exact}
\thinspace .
\end{equation}
$$

<p>
Implementation:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">verify_exact_discrete_solution</span>():

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">exact_discrete_solution</span>(n, I, a, theta, dt):
        factor <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)
        <span style="color: #AA22FF; font-weight: bold">return</span> I<span style="color: #666666">*</span>factor<span style="color: #666666">**</span>n

    theta <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>; a <span style="color: #666666">=</span> <span style="color: #666666">2</span>; I <span style="color: #666666">=</span> <span style="color: #666666">0.1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>
    N <span style="color: #666666">=</span> <span style="color: #AA22FF">int</span>(<span style="color: #666666">8/</span>dt)  <span style="color: #008800; font-style: italic"># no of steps</span>
    u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, T<span style="color: #666666">=</span>N<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)
    u_de <span style="color: #666666">=</span> array([exact_discrete_solution(n, I, a, theta, dt)
                  <span style="color: #AA22FF; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #AA22FF">range</span>(N<span style="color: #666666">+1</span>)])
    difference <span style="color: #666666">=</span> <span style="color: #AA22FF">abs</span>(u_de <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()  <span style="color: #008800; font-style: italic"># max deviation</span>
    tol <span style="color: #666666">=</span> <span style="color: #666666">1E-15</span>  <span style="color: #008800; font-style: italic"># tolerance for comparing floats</span>
    success <span style="color: #666666">=</span> difference <span style="color: #666666">&lt;=</span> tol
    <span style="color: #AA22FF; font-weight: bold">return</span> success
</pre></div>
<p>

<p>
The complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_verf2.py"><tt>dc_verf2.py</tt></a>.

<p>

<p>

<h3>Computing the numerical error <a name="decay:computing:error"></a></h3>
<p>

<p>
Task: compute exact minus numerical solution, \( \uex(t_n) - u^n \)

<p>
Exact solution: \( \uex(t)=Ie^{-at} \), implemented as

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">exact_solution</span>(t, I, a):
    <span style="color: #AA22FF; font-weight: bold">return</span> I<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>
<p>

<p>
Compute

<p>
$$
\begin{equation}
e_n = \uex(t_n) - u^n,\quad n=0,1,\ldots,N \thinspace .
\end{equation}
$$

<p>
by

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">u, t <span style="color: #666666">=</span> solver(I, a, T, dt, theta)  <span style="color: #008800; font-style: italic"># Numerical solution</span>
u_e <span style="color: #666666">=</span> exact_solution(t, I, a)
e <span style="color: #666666">=</span> u_e <span style="color: #666666">-</span> u
</pre></div>
<p>

<p>
Note: array arithmetics - we compute on entire arrays

<p>

<ul>
 <p><li> Array <tt>e</tt> is the problem's discrete <em>error function</em>
 <p><li> Sometimes convenient with a scalar error measure (one number)
 <p><li> Can integrate \( e^n \)
</ul>

The Trapezoidal rule:

<p>
$$ \hat E^2 = \Delta t\left(\frac{1}{2}e_0^2 + \frac{1}{2}e_N^2
+ \sum_{n=1}^{N-1} e_n^2\right) $$
Common approximation (ok if used consistently in all error computations):

<p>
$$ \hat E^2 \approx E^2 = \Delta t\sum_{n=0}^{N} e_n^2 $$

<p>
\( E \) is the \( L_2 \) norm of the discrete error function \( e^n \).

<p>
$$
\begin{equation}
E = \sqrt{\Delta t\sum_{n=0}^N e_n^2}
\label{decay:E}
\end{equation}
$$

<p>
Python:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">E <span style="color: #666666">=</span> sqrt(dt<span style="color: #666666">*</span><span style="color: #AA22FF">sum</span>(e<span style="color: #666666">**2</span>))
</pre></div>
<p>

<p>
Similar element by element computation:
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">m <span style="color: #666666">=</span> <span style="color: #AA22FF">len</span>(u)     <span style="color: #008800; font-style: italic"># length of u array (alt: u.size)</span>
u_e <span style="color: #666666">=</span> zeros(m)
t <span style="color: #666666">=</span> <span style="color: #666666">0</span>
<span style="color: #AA22FF; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #AA22FF">range</span>(m):
    u_e[i] <span style="color: #666666">=</span> exact_solution(t, a, I)
    t <span style="color: #666666">=</span> t <span style="color: #666666">+</span> dt
e <span style="color: #666666">=</span> zeros(m)
<span style="color: #AA22FF; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #AA22FF">range</span>(m):
    e[i] <span style="color: #666666">=</span> u_e[i] <span style="color: #666666">-</span> u[i]
s <span style="color: #666666">=</span> <span style="color: #666666">0</span>  <span style="color: #008800; font-style: italic"># summation variable</span>
<span style="color: #AA22FF; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #AA22FF">range</span>(m):
    s <span style="color: #666666">=</span> s <span style="color: #666666">+</span> e[i]<span style="color: #666666">**2</span>
error <span style="color: #666666">=</span> sqrt(dt<span style="color: #666666">*</span>s)
</pre></div>
<p>
Such <em>scalar</em> computing

<p>

<ul>
 <p><li> takes more code
 <p><li> is less readable
 <p><li> runs much slower
</ul>

Rule: Compute on entire arrays!

<p>

<h3>Plotting solutions  <a name="___sec12"></a></h3>
<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #666666">*</span>
plot(t, u)
show()
</pre></div>
<p>

<p>
Compare with \( \uex(t) \):

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">t_e <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, <span style="color: #666666">1001</span>)      <span style="color: #008800; font-style: italic"># fine mesh</span>
u_e <span style="color: #666666">=</span> exact_solution(t_e, I, a)
plot(t,   u,   <span style="color: #BB4444">&#39;r-&#39;</span>)            <span style="color: #008800; font-style: italic"># red  line for u</span>
plot(t_e, u_e, <span style="color: #BB4444">&#39;b-&#39;</span>)            <span style="color: #008800; font-style: italic"># blue line for u_e</span>
</pre></div>
<p>

<p>

<p>
<center> <! -- figure -->
<hr class="figure">
<center><p class="caption">Figure 1:  The Forward Euler scheme for two values of the time step. <a name="decay:fig:FE1"></a> </p></center>
<p><img src="fig-decay/FE1.png" align="bottom" width=600,></p>
</center>

<p>

<p>
How to include such decorations:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #666666">*</span>

figure()                          <span style="color: #008800; font-style: italic"># create new plot</span>
t_e <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, <span style="color: #666666">1001</span>)        <span style="color: #008800; font-style: italic"># fine mesh for u_e</span>
u_e <span style="color: #666666">=</span> exact_solution(t_e, I, a)
plot(t,   u,   <span style="color: #BB4444">&#39;r--o&#39;</span>)            <span style="color: #008800; font-style: italic"># red dashes w/circles</span>
plot(t_e, u_e, <span style="color: #BB4444">&#39;b-&#39;</span>)              <span style="color: #008800; font-style: italic"># blue line for exact sol.</span>
legend([<span style="color: #BB4444">&#39;numerical&#39;</span>, <span style="color: #BB4444">&#39;exact&#39;</span>])
xlabel(<span style="color: #BB4444">&#39;t&#39;</span>)
ylabel(<span style="color: #BB4444">&#39;u&#39;</span>)
title(<span style="color: #BB4444">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BB4444">, dt=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BB4444">&#39;</span> <span style="color: #666666">%</span> (theta, dt))
savefig(<span style="color: #BB4444">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BB4444">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BB4444">.png&#39;</span> <span style="color: #666666">%</span> (theta, dt))
show()
</pre></div>
<p>

<p>
Computation and plotting:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">explore</span>(I, a, T, dt, theta<span style="color: #666666">=0.5</span>, makeplot<span style="color: #666666">=</span><span style="color: #AA22FF">True</span>):
    <span style="color: #BB4444; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BB4444; font-style: italic">    Run a case with the solver, compute error measure,</span>
<span style="color: #BB4444; font-style: italic">    and plot the numerical and exact solutions (if makeplot=True).</span>
<span style="color: #BB4444; font-style: italic">    &quot;&quot;&quot;</span>
    u, t <span style="color: #666666">=</span> solver(I, a, T, dt, theta)  <span style="color: #008800; font-style: italic"># Numerical solution</span>
    u_e <span style="color: #666666">=</span> exact_solution(t, I, a)
    e <span style="color: #666666">=</span> u_e <span style="color: #666666">-</span> u
    E <span style="color: #666666">=</span> sqrt(dt<span style="color: #666666">*</span><span style="color: #AA22FF">sum</span>(e<span style="color: #666666">**2</span>))
    <span style="color: #AA22FF; font-weight: bold">if</span> makeplot:
        figure()                         <span style="color: #008800; font-style: italic"># create new plot</span>
        t_e <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, <span style="color: #666666">1001</span>)       <span style="color: #008800; font-style: italic"># fine mesh for u_e</span>
        u_e <span style="color: #666666">=</span> exact_solution(t_e, I, a)
        plot(t,   u,   <span style="color: #BB4444">&#39;r--o&#39;</span>)           <span style="color: #008800; font-style: italic"># red dashes w/circles</span>
        plot(t_e, u_e, <span style="color: #BB4444">&#39;b-&#39;</span>)             <span style="color: #008800; font-style: italic"># blue line for exact sol.</span>
        legend([<span style="color: #BB4444">&#39;numerical&#39;</span>, <span style="color: #BB4444">&#39;exact&#39;</span>])
        xlabel(<span style="color: #BB4444">&#39;t&#39;</span>)
        ylabel(<span style="color: #BB4444">&#39;u&#39;</span>)
        title(<span style="color: #BB4444">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BB4444">, dt=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BB4444">&#39;</span> <span style="color: #666666">%</span> (theta, dt))
        theta2name <span style="color: #666666">=</span> {<span style="color: #666666">0</span>: <span style="color: #BB4444">&#39;FE&#39;</span>, <span style="color: #666666">1</span>: <span style="color: #BB4444">&#39;BE&#39;</span>, <span style="color: #666666">0.5</span>: <span style="color: #BB4444">&#39;CN&#39;</span>}
        savefig(<span style="color: #BB4444">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BB4444">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BB4444">.png&#39;</span> <span style="color: #666666">%</span> (theta2name[theta], dt))
        show()
    <span style="color: #AA22FF; font-weight: bold">return</span> E
</pre></div>
<p>

<p>
Complete code: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_plot_mpl.py"><tt>dc_plot_mpl.py</tt></a>.

<p>

<p>
<center> <! -- figure -->
<hr class="figure">
<center><p class="caption">Figure 2:  The Backward Euler scheme for two values of the time step. <a name="decay:fig:BE1"></a> </p></center>
<p><img src="fig-decay/BE1.png" align="bottom" width=600></p>
</center>

<p>

<p>

<p>
<center> <! -- figure -->
<hr class="figure">
<center><p class="caption">Figure 3:  The Crank-Nicolson scheme for two values of the time step. <a name="decay:fig:CN1"></a> </p></center>
<p><img src="fig-decay/CN1.png" align="bottom" width=600></p>
</center>

<p>

<p>

<p>

<h3>Plotting with SciTools  <a name="___sec13"></a></h3>
<p>
<a href="http://code.google.com/p/scitools">SciTools</a> provides a
unified plotting interface (Easyviz) to many different plotting
packages: Matplotlib, Gnuplot, Grace, VTK, OpenDX, ...

<p>
Can use Matplotlib syntax, or a more compact <tt>plot</tt> function syntax:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">scitools.std</span> <span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #666666">*</span>

plot(t,   u,   <span style="color: #BB4444">&#39;r--o&#39;</span>,           <span style="color: #008800; font-style: italic"># red dashes w/circles</span>
     t_e, u_e, <span style="color: #BB4444">&#39;b-&#39;</span>,             <span style="color: #008800; font-style: italic"># blue line for exact sol.</span>
     legend<span style="color: #666666">=</span>[<span style="color: #BB4444">&#39;numerical&#39;</span>, <span style="color: #BB4444">&#39;exact&#39;</span>],
     xlabel<span style="color: #666666">=</span><span style="color: #BB4444">&#39;t&#39;</span>,
     ylabel<span style="color: #666666">=</span><span style="color: #BB4444">&#39;u&#39;</span>,
     title<span style="color: #666666">=</span><span style="color: #BB4444">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BB4444">, dt=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BB4444">&#39;</span> <span style="color: #666666">%</span> (theta, dt),
     savefig<span style="color: #666666">=</span><span style="color: #BB4444">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BB4444">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BB4444">.png&#39;</span> <span style="color: #666666">%</span> (theta2name[theta], dt),
     show<span style="color: #666666">=</span><span style="color: #AA22FF">True</span>)
</pre></div>
<p>

<p>
Complete code in <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_plot_st.py"><tt>dc_plot_st.py</tt></a>.

<p>
Change backend (plotting engine, Matplotlib by default):

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python dc_plot_st.py --SCITOOLS_easyviz_backend gnuplot
Terminal&gt; python dc_plot_st.py --SCITOOLS_easyviz_backend grace
</pre></div>
<p>

<p>

<h3>Creating user interfaces  <a name="___sec14"></a></h3>
<p>

<ul>
 <p><li> Read input from the command line!
 <p><li> Or file if much input
 <p><li> All command-line arguments are available in <tt>sys.argv</tt>
 <p><li> <tt>sys.argv[0]</tt> is the program
 <p><li> <tt>sys.argv[1:]</tt> holds the command-line arguments
 <p><li> Method 1: fixed sequence of parameters on the command line
 <p><li> Method 2: <tt>--option value</tt> pairs on the command line (with default values)
</ul>

<h4>Reading a sequence of command-line arguments  <a name="___sec15"></a></h4>
<p>
The program <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_plot_mpl.py"><tt>dc_plot_mpl.py</tt></a>
needs this input: \( I \), \( a \), \( T \), an option to
turn the plot on or off (<tt>makeplot</tt>), and a list of \( \Delta t \) values.
Give these on the command line:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span>

<span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">read_command_line</span>():
    <span style="color: #AA22FF; font-weight: bold">if</span> <span style="color: #AA22FF">len</span>(sys<span style="color: #666666">.</span>argv) <span style="color: #666666">&lt;</span> <span style="color: #666666">6</span>:
        <span style="color: #AA22FF; font-weight: bold">print</span> <span style="color: #BB4444">&#39;Usage: </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BB4444"> I a T on/off dt1 dt2 dt3 ...&#39;</span> <span style="color: #666666">%</span> \ 
              sys<span style="color: #666666">.</span>argv[<span style="color: #666666">0</span>]; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)  <span style="color: #008800; font-style: italic"># abort</span>

    I <span style="color: #666666">=</span> <span style="color: #AA22FF">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>])
    a <span style="color: #666666">=</span> <span style="color: #AA22FF">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">2</span>])
    T <span style="color: #666666">=</span> <span style="color: #AA22FF">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">3</span>])
    makeplot <span style="color: #666666">=</span> sys<span style="color: #666666">.</span>argv[<span style="color: #666666">4</span>] <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #BB4444">&#39;on&#39;</span>, <span style="color: #BB4444">&#39;True&#39;</span>)
    dt_values <span style="color: #666666">=</span> [<span style="color: #AA22FF">float</span>(arg) <span style="color: #AA22FF; font-weight: bold">for</span> arg <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv[<span style="color: #666666">5</span>:]]

    <span style="color: #AA22FF; font-weight: bold">return</span> I, a, T, makeplot, dt_values
</pre></div>
<p>

<p>
Note:

<p>

<ul>
  <p><li> <tt>sys.argv[i]</tt> is <em>always a string</em>
  <p><li> Must explicitly convert to (e.g.) <tt>float</tt> for computations
  <p><li> List comprehensions make lists: <tt>[expression for e in somelist]</tt>
</ul>

Complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_cml.py"><tt>dc_cml.py</tt></a>.

<p>

<h4>Working with an argument parser  <a name="___sec16"></a></h4>
<p>
Example: give \( a \) as <tt>--a 2.5</tt> on the command line
if the default value is not suitable.

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">define_command_line_options</span>():
    <span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">argparse</span>
    parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser()
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BB4444">&#39;--I&#39;</span>, <span style="color: #BB4444">&#39;--initial_condition&#39;</span>, <span style="color: #AA22FF">type</span><span style="color: #666666">=</span><span style="color: #AA22FF">float</span>,
                        default<span style="color: #666666">=1.0</span>, help<span style="color: #666666">=</span><span style="color: #BB4444">&#39;initial condition, u(0)&#39;</span>,
                        metavar<span style="color: #666666">=</span><span style="color: #BB4444">&#39;I&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BB4444">&#39;--a&#39;</span>, <span style="color: #AA22FF">type</span><span style="color: #666666">=</span><span style="color: #AA22FF">float</span>,
                        default<span style="color: #666666">=1.0</span>, help<span style="color: #666666">=</span><span style="color: #BB4444">&#39;coefficient in ODE&#39;</span>,
                        metavar<span style="color: #666666">=</span><span style="color: #BB4444">&#39;a&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BB4444">&#39;--T&#39;</span>, <span style="color: #BB4444">&#39;--stop_time&#39;</span>, <span style="color: #AA22FF">type</span><span style="color: #666666">=</span><span style="color: #AA22FF">float</span>,
                        default<span style="color: #666666">=1.0</span>, help<span style="color: #666666">=</span><span style="color: #BB4444">&#39;end time of simulation&#39;</span>,
                        metavar<span style="color: #666666">=</span><span style="color: #BB4444">&#39;T&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BB4444">&#39;--makeplot&#39;</span>, action<span style="color: #666666">=</span><span style="color: #BB4444">&#39;store_true&#39;</span>,
                        help<span style="color: #666666">=</span><span style="color: #BB4444">&#39;display plot or not&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BB4444">&#39;--dt&#39;</span>, <span style="color: #BB4444">&#39;--time_step_values&#39;</span>, <span style="color: #AA22FF">type</span><span style="color: #666666">=</span><span style="color: #AA22FF">float</span>,
                        default<span style="color: #666666">=</span>[<span style="color: #666666">1.0</span>], help<span style="color: #666666">=</span><span style="color: #BB4444">&#39;time step values&#39;</span>,
                        metavar<span style="color: #666666">=</span><span style="color: #BB4444">&#39;dt&#39;</span>, nargs<span style="color: #666666">=</span><span style="color: #BB4444">&#39;+&#39;</span>, dest<span style="color: #666666">=</span><span style="color: #BB4444">&#39;dt_values&#39;</span>)
    <span style="color: #AA22FF; font-weight: bold">return</span> parser
</pre></div>
<p>

<p>
Automatically generated help functionality:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python dc_argparse.py -h
  ...
  --I I, --initial_condition I
                        initial condition, u<span style="color: #666666">(</span>0<span style="color: #666666">)</span>
  ...
</pre></div>
<p>

<p>
Structure of this help output:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">  --I metavar, --initial_condition metavar
                        help-string
</pre></div>
<p>

<p>
How to read data from the command line:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">read_command_line</span>():
    parser <span style="color: #666666">=</span> define_command_line_options()
    args <span style="color: #666666">=</span> parser<span style="color: #666666">.</span>parse_args()
    <span style="color: #AA22FF; font-weight: bold">print</span> <span style="color: #BB4444">&#39;I={}, a={}, T={}, makeplot={}, dt_values={}&#39;</span><span style="color: #666666">.</span>format(
        args<span style="color: #666666">.</span>I, args<span style="color: #666666">.</span>a, args<span style="color: #666666">.</span>T, args<span style="color: #666666">.</span>makeplot, args<span style="color: #666666">.</span>dt_values)
    <span style="color: #AA22FF; font-weight: bold">return</span> args<span style="color: #666666">.</span>I, args<span style="color: #666666">.</span>a, args<span style="color: #666666">.</span>T, args<span style="color: #666666">.</span>makeplot, args<span style="color: #666666">.</span>dt_values
</pre></div>
<p>

<p>
Complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_argparse.py"><tt>dc_argparse.py</tt></a>.

<p>

<p>

<h3>Computing convergence rates  <a name="___sec17"></a></h3>
<p>
Frequent assumption on the relation between the numerical error \( E \) and
some discretization parameter \( \Delta t \):

<p>
$$
\begin{equation}
E = C\Delta t^r,
\label{decay:E:dt}
\end{equation}
$$
Unknown: \( C \) and \( r \).

<p>

<h4>Estimating the convergence rate \( r \)  <a name="___sec18"></a></h4>
<p>
Perform numerical experiments: \( (\Delta t_i, E_i) \), \( i=0,\ldots,m-1 \).

<p>

<ol>
 <p><li> Take the logarithm of \eqref{decay:E:dt}, \( \ln E = r\ln \Delta t + \ln C \),
    and fit a straight line to the data points \( (\Delta t_i, E_i) \),
    \( i=0,\ldots,m-1 \).
 <p><li> Consider two consecutive experiments, \( (\Delta t_i, E_i) \) and
    \( (\Delta t_{i-1}, E_{i-1}) \). Dividing the equation
    \( E_{i-1}=C\Delta t_{i-1}^r \) by \( E_{i}=C\Delta t_{i}^r \) and solving
    for \( r \) yields
</ol>

$$
\begin{equation}
r_{i-1} = \frac{\ln (E_{i-1}/E_i)}{\ln (\Delta t_{i-1}/\Delta t_i)}
\label{decay:conv:rate}
\end{equation}
$$
for \( i=1,=\ldots,m-1 \).

<p>
Method 2 is best.

<p>

<h4>Implementation  <a name="___sec19"></a></h4>
<p>
Compute \( r_0, r_1, \ldots, r_{m-2} \):

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">math</span> <span style="color: #AA22FF; font-weight: bold">import</span> log

<span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">main</span>():
    I, a, T, makeplot, dt_values <span style="color: #666666">=</span> read_command_line()
    r <span style="color: #666666">=</span> {}  <span style="color: #008800; font-style: italic"># estimated convergence rates</span>
    <span style="color: #AA22FF; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>:
        E_values <span style="color: #666666">=</span> []
        <span style="color: #AA22FF; font-weight: bold">for</span> dt <span style="color: #AA22FF; font-weight: bold">in</span> dt_values:
            E <span style="color: #666666">=</span> explore(I, a, T, dt, theta, makeplot<span style="color: #666666">=</span><span style="color: #AA22FF">False</span>)
            E_values<span style="color: #666666">.</span>append(E)

        <span style="color: #008800; font-style: italic"># Compute convergence rates</span>
        m <span style="color: #666666">=</span> <span style="color: #AA22FF">len</span>(dt_values)
        r[theta] <span style="color: #666666">=</span> [log(E_values[i<span style="color: #666666">-1</span>]<span style="color: #666666">/</span>E_values[i])<span style="color: #666666">/</span>
                    log(dt_values[i<span style="color: #666666">-1</span>]<span style="color: #666666">/</span>dt_values[i])
                    <span style="color: #AA22FF; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #AA22FF">range</span>(<span style="color: #666666">1</span>, m, <span style="color: #666666">1</span>)]

    <span style="color: #AA22FF; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> r:
        <span style="color: #AA22FF; font-weight: bold">print</span> <span style="color: #BB4444">&#39;</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BB4444">Pairwise convergence rates for theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BB4444">:&#39;</span> <span style="color: #666666">%</span> theta
        <span style="color: #AA22FF; font-weight: bold">print</span> <span style="color: #BB4444">&#39; &#39;</span><span style="color: #666666">.</span>join([<span style="color: #BB4444">&#39;</span><span style="color: #BB6688; font-weight: bold">%.2f</span><span style="color: #BB4444">&#39;</span> <span style="color: #666666">%</span> r_ <span style="color: #AA22FF; font-weight: bold">for</span> r_ <span style="color: #AA22FF; font-weight: bold">in</span> r[theta]])
    <span style="color: #AA22FF; font-weight: bold">return</span> r
</pre></div>
<p>

<p>
Complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_convrate.py"><tt>dc_convrate.py</tt></a>.

<p>
Example on execution:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python dc_convrate.py --dt 0.5 0.25 0.1 0.05 0.025 0.01
...
Pairwise convergence rates <span style="color: #AA22FF; font-weight: bold">for </span><span style="color: #B8860B">theta</span><span style="color: #666666">=</span>0:
1.33 1.15 1.07 1.03 1.02

Pairwise convergence rates <span style="color: #AA22FF; font-weight: bold">for </span><span style="color: #B8860B">theta</span><span style="color: #666666">=</span>0.5:
2.14 2.07 2.03 2.01 2.01

Pairwise convergence rates <span style="color: #AA22FF; font-weight: bold">for </span><span style="color: #B8860B">theta</span><span style="color: #666666">=</span>1:
0.98 0.99 0.99 1.00 1.00
</pre></div>
<p>

<p>

<h4>Verification  <a name="___sec20"></a></h4>
<p>
Strong verification method: verify that \( r \) has the expected value!

<p>

<h4>Debugging via convergence rates  <a name="___sec21"></a></h4>
<p>
Potential bug: missing <tt>a</tt> in the denominator,

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt)<span style="color: #666666">*</span>u[n]
</pre></div>
<p>
Running <tt>dc_convrate.py</tt> gives same rates.

<p>
Why? The value of \( a \)... (\( a=1 \))

<p>
0 and 1 are <em>bad values</em> in tests!

<p>
Better:
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python dc_convrate.py --a 2.1 --I 0.1  <span style="color: #BB6622; font-weight: bold">\</span>
          --dt 0.5 0.25 0.1 0.05 0.025 0.01
...
Pairwise convergence rates <span style="color: #AA22FF; font-weight: bold">for </span><span style="color: #B8860B">theta</span><span style="color: #666666">=</span>0:
1.49 1.18 1.07 1.04 1.02

Pairwise convergence rates <span style="color: #AA22FF; font-weight: bold">for </span><span style="color: #B8860B">theta</span><span style="color: #666666">=</span>0.5:
-1.42 -0.22 -0.07 -0.03 -0.01

Pairwise convergence rates <span style="color: #AA22FF; font-weight: bold">for </span><span style="color: #B8860B">theta</span><span style="color: #666666">=</span>1:
0.21 0.12 0.06 0.03 0.01
</pre></div>
<p>

<p>
Forward Euler works...because \( \theta=0 \) hides the bug.

<p>
This bug gives \( r\approx 0 \):

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> ((<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)<span style="color: #666666">*</span>u[n]
</pre></div>
<p>

<p>

<p>

<h3>Memory-saving implementation  <a name="___sec22"></a></h3>
<p>

<ul>
 <p><li> Note 1: we store the entire array <tt>u</tt>, i.e., \( u^n \) for \( n=0,1,\ldots,N \)
 <p><li> Note 2: the formula for \( u^{n+1} \) needs \( u^n \) only, not \( u^{n-1} \), \( u^{n-2} \), ...
 <p><li> No need to store more than \( u^{n+1} \) and \( u^{n} \)
 <p><li> Extremely important when solving PDEs
 <p><li> No practical importance here (much memory available)
 <p><li> But let's illustrate how to do save memory!
 <p><li> Idea 1: store \( u^{n+1} \) in <tt>u</tt>, \( u^n \) in <tt>u_1</tt> (<tt>float</tt>)
 <p><li> Idea 2: store <tt>u</tt> in a file, read file later for plotting
</ul>

<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">solver_memsave</span>(I, a, T, dt, theta, filename<span style="color: #666666">=</span><span style="color: #BB4444">&#39;sol.dat&#39;</span>):
    <span style="color: #BB4444; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BB4444; font-style: italic">    Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.</span>
<span style="color: #BB4444; font-style: italic">    Minimum use of memory. The solution is store on file</span>
<span style="color: #BB4444; font-style: italic">    (with name filename) for later plotting.</span>
<span style="color: #BB4444; font-style: italic">    &quot;&quot;&quot;</span>
    dt <span style="color: #666666">=</span> <span style="color: #AA22FF">float</span>(dt)        <span style="color: #008800; font-style: italic"># avoid integer division</span>
    N <span style="color: #666666">=</span> <span style="color: #AA22FF">int</span>(<span style="color: #AA22FF">round</span>(T<span style="color: #666666">/</span>dt))  <span style="color: #008800; font-style: italic"># no of intervals</span>

    outfile <span style="color: #666666">=</span> <span style="color: #AA22FF">open</span>(filename, <span style="color: #BB4444">&#39;w&#39;</span>)
    <span style="color: #008800; font-style: italic"># u: time level n+1, u_1: time level n</span>
    t <span style="color: #666666">=</span> <span style="color: #666666">0</span>
    u_1 <span style="color: #666666">=</span> I
    outfile<span style="color: #666666">.</span>write(<span style="color: #BB4444">&#39;</span><span style="color: #BB6688; font-weight: bold">%.16E</span><span style="color: #BB4444">  </span><span style="color: #BB6688; font-weight: bold">%.16E</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BB4444">&#39;</span> <span style="color: #666666">%</span> (t, u_1))
    <span style="color: #AA22FF; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #AA22FF">range</span>(<span style="color: #666666">1</span>, N<span style="color: #666666">+1</span>):
        u <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)<span style="color: #666666">*</span>u_1
        u_1 <span style="color: #666666">=</span> u
        t <span style="color: #666666">+=</span> dt
        outfile<span style="color: #666666">.</span>write(<span style="color: #BB4444">&#39;</span><span style="color: #BB6688; font-weight: bold">%.16E</span><span style="color: #BB4444">  </span><span style="color: #BB6688; font-weight: bold">%.16E</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BB4444">&#39;</span> <span style="color: #666666">%</span> (t, u))
    outfile<span style="color: #666666">.</span>close()
    <span style="color: #AA22FF; font-weight: bold">return</span> u, t
</pre></div>
<p>

<p>
Reading the computed data:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">read_file</span>(filename<span style="color: #666666">=</span><span style="color: #BB4444">&#39;sol.dat&#39;</span>):
    infile <span style="color: #666666">=</span> <span style="color: #AA22FF">open</span>(filename, <span style="color: #BB4444">&#39;r&#39;</span>)
    u <span style="color: #666666">=</span> [];  t <span style="color: #666666">=</span> []
    <span style="color: #AA22FF; font-weight: bold">for</span> line <span style="color: #AA22FF; font-weight: bold">in</span> infile:
        words <span style="color: #666666">=</span> line<span style="color: #666666">.</span>split()
        <span style="color: #AA22FF; font-weight: bold">if</span> <span style="color: #AA22FF">len</span>(words) <span style="color: #666666">!=</span> <span style="color: #666666">2</span>:
            <span style="color: #AA22FF; font-weight: bold">print</span> <span style="color: #BB4444">&#39;Found more than two numbers on a line!&#39;</span>, words
            sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)  <span style="color: #008800; font-style: italic"># abort</span>
        t<span style="color: #666666">.</span>append(<span style="color: #AA22FF">float</span>(words[<span style="color: #666666">0</span>]))
        u<span style="color: #666666">.</span>append(<span style="color: #AA22FF">float</span>(words[<span style="color: #666666">1</span>]))
    <span style="color: #AA22FF; font-weight: bold">return</span> np<span style="color: #666666">.</span>array(t), np<span style="color: #666666">.</span>array(u)
</pre></div>
<p>

<p>
Simpler code with <tt>numpy</tt> functionality for reading/writing tabular data:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">read_file_numpy</span>(filename<span style="color: #666666">=</span><span style="color: #BB4444">&#39;sol.dat&#39;</span>):
    data <span style="color: #666666">=</span> np<span style="color: #666666">.</span>loadtxt(filename)
    t <span style="color: #666666">=</span> data[:,<span style="color: #666666">0</span>]
    u <span style="color: #666666">=</span> data[:,<span style="color: #666666">1</span>]
    <span style="color: #AA22FF; font-weight: bold">return</span> t, u
</pre></div>
<p>

<p>
Similar function <tt>np.savetxt</tt>, but then we need all \( u^n \) and \( t^n \) values
in a two-dimensional array (which we try to prevent now!).

<p>
Usage:
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">explore</span>(I, a, T, dt, theta<span style="color: #666666">=0.5</span>, makeplot<span style="color: #666666">=</span><span style="color: #AA22FF">True</span>):
    filename <span style="color: #666666">=</span> <span style="color: #BB4444">&#39;u.dat&#39;</span>
    u, t <span style="color: #666666">=</span> solver_minmem(I, a, T, dt, theta, filename)

    t, u <span style="color: #666666">=</span> read_file(filename)
    u_e <span style="color: #666666">=</span> exact_solution(t, I, a)
    e <span style="color: #666666">=</span> u_e <span style="color: #666666">-</span> u
    E <span style="color: #666666">=</span> np<span style="color: #666666">.</span>sqrt(dt<span style="color: #666666">*</span>np<span style="color: #666666">.</span>sum(e<span style="color: #666666">**2</span>))
    <span style="color: #AA22FF; font-weight: bold">if</span> makeplot:
        plt<span style="color: #666666">.</span>figure()
        <span style="color: #666666">...</span>
</pre></div>
<p>

<p>
Complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/dc_memsave.py"><tt>dc_memsave.py</tt></a>.

<p>

<p>

<p>

<h2>Software engineering  <a name="___sec23"></a></h2>
<p>
Goal: make more professional numerical software.

<p>
Topics:

<p>

<ul>
  <p><li> How to make modules (reusable libraries)
  <p><li> Testing frameworks (doctest, nose, unittest)
  <p><li> Implementation with classes
</ul>

<h3>Making a module  <a name="___sec24"></a></h3>
<p>

<p>

<ul>
 <p><li> Previous programs: much repetitive code (esp. <tt>solver</tt>)
 <p><li> DRY (Don' Repeat Yourself) principle: no copies of code
 <p><li> A change needs to be done in one <em>and only one</em> place
 <p><li> Module = just a file with functions (reused through <tt>import</tt>)
 <p><li> Let's make a module of

<ul>
   <p><li> <tt>solver</tt>
   <p><li> <tt>verify_three_steps</tt>
   <p><li> <tt>verify_discrete_solution</tt>
   <p><li> <tt>explore</tt>
   <p><li> <tt>define_command_line_options</tt>
   <p><li> <tt>read_command_line</tt>
   <p><li> <tt>main</tt> (with convergence rates)
   <p><li> <tt>verify_convergence_rate</tt>
</ul>

</ul>

Module name: <tt>dc_mod</tt>, filename: <tt>dc_mod.py</tt>.

<p>
Sketch:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span>

<span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">solver</span>(I, a, T, dt, theta):
    <span style="color: #666666">...</span>

<span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">verify_three_steps</span>():
    <span style="color: #666666">...</span>

<span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">verify_exact_discrete_solution</span>():
    <span style="color: #666666">...</span>

<span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">exact_solution</span>(t, I, a):
    <span style="color: #666666">...</span>

<span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">explore</span>(I, a, T, dt, theta<span style="color: #666666">=0.5</span>, makeplot<span style="color: #666666">=</span><span style="color: #AA22FF">True</span>):
    <span style="color: #666666">...</span>

<span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">define_command_line_options</span>():
    <span style="color: #666666">...</span>

<span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">read_command_line</span>(use_argparse<span style="color: #666666">=</span><span style="color: #AA22FF">True</span>):
    <span style="color: #666666">...</span>

<span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">main</span>():
    <span style="color: #666666">...</span>
</pre></div>
<p>
That is! It's a module <tt>dc_mod</tt> in file <tt>dc_mod.py</tt>.

<p>
Usage in some other program:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">dc_mod</span> <span style="color: #AA22FF; font-weight: bold">import</span> solver
u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=1.0</span>, a<span style="color: #666666">=3.0</span>, T<span style="color: #666666">=3</span>, dt<span style="color: #666666">=0.01</span>, theta<span style="color: #666666">=0.5</span>)
</pre></div>
<p>

<p>

<p>
Test block:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BB4444">&#39;__main__&#39;</span>:
    main()
</pre></div>
<p>

<p>
If <tt>dc_mod</tt> is imported, <tt>__name__</tt> is <tt>dc_mod</tt>.

<p>
If <tt>dc_mod.py</tt> is run, <tt>__name__</tt> is <tt>__main__</tt>.

<p>
Use test block for testing, demo, user interface, ...

<p>
Extended test block:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BB4444">&#39;__main__&#39;</span>:
    <span style="color: #AA22FF; font-weight: bold">if</span> <span style="color: #BB4444">&#39;verify&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv:
        <span style="color: #AA22FF; font-weight: bold">if</span> verify_three_steps() <span style="color: #AA22FF; font-weight: bold">and</span> verify_discrete_solution():
            <span style="color: #AA22FF; font-weight: bold">pass</span> <span style="color: #008800; font-style: italic"># ok</span>
        <span style="color: #AA22FF; font-weight: bold">else</span>:
            <span style="color: #AA22FF; font-weight: bold">print</span> <span style="color: #BB4444">&#39;Bug in the implementation!&#39;</span>
    <span style="color: #AA22FF; font-weight: bold">elif</span> <span style="color: #BB4444">&#39;verify_rates&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv:
        sys<span style="color: #666666">.</span>argv<span style="color: #666666">.</span>remove(<span style="color: #BB4444">&#39;verify_rates&#39;</span>)
        <span style="color: #AA22FF; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #BB4444">&#39;--dt&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv:
            <span style="color: #AA22FF; font-weight: bold">print</span> <span style="color: #BB4444">&#39;Must assign several dt values&#39;</span>
            sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)  <span style="color: #008800; font-style: italic"># abort</span>
        <span style="color: #AA22FF; font-weight: bold">if</span> verify_convergence_rate():
            <span style="color: #AA22FF; font-weight: bold">pass</span>
        <span style="color: #AA22FF; font-weight: bold">else</span>:
            <span style="color: #AA22FF; font-weight: bold">print</span> <span style="color: #BB4444">&#39;Bug in the implementation!&#39;</span>
    <span style="color: #AA22FF; font-weight: bold">else</span>:
        <span style="color: #008800; font-style: italic"># Perform simulations</span>
        main()
</pre></div>
<p>

<p>

<h3>Prefixing imported functions by the module name  <a name="___sec25"></a></h3>
<p>

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #666666">*</span>
</pre></div>
<p>

<p>
This imports a large number of names (<tt>sin</tt>, <tt>exp</tt>, <tt>linspace</tt>, <tt>plot</tt>, ...).

<p>
Confusion: is a function from`numpy`? Or <tt>matplotlib.pyplot</tt>?
Or is it our own function?

<p>
Alternative (recommended) import:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span>
<span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span>
</pre></div>
<p>

<p>
Now we need to prefix functions with module name:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">t <span style="color: #666666">=</span> numpy<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, N<span style="color: #666666">+1</span>)
u_e <span style="color: #666666">=</span> I<span style="color: #666666">*</span>numpy<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
matplotlib<span style="color: #666666">.</span>pyplot<span style="color: #666666">.</span>plot(t, u_e)
</pre></div>
<p>

<p>
Common standard:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #AA22FF; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>
<span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #AA22FF; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>

t <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, N<span style="color: #666666">+1</span>)
u_e <span style="color: #666666">=</span> I<span style="color: #666666">*</span>np<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
plt<span style="color: #666666">.</span>plot(t, u_e)
</pre></div>
<p>

<p>
Downside:
math line \( e^{-at}\sin(2\pi t) \) gets
cluttered with module names,
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">numpy<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)<span style="color: #666666">*</span>numpy<span style="color: #666666">.</span>sin(<span style="color: #666666">2</span>(numpy<span style="color: #666666">.</span>pi<span style="color: #666666">*</span>t)
<span style="color: #008800; font-style: italic"># or</span>
np<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)<span style="color: #666666">*</span>np<span style="color: #666666">.</span>sin(<span style="color: #666666">2*</span>np<span style="color: #666666">.</span>pi<span style="color: #666666">*</span>t)
</pre></div>
<p>

<p>

<h3>Doctests  <a name="___sec26"></a></h3>
<p>

<p>
Doc strings can be equipped with interactive Python sessions for
demonstrating usage and <em>automatic testing</em> of functions.

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">solver</span>(I, a, T, dt, theta):
    <span style="color: #BB4444; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BB4444; font-style: italic">    Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.</span>


<span style="color: #BB4444; font-style: italic">    &gt;&gt;&gt; u, t = solver(I=0.8, a=1.2, T=4, dt=0.5, theta=0.5)</span>
<span style="color: #BB4444; font-style: italic">    &gt;&gt;&gt; for t_n, u_n in zip(t, u):</span>
<span style="color: #BB4444; font-style: italic">    ...     print &#39;t=%.1f, u=%.14f&#39; % (t_n, u_n)</span>
<span style="color: #BB4444; font-style: italic">    t=0.0, u=0.80000000000000</span>
<span style="color: #BB4444; font-style: italic">    t=0.5, u=0.43076923076923</span>
<span style="color: #BB4444; font-style: italic">    t=1.0, u=0.23195266272189</span>
<span style="color: #BB4444; font-style: italic">    t=1.5, u=0.12489758761948</span>
<span style="color: #BB4444; font-style: italic">    t=2.0, u=0.06725254717972</span>
<span style="color: #BB4444; font-style: italic">    t=2.5, u=0.03621291001985</span>
<span style="color: #BB4444; font-style: italic">    t=3.0, u=0.01949925924146</span>
<span style="color: #BB4444; font-style: italic">    t=3.5, u=0.01049960113002</span>
<span style="color: #BB4444; font-style: italic">    t=4.0, u=0.00565363137770</span>
<span style="color: #BB4444; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #666666">...</span>
</pre></div>
<p>

<p>
Automatic check that the code gives the same output as above:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal<span style="color: #666666">&gt;</span> python <span style="color: #666666">-</span>m doctest dc_mod_doctest<span style="color: #666666">.</span>py
</pre></div>
<p>

<p>
Report in case of failure:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python -m doctest dc_mod_doctest.py
********************************************************
File <span style="color: #BB4444">&quot;dc_mod_doctest.py&quot;</span>, line 12, in dc_mod_doctest....
Failed example:
    <span style="color: #AA22FF; font-weight: bold">for </span>t_n, u_n in zip<span style="color: #666666">(</span>t, u<span style="color: #666666">)</span>:
        print <span style="color: #BB4444">&#39;t=%.1f, u=%.14f&#39;</span> % <span style="color: #666666">(</span>t_n, u_n<span style="color: #666666">)</span>
Expected:
    <span style="color: #B8860B">t</span><span style="color: #666666">=</span>0.0, <span style="color: #B8860B">u</span><span style="color: #666666">=</span>0.80000000000000
    <span style="color: #B8860B">t</span><span style="color: #666666">=</span>0.5, <span style="color: #B8860B">u</span><span style="color: #666666">=</span>0.43076923076923
    <span style="color: #B8860B">t</span><span style="color: #666666">=</span>1.0, <span style="color: #B8860B">u</span><span style="color: #666666">=</span>0.23195266272189
    <span style="color: #B8860B">t</span><span style="color: #666666">=</span>1.5, <span style="color: #B8860B">u</span><span style="color: #666666">=</span>0.12489758761948
    <span style="color: #B8860B">t</span><span style="color: #666666">=</span>2.0, <span style="color: #B8860B">u</span><span style="color: #666666">=</span>0.06725254717972
    <span style="color: #B8860B">t</span><span style="color: #666666">=</span>2.5, <span style="color: #B8860B">u</span><span style="color: #666666">=</span>0.03621291001985
    <span style="color: #B8860B">t</span><span style="color: #666666">=</span>3.0, <span style="color: #B8860B">u</span><span style="color: #666666">=</span>0.01949925924146
    <span style="color: #B8860B">t</span><span style="color: #666666">=</span>3.5, <span style="color: #B8860B">u</span><span style="color: #666666">=</span>0.01049960113002
    <span style="color: #B8860B">t</span><span style="color: #666666">=</span>4.0, <span style="color: #B8860B">u</span><span style="color: #666666">=</span>0.00565363137770
Got:
    <span style="color: #B8860B">t</span><span style="color: #666666">=</span>0.0, <span style="color: #B8860B">u</span><span style="color: #666666">=</span>0.80000000000000
    <span style="color: #B8860B">t</span><span style="color: #666666">=</span>0.5, <span style="color: #B8860B">u</span><span style="color: #666666">=</span>0.43076923076923
    <span style="color: #B8860B">t</span><span style="color: #666666">=</span>1.0, <span style="color: #B8860B">u</span><span style="color: #666666">=</span>0.23195266272189
    <span style="color: #B8860B">t</span><span style="color: #666666">=</span>1.5, <span style="color: #B8860B">u</span><span style="color: #666666">=</span>0.12489758761948
    <span style="color: #B8860B">t</span><span style="color: #666666">=</span>2.0, <span style="color: #B8860B">u</span><span style="color: #666666">=</span>0.06725254717972
********************************************************
1 items had failures:
   1 of   2 in dc_mod_doctest.solver
***Test Failed*** 1 failures.
</pre></div>
<p>

<p>
Limit the number of digits in the output in doctests! Otherwise,
round-off errors on a different machine may ruin the test.

<p>

<p>
Another example on using doctests:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">explore</span>(I, a, T, dt, theta<span style="color: #666666">=0.5</span>, makeplot<span style="color: #666666">=</span><span style="color: #AA22FF">True</span>):
    <span style="color: #BB4444; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BB4444; font-style: italic">    Run a case with the solver, compute error measure,</span>
<span style="color: #BB4444; font-style: italic">    and plot the numerical and exact solutions (if makeplot=True).</span>

<span style="color: #BB4444; font-style: italic">    &gt;&gt;&gt; for theta in 0, 0.5, 1:</span>
<span style="color: #BB4444; font-style: italic">    ...    E = explore(I=1.9, a=2.1, T=5, dt=0.1, theta=theta,</span>
<span style="color: #BB4444; font-style: italic">    ...                makeplot=False)</span>
<span style="color: #BB4444; font-style: italic">    ...    print &#39;%.10E&#39; % E</span>
<span style="color: #BB4444; font-style: italic">    ...</span>
<span style="color: #BB4444; font-style: italic">    7.3565079236E-02</span>
<span style="color: #BB4444; font-style: italic">    2.4183893110E-03</span>
<span style="color: #BB4444; font-style: italic">    6.5013039886E-02</span>
<span style="color: #BB4444; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #666666">...</span>
</pre></div>
<p>

<p>
Complete program: <a href="http://github.hplgit.com/INF5620/src/decay/dc_mod_doctest.py"><tt>dc_mod_doctest.py</tt></a>.

<p>

<p>
Avoid doctests in functions using <tt>sys.argv</tt> and <tt>print</tt> (possible,
but needs careful coding).

<p>

<h3>Unit testing with nose  <a name="___sec27"></a></h3>
<p>

<p>

<ul>
 <p><li> Nose is a very user-friendly testing framework
 <p><li> Based on <em>unit testing</em>
 <p><li> Identify small units of code
 <p><li> Test each unit
 <p><li> Nose automates running all tests
 <p><li> Good habit: make a small edit in a code, run all tests
 <p><li> Even better habit: write tests before the code
 <p><li> Unit testing in scientific computing is not well so established
</ul>

<h4>Basic use of nose  <a name="___sec28"></a></h4>
<p>

<ol>
 <p><li> Collect tests in separate files with names starting with <tt>test_</tt>.
 <p><li> Implement tests in functions with names starting with <tt>test_</tt>.
 <p><li> These functions perform assertions on computing results
    using <tt>assert</tt> functions from the <tt>nose.tools</tt> module.
</ol>

Very simple illustration of module <tt>mymod</tt>:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">double</span>(n):
    <span style="color: #AA22FF; font-weight: bold">return</span> <span style="color: #666666">2*</span>n
</pre></div>
<p>

<p>
A corresponding <tt>test_mymod.py</tt> has a test function for testing
that function <tt>double</tt> works:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">mymod</span>
<span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">nose.tools</span> <span style="color: #AA22FF; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">nt</span>

<span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">test_double</span>():
    result <span style="color: #666666">=</span> mymod<span style="color: #666666">.</span>double(<span style="color: #666666">4</span>)
    nt<span style="color: #666666">.</span>assert_equal(result, <span style="color: #666666">8</span>)
</pre></div>
<p>

<p>
Running

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; nosetests
</pre></div>
<p>
makes the <tt>nose</tt> tool look for <tt>test_*.py</tt> files and run the <tt>test*()</tt>
functions found in these files.

<p>
Main point with a test function: raise <tt>AssertionError</tt> exception if the
test fails.

<p>
Alternative:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">if</span> result <span style="color: #666666">!=</span> <span style="color: #666666">8</span>:
    <span style="color: #AA22FF; font-weight: bold">raise</span> <span style="color: #D2413A; font-weight: bold">AssertionError</span>()
</pre></div>
<p>

<p>
Advantage of nose:

<p>

<ul>
  <p><li> tests are written and collected in a structured way
  <p><li> large collections of tests, scattered throughout a tree of folders,
    can be executed with one command (<tt>nosetests</tt>).
</ul>

<h4>Demonstrating nose  <a name="___sec29"></a></h4>
<p>
Back to the exponential decay problem and the <tt>solver</tt> function.

<p>
We design three unit tests:

<p>

<ol>
 <p><li> A comparison between the computed \( u^n \) values and the
    exact discrete solution.
 <p><li> A comparison between the computed \( u^n \) values and precomputed,
    verified reference values.
 <p><li> A comparison between observed and expected convergence rates.
</ol>

These tests follow very closely the previous <tt>verify*</tt> functions.

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">nose.tools</span> <span style="color: #AA22FF; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">nt</span>
<span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">os</span>
sys<span style="color: #666666">.</span>path<span style="color: #666666">.</span>insert(<span style="color: #666666">0</span>, os<span style="color: #666666">.</span>pardir)
<span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">dc_mod_unittest</span> <span style="color: #AA22FF; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">dc_mod</span>
<span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #AA22FF; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>

<span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">exact_discrete_solution</span>(n, I, a, theta, dt):
    <span style="color: #BB4444; font-style: italic">&quot;&quot;&quot;Return exact discrete solution of the theta scheme.&quot;&quot;&quot;</span>
    dt <span style="color: #666666">=</span> <span style="color: #AA22FF">float</span>(dt)  <span style="color: #008800; font-style: italic"># avoid integer division</span>
    factor <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)
    <span style="color: #AA22FF; font-weight: bold">return</span> I<span style="color: #666666">*</span>factor<span style="color: #666666">**</span>n

<span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">test_against_discrete_solution</span>():
    <span style="color: #BB4444; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BB4444; font-style: italic">    Compare result from solver against</span>
<span style="color: #BB4444; font-style: italic">    formula for the discrete solution.</span>
<span style="color: #BB4444; font-style: italic">    &quot;&quot;&quot;</span>
    theta <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>; a <span style="color: #666666">=</span> <span style="color: #666666">2</span>; I <span style="color: #666666">=</span> <span style="color: #666666">0.1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>
    N <span style="color: #666666">=</span> <span style="color: #AA22FF">int</span>(<span style="color: #666666">8/</span>dt)  <span style="color: #008800; font-style: italic"># no of steps</span>
    u, t <span style="color: #666666">=</span> dc_mod<span style="color: #666666">.</span>solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, T<span style="color: #666666">=</span>N<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)
    u_de <span style="color: #666666">=</span> np<span style="color: #666666">.</span>array([exact_discrete_solution(n, I, a, theta, dt)
                     <span style="color: #AA22FF; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #AA22FF">range</span>(N<span style="color: #666666">+1</span>)])
    diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u_de <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()
    nt<span style="color: #666666">.</span>assert_almost_equal(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)
</pre></div>
<p>

<p>
<tt>nt.assert_almost_equal</tt>: compare two floats and avoid
differences due to round-off errors.

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">test_solver</span>():
    <span style="color: #BB4444; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BB4444; font-style: italic">    Compare result from solver against</span>
<span style="color: #BB4444; font-style: italic">    precomputed arrays for theta=0, 0.5, 1.</span>
<span style="color: #BB4444; font-style: italic">    &quot;&quot;&quot;</span>
    I<span style="color: #666666">=0.8</span>; a<span style="color: #666666">=1.2</span>; T<span style="color: #666666">=4</span>; dt<span style="color: #666666">=0.5</span>  <span style="color: #008800; font-style: italic"># fixed parameters</span>
    precomputed <span style="color: #666666">=</span> {
        <span style="color: #BB4444">&#39;t&#39;</span>: np<span style="color: #666666">.</span>array([ <span style="color: #666666">0.</span> ,  <span style="color: #666666">0.5</span>,  <span style="color: #666666">1.</span> ,  <span style="color: #666666">1.5</span>,  <span style="color: #666666">2.</span> ,  <span style="color: #666666">2.5</span>,
                        <span style="color: #666666">3.</span> ,  <span style="color: #666666">3.5</span>,  <span style="color: #666666">4.</span> ]),
        <span style="color: #666666">0.5</span>: np<span style="color: #666666">.</span>array(
            [ <span style="color: #666666">0.8</span>       ,  <span style="color: #666666">0.43076923</span>,  <span style="color: #666666">0.23195266</span>, <span style="color: #666666">0.12489759</span>,
              <span style="color: #666666">0.06725255</span>,  <span style="color: #666666">0.03621291</span>,  <span style="color: #666666">0.01949926</span>, <span style="color: #666666">0.0104996</span> ,
              <span style="color: #666666">0.00565363</span>]),
        <span style="color: #666666">0</span>: np<span style="color: #666666">.</span>array(
            [  <span style="color: #666666">8.00000000e-01</span>,   <span style="color: #666666">3.20000000e-01</span>,
               <span style="color: #666666">1.28000000e-01</span>,   <span style="color: #666666">5.12000000e-02</span>,
               <span style="color: #666666">2.04800000e-02</span>,   <span style="color: #666666">8.19200000e-03</span>,
               <span style="color: #666666">3.27680000e-03</span>,   <span style="color: #666666">1.31072000e-03</span>,
               <span style="color: #666666">5.24288000e-04</span>]),
        <span style="color: #666666">1</span>: np<span style="color: #666666">.</span>array(
            [ <span style="color: #666666">0.8</span>       ,  <span style="color: #666666">0.5</span>       ,  <span style="color: #666666">0.3125</span>    ,  <span style="color: #666666">0.1953125</span> ,
              <span style="color: #666666">0.12207031</span>,  <span style="color: #666666">0.07629395</span>,  <span style="color: #666666">0.04768372</span>,  <span style="color: #666666">0.02980232</span>,
              <span style="color: #666666">0.01862645</span>]),
        }
    <span style="color: #AA22FF; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>:
        u, t <span style="color: #666666">=</span> dc_mod<span style="color: #666666">.</span>solver(I, a, T, dt, theta<span style="color: #666666">=</span>theta)
        diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u <span style="color: #666666">-</span> precomputed[theta])<span style="color: #666666">.</span>max()
        <span style="color: #008800; font-style: italic"># Compare to 8 decimal places</span>
        nt<span style="color: #666666">.</span>assert_almost_equal(diff, <span style="color: #666666">0</span>, places<span style="color: #666666">=8</span>,
                               msg<span style="color: #666666">=</span><span style="color: #BB4444">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BB4444">&#39;</span> <span style="color: #666666">%</span> theta)
</pre></div>
<p>

<p>

<ul>
 <p><li> Testing for special type of input data that may cause trouble is important
 <p><li> Here: the formula for \( u^{n+1} \) may involve integer division
</ul>

Example:
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">theta <span style="color: #666666">=</span> <span style="color: #666666">1</span>; a <span style="color: #666666">=</span> <span style="color: #666666">1</span>; I <span style="color: #666666">=</span> <span style="color: #666666">1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">2</span>
</pre></div>
<p>
lead to integer division:
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">(<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)  <span style="color: #008800; font-style: italic"># becomes 1</span>
(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)      <span style="color: #008800; font-style: italic"># becomes 2</span>
(<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)  <span style="color: #008800; font-style: italic"># becomes 0 (!)</span>
</pre></div>
<p>

<p>
Unit test for this issue:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">test_potential_integer_division</span>():
    <span style="color: #BB4444; font-style: italic">&quot;&quot;&quot;Choose variables that can trigger integer division.&quot;&quot;&quot;</span>
    theta <span style="color: #666666">=</span> <span style="color: #666666">1</span>; a <span style="color: #666666">=</span> <span style="color: #666666">1</span>; I <span style="color: #666666">=</span> <span style="color: #666666">1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">2</span>
    N <span style="color: #666666">=</span> <span style="color: #666666">4</span>
    u, t <span style="color: #666666">=</span> dc_mod<span style="color: #666666">.</span>solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, T<span style="color: #666666">=</span>N<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)
    u_de <span style="color: #666666">=</span> np<span style="color: #666666">.</span>array([exact_discrete_solution(n, I, a, theta, dt)
                     <span style="color: #AA22FF; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #AA22FF">range</span>(N<span style="color: #666666">+1</span>)])
    diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u_de <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()
    nt<span style="color: #666666">.</span>assert_almost_equal(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)
</pre></div>
<p>

<p>
Test convergence rates:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">test_convergence_rates</span>():
    <span style="color: #BB4444; font-style: italic">&quot;&quot;&quot;Compare empirical convergence rates to exact ones.&quot;&quot;&quot;</span>
    <span style="color: #008800; font-style: italic"># Set command-line arguments directly in sys.argv</span>
    sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>:] <span style="color: #666666">=</span> <span style="color: #BB4444">&#39;--I 0.8 --a 2.1 --T 5 &#39;</span>\ 
                   <span style="color: #BB4444">&#39;--dt 0.4 0.2 0.1 0.05 0.025&#39;</span><span style="color: #666666">.</span>split()
    <span style="color: #008800; font-style: italic"># Suppress output from dc_mod.main()</span>
    stdout <span style="color: #666666">=</span> sys<span style="color: #666666">.</span>stdout  <span style="color: #008800; font-style: italic"># save standard output for later use</span>
    scratchfile <span style="color: #666666">=</span> <span style="color: #AA22FF">open</span>(<span style="color: #BB4444">&#39;.tmp&#39;</span>, <span style="color: #BB4444">&#39;w&#39;</span>)  <span style="color: #008800; font-style: italic"># fake standard output</span>
    sys<span style="color: #666666">.</span>stdout <span style="color: #666666">=</span> scratchfile

    r <span style="color: #666666">=</span> dc_mod<span style="color: #666666">.</span>main()
    <span style="color: #AA22FF; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> r:
        nt<span style="color: #666666">.</span>assert_true(r[theta])  <span style="color: #008800; font-style: italic"># check for non-empty list</span>

    scratchfile<span style="color: #666666">.</span>close()
    sys<span style="color: #666666">.</span>stdout <span style="color: #666666">=</span> stdout  <span style="color: #008800; font-style: italic"># restore standard output</span>

    expected_rates <span style="color: #666666">=</span> {<span style="color: #666666">0</span>: <span style="color: #666666">1</span>, <span style="color: #666666">1</span>: <span style="color: #666666">1</span>, <span style="color: #666666">0.5</span>: <span style="color: #666666">2</span>}
    <span style="color: #AA22FF; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> r:
        r_final <span style="color: #666666">=</span> r[theta][<span style="color: #666666">-1</span>]
        <span style="color: #008800; font-style: italic"># Compare to 1 decimal place</span>
        nt<span style="color: #666666">.</span>assert_almost_equal(expected_rates[theta], r_final,
                               places<span style="color: #666666">=1</span>, msg<span style="color: #666666">=</span><span style="color: #BB4444">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BB4444">&#39;</span> <span style="color: #666666">%</span> theta)

<span style="color: #008800; font-style: italic"># no need for any main</span>
</pre></div>
<p>

<p>
Complete program: <a href="http://github.hplgit.com/INF5620/src/decay/test/test_dc_nose.py"><tt>test_dc_nose.py</tt></a>.

<p>

<p>

<h3>Classical unit testing with unittest  <a name="___sec30"></a></h3>
<p>

<p>

<ul>
 <p><li> <tt>unittest</tt> is a Python module mimicing the classical JUnit
   class-based unit testing framework from Java
 <p><li> This is how unit testing is normally done
 <p><li> Requires knowledge of object-oriented programming
</ul>

<h4>Basic use of unittest  <a name="___sec31"></a></h4>
<p>

<p>
Write file <tt>test_mymod.py</tt>:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">unittest</span>
<span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">mymod</span>

<span style="color: #AA22FF; font-weight: bold">class</span> <span style="color: #0000FF">TestMyCode</span>(unittest<span style="color: #666666">.</span>TestCase):
    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">test_double</span>(<span style="color: #AA22FF">self</span>):
        result <span style="color: #666666">=</span> mymod<span style="color: #666666">.</span>double(<span style="color: #666666">4</span>)
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>assertEqual(result, <span style="color: #666666">8</span>)

<span style="color: #AA22FF; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BB4444">&#39;__main__&#39;</span>:
    unittest<span style="color: #666666">.</span>main()
</pre></div>
<p>

<p>

<h4>Demonstration of unittest  <a name="___sec32"></a></h4>
<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">unittest</span>
<span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">dc_mod_unittest</span> <span style="color: #AA22FF; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">decay</span>
<span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #AA22FF; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>

<span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">exact_discrete_solution</span>(n, I, a, theta, dt):
    factor <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)
    <span style="color: #AA22FF; font-weight: bold">return</span> I<span style="color: #666666">*</span>factor<span style="color: #666666">**</span>n

<span style="color: #AA22FF; font-weight: bold">class</span> <span style="color: #0000FF">TestDecay</span>(unittest<span style="color: #666666">.</span>TestCase):

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">test_against_discrete_solution</span>(<span style="color: #AA22FF">self</span>):
        <span style="color: #666666">...</span>
        diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u_de <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>assertAlmostEqual(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">test_solver</span>(<span style="color: #AA22FF">self</span>):
        <span style="color: #666666">...</span>
        <span style="color: #AA22FF; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>:
            <span style="color: #666666">...</span>
            <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>assertAlmostEqual(diff, <span style="color: #666666">0</span>, places<span style="color: #666666">=8</span>,
                                   msg<span style="color: #666666">=</span><span style="color: #BB4444">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BB4444">&#39;</span> <span style="color: #666666">%</span> theta)

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">test_potential_integer_division</span>():
        <span style="color: #666666">...</span>
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>assertAlmostEqual(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">test_convergence_rates</span>(<span style="color: #AA22FF">self</span>):
        <span style="color: #666666">...</span>
        <span style="color: #AA22FF; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> r:
            <span style="color: #666666">...</span>
            <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>assertAlmostEqual(<span style="color: #666666">...</span>)

<span style="color: #AA22FF; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BB4444">&#39;__main__&#39;</span>:
    unittest<span style="color: #666666">.</span>main()
</pre></div>
<p>

<p>
<!-- @@@CODE src-decay/test/test_dc_unittest.py fromto: def test_conv@ -->

<p>
Complete program: <a href="http://github.hplgit.com/INF5620/src/decay/test/test_dc_nose.py"><tt>test_dc_unittest.py</tt></a>.

<p>

<h3>Implementing simple problem and solver classes  <a name="___sec33"></a></h3>
<p>

<ul>
 <p><li> So far: programs are built of Python functions
 <p><li> New focus: alternative implementations using classes
 <p><li> Class-based implementations are very popular,
   especially in business/adm applications
 <p><li> Class-based implementations scales better to large and
   compliex scientific applications
</ul>

Tasks:

<p>

<ul>
 <p><li> Explain basic use of classes to build a differential equation solver
 <p><li> Introduce concepts that make such programs easily scale to
   more complex applications
 <p><li> Demonstrate the advantage of using classes
 <p><li> Idea: classes for Problem, Solver, and Visualizer
 <p><li> Problem: all the physics information about the problem
 <p><li> Solver: all the numerics information + numerical computations
 <p><li> Visualizer: plot the solution and other quantities
</ul>

<h4>The problem class  <a name="___sec34"></a></h4>
<p>

<p>

<ul>
 <p><li> Model problem: \( u'=-au \), \( u(0)=I \), for \( t\in (0,T] \).
 <p><li> Class <tt>Problem</tt> stores the physical parameters \( a \), \( I \), \( T \)
 <p><li> May also offer other data, e.g., \( \uex(t)=Ie^{-at} \)
</ul>

Implementation:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #AA22FF; font-weight: bold">import</span> exp

<span style="color: #AA22FF; font-weight: bold">class</span> <span style="color: #0000FF">Problem</span>:
    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">__init__</span>(<span style="color: #AA22FF">self</span>, I<span style="color: #666666">=1</span>, a<span style="color: #666666">=1</span>, T<span style="color: #666666">=10</span>):
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>T, <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>I, <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>a <span style="color: #666666">=</span> I, <span style="color: #AA22FF">float</span>(a), T

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">exact_solution</span>(<span style="color: #AA22FF">self</span>, t):
        I, a <span style="color: #666666">=</span> <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>I, <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>a     <span style="color: #008800; font-style: italic"># extract local variables</span>
        <span style="color: #AA22FF; font-weight: bold">return</span> I<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>
<p>
Basic usage:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">problem <span style="color: #666666">=</span> Problem(T<span style="color: #666666">=5</span>)
problem<span style="color: #666666">.</span>T <span style="color: #666666">=</span> <span style="color: #666666">8</span>
problem<span style="color: #666666">.</span>dt <span style="color: #666666">=</span> <span style="color: #666666">1.5</span>
</pre></div>
<p>

<p>
Improvement: read data from the command line.

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">class</span> <span style="color: #0000FF">Problem</span>:
    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">__init__</span>(<span style="color: #AA22FF">self</span>, I<span style="color: #666666">=1</span>, a<span style="color: #666666">=1</span>, T<span style="color: #666666">=10</span>):
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>T, <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>I, <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>a <span style="color: #666666">=</span> I, <span style="color: #AA22FF">float</span>(a), T

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">define_command_line_options</span>(<span style="color: #AA22FF">self</span>, parser<span style="color: #666666">=</span><span style="color: #AA22FF">None</span>):
        <span style="color: #AA22FF; font-weight: bold">if</span> parser <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF">None</span>:
            <span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">argparse</span>
            parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser()

        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BB4444">&#39;--I&#39;</span>, <span style="color: #BB4444">&#39;--initial_condition&#39;</span>, <span style="color: #AA22FF">type</span><span style="color: #666666">=</span><span style="color: #AA22FF">float</span>,
            default<span style="color: #666666">=</span><span style="color: #AA22FF">self</span><span style="color: #666666">.</span>I, help<span style="color: #666666">=</span><span style="color: #BB4444">&#39;initial condition, u(0)&#39;</span>,
            metavar<span style="color: #666666">=</span><span style="color: #BB4444">&#39;I&#39;</span>)
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BB4444">&#39;--a&#39;</span>, <span style="color: #AA22FF">type</span><span style="color: #666666">=</span><span style="color: #AA22FF">float</span>, default<span style="color: #666666">=</span><span style="color: #AA22FF">self</span><span style="color: #666666">.</span>a,
            help<span style="color: #666666">=</span><span style="color: #BB4444">&#39;coefficient in ODE&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BB4444">&#39;a&#39;</span>)
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BB4444">&#39;--T&#39;</span>, <span style="color: #BB4444">&#39;--stop_time&#39;</span>, <span style="color: #AA22FF">type</span><span style="color: #666666">=</span><span style="color: #AA22FF">float</span>, default<span style="color: #666666">=</span><span style="color: #AA22FF">self</span><span style="color: #666666">.</span>T,
            help<span style="color: #666666">=</span><span style="color: #BB4444">&#39;end time of simulation&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BB4444">&#39;T&#39;</span>)
        <span style="color: #AA22FF; font-weight: bold">return</span> parser

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">init_from_command_line</span>(<span style="color: #AA22FF">self</span>, args):
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>I, <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>a, <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>T <span style="color: #666666">=</span> args<span style="color: #666666">.</span>I, args<span style="color: #666666">.</span>a, args<span style="color: #666666">.</span>T

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">exact_solution</span>(<span style="color: #AA22FF">self</span>, t):
        I, a <span style="color: #666666">=</span> <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>I, <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>a
        <span style="color: #AA22FF; font-weight: bold">return</span> I<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>
<p>

<p>
Observe

<p>

<ul>
 <p><li> Can utilize user's <tt>ArgumentParser</tt>, or make one
 <p><li> <tt>None</tt> is used to indicate an "empty" (non-initialized) variable
</ul>

<h4>The solver class  <a name="___sec35"></a></h4>
<p>

<p>

<ul>
 <p><li> Store numerical data \( \Delta t \), \( \theta \)
 <p><li> Compute solution and quantities derived from the solution
</ul>

Implementation:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">class</span> <span style="color: #0000FF">Solver</span>:
    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">__init__</span>(<span style="color: #AA22FF">self</span>, problem, dt<span style="color: #666666">=0.1</span>, theta<span style="color: #666666">=0.5</span>):
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>problem <span style="color: #666666">=</span> problem
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>dt, <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>theta <span style="color: #666666">=</span> <span style="color: #AA22FF">float</span>(dt), theta

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">define_command_line_options</span>(<span style="color: #AA22FF">self</span>, parser):
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BB4444">&#39;--dt&#39;</span>, <span style="color: #BB4444">&#39;--time_step_value&#39;</span>, <span style="color: #AA22FF">type</span><span style="color: #666666">=</span><span style="color: #AA22FF">float</span>,
            default<span style="color: #666666">=0.5</span>, help<span style="color: #666666">=</span><span style="color: #BB4444">&#39;time step value&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BB4444">&#39;dt&#39;</span>)
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BB4444">&#39;--theta&#39;</span>, <span style="color: #AA22FF">type</span><span style="color: #666666">=</span><span style="color: #AA22FF">float</span>, default<span style="color: #666666">=0.5</span>,
            help<span style="color: #666666">=</span><span style="color: #BB4444">&#39;time discretization parameter&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BB4444">&#39;dt&#39;</span>)
        <span style="color: #AA22FF; font-weight: bold">return</span> parser

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">init_from_command_line</span>(<span style="color: #AA22FF">self</span>, args):
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>dt, <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>theta <span style="color: #666666">=</span> args<span style="color: #666666">.</span>dt, args<span style="color: #666666">.</span>theta

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">solve</span>(<span style="color: #AA22FF">self</span>):
        <span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">dc_mod</span> <span style="color: #AA22FF; font-weight: bold">import</span> solver
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>u, <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>t <span style="color: #666666">=</span> solver(
            <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>I, <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>a, <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>T,
            <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>dt, <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>theta)

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">error</span>(<span style="color: #AA22FF">self</span>):
        u_e <span style="color: #666666">=</span> <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>exact_solution(<span style="color: #AA22FF">self</span><span style="color: #666666">.</span>t)
        e <span style="color: #666666">=</span> u_e <span style="color: #666666">-</span> <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>u
        E <span style="color: #666666">=</span> sqrt(<span style="color: #AA22FF">self</span><span style="color: #666666">.</span>dt<span style="color: #666666">*</span><span style="color: #AA22FF">sum</span>(e<span style="color: #666666">**2</span>))
        <span style="color: #AA22FF; font-weight: bold">return</span> E
</pre></div>
<p>

<p>
Note: reuse of the numerical algorithm from the <tt>dc_mod</tt> module.

<p>

<h4>The visualizer class  <a name="___sec36"></a></h4>
<p>

<p>

<ul>
 <p><li> Store data about what to plot (if any)
 <p><li> Offer different types of plots
 <p><li> Here: make just the same plot as in the previous <tt>explore</tt> function
</ul>

Implementation:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">class</span> <span style="color: #0000FF">Visualizer</span>:
    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">__init__</span>(<span style="color: #AA22FF">self</span>, problem, solver):
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>problem, <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>solver <span style="color: #666666">=</span> problem, solver

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">plot</span>(<span style="color: #AA22FF">self</span>, include_exact<span style="color: #666666">=</span><span style="color: #AA22FF">True</span>, plt<span style="color: #666666">=</span><span style="color: #AA22FF">None</span>):
        <span style="color: #BB4444; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BB4444; font-style: italic">        Add solver.u curve to scitools plotting object plt,</span>
<span style="color: #BB4444; font-style: italic">        and include the exact solution if include_exact is True.</span>
<span style="color: #BB4444; font-style: italic">        This plot function can be called several times (if</span>
<span style="color: #BB4444; font-style: italic">        the solver object has computed new solutions).</span>
<span style="color: #BB4444; font-style: italic">        &quot;&quot;&quot;</span>
        <span style="color: #AA22FF; font-weight: bold">if</span> plt <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF">None</span>:
            <span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">scitools.std</span>
            plt <span style="color: #666666">=</span> scitools<span style="color: #666666">.</span>std

        plt<span style="color: #666666">.</span>plot(<span style="color: #AA22FF">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>t, <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>u, <span style="color: #BB4444">&#39;--o&#39;</span>)
        plt<span style="color: #666666">.</span>hold(<span style="color: #BB4444">&#39;on&#39;</span>)
        theta2name <span style="color: #666666">=</span> {<span style="color: #666666">0</span>: <span style="color: #BB4444">&#39;FE&#39;</span>, <span style="color: #666666">1</span>: <span style="color: #BB4444">&#39;BE&#39;</span>, <span style="color: #666666">0.5</span>: <span style="color: #BB4444">&#39;CN&#39;</span>}
        name <span style="color: #666666">=</span> <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>theta2name<span style="color: #666666">.</span>get(<span style="color: #AA22FF">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>theta, <span style="color: #BB4444">&#39;&#39;</span>)
        plt<span style="color: #666666">.</span>legend(<span style="color: #BB4444">&#39;numerical </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BB4444">&#39;</span> <span style="color: #666666">%</span> name)
        <span style="color: #AA22FF; font-weight: bold">if</span> include_exact:
            t_e <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>T, <span style="color: #666666">1001</span>)
            u_e <span style="color: #666666">=</span> <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>exact_solution(t_e)
            plt<span style="color: #666666">.</span>plot(t_e, u_e, <span style="color: #BB4444">&#39;b-&#39;</span>)
            plt<span style="color: #666666">.</span>legend(<span style="color: #BB4444">&#39;exact&#39;</span>)
        plt<span style="color: #666666">.</span>xlabel(<span style="color: #BB4444">&#39;t&#39;</span>)
        plt<span style="color: #666666">.</span>ylabel(<span style="color: #BB4444">&#39;u&#39;</span>)
        plt<span style="color: #666666">.</span>title(<span style="color: #BB4444">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BB4444">, dt=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BB4444">&#39;</span> <span style="color: #666666">%</span>
                  (<span style="color: #AA22FF">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>theta, <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>dt))
        plt<span style="color: #666666">.</span>savefig(<span style="color: #BB4444">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BB4444">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BB4444">.png&#39;</span> <span style="color: #666666">%</span> (name, <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>dt))
        <span style="color: #AA22FF; font-weight: bold">return</span> plt
</pre></div>
<p>

<p>
Note:

<ul>
  <p><li> The <tt>plt</tt> object in <tt>plot</tt> adds a new curve to a plot,
    which enables comparing different solutions from different
    runs of <tt>Solver.solve</tt>
  <p><li> Such different curves gets different colors
</ul>

<h4>Combing the objects  <a name="___sec37"></a></h4>
<p>
Let <tt>Problem</tt>, <tt>Solver</tt>, and <tt>Visualizer</tt> play together:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">main</span>():
    problem <span style="color: #666666">=</span> Problem()
    solver <span style="color: #666666">=</span> Solver(problem)
    viz <span style="color: #666666">=</span> Visualizer(problem, solver)

    <span style="color: #008800; font-style: italic"># Read input from the command line</span>
    parser <span style="color: #666666">=</span> problem<span style="color: #666666">.</span>define_command_line_options()
    parser <span style="color: #666666">=</span> solver<span style="color: #666666">.</span> define_command_line_options(parser)
    args <span style="color: #666666">=</span> parser<span style="color: #666666">.</span>parse_args()
    problem<span style="color: #666666">.</span>init_from_command_line(args)
    solver<span style="color: #666666">.</span> init_from_command_line(args)

    <span style="color: #008800; font-style: italic"># Solve and plot</span>
    solver<span style="color: #666666">.</span>solve()
    plt <span style="color: #666666">=</span> viz<span style="color: #666666">.</span>plot()
    E <span style="color: #666666">=</span> solver<span style="color: #666666">.</span>error()
    <span style="color: #AA22FF; font-weight: bold">if</span> E <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF">None</span>:
        <span style="color: #AA22FF; font-weight: bold">print</span> <span style="color: #BB4444">&#39;Error: </span><span style="color: #BB6688; font-weight: bold">%.4E</span><span style="color: #BB4444">&#39;</span> <span style="color: #666666">%</span> E
    plt<span style="color: #666666">.</span>show()
</pre></div>
<p>

<p>
Complete program: <a href="http://github.hplgit.com/INF5620/src/decay/dc_class.py"><tt>dc_class.py</tt></a>.

<p>

<p>

<h3>Implementing more advanced problem and solver classes  <a name="___sec38"></a></h3>
<p>

<ul>
 <p><li> The previous <tt>Problem</tt> and <tt>Solver</tt> classes soon contain
   much repetitive code when the number of parameters increases
 <p><li> Much of such code can be parameterized and be made more compact
 <p><li> Idea: collect all parameters in a dictionary <tt>self.prms</tt>,
   with two associated dictionaries <tt>self.types</tt> and
   <tt>self.help</tt> for holding associated object types and help strings
 <p><li> Collect common code in class <tt>Parameters</tt>
 <p><li> Let <tt>Problem</tt>, <tt>Solver</tt>, and maybe <tt>Visualizer</tt> be subclasses
   of class <tt>Parameters</tt>, basically defining <tt>self.prms</tt>, <tt>self.types</tt>,
   <tt>self.help</tt>
</ul>

<h4>A generic class for parameters  <a name="___sec39"></a></h4>
<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">class</span> <span style="color: #0000FF">Parameters</span>:
    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">set</span>(<span style="color: #AA22FF">self</span>, <span style="color: #666666">**</span>parameters):
        <span style="color: #AA22FF; font-weight: bold">for</span> name <span style="color: #AA22FF; font-weight: bold">in</span> parameters:
            <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>prms[name] <span style="color: #666666">=</span> parameters[name]

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">get</span>(<span style="color: #AA22FF">self</span>, name):
        <span style="color: #AA22FF; font-weight: bold">return</span> <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>prms[name]

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">define_command_line_options</span>(<span style="color: #AA22FF">self</span>, parser<span style="color: #666666">=</span><span style="color: #AA22FF">None</span>):
        <span style="color: #AA22FF; font-weight: bold">if</span> parser <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF">None</span>:
            <span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">argparse</span>
            parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser()

        <span style="color: #AA22FF; font-weight: bold">for</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>prms:
            tp <span style="color: #666666">=</span> <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>types[name] <span style="color: #AA22FF; font-weight: bold">if</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>types <span style="color: #AA22FF; font-weight: bold">else</span> <span style="color: #AA22FF">str</span>
            help <span style="color: #666666">=</span> <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>help[name] <span style="color: #AA22FF; font-weight: bold">if</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>help <span style="color: #AA22FF; font-weight: bold">else</span> <span style="color: #AA22FF">None</span>
            parser<span style="color: #666666">.</span>add_argument(
                <span style="color: #BB4444">&#39;--&#39;</span> <span style="color: #666666">+</span> name, default<span style="color: #666666">=</span><span style="color: #AA22FF">self</span><span style="color: #666666">.</span>get(name), metavar<span style="color: #666666">=</span>name,
                <span style="color: #AA22FF">type</span><span style="color: #666666">=</span>tp, help<span style="color: #666666">=</span>help)

        <span style="color: #AA22FF; font-weight: bold">return</span> parser

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">init_from_command_line</span>(<span style="color: #AA22FF">self</span>, args):
        <span style="color: #AA22FF; font-weight: bold">for</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>prms:
            <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>prms[name] <span style="color: #666666">=</span> <span style="color: #AA22FF">getattr</span>(args, name)
</pre></div>
<p>

<p>
Slightly more advanced version in <a href="http://github.hplgit.com/INF5620/src/decay/class_dc_verf1.py"><tt>class_dc_verf1.py</tt></a>.

<p>

<h4>The problem class  <a name="___sec34"></a></h4>
<p>

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">class</span> <span style="color: #0000FF">Problem</span>(Parameters):
    <span style="color: #BB4444; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BB4444; font-style: italic">    Physical parameters for the problem u&#39;=-a*u, u(0)=I,</span>
<span style="color: #BB4444; font-style: italic">    with t in [0,T].</span>
<span style="color: #BB4444; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">__init__</span>(<span style="color: #AA22FF">self</span>):
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>prms <span style="color: #666666">=</span> <span style="color: #AA22FF">dict</span>(I<span style="color: #666666">=1</span>, a<span style="color: #666666">=1</span>, T<span style="color: #666666">=10</span>)
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>types <span style="color: #666666">=</span> <span style="color: #AA22FF">dict</span>(I<span style="color: #666666">=</span><span style="color: #AA22FF">float</span>, a<span style="color: #666666">=</span><span style="color: #AA22FF">float</span>, T<span style="color: #666666">=</span><span style="color: #AA22FF">float</span>)
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>help <span style="color: #666666">=</span> <span style="color: #AA22FF">dict</span>(I<span style="color: #666666">=</span><span style="color: #BB4444">&#39;initial condition, u(0)&#39;</span>,
                         a<span style="color: #666666">=</span><span style="color: #BB4444">&#39;coefficient in ODE&#39;</span>,
                         T<span style="color: #666666">=</span><span style="color: #BB4444">&#39;end time of simulation&#39;</span>)

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">exact_solution</span>(<span style="color: #AA22FF">self</span>, t):
        I, a <span style="color: #666666">=</span> <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>get(<span style="color: #BB4444">&#39;I&#39;</span>), <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>get(<span style="color: #BB4444">&#39;a&#39;</span>)
        <span style="color: #AA22FF; font-weight: bold">return</span> I<span style="color: #666666">*</span>np<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>
<p>

<p>

<h4>The solver class  <a name="___sec35"></a></h4>
<p>

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">class</span> <span style="color: #0000FF">Solver</span>(Parameters):
    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">__init__</span>(<span style="color: #AA22FF">self</span>, problem):
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>problem <span style="color: #666666">=</span> problem
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>prms <span style="color: #666666">=</span> <span style="color: #AA22FF">dict</span>(dt<span style="color: #666666">=0.5</span>, theta<span style="color: #666666">=0.5</span>)
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>types <span style="color: #666666">=</span> <span style="color: #AA22FF">dict</span>(dt<span style="color: #666666">=</span><span style="color: #AA22FF">float</span>, theta<span style="color: #666666">=</span><span style="color: #AA22FF">float</span>)
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>help <span style="color: #666666">=</span> <span style="color: #AA22FF">dict</span>(dt<span style="color: #666666">=</span><span style="color: #BB4444">&#39;time step value&#39;</span>,
                         theta<span style="color: #666666">=</span><span style="color: #BB4444">&#39;time discretization parameter&#39;</span>)

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">solve</span>(<span style="color: #AA22FF">self</span>):
        <span style="color: #008800; font-style: italic">#from dc_mod import solver</span>
        <span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">decay_theta</span> <span style="color: #AA22FF; font-weight: bold">import</span> solver
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>u, <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>t <span style="color: #666666">=</span> solver(
            <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>get(<span style="color: #BB4444">&#39;I&#39;</span>),
            <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>get(<span style="color: #BB4444">&#39;a&#39;</span>),
            <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>get(<span style="color: #BB4444">&#39;T&#39;</span>),
            <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>get(<span style="color: #BB4444">&#39;dt&#39;</span>),
            <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>get(<span style="color: #BB4444">&#39;theta&#39;</span>))

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">error</span>(<span style="color: #AA22FF">self</span>):
        <span style="color: #AA22FF; font-weight: bold">try</span>:
            u_e <span style="color: #666666">=</span> <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>exact_solution(<span style="color: #AA22FF">self</span><span style="color: #666666">.</span>t)
            e <span style="color: #666666">=</span> u_e <span style="color: #666666">-</span> <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>u
            E <span style="color: #666666">=</span> np<span style="color: #666666">.</span>sqrt(<span style="color: #AA22FF">self</span><span style="color: #666666">.</span>get(<span style="color: #BB4444">&#39;dt&#39;</span>)<span style="color: #666666">*</span>np<span style="color: #666666">.</span>sum(e<span style="color: #666666">**2</span>))
        <span style="color: #AA22FF; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">AttributeError</span>:
            E <span style="color: #666666">=</span> <span style="color: #AA22FF">None</span>
        <span style="color: #AA22FF; font-weight: bold">return</span> E
</pre></div>
<p>

<p>

<h4>The visualizer class  <a name="___sec36"></a></h4>
<p>

<p>

<ul>
 <p><li> No parameters needed (for this simple problem), no need to inherit
   class <tt>Parameters</tt>
 <p><li> Same code as previously shown class <tt>Visualizer</tt>
 <p><li> Same code as previously shown for combining <tt>Problem</tt>, <tt>Solver</tt>, and
   <tt>Visualizer</tt>
</ul>

<h2>Performing scientific experiments <a name="decay:experiments"></a></h2>
<p>

<p>

<p>
Goal: explore the behavior of a numerical
method for a differential equation and show how scientific experiments
can be set up and reported.

<p>
Tasks:

<p>

<ul>
  <p><li> Write scripts to automate experiments
  <p><li> Generate scientific reports from scripts
</ul>

Tools to learn:

<p>

<ul>
  <p><li> <tt>os.system</tt> for running other programs
  <p><li> <tt>subprocess</tt> for running other programs and extracting the output
  <p><li> List comprehensions
  <p><li> Formats for scientific reports: HTML w/MathJax, LaTeX, Sphinx, Doconce
</ul>

Problem:

<p>
$$
\begin{equation}
u'(t) = -au(t),\quad u(0)=I,\quad 0<t\leq T,
\label{decay:experiments:model}
\end{equation}
$$

<p>
Solution method (\( \theta \)-rule):

<p>
$$
u^{n+1} = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a\Delta t}u^n,
\quad u^0=I\thinspace .
$$

<p>
Tasks:

<p>

<ul>
 <p><li> Plot \( u^n \) against \( \uex = Ie^{-at} \) for
   various choices of the parameters
   \( I \), \( a \), \( \Delta t \), and \( \theta \)
 <p><li> How does the discrete solution compare with the exact solution
   when \( \Delta t \) is varied and \( \theta=0,0.5,1 \)?
 <p><li> Use the <a href="http://github.hplgit.com/INF5620/src/decay/dc_mod.py"><tt>dc_mod.py</tt></a> module (little modification of the plotting, see "`experiments/dc_mod.py`":
</ul>

"http://github.hplgit.com/INF5620/src/decay/experiments/dc_mod.py")

<ul>
 <p><li> Make separate program for running (automating) the experiments (<em>script</em>)

<ol>
   <p><li> <tt>python dc_mod.py --I 1 --a 2 --makeplot --T 5 --dt 0.5 0.25 0.1 0.05</tt>
   <p><li> Combine generated figures <tt>FE_*.png</tt>, <tt>BE_*.png</tt>, and <tt>CN_*.png</tt>
      to new figures with multiple plots
   <p><li> Run script as <tt>python dc_exper0.py 0.5 0.25 0.1 0.05</tt> (\( \Delta t \) values on the command line)
</ol>

</ul>

<center> <! -- figure -->
<hr class="figure">
<center><p class="caption">Figure 4:  Illustration of the Backward Euler method for four time step values. <a name="decay:experiments:fig:BE4a"></a> </p></center>
<p><img src="fig-decay/BE4a.png" align="bottom" width=600,></p>
</center>

<p>

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">os</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">sys</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">glob</span>

<span style="color: #008800; font-style: italic"># The command line must contain dt values</span>
<span style="color: #AA22FF; font-weight: bold">if</span> <span style="color: #AA22FF">len</span>(sys<span style="color: #666666">.</span>argv) <span style="color: #666666">&gt;</span> <span style="color: #666666">1</span>:
    dt_values <span style="color: #666666">=</span> [<span style="color: #AA22FF">float</span>(arg) <span style="color: #AA22FF; font-weight: bold">for</span> arg <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>:]]
<span style="color: #AA22FF; font-weight: bold">else</span>:
    <span style="color: #AA22FF; font-weight: bold">print</span> <span style="color: #BB4444">&#39;Usage: </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BB4444"> dt1 dt2 dt3 ...&#39;</span>;  sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)  <span style="color: #008800; font-style: italic"># abort</span>

<span style="color: #008800; font-style: italic"># Fixed physical parameters</span>
I <span style="color: #666666">=</span> <span style="color: #666666">1</span>
a <span style="color: #666666">=</span> <span style="color: #666666">2</span>
T <span style="color: #666666">=</span> <span style="color: #666666">5</span>

<span style="color: #008800; font-style: italic"># Run module file as a stand-alone application</span>
cmd <span style="color: #666666">=</span> <span style="color: #BB4444">&#39;python dc_mod.py --I </span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BB4444"> --a </span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BB4444"> --makeplot --T </span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BB4444">&#39;</span> <span style="color: #666666">%</span> \
      (I, a, T)
dt_values_str <span style="color: #666666">=</span> <span style="color: #BB4444">&#39; &#39;</span><span style="color: #666666">.</span>join([<span style="color: #AA22FF">str</span>(v) <span style="color: #AA22FF; font-weight: bold">for</span> v <span style="color: #AA22FF; font-weight: bold">in</span> dt_values])
cmd <span style="color: #666666">+=</span> <span style="color: #BB4444">&#39; --dt </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BB4444">&#39;</span> <span style="color: #666666">%</span> dt_values_str
<span style="color: #AA22FF; font-weight: bold">print</span> cmd
failure <span style="color: #666666">=</span> os<span style="color: #666666">.</span>system(cmd)
<span style="color: #AA22FF; font-weight: bold">if</span> failure:
    <span style="color: #AA22FF; font-weight: bold">print</span> <span style="color: #BB4444">&#39;Command failed:&#39;</span>, cmd; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)

<span style="color: #008800; font-style: italic"># Combine images into rows with 2 plots in each row</span>
montage_commands <span style="color: #666666">=</span> []
<span style="color: #AA22FF; font-weight: bold">for</span> method <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #BB4444">&#39;BE&#39;</span>, <span style="color: #BB4444">&#39;CN&#39;</span>, <span style="color: #BB4444">&#39;FE&#39;</span>:
    imagefiles <span style="color: #666666">=</span> [<span style="color: #BB4444">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BB4444">_</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BB4444">.png&#39;</span> <span style="color: #666666">%</span> (method, dt) <span style="color: #AA22FF; font-weight: bold">for</span> dt <span style="color: #AA22FF; font-weight: bold">in</span> dt_values]
    montage_commands<span style="color: #666666">.</span>append(
        <span style="color: #BB4444">&#39;montage -background white -geometry 100%&#39;</span> <span style="color: #666666">+</span> \
        <span style="color: #BB4444">&#39; -tile 2x </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BB4444"> </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BB4444">.png&#39;</span> <span style="color: #666666">%</span> (<span style="color: #BB4444">&#39; &#39;</span><span style="color: #666666">.</span>join(imagefiles), method))

<span style="color: #AA22FF; font-weight: bold">for</span> cmd <span style="color: #AA22FF; font-weight: bold">in</span> montage_commands:
    <span style="color: #AA22FF; font-weight: bold">print</span> cmd
    failure <span style="color: #666666">=</span> os<span style="color: #666666">.</span>system(cmd)
    <span style="color: #AA22FF; font-weight: bold">if</span> failure:
        <span style="color: #AA22FF; font-weight: bold">print</span> <span style="color: #BB4444">&#39;Command failed:&#39;</span>, cmd; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)

<span style="color: #008800; font-style: italic"># Remove the files generated by dc_mod.py</span>
filenames <span style="color: #666666">=</span> glob<span style="color: #666666">.</span>glob(<span style="color: #BB4444">&#39;*_*.png&#39;</span>)
<span style="color: #AA22FF; font-weight: bold">for</span> filename <span style="color: #AA22FF; font-weight: bold">in</span> filenames:
    os<span style="color: #666666">.</span>remove(filename)
</pre></div>
<p>

<p>
Complete program: <a href="http://github.hplgit.com/INF5620/src/decay/experiments/dc_exper0.py"><tt>experiments/dc_exper0.py</tt></a>.

<p>

<p>
Many useful constructs in the program above:

<p>

<ul>
 <p><li> <tt>[float(arg) for arg in sys.argv[1:]]</tt> builds a list of real numbers
   from all the command-line arguments
 <p><li> <tt>failure = os.system(cmd)</tt> runs an operating system command
   (e.g., another program)
 <p><li> <tt>sys.exit(1)</tt> aborts the program
 <p><li> <tt>['%s_%s.png' % (method, dt) for dt in dt_values]</tt> builds a list of
   filenames from a list of numbers (<tt>dt_values</tt>)
 <p><li> All <tt>montage</tt> commands for creating composite figures are stored in a
   list and thereafter executed in a loop
 <p><li> <tt>glob.glob('*_*.png')</tt> returns a list of the names of all files in the
   current folder where the filename matches the <em>Unix wildcard notation</em>
   <tt>*_*.png</tt> (meaning "any text, underscore, any text, and then `.png`")
 <p><li> <tt>os.remove(filename)</tt> removes the file with name <tt>filename</tt>
</ul>

<h3>Interpreting output from other programs  <a name="___sec44"></a></h3>
<p>
Programs that run other programs, like <tt>dc_exper0.py</tt> does, will often
need to interpret output from the other programs.
For example,

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python dc_plot_mpl.py
0.0   0.40:    2.105E-01
0.0   0.04:    1.449E-02
0.5   0.40:    3.362E-02
0.5   0.04:    1.887E-04
1.0   0.40:    1.030E-01
1.0   0.04:    1.382E-02
</pre></div>
<p>

<p>
Tasks:

<p>

<ul>
  <p><li> read the output from the <tt>dc_mod.py</tt> program
  <p><li> interpret this output and store the \( E \) values in arrays for each
    \( \theta \) value
  <p><li> plot \( E \) versus \( \Delta t \), for each \( \theta \), in a log-log plot
</ul>

Must replace <tt>os.system(cmd)</tt> by use of the <tt>subprocess</tt> module:

<p>
<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">subprocess</span> <span style="color: #AA22FF; font-weight: bold">import</span> Popen, PIPE, STDOUT
p <span style="color: #666666">=</span> Popen(cmd, shell<span style="color: #666666">=</span><span style="color: #AA22FF">True</span>, stdout<span style="color: #666666">=</span>PIPE, stderr<span style="color: #666666">=</span>STDOUT)
output, dummy <span style="color: #666666">=</span> p<span style="color: #666666">.</span>communicate()
failure <span style="color: #666666">=</span> p<span style="color: #666666">.</span>returncode
<span style="color: #AA22FF; font-weight: bold">if</span> failure:
    <span style="color: #AA22FF; font-weight: bold">print</span> <span style="color: #BB4444">&#39;Command failed:&#39;</span>, cmd; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)
</pre></div>
<p>

<p>
Note: The command stored in <tt>cmd</tt> is run and all text that is written to
the standard output <em>and</em> the standard error is available in the
string <tt>output</tt>. The text in <tt>output</tt> is what appeared in the
terminal window while running <tt>cmd</tt>.

<p>
Next tasks:

<p>

<ul>
 <p><li> Run through the <tt>output</tt> string, line by line
 <p><li> If the current line prints \( \theta \), \( \Delta t \), and \( E \),
   split the line into these three pieces and store the data
 <p><li> Store data in a dictionary <tt>errors</tt> with keys <tt>dt</tt> and
   the three \( \theta \) values
</ul>

<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">errors <span style="color: #666666">=</span> {<span style="color: #BB4444">&#39;dt&#39;</span>: dt_values, <span style="color: #666666">1</span>: [], <span style="color: #666666">0</span>: [], <span style="color: #666666">0.5</span>: []}
<span style="color: #AA22FF; font-weight: bold">for</span> line <span style="color: #AA22FF; font-weight: bold">in</span> output<span style="color: #666666">.</span>splitlines():
    words <span style="color: #666666">=</span> line<span style="color: #666666">.</span>split()
    <span style="color: #AA22FF; font-weight: bold">if</span> words[<span style="color: #666666">0</span>] <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #BB4444">&#39;0.0&#39;</span>, <span style="color: #BB4444">&#39;0.5&#39;</span>, <span style="color: #BB4444">&#39;1.0&#39;</span>):  <span style="color: #008800; font-style: italic"># line with E?</span>
        <span style="color: #008800; font-style: italic"># typical line: 0.0   1.25:    7.463E+00</span>
        theta <span style="color: #666666">=</span> <span style="color: #AA22FF">float</span>(words[<span style="color: #666666">0</span>])
        E <span style="color: #666666">=</span> <span style="color: #AA22FF">float</span>(words[<span style="color: #666666">2</span>])
        errors[theta]<span style="color: #666666">.</span>append(E)
</pre></div>
<p>

<p>

<ul>
 <p><li> Plot \( E \) versus \( \Delta t \) for \( \theta=0,0.5,1 \)
</ul>

<p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #AA22FF; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>
<span style="color: #008800; font-style: italic">#import scitools.std as plt</span>
plt<span style="color: #666666">.</span>loglog(errors[<span style="color: #BB4444">&#39;dt&#39;</span>], errors[<span style="color: #666666">0</span>], <span style="color: #BB4444">&#39;ro-&#39;</span>)
plt<span style="color: #666666">.</span>hold(<span style="color: #BB4444">&#39;on&#39;</span>)  <span style="color: #008800; font-style: italic"># MATLAB style...</span>
plt<span style="color: #666666">.</span>loglog(errors[<span style="color: #BB4444">&#39;dt&#39;</span>], errors[<span style="color: #666666">0.5</span>], <span style="color: #BB4444">&#39;b+-&#39;</span>)
plt<span style="color: #666666">.</span>loglog(errors[<span style="color: #BB4444">&#39;dt&#39;</span>], errors[<span style="color: #666666">1</span>], <span style="color: #BB4444">&#39;gx-&#39;</span>)
plt<span style="color: #666666">.</span>legend([<span style="color: #BB4444">&#39;FE&#39;</span>, <span style="color: #BB4444">&#39;CN&#39;</span>, <span style="color: #BB4444">&#39;BE&#39;</span>], loc<span style="color: #666666">=</span><span style="color: #BB4444">&#39;upper left&#39;</span>)
plt<span style="color: #666666">.</span>xlabel(<span style="color: #BB4444">&#39;log(time step)&#39;</span>)
plt<span style="color: #666666">.</span>ylabel(<span style="color: #BB4444">&#39;log(error)&#39;</span>)
plt<span style="color: #666666">.</span>title(<span style="color: #BB4444">&#39;Error vs time step&#39;</span>)
plt<span style="color: #666666">.</span>savefig(<span style="color: #BB4444">&#39;error_BE_CN_FE.png&#39;</span>)
</pre></div>
<p>
This is a log-log plot because we expect \( E\sim\Delta t^r \).

<p>

<p>
<center> <! -- figure -->
<hr class="figure">
<center><p class="caption">Figure 5:  Default plot (left) and manually adjusted plot (right). <a name="decay:exper:Evsdt"></a> </p></center>
<p><img src="fig-decay/error_plot_improvement.png" align="bottom" width=800,></p>
</center>

<p>

<p>
Complete program: <a href="http://github.hplgit.com/INF5620/src/decay/experiments/dc_exper1.py"><tt>experiments/dc_exper1.py</tt></a>.
Fine recipe for

<p>

<ul>
  <p><li> how to run other programs
  <p><li> how to extract and interpret output from other programs
  <p><li> how to automate many manual steps in creating simulations and figures
</ul>

<h3>Making a report <a name="decay:exper:report"></a></h3>
<p>

<p>

<ul>
 <p><li> Scientific investigations are best documented in a report!
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/sphinx-cloud/">A sample report</a>
 <p><li> How can we write such a report?
 <p><li> First problem: what format should I write in?
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report_html.html">Plain HTML</a>, generated by <a href="http://github.hplgit.com/INF5620/src/decay/experiments/dc_exper1_html.py"><tt>dc_exper1_html.py</tt></a>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report_html_mathjax.html">HTML with MathJax</a>, generated by <a href="http://github.hplgit.com/INF5620/src/decay/experiments/dc_exper1_html.py"><tt>dc_exper1_mathjax.py</tt></a>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report.pdf">LaTeX PDF</a>, based on <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report.tex.html">LaTeX source</a>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/sphinx-cloud/index.html">Sphinx HTML</a>, based on <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report_sphinx.rst.html">reStructuredText</a>
 <p><li> Markdown, MediaWiki, ...
 <p><li> <a href="http://code.google.com/p/doconce">Doconce</a> can generate LaTeX, HTML w/MathJax, Sphinx, Markdown, MediaWiki, ... (<a href="http://hplgit.github.com/INF5620/doc/writing_reports/report.do.txt.html">Doconce source</a> for the examples above, and Python program for <a href="http://github.hplgit.com/INF5620/src/decay/experiments/dc_exper1_do.py">generating the Doconce source</a>)
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/">Examples on different report formats</a>
</ul>

<h3>Publishing a complete project <a name="decay:exper:github"></a></h3>
<p>

<p>

<ul>
 <p><li> Make folder (directory) tree
 <p><li> Keep track of all files via a <em>version control system</em> (Mercurial, Git, ...)
 <p><li> Publish as private or public repository
 <p><li> Utilize Bitbucket, Googlecode, GitHub, or similar
 <p><li> See the <a href="http://hplgit.github.com/teamods/bitgit/html/">intro to such tools</a>
</ul>


<!-- ------------------- end of main content ----------------->
</body>
</html>
    

