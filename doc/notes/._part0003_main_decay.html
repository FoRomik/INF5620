<!DOCTYPE html>
<!--
Automatically generated HTML file from Doconce source
(https://github.com/hplgit/doconce/)
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Doconce: https://github.com/hplgit/doconce/" />
<meta name="description" content="Introduction to computing with finite difference methods">
<meta name="keywords" content="decay (problem),exponential decay,mesh,grid,mesh function,finite differences,difference equation,discrete equation,algebraic equation,finite difference scheme,Forward Euler scheme,backward scheme, 1-step,Backward Euler scheme,Crank-Nicolson scheme,weighted average,theta-rule,$\theta$-rule,$\theta$-rule,finite difference operator notation,operator notation, finite differences,directory,folder,doc strings,printf format (Python),format string syntax (Python),representative (mesh function),array arithmetics,array computing,continuous function norms,norm continuous,discrete function norms,mesh function norms,norm discrete (mesh function),scalar computing,PNG plot,PDF plot,EPS plot,view PNG plot,view PDF plot,view EPS plot,cropping images,user interfaces to programs,command-line interfaces,reading the command line,list comprehension,option-value pairs (command line),command-line options and values,reading the command line,convergence rate,dictionary,verification,modules (Python),test block (Python modules),module import,doctests,software testing doctests,unit testing,software testing nose,software testing nose w/doctests,unit testing,software testing unit testing,problem class,solver class,wrapper (code),visualizer class,problem class,solver class,visualizer class,numerical experiments,scientific experiments,script,Unix wildcard notation,wildcard notation (Unix),stability,amplification factor,A-stable methods,L-stable methods,consistency,stability,convergence,lambda functions,method of manufactured solutions,MMS (method of manufactured solutions),backward scheme, 2-step,BDF2 scheme,implicit schemes,explicit schemes,theta-rule,$\theta$-rule,Leapfrog scheme,Leapfrog scheme, filtered,Heun's method,Runge-Kutta, 2nd-order scheme,Taylor-series methods (for ODEs),Adams-Bashforth scheme, 2nd-order,Adams-Bashforth scheme, 3rd order,Runge-Kutta, 4th-order scheme,RK4,adaptive time stepping,Dormand-Prince Runge-Kutta 4-5 method,population dynamics,logistic model,radioactive decay,terminal velocity,geometric average,averaging geometric,scaling">



<style type="text/css">
    /* blueish style */

    /* Color definitions:  http://www.december.com/html/spec/color0.html
       CSS examples:       http://www.w3schools.com/css/css_examples.asp */

    body {
      margin-top: 1.0em;
      background-color: #ffffff;
      font-family: Helvetica, Arial, FreeSans, san-serif;
      color: #000000;
    }
    h1 { font-size: 1.8em; color: #1e36ce; }
    h2 { font-size: 1.5em; color: #1e36ce; }
    h3 { color: #1e36ce; }
    a { color: #1e36ce; text-decoration:none; }
    tt { font-family: "Courier New", Courier; }
    
    p { text-indent: 0px; }
    hr { border: 0; width: 80%; border-bottom: 1px solid #aaa}
    p.caption { width: 80%; font-style: normal; text-align: left; }
    hr.figure { border: 0; width: 80%; border-bottom: 1px solid #aaa}
    .alert-text-small   { font-size: 80%;  }
    .alert-text-large   { font-size: 130%; }
    .alert-text-normal  { font-size: 90%;  }
    .alert {
             padding:8px 35px 8px 14px; margin-bottom:18px;
             text-shadow:0 1px 0 rgba(255,255,255,0.5);
             border:1px solid #bababa;
             -webkit-border-radius: 4px; -moz-border-radius: 4px;
             border-radius: 4px
             color: #555;
             background-color: #f8f8f8;
             background-position: 10px 5px;
             background-repeat: no-repeat;
             background-size: 38px;
             padding-left: 55px;
             width: 75%;
     }
     .alert-block {padding-top:14px; padding-bottom:14px}
     .alert-block > p, .alert-block > ul {margin-bottom:0}
     .alert li {margin-top: 1em}
     .alert-block p+p {margin-top:5px}
     .alert-notice { background-image: url(https://doconce.googlecode.com/hg/bundled/html_images/small_gray_notice.png); }
     .alert-summary  { background-image:url(https://doconce.googlecode.com/hg/bundled/html_images/small_gray_summary.png); }
     .alert-warning { background-image: url(https://doconce.googlecode.com/hg/bundled/html_images/small_gray_warning.png); }
     .alert-question {background-image:url(https://doconce.googlecode.com/hg/bundled/html_images/small_gray_question.png); }

</style>

</head>

<!-- tocinfo
{'highest level': 1,
 'sections': [(' Finite difference methods  ',
               1,
               'decay:basics',
               'decay:basics'),
              (' A basic model for exponential decay ',
               2,
               'decay:model',
               'decay:model'),
              (' The Forward Euler scheme ',
               2,
               'decay:schemes:FE',
               'decay:schemes:FE'),
              (' Step 1: Discretizing the domain ', 3, None, '___sec3'),
              (' Step 2: Fulfilling the equation at discrete time points ',
               3,
               None,
               '___sec4'),
              (' Step 3: Replacing derivatives by finite differences ',
               3,
               None,
               '___sec5'),
              (' Step 4: Formulating a recursive algorithm ',
               3,
               None,
               '___sec6'),
              (' The Backward Euler scheme ',
               2,
               'decay:schemes:BE',
               'decay:schemes:BE'),
              (' The Crank-Nicolson scheme ',
               2,
               'decay:schemes:CN',
               'decay:schemes:CN'),
              (' The unifying $\\theta$-rule ',
               2,
               'decay:schemes:theta',
               'decay:schemes:theta'),
              (' Constant time step ', 2, None, '___sec10'),
              (' Compact operator notation for finite differences ',
               2,
               'decay:fd:op',
               'decay:fd:op'),
              (' Implementation ', 1, 'decay:impl1', 'decay:impl1'),
              (' Making a solver function ', 2, 'decay:py1', 'decay:py1'),
              (' Function for computing the numerical solution ',
               3,
               None,
               '___sec14'),
              (' Integer division ', 3, None, '___sec15'),
              (' Doc strings ', 3, None, '___sec16'),
              (' Formatting of numbers ', 3, None, '___sec17'),
              (' Running the program ', 3, None, '___sec18'),
              (' Verifying the implementation ', 2, None, '___sec19'),
              (' Running a few algorithmic steps by hand ',
               3,
               None,
               '___sec20'),
              (' Comparison with an exact discrete solution ',
               3,
               None,
               '___sec21'),
              (' Computing the numerical error as a mesh function ',
               2,
               'decay:computing:error',
               'decay:computing:error'),
              (' Computing the norm of the numerical error ',
               2,
               'decay:computing:error:norm',
               'decay:computing:error:norm'),
              (' Scalar computing ', 3, None, '___sec24'),
              (' Plotting solutions ', 2, 'decay:plotting', 'decay:plotting'),
              (' Plotting multiple curves ', 3, None, '___sec26'),
              (' Experiments with computing and plotting ',
               3,
               None,
               '___sec27'),
              (' Combining plot files ', 3, None, '___sec28'),
              (' Plotting with SciTools ', 3, None, '___sec29'),
              (' Creating command-line interfaces ', 2, None, '___sec30'),
              (' Reading a sequence of command-line arguments ',
               3,
               None,
               '___sec31'),
              (' Working with an argument parser ', 3, None, '___sec32'),
              (' Creating a graphical web user interface ',
               2,
               None,
               '___sec33'),
              (' Making a compute function ', 3, None, '___sec34'),
              (' Generating the user interface ', 3, None, '___sec35'),
              (' Running the web application ', 3, None, '___sec36'),
              (' Computing convergence rates ',
               2,
               'decay:convergence:rate',
               'decay:convergence:rate'),
              (' Estimating $r$ ', 3, None, '___sec38'),
              (' Implementation ', 3, None, '___sec39'),
              (' Debugging via convergence rates ', 3, None, '___sec40'),
              (' Memory-saving implementation ', 2, None, '___sec41'),
              (' Software engineering ', 1, None, '___sec42'),
              (' Making a module ',
               2,
               'decay:prog:se:module',
               'decay:prog:se:module'),
              (' Prefixing imported functions by the module name ',
               2,
               'decay:prog:se:import',
               'decay:prog:se:import'),
              (' Doctests ',
               2,
               'decay:prog:se:doctest',
               'decay:prog:se:doctest'),
              (' Unit testing with nose ',
               2,
               'decay:prog:se:nose',
               'decay:prog:se:nose'),
              (' Basic use of nose ', 3, None, '___sec47'),
              (' Alternative assert statements ', 3, None, '___sec48'),
              (' Applying nose ', 3, None, '___sec49'),
              (' Installation of nose ', 3, None, '___sec50'),
              (' Using nose to test modules with doctests ',
               3,
               None,
               '___sec51'),
              (' Classical class-based unit testing ',
               2,
               'decay:prog:se:unittest',
               'decay:prog:se:unittest'),
              (' Basic use of unittest ', 3, None, '___sec53'),
              (' Demonstration of unittest ', 3, None, '___sec54'),
              (' Implementing simple problem and solver classes ',
               2,
               'decay:prog:se:class',
               'decay:prog:se:class'),
              (' The problem class ', 3, None, '___sec56'),
              (' The solver class ', 3, None, '___sec57'),
              (' The visualizer class ', 3, None, '___sec58'),
              (' Combing the objects ', 3, None, '___sec59'),
              (' Improving the problem and solver classes ',
               2,
               'decay:prog:se:class2',
               'decay:prog:se:class2'),
              (' A generic class for parameters ', 3, None, '___sec61'),
              (' The problem class ', 3, None, '___sec62'),
              (' The solver class ', 3, None, '___sec63'),
              (' The visualizer class ', 3, None, '___sec64'),
              (' Performing scientific experiments ',
               1,
               'decay:experiments',
               'decay:experiments'),
              (' Software ', 2, None, '___sec66'),
              (' Combining plot files ', 2, None, '___sec67'),
              (' Interpreting output from other programs ',
               2,
               None,
               '___sec68'),
              (' Making a report ',
               2,
               'decay:exper:report',
               'decay:exper:report'),
              (' Plain HTML ', 3, None, '___sec70'),
              (' HTML with MathJax ', 3, None, '___sec71'),
              (' LaTeX ', 3, None, '___sec72'),
              (' Sphinx ', 3, None, '___sec73'),
              (' Markdown ', 3, None, '___sec74'),
              (' Wiki formats ', 3, None, '___sec75'),
              (' Doconce ', 3, None, '___sec76'),
              (' Worked example ', 3, None, '___sec77'),
              (' Publishing a complete project ',
               2,
               'decay:exper:github',
               'decay:exper:github'),
              (' Exercises ', 1, None, '___sec79'),
              (' Exercise 1: Experiment with integer division ',
               2,
               'decay:exer:intdiv',
               'decay:exer:intdiv'),
              (' Exercise 2: Experiment with wrong computations ',
               2,
               'decay:exer:decay1err',
               'decay:exer:decay1err'),
              (' Exercise 3: Plot the error function ',
               2,
               'decay:exer:plot:error',
               'decay:exer:plot:error'),
              (' Exercise 4: Compare methods for a given time mesh ',
               2,
               'decay:exer:plot:dtconst',
               'decay:exer:plot:dtconst'),
              (' Exercise 5: Change formatting of numbers and debug ',
               2,
               'decay:exer:inexact:output',
               'decay:exer:inexact:output'),
              (' Problem 1: Write a doctest ',
               2,
               'decay:exer:doctest1',
               'decay:exer:doctest1'),
              (' Problem 2: Write a nose test ',
               2,
               'decay:exer:nosetest1',
               'decay:exer:nosetest1'),
              (' Problem 3: Make a module ',
               2,
               'decay:exer:module1',
               'decay:exer:module1'),
              (' Exercise 6: Make use of a class implementation ',
               2,
               'decay:exer:decay_class:exper',
               'decay:exer:decay_class:exper'),
              (' Exercise 7: Generalize a class implementation ',
               2,
               'decay:exer:decay_class2',
               'decay:exer:decay_class2'),
              (' Exercise 8: Generalize an advanced class implementation ',
               2,
               'decay:exer:decay_class3',
               'decay:exer:decay_class3'),
              (' Analysis of finite difference equations ',
               1,
               'decay:analysis',
               'decay:analysis'),
              (' Discouraging numerical solutions ', 3, None, '___sec92'),
              (' Experimental investigation of oscillatory solutions ',
               2,
               None,
               '___sec93'),
              (' Exact numerical solution ', 2, None, '___sec94'),
              (' Stability ', 2, None, '___sec95'),
              (' Comparing amplification factors ', 2, None, '___sec96'),
              (' Series expansion of amplification factors ',
               2,
               None,
               '___sec97'),
              (' The fraction of numerical and exact amplification factors ',
               2,
               None,
               '___sec98'),
              (' The true error at a point ',
               2,
               'decay:analysis:gobal:error',
               'decay:analysis:gobal:error'),
              (' Integrated errors ', 2, None, '___sec100'),
              (' Truncation error ', 2, None, '___sec101'),
              (' Consistency, stability, and convergence ',
               2,
               None,
               '___sec102'),
              (' Exercises ', 1, None, '___sec103'),
              (' Exercise 9: Visualize the accuracy of finite differences $u=e^{-at}$ ',
               2,
               'decay:analysis:exer:fd:exp:plot',
               'decay:analysis:exer:fd:exp:plot'),
              (' Exercise 10: Explore the $\\theta$-rule for exponential growth ',
               2,
               'decay:analysis:exer:growth',
               'decay:analysis:exer:growth'),
              (' Model extensions ', 1, None, '___sec106'),
              (' Generalization: including a variable coefficient ',
               2,
               None,
               '___sec107'),
              (' Generalization: including a source term ',
               2,
               'decay:source',
               'decay:source'),
              (' Schemes ', 3, None, '___sec109'),
              (' Implementation of the generalized model problem ',
               2,
               'decay:general',
               'decay:general'),
              (' Deriving the $\\theta$-rule formula ', 3, None, '___sec111'),
              (' The Python code ', 3, None, '___sec112'),
              (' Coding of variable coefficients ', 3, None, '___sec113'),
              (' Verifying a constant solution ',
               2,
               'decay:verify:trivial',
               'decay:verify:trivial'),
              (' Verification via manufactured solutions ',
               2,
               'decay:MMS',
               'decay:MMS'),
              (' Extension to systems of ODEs ', 2, None, '___sec116'),
              (' General first-order ODEs ', 1, None, '___sec117'),
              (' Generic form ', 2, None, '___sec118'),
              (' Some popular schemes for ODEs ', 2, None, '___sec119'),
              (' The $\\theta$-rule ', 3, None, '___sec120'),
              (' Implicit 2-step backward scheme ', 3, None, '___sec121'),
              (' The Leapfrog scheme ', 3, None, '___sec122'),
              (' The filtered Leapfrog scheme ', 3, None, '___sec123'),
              (' 2nd-order Runge-Kutta scheme ', 3, None, '___sec124'),
              (' A 2nd-order Taylor-series method ', 3, None, '___sec125'),
              (' 2nd-order Adams-Bashforth scheme ', 3, None, '___sec126'),
              (' 3rd-order Adams-Bashforth scheme ', 3, None, '___sec127'),
              (' 4th-order Runge-Kutta scheme ', 3, None, '___sec128'),
              (' The Odespy software ', 2, None, '___sec129'),
              (' Example: Runge-Kutta methods  ', 2, None, '___sec130'),
              (' Remark about using the $\\theta$-rule in Odespy ',
               3,
               None,
               '___sec131'),
              (' Example: Adaptive Runge-Kutta methods  ',
               2,
               None,
               '___sec132'),
              (' Exercises ', 1, None, '___sec133'),
              (' Exercise 11: Experiment with precision in tests and the size of $u$ ',
               2,
               'decay:fd2:exer:precision',
               'decay:fd2:exer:precision'),
              (' Exercise 12: Implement the 2-step backward scheme ',
               2,
               'decay:fd2:exer:bw2',
               'decay:fd2:exer:bw2'),
              (' Exercise 13: Implement the 2nd-order Adams-Bashforth scheme ',
               2,
               'decay:fd2:exer:AB2',
               'decay:fd2:exer:AB2'),
              (' Exercise 14: Implement the 3rd-order Adams-Bashforth scheme ',
               2,
               'decay:fd2:exer:AB3',
               'decay:fd2:exer:AB3'),
              (' Exercise 15: Analyze explicit 2nd-order methods ',
               2,
               'decay:exer:RK2:Taylor:analysis',
               'decay:exer:RK2:Taylor:analysis'),
              (' Problem 4: Implement and investigate the Leapfrog scheme ',
               2,
               'decay:fd2:exer:leapfrog1',
               'decay:fd2:exer:leapfrog1'),
              (' Problem 5: Make a unified implementation of many schemes ',
               2,
               'decay:fd2:exer:uni',
               'decay:fd2:exer:uni'),
              (' Applications of exponential decay models ',
               1,
               'decay:app',
               'decay:app'),
              (' Scaling ', 2, 'decay:app:scaling', 'decay:app:scaling'),
              (' Evolution of a population ',
               2,
               'decay:app:pop',
               'decay:app:pop'),
              (' Compound interest and inflation ',
               2,
               'decay:app:interest',
               'decay:app:interest'),
              (' Radioactive Decay ',
               2,
               'decay:app:nuclear',
               'decay:app:nuclear'),
              (' Deterministic model ', 3, None, '___sec146'),
              (' Stochastic model ', 3, None, '___sec147'),
              (' Relation between stochastic and deterministic models ',
               3,
               None,
               '___sec148'),
              (" Newton's law of cooling ",
               2,
               'decay:app:Newton:cooling',
               'decay:app:Newton:cooling'),
              (' Decay of atmospheric pressure with altitude ',
               2,
               'decay:app:atm',
               'decay:app:atm'),
              (' Multiple atmospheric layers ', 3, None, '___sec151'),
              (' Simplification: $L=0$ ', 3, None, '___sec152'),
              (' Simplification: one-layer model ', 3, None, '___sec153'),
              (' Compaction of sediments ',
               2,
               'decay:app:sediment',
               'decay:app:sediment'),
              (' Vertical motion of a body in a viscous fluid ',
               2,
               'decay:app:drag',
               'decay:app:drag'),
              (' Overview of forces ', 3, None, '___sec156'),
              (' Equation of motion ', 3, None, '___sec157'),
              (' Terminal velocity ', 3, None, '___sec158'),
              (' A Crank-Nicolson scheme ', 3, None, '___sec159'),
              (' Physical data ', 3, None, '___sec160'),
              (' Verification ', 3, None, '___sec161'),
              (' Scaling ', 3, None, '___sec162'),
              (' Decay ODEs from solving a PDE by Fourier expansions ',
               2,
               'decay:app:diffusion:Fourier',
               'decay:app:diffusion:Fourier'),
              (' Exercises ', 1, None, '___sec164'),
              (" Exercise 16: Derive schemes for Newton's law of cooling ",
               2,
               'decay:app:exer:cooling:schemes',
               'decay:app:exer:cooling:schemes'),
              (" Exercise 17: Implement schemes for Newton's law of cooling ",
               2,
               'decay:app:exer:cooling:py',
               'decay:app:exer:cooling:py'),
              (' Exercise 18: Find time of murder from body temperature ',
               2,
               'decay:app:exer:cooling:pizza',
               'decay:app:exer:cooling:pizza'),
              (' Exercise 19: Simulate an oscillating cooling process ',
               2,
               'decay:app:exer:cooling:osc',
               'decay:app:exer:cooling:osc'),
              (' Exercise 20: Radioactive decay of Carbon-14 ',
               2,
               'decay:app:exer:radio:C14',
               'decay:app:exer:radio:C14'),
              (' Exercise 21: Simulate stochastic radioactive decay ',
               2,
               'decay:app:exer:stoch:nuclear',
               'decay:app:exer:stoch:nuclear'),
              (' Exercise 22: Radioactive decay of two substances ',
               2,
               'decay:app:exer:radio:twosubst',
               'decay:app:exer:radio:twosubst'),
              (' Exercise 23: Simulate the pressure drop in the atmosphere ',
               2,
               'decay:app:exer:atm1',
               'decay:app:exer:atm1'),
              (' Exercise 24: Make a program for vertical motion in a fluid ',
               2,
               'decay:app:exer:drag:prog',
               'decay:app:exer:drag:prog'),
              (' Exercise 25: Use classes to make a simulation program ',
               2,
               'decay:app:exer:class',
               'decay:app:exer:class'),
              (' Project 1: Simulate parachuting ',
               2,
               'decay:app:exer:parachute',
               'decay:app:exer:parachute'),
              (' Exercise 26: Formulate vertical motion in the atmosphere ',
               2,
               'decay:app:exer:drag:atm1',
               'decay:app:exer:drag:atm1'),
              (' Exercise 27: Simulate vertical motion in the atmosphere ',
               2,
               'decay:app:exer:drag:atm2',
               'decay:app:exer:drag:atm2'),
              (' Exercise 28: Compute $y=|x|$ by solving an ODE ',
               2,
               'decay:app:exer:signum',
               'decay:app:exer:signum'),
              (' Exercise 29: Simulate growth of a fortune with random interest rate ',
               2,
               'decay:app:exer:interest',
               'decay:app:exer:interest'),
              (' Exercise 30: Simulate sudden environmental changes for a population ',
               2,
               'decay:app:exer:pop:at',
               'decay:app:exer:pop:at'),
              (' Exercise 31: Simulate oscillating environment for a population ',
               2,
               'decay:app:exer:pop:osc',
               'decay:app:exer:pop:osc'),
              (' Exercise 32: Simulate logistic growth ',
               2,
               'decay:app:exer:pop:logistic1',
               'decay:app:exer:pop:logistic1'),
              (' Exercise 33: Rederive the equation for continuous compound interest ',
               2,
               'decay:app:exer:interest:derive',
               'decay:app:exer:interest:derive')]}
end of tocinfo -->

<body>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
     equationNumbers: {  autoNumber: "AMS"  },
     extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js"]
  }
});
</script>
<script type="text/javascript"
 src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- Fix slow MathJax rendering in IE8 -->
<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7">


<!-- newcommands_keep.tex -->
$$
\newcommand{\uex}{u_{\small\mbox{e}}}
\newcommand{\Aex}{A_{\small\mbox{e}}}
\newcommand{\half}{\frac{1}{2}}
\newcommand{\halfi}{{1/2}}
\newcommand{\ts}{\thinspace .}

\newcommand{\Ddt}[1]{\frac{D #1}{dt}}
\newcommand{\E}[1]{\hbox{E}\lbrack #1 \rbrack}
\newcommand{\Var}[1]{\hbox{Var}\lbrack #1 \rbrack}
\newcommand{\Std}[1]{\hbox{Std}\lbrack #1 \rbrack}

\newcommand{\xpoint}{\boldsymbol{x}}
\newcommand{\normalvec}{\boldsymbol{n}}
\newcommand{\Oof}[1]{{\cal O}(#1)}

\newcommand{\x}{\boldsymbol{x}}
\newcommand{\X}{\boldsymbol{X}}
\renewcommand{\u}{\boldsymbol{u}}
\renewcommand{\v}{\boldsymbol{v}}
\newcommand{\w}{\boldsymbol{w}}
\newcommand{\V}{\boldsymbol{V}}
\newcommand{\e}{\boldsymbol{e}}
\newcommand{\f}{\boldsymbol{f}}
\newcommand{\F}{\boldsymbol{F}}
\newcommand{\stress}{\boldsymbol{\sigma}}
\newcommand{\strain}{\boldsymbol{\varepsilon}}
\newcommand{\stressc}{{\sigma}}
\newcommand{\strainc}{{\varepsilon}}
\newcommand{\I}{\boldsymbol{I}}
\newcommand{\T}{\boldsymbol{T}}

% Unit vectors
\newcommand{\ii}{\boldsymbol{i}}
\newcommand{\jj}{\boldsymbol{j}}
\newcommand{\kk}{\boldsymbol{k}}
\newcommand{\ir}{\boldsymbol{i}_r}
\newcommand{\ith}{\boldsymbol{i}_{\theta}}
\newcommand{\iz}{\boldsymbol{i}_z}

% Index sets
\newcommand{\Ix}{{\cal I}_x}
\newcommand{\Iy}{{\cal I}_y}
\newcommand{\Iz}{{\cal I}_z}
\newcommand{\It}{{\cal I}_t}
\newcommand{\setb}[1]{{#1}^0}    % set begin
\newcommand{\sete}[1]{{#1}^{-1}} % set end
%\newcommand{\setl}[1]{#1\setminus\{\set1{#1}\}}
%\newcommand{\setr}[1]{#1\setminus\{\set0{#1}\}}
%\newcommand{\seti}[1]{#1\setminus\{\set0{#1},\set1{#1}\}}
\newcommand{\setl}[1]{{#1}^-}
\newcommand{\setr}[1]{{#1}^+}
\newcommand{\seti}[1]{{#1}^i}

% Finite elements
\newcommand{\basphi}{\varphi}
\newcommand{\baspsi}{\psi}
\newcommand{\refphi}{\tilde\basphi}
\newcommand{\psib}{\boldsymbol{\psi}}
\newcommand{\sinL}[1]{\sin\left((#1+1)\pi\frac{x}{L}\right)}
\newcommand{\xno}[1]{x_{#1}}
%\newcommand{\xno}[1]{x^{(#1)}}
\newcommand{\Xno}[1]{X_{(#1)}}
\newcommand{\yno}[1]{y_{#1}}
\newcommand{\Yno}[1]{Y_{(#1)}}
\newcommand{\xdno}[1]{\boldsymbol{x}_{#1}}

% FEniCS commands
\newcommand{\dX}{\, \mathrm{d}X}
\newcommand{\dx}{\, \mathrm{d}x}
\newcommand{\ds}{\, \mathrm{d}s}
\newcommand{\Real}{\mathbb{R}}
\newcommand{\Integerp}{\mathbb{N}}
\newcommand{\Integer}{\mathbb{Z}}
$$




    
<a name="part0003"></a>
<!-- begin top navigation -->
<a href="._part0002_main_decay.html"><img src="https://doconce.googlecode.com/hg/bundled/html_images/prev1.png" border=0 alt="previous"></a>

<a href="._part0004_main_decay.html"><img src="https://doconce.googlecode.com/hg/bundled/html_images/next1.png" border=0 alt="next"></a>
<!-- end top navigation -->

<p>
<!-- !split -->

<h2>Software engineering  <a name="___sec42"></a></h2>

<p>
<div class="alert alert-block alert-notice alert-text-normal"><b>Goal.</b>
Efficient use of differential equation models requires software that is easy to
test and flexible for setting up extensive numerical experiments.
This section introduces three important concepts:

<p>

<ul>
  <li> Modules</li>
  <li> Testing frameworks</li>
  <li> Implementation with classes</li>
</ul>

The concepts are introduced using the differential equation
problem \( u'=-au \), \( u(0)=I \), as example.
</div>
<h3>Making a module <a name="decay:prog:se:module"></a></h3>

<p>
<div class="alert alert-block alert-warning alert-text-normal"><b>The DRY principle.</b>
The previous sections have outlined numerous different programs, all of
them having their own copy of the <code>solver</code> function.  Such copies
of the same piece of code is against the important <em>Don't Repeat
Yourself</em> (DRY) principle in programming.  If we want to change the
<code>solver</code> function there should be <em>one and only one</em> place where the
change needs to be performed.
</div>
<p>
To clean up the repetitive code snippets scattered among the
<code>decay_*.py</code> files, we start by collecting the
various functions we want to keep for the future in one file,
now called <a href="http://tinyurl.com/jvzzcfn/decay/decay_mod.py"><tt>decay_mod.py</tt></a> (<code>mod</code> stands for "module").
The following functions are copied to this file:

<p>

<ul>
 <li> <code>solver</code> for computing the numerical solution</li>
 <li> <code>verify_three_steps</code> for verifying the first three solution
   points against hand calculations</li>
 <li> <code>verify_discrete_solution</code> for verifying the entire computed solution
   against an exact formula for the numerical solution</li>
 <li> <code>explore</code> for computing and plotting the solution</li>
 <li> <code>define_command_line_options</code> for defining option-value pairs
   on the command line</li>
 <li> <code>read_command_line</code> for reading input from the command line,
   now extended to work both with <code>sys.argv</code> directly
   and with an <code>ArgumentParser</code> object</li>
 <li> <code>main</code> for running experiments with \( \theta=0,0.5,1 \) and a series of
   \( \Delta t \) values, and computing convergence rates</li>
 <li> <code>main_GUI</code> for doing the same as the <code>main</code> function, but modified
   for automatic GUI generation</li>
 <li> <code>verify_convergence_rate</code> for verifying the computed convergence
   rates against the theoretically expected values</li>
</ul>

We use Matplotlib for plotting. A sketch of the <code>decay_mod.py</code>
file, with complete versions of the modified functions, looks as follows:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, a, T, dt, theta):
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">verify_three_steps</span>():
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">verify_exact_discrete_solution</span>():
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(t, I, a):
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">explore</span>(I, a, T, dt, theta<span style="color: #666666">=0.5</span>, makeplot<span style="color: #666666">=</span><span style="color: #008000">True</span>):
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>():
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">read_command_line</span>(use_argparse<span style="color: #666666">=</span><span style="color: #008000">True</span>):
    <span style="color: #008000; font-weight: bold">if</span> use_argparse:
        parser <span style="color: #666666">=</span> define_command_line_options()
        args <span style="color: #666666">=</span> parser<span style="color: #666666">.</span>parse_args()
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;I={}, a={}, makeplot={}, dt_values={}&#39;</span><span style="color: #666666">.</span>format(
            args<span style="color: #666666">.</span>I, args<span style="color: #666666">.</span>a, args<span style="color: #666666">.</span>makeplot, args<span style="color: #666666">.</span>dt_values)
        <span style="color: #008000; font-weight: bold">return</span> args<span style="color: #666666">.</span>I, args<span style="color: #666666">.</span>a, args<span style="color: #666666">.</span>makeplot, args<span style="color: #666666">.</span>dt_values
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(sys<span style="color: #666666">.</span>argv) <span style="color: #666666">&lt;</span> <span style="color: #666666">6</span>:
            <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Usage: </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> I a on/off dt1 dt2 dt3 ...&#39;</span> <span style="color: #666666">%</span> \ 
                  sys<span style="color: #666666">.</span>argv[<span style="color: #666666">0</span>]; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)

        I <span style="color: #666666">=</span> <span style="color: #008000">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>])
        a <span style="color: #666666">=</span> <span style="color: #008000">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">2</span>])
        T <span style="color: #666666">=</span> <span style="color: #008000">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">3</span>])
        makeplot <span style="color: #666666">=</span> sys<span style="color: #666666">.</span>argv[<span style="color: #666666">4</span>] <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #BA2121">&#39;on&#39;</span>, <span style="color: #BA2121">&#39;True&#39;</span>)
        dt_values <span style="color: #666666">=</span> [<span style="color: #008000">float</span>(arg) <span style="color: #008000; font-weight: bold">for</span> arg <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv[<span style="color: #666666">5</span>:]]

        <span style="color: #008000; font-weight: bold">return</span> I, a, makeplot, dt_values

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>():
    <span style="color: #666666">...</span>
</pre></div>
<p>
This <code>decay_mod.py</code> file is already a module such that we can import
desired functions in other programs. For example, we can in a file do

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">decay_mod</span> <span style="color: #008000; font-weight: bold">import</span> solver
u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=1.0</span>, a<span style="color: #666666">=3.0</span>, T<span style="color: #666666">=3</span>, dt<span style="color: #666666">=0.01</span>, theta<span style="color: #666666">=0.5</span>)
</pre></div>
<p>
However, it should also be possible to both use <code>decay_mod.py</code> as
a module <em>and</em> execute the file as a program that runs <code>main()</code>. This is
accomplished by ending the file with a <em>test block</em>:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    main()
</pre></div>
<p>
When <code>decay_mod.py</code> is used as a module, <code>__name__</code> equals the module
name <code>decay_mod</code>, while <code>__name__</code> equals <code>'__main__'</code> when the
file is run as a program.
Optionally, we could run the verification tests if the word <code>verify</code>
is present on the command line and <code>verify_convergence_rate</code> could
be tested if <code>verify_rates</code> is found on the command line. The
<code>verify_rates</code> argument must be removed before we read parameter values from
the command line, otherwise the <code>read_command_line</code> function (called by <code>main</code>)
will not work properly.

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&#39;verify&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv:
        <span style="color: #008000; font-weight: bold">if</span> verify_three_steps() <span style="color: #AA22FF; font-weight: bold">and</span> verify_discrete_solution():
            <span style="color: #008000; font-weight: bold">pass</span> <span style="color: #408080; font-style: italic"># ok</span>
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Bug in the implementation!&#39;</span>
    <span style="color: #008000; font-weight: bold">elif</span> <span style="color: #BA2121">&#39;verify_rates&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv:
        sys<span style="color: #666666">.</span>argv<span style="color: #666666">.</span>remove(<span style="color: #BA2121">&#39;verify_rates&#39;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #BA2121">&#39;--dt&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv:
            <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Must assign several dt values&#39;</span>
            sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)  <span style="color: #408080; font-style: italic"># abort</span>
        <span style="color: #008000; font-weight: bold">if</span> verify_convergence_rate():
            <span style="color: #008000; font-weight: bold">pass</span>
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Bug in the implementation!&#39;</span>
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #408080; font-style: italic"># Perform simulations</span>
        main()
</pre></div>

<h3>Prefixing imported functions by the module name <a name="decay:prog:se:import"></a></h3>

<p>
Import statements of the form <code>from module import *</code> import
functions and variables in <code>module.py</code> into the current file.
For example, when doing

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
</pre></div>
<p>
we get mathematical functions like <code>sin</code> and <code>exp</code>
as well as MATLAB-style functions like <code>linspace</code> and <code>plot</code>,
which can be called by these well-known names.
Unfortunately, it sometimes becomes confusing to
know where a particular function comes from. Is it from <code>numpy</code>? Or
<code>matplotlib.pyplot</code>?
Or is it our own function?

<p>
An alternative import is

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span>
</pre></div>
<p>
and such imports require functions to be prefixed by the module name, e.g.,

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">t <span style="color: #666666">=</span> numpy<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, Nt<span style="color: #666666">+1</span>)
u_e <span style="color: #666666">=</span> I<span style="color: #666666">*</span>numpy<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
matplotlib<span style="color: #666666">.</span>pyplot<span style="color: #666666">.</span>plot(t, u_e)
</pre></div>
<p>
This is normally regarded as a better habit because it is explicitly stated
from which module a function comes from.

<p>
The modules <code>numpy</code> and <code>matplotlib.pyplot</code> are so frequently used,
and their full names quite tedious to write, so two standard abbreviations
have evolved in the Python scientific computing community:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>

t <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, Nt<span style="color: #666666">+1</span>)
u_e <span style="color: #666666">=</span> I<span style="color: #666666">*</span>np<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
plt<span style="color: #666666">.</span>plot(t, u_e)
</pre></div>
<p>
A version of the <code>decay_mod</code> module where we use the <code>np</code> and <code>plt</code>
prefixes is found in the file
<a href="http://tinyurl.com/jvzzcfn/decay/decay_mod_prefix.py"><tt>decay_mod_prefix.py</tt></a>.

<p>
The downside of prefixing functions by the module name is that
mathematical expressions like \( e^{-at}\sin(2\pi t) \) get
cluttered with module names,
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">numpy<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)<span style="color: #666666">*</span>numpy<span style="color: #666666">.</span>sin(<span style="color: #666666">2</span>(numpy<span style="color: #666666">.</span>pi<span style="color: #666666">*</span>t)
<span style="color: #408080; font-style: italic"># or</span>
np<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)<span style="color: #666666">*</span>np<span style="color: #666666">.</span>sin(<span style="color: #666666">2*</span>np<span style="color: #666666">.</span>pi<span style="color: #666666">*</span>t)
</pre></div>
<p>
Such an expression looks like <code>exp(-a*t)*sin(2*pi*t)</code> in most
other programming languages. Similarly,
<code>np.linspace</code> and <code>plt.plot</code> look less familiar to people who are
used to MATLAB and who have not adopted Python's prefix style.
Whether to do <code>from module import *</code> or <code>import module</code> depends
on personal taste and the problem at hand. In these writings we use
<code>from module import</code> in shorter programs where similarity with
MATLAB could be an advantage, and where a one-to-one correspondence between
mathematical formulas and Python expressions is important.
The style <code>import module</code> is preferred inside Python modules (see
<a href="._part0005_main_decay.html#decay:exer:module1">Problem 3: Make a module</a> for a demonstration).

<h3>Doctests <a name="decay:prog:se:doctest"></a></h3>

<p>
We have emphasized how important it is to be able to run tests in the
program at any time. This was solved by calling various <code>verify*</code>
functions in the previous examples. However, there exists
well-established procedures and corresponding tools for automating
the execution of tests. We shall briefly demonstrate two important
techniques: <em>doctest</em> and <em>unit testing</em>. The corresponding files are
the modules <a href="http://tinyurl.com/jvzzcfn/decay/decay_mod_doctest.py"><tt>decay_mod_doctest.py</tt></a>
and <a href="http://tinyurl.com/jvzzcfn/decay/decay_mod_unittest.py"><tt>decay_mod_unittest.py</tt></a>.

<p>
Doc strings (the first string after the function header) are used to
document the purpose of functions and their arguments. Very often it
is instructive to include an example on how to use the function.
Interactive examples in the Python shell are most illustrative as
we can see the output resulting from function calls. For example,
we can in the <code>solver</code> function include an example on calling
this function and printing the computed <code>u</code> and <code>t</code> arrays:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, a, T, dt, theta):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.</span>


<span style="color: #BA2121; font-style: italic">    &gt;&gt;&gt; u, t = solver(I=0.8, a=1.2, T=4, dt=0.5, theta=0.5)</span>
<span style="color: #BA2121; font-style: italic">    &gt;&gt;&gt; for t_n, u_n in zip(t, u):</span>
<span style="color: #BA2121; font-style: italic">    ...     print &#39;t=%.1f, u=%.14f&#39; % (t_n, u_n)</span>
<span style="color: #BA2121; font-style: italic">    t=0.0, u=0.80000000000000</span>
<span style="color: #BA2121; font-style: italic">    t=0.5, u=0.43076923076923</span>
<span style="color: #BA2121; font-style: italic">    t=1.0, u=0.23195266272189</span>
<span style="color: #BA2121; font-style: italic">    t=1.5, u=0.12489758761948</span>
<span style="color: #BA2121; font-style: italic">    t=2.0, u=0.06725254717972</span>
<span style="color: #BA2121; font-style: italic">    t=2.5, u=0.03621291001985</span>
<span style="color: #BA2121; font-style: italic">    t=3.0, u=0.01949925924146</span>
<span style="color: #BA2121; font-style: italic">    t=3.5, u=0.01049960113002</span>
<span style="color: #BA2121; font-style: italic">    t=4.0, u=0.00565363137770</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #666666">...</span>
</pre></div>
<p>
When such interactive demonstrations are inserted in doc strings,
Python's <a href="http://docs.python.org/library/doctest.html"><tt>doctest</tt></a>
module can be used to automate running all commands
in interactive sessions and compare new output with the output
appearing in the doc string.  All we have to do in the current example
is to write

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal<span style="color: #666666">&gt;</span> python <span style="color: #666666">-</span>m doctest decay_mod_doctest<span style="color: #666666">.</span>py
</pre></div>
<p>
This command imports the <code>doctest</code> module, which runs all tests.
No additional command-line argument is allowed when running doctests.
If any test fails, the problem is reported, e.g.,

<p>

<!-- code=bash (from !bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python -m doctest decay_mod_doctest.py
********************************************************
File <span style="color: #BA2121">&quot;decay_mod_doctest.py&quot;</span>, line 12, in decay_mod_doctest....
Failed example:
    <span style="color: #008000; font-weight: bold">for </span>t_n, u_n in zip<span style="color: #666666">(</span>t, u<span style="color: #666666">)</span>:
        print <span style="color: #BA2121">&#39;t=%.1f, u=%.14f&#39;</span> % <span style="color: #666666">(</span>t_n, u_n<span style="color: #666666">)</span>
Expected:
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>0.0, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.80000000000000
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>0.5, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.43076923076923
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>1.0, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.23195266272189
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>1.5, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.12489758761948
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>2.0, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.06725254717972
Got:
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>0.0, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.80000000000000
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>0.5, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.43076923076923
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>1.0, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.23195266272189
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>1.5, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.12489758761948
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>2.0, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.06725254718756
********************************************************
1 items had failures:
   1 of   2 in decay_mod_doctest.solver
***Test Failed*** 1 failures.
</pre></div>
<p>
Note that in the output of <code>t</code> and <code>u</code> we write <code>u</code> with 14 digits.
Writing all 16 digits is not a good idea: if the tests are run on
different hardware, round-off errors might be different, and
the <code>doctest</code> module detects that the numbers are not precisely the same
and reports failures. In the present application, where \( 0 < u(t) \leq 0.8 \),
we expect round-off errors to be of size \( 10^{-16} \), so comparing 15
digits would probably be reliable, but we compare 14 to be on the
safe side.

<p>
Doctests are highly encouraged as they do two things: 1) demonstrate
how a function is used and 2) test that the function works.

<p>
Here is an example on a doctest in the <code>explore</code> function:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">explore</span>(I, a, T, dt, theta<span style="color: #666666">=0.5</span>, makeplot<span style="color: #666666">=</span><span style="color: #008000">True</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Run a case with the solver, compute error measure,</span>
<span style="color: #BA2121; font-style: italic">    and plot the numerical and exact solutions (if makeplot=True).</span>

<span style="color: #BA2121; font-style: italic">    &gt;&gt;&gt; for theta in 0, 0.5, 1:</span>
<span style="color: #BA2121; font-style: italic">    ...    E = explore(I=1.9, a=2.1, T=5, dt=0.1, theta=theta,</span>
<span style="color: #BA2121; font-style: italic">    ...                makeplot=False)</span>
<span style="color: #BA2121; font-style: italic">    ...    print &#39;%.10E&#39; % E</span>
<span style="color: #BA2121; font-style: italic">    ...</span>
<span style="color: #BA2121; font-style: italic">    7.3565079236E-02</span>
<span style="color: #BA2121; font-style: italic">    2.4183893110E-03</span>
<span style="color: #BA2121; font-style: italic">    6.5013039886E-02</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #666666">...</span>
</pre></div>
<p>
This time we limit the output to 10 digits.

<p>
<div class="alert alert-block alert-warning alert-text-normal"><b>Warning.</b>
Doctests are not straightforward to construct for
functions that rely on command-line input and that print results to
the terminal window.
</div>
<h3>Unit testing with nose <a name="decay:prog:se:nose"></a></h3>

<p>
The unit testing technique consists of identifying small units
of code, usually functions (or classes), and write one or more tests for
each unit. One test should, ideally, not depend on the outcome of
other tests. For example, the doctest in function <code>solver</code> is a
unit test, and the doctest in function <code>explore</code> as well, but the
latter depends on a working <code>solver</code>. Putting the error computation
and plotting in <code>explore</code> in two separate functions would allow
independent unit tests. In this way, the design of unit tests impacts
the design of functions. The recommended practice is actually to
design and write the unit tests first and <em>then</em> implement the functions!

<p>
In scientific computing it is not always obvious how to best perform
unit testing. The units is naturally larger than in non-scientific
software. Very often the solution procedure of a mathematical problem
identifies a unit.

<h4>Basic use of nose  <a name="___sec47"></a></h4>

<p>
The <code>nose</code> package is a versatile tool for implementing unit tests
in Python. Here is a recommended way of structuring tests:

<p>

<ol>
 <li> Implement tests in functions with names starting with <code>test_</code>.</li>
 <li> The test functions perform assertions on computed results
    using <code>assert</code> functions from the <code>nose.tools</code> module.</li>
 <li> The test functions can be in the source code files or be
    collected in separate files, usually with names starting with <code>test_</code>.</li>
</ol>

Here comes a very simple illustration of the three points.
Assume that we have this function in a module <code>mymod</code>:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">double</span>(n):
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">2*</span>n
</pre></div>
<p>
Either in this file, or in a separate file <code>test_mymod.py</code>, we
implement a test function whose purpose is
to test that the function <code>double</code> works as intended:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">nose.tools</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">nt</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_double</span>():
    result <span style="color: #666666">=</span> mymod<span style="color: #666666">.</span>double(<span style="color: #666666">4</span>)
    nt<span style="color: #666666">.</span>assert_equal(result, <span style="color: #666666">8</span>)
</pre></div>
<p>
We need to do an <code>import mymod</code> if this test is in a separate file, and
Python needs to be able to find <code>mymod</code> (it must be avaliable in
the same directory, installed in a
registered system library or in a directory listed in <code>PYTHONPATH</code>,
or the directory containing <code>mymod.py</code>
must explicitly be added to the <code>sys.path</code> list).

<p>
Running

<p>

<!-- code=bash (from !bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; nosetests -s mymod
</pre></div>
<p>
makes the <code>nose</code> tool run all functions with names matching <code>test_*()</code>
in <code>mymod.py</code>.
Alternatively, if the test functions are in some <code>test_mymod.py</code> file,
we can just write <code>nosetests -s</code>. The nose tool will then look
for all files with names mathching <code>test_*.py</code> and run all
functions <code>test_*()</code> in these files.

<p>
When you have nose tests in files <code>test_*.py</code> it is common to collect
these files in a subdirectory <code>tests</code>, or <code>*_tests</code> if
you have several test subdirectories. Running <code>nosetests -s</code> will
then recursively look for all <code>tests</code> and <code>*_tests</code> subdirectories
and run all functions <code>test_*()</code> in all files <code>test_*.py</code> in these
directories. Just one command can then launch a series of tests in
a directory tree!

<p>
An example of a <code>tests</code> directory with different types of <code>test_*.py</code>
files are found in <a href="http://tinyurl.com/jvzzcfn/decay/tests">src/decay/tests</a>.

<p>
<div class="alert alert-block alert-notice alert-text-normal"><b>Tip.</b>
The <code>-s</code> option to <code>nosetests</code> assures that any print statement
in the <code>test_*</code> functions appears in the output. Without this
option, <code>nosetests</code> suppressed whatever the tests writes to
the terminal window (standard output). Such behavior is annoying,
especially when developing and testing tests.
</div>
<p>
The number of failed tests and their details are
reported, or an <code>OK</code> is printed if all tests passed.

<p>
The advantage with the <code>nose</code> package is two-fold:

<p>

<ol>
<li> tests are written and collected
   in a structured way, and</li>
<li> large collections of tests, scattered
   throughout a tree of directories,
   can be executed with one command <code>nosetests -s</code>.</li>
</ol>

<h4>Alternative assert statements  <a name="___sec48"></a></h4>

<p>
In case the <code>nt.assert_equal</code> function
finds that the two arguments are equal, the test is a success, otherwise
it is a failure and an exception of type <code>AssertionError</code> is raised.
The particular exception is the indicator that a test has failed.

<p>
Instead of calling the convenience function <code>nt.assert_equal</code>, we
can use Python's plain <code>assert</code> statement, which tests if a boolean
expression is true and raises an <code>AssertionError</code> otherwise.
Here, the statement is <code>assert result == 8</code>.

<p>
A completely manual alternative is to explicitly raise an <code>AssertionError</code>
exception if the computed result is wrong:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">if</span> result <span style="color: #666666">!=</span> <span style="color: #666666">8</span>:
    <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #D2413A; font-weight: bold">AssertionError</span>()
</pre></div>

<h4>Applying nose  <a name="___sec49"></a></h4>

<p>
Let us illustrate how to use the <code>nose</code> tool for testing key functions
in the <code>decay_mod</code> module. Or more precisely, the module is called
<code>decay_mod_unittest</code> with all the <code>verify*</code> functions removed
as these now are outdated by the unit tests.

<p>
We design three unit tests:

<p>

<ol>
 <li> A comparison between the computed \( u^n \) values and the
    exact discrete solution.</li>
 <li> A comparison between the computed \( u^n \) values and precomputed,
    verified reference values.</li>
 <li> A comparison between observed and expected convergence rates.</li>
</ol>

These tests follow very closely the code in the previously shown
<code>verify*</code> functions. We start with comparing \( u^n \), as computed by
the function <code>solver</code>, to the formula
for the exact discrete solution:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">nose.tools</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">nt</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">decay_mod_unittest</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">decay_mod</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_discrete_solution</span>(n, I, a, theta, dt):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return exact discrete solution of the theta scheme.&quot;&quot;&quot;</span>
    dt <span style="color: #666666">=</span> <span style="color: #008000">float</span>(dt)  <span style="color: #408080; font-style: italic"># avoid integer division</span>
    factor <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)
    <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>factor<span style="color: #666666">**</span>n

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_against_discrete_solution</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Compare result from solver against</span>
<span style="color: #BA2121; font-style: italic">    formula for the discrete solution.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    theta <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>; a <span style="color: #666666">=</span> <span style="color: #666666">2</span>; I <span style="color: #666666">=</span> <span style="color: #666666">0.1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>
    N <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #666666">8/</span>dt)  <span style="color: #408080; font-style: italic"># no of steps</span>
    u, t <span style="color: #666666">=</span> decay_mod<span style="color: #666666">.</span>solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, T<span style="color: #666666">=</span>N<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)
    u_de <span style="color: #666666">=</span> np<span style="color: #666666">.</span>array([exact_discrete_solution(n, I, a, theta, dt)
                     <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(N<span style="color: #666666">+1</span>)])
    diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u_de <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()
    nt<span style="color: #666666">.</span>assert_almost_equal(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)
</pre></div>
<p>
The <code>nt.assert_almost_equal</code> is the relevant function for comparing two
real numbers. The <code>delta</code> argument specifies a tolerance for the
comparison. Alternatively, one can specify a <code>places</code> argument
for the number of decimal places to be used in the comparison.

<p>
After having carefully verified the implementation, we may
store correctly computed numbers in the test program or in files for
use in future tests. Here is an example on how the outcome from the
<code>solver</code> function can be compared to what is considered to be
correct results:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_solver</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Compare result from solver against</span>
<span style="color: #BA2121; font-style: italic">    precomputed arrays for theta=0, 0.5, 1.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    I<span style="color: #666666">=0.8</span>; a<span style="color: #666666">=1.2</span>; T<span style="color: #666666">=4</span>; dt<span style="color: #666666">=0.5</span>  <span style="color: #408080; font-style: italic"># fixed parameters</span>
    precomputed <span style="color: #666666">=</span> {
        <span style="color: #BA2121">&#39;t&#39;</span>: np<span style="color: #666666">.</span>array([ <span style="color: #666666">0.</span> ,  <span style="color: #666666">0.5</span>,  <span style="color: #666666">1.</span> ,  <span style="color: #666666">1.5</span>,  <span style="color: #666666">2.</span> ,  <span style="color: #666666">2.5</span>,
                        <span style="color: #666666">3.</span> ,  <span style="color: #666666">3.5</span>,  <span style="color: #666666">4.</span> ]),
        <span style="color: #666666">0.5</span>: np<span style="color: #666666">.</span>array(
            [ <span style="color: #666666">0.8</span>       ,  <span style="color: #666666">0.43076923</span>,  <span style="color: #666666">0.23195266</span>, <span style="color: #666666">0.12489759</span>,
              <span style="color: #666666">0.06725255</span>,  <span style="color: #666666">0.03621291</span>,  <span style="color: #666666">0.01949926</span>, <span style="color: #666666">0.0104996</span> ,
              <span style="color: #666666">0.00565363</span>]),
        <span style="color: #666666">0</span>: np<span style="color: #666666">.</span>array(
            [  <span style="color: #666666">8.00000000e-01</span>,   <span style="color: #666666">3.20000000e-01</span>,
               <span style="color: #666666">1.28000000e-01</span>,   <span style="color: #666666">5.12000000e-02</span>,
               <span style="color: #666666">2.04800000e-02</span>,   <span style="color: #666666">8.19200000e-03</span>,
               <span style="color: #666666">3.27680000e-03</span>,   <span style="color: #666666">1.31072000e-03</span>,
               <span style="color: #666666">5.24288000e-04</span>]),
        <span style="color: #666666">1</span>: np<span style="color: #666666">.</span>array(
            [ <span style="color: #666666">0.8</span>       ,  <span style="color: #666666">0.5</span>       ,  <span style="color: #666666">0.3125</span>    ,  <span style="color: #666666">0.1953125</span> ,
              <span style="color: #666666">0.12207031</span>,  <span style="color: #666666">0.07629395</span>,  <span style="color: #666666">0.04768372</span>,  <span style="color: #666666">0.02980232</span>,
              <span style="color: #666666">0.01862645</span>]),
        }
    <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>:
        u, t <span style="color: #666666">=</span> decay_mod<span style="color: #666666">.</span>solver(I, a, T, dt, theta<span style="color: #666666">=</span>theta)
        diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u <span style="color: #666666">-</span> precomputed[theta])<span style="color: #666666">.</span>max()
        <span style="color: #408080; font-style: italic"># Precomputed numbers are known to 8 decimal places</span>
        nt<span style="color: #666666">.</span>assert_almost_equal(diff, <span style="color: #666666">0</span>, places<span style="color: #666666">=8</span>,
                               msg<span style="color: #666666">=</span><span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> theta)
</pre></div>
<p>
The <code>precomputed</code> object is a dictionary with four keys: <code>'t'</code> for the
time mesh, and three \( \theta \) values for \( u^n \) solutions corresponding
to \( \theta=0,0.5,1 \).

<p>
Testing for special type of input data that may cause trouble constitutes
a common way of constructing unit tests.
For example, the updating formula for
\( u^{n+1} \) may be incorrectly evaluated because of unintended integer
divisions. With
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">theta <span style="color: #666666">=</span> <span style="color: #666666">1</span>; a <span style="color: #666666">=</span> <span style="color: #666666">1</span>; I <span style="color: #666666">=</span> <span style="color: #666666">1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">2</span>
</pre></div>
<p>
the nominator and denominator in the updating expression,
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">(<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)
(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)
</pre></div>
<p>
evaluate to 1 and 3, respectively, and the fraction <code>1/3</code> will
call up integer division and consequently lead to <code>u[n+1]=0</code>.
We construct a unit test to make sure <code>solver</code> is smart
enough to avoid this problem:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_potential_integer_division</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Choose variables that can trigger integer division.&quot;&quot;&quot;</span>
    theta <span style="color: #666666">=</span> <span style="color: #666666">1</span>; a <span style="color: #666666">=</span> <span style="color: #666666">1</span>; I <span style="color: #666666">=</span> <span style="color: #666666">1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">2</span>
    N <span style="color: #666666">=</span> <span style="color: #666666">4</span>
    u, t <span style="color: #666666">=</span> decay_mod<span style="color: #666666">.</span>solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, T<span style="color: #666666">=</span>N<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)
    u_de <span style="color: #666666">=</span> np<span style="color: #666666">.</span>array([exact_discrete_solution(n, I, a, theta, dt)
                     <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(N<span style="color: #666666">+1</span>)])
    diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u_de <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()
    nt<span style="color: #666666">.</span>assert_almost_equal(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)
</pre></div>
<p>
The final test is to see that the convergence rates corresponding to
\( \theta=0,0.5, 1 \) are 1, 2, and 1, respectively:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_convergence_rates</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Compare empirical convergence rates to exact ones.&quot;&quot;&quot;</span>
    <span style="color: #408080; font-style: italic"># Set command-line arguments directly in sys.argv</span>
    <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span>
    sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>:] <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;--I 0.8 --a 2.1 --T 5 &#39;</span>\ 
                   <span style="color: #BA2121">&#39;--dt 0.4 0.2 0.1 0.05 0.025&#39;</span><span style="color: #666666">.</span>split()
    <span style="color: #408080; font-style: italic"># Suppress output from decay_mod.main()</span>
    stdout <span style="color: #666666">=</span> sys<span style="color: #666666">.</span>stdout  <span style="color: #408080; font-style: italic"># save standard output for later use</span>
    scratchfile <span style="color: #666666">=</span> <span style="color: #008000">open</span>(<span style="color: #BA2121">&#39;.tmp&#39;</span>, <span style="color: #BA2121">&#39;w&#39;</span>)  <span style="color: #408080; font-style: italic"># fake standard output</span>
    sys<span style="color: #666666">.</span>stdout <span style="color: #666666">=</span> scratchfile

    r <span style="color: #666666">=</span> decay_mod<span style="color: #666666">.</span>main()
    <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> r:
        nt<span style="color: #666666">.</span>assert_true(r[theta])  <span style="color: #408080; font-style: italic"># check for non-empty list</span>

    scratchfile<span style="color: #666666">.</span>close()
    sys<span style="color: #666666">.</span>stdout <span style="color: #666666">=</span> stdout  <span style="color: #408080; font-style: italic"># restore standard output</span>

    expected_rates <span style="color: #666666">=</span> {<span style="color: #666666">0</span>: <span style="color: #666666">1</span>, <span style="color: #666666">1</span>: <span style="color: #666666">1</span>, <span style="color: #666666">0.5</span>: <span style="color: #666666">2</span>}
    <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> r:
        r_final <span style="color: #666666">=</span> r[theta][<span style="color: #666666">-1</span>]
        <span style="color: #408080; font-style: italic"># Compare to 1 decimal place</span>
        nt<span style="color: #666666">.</span>assert_almost_equal(expected_rates[theta], r_final,
                               places<span style="color: #666666">=1</span>, msg<span style="color: #666666">=</span><span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> theta)
</pre></div>
<p>
Nothing more is needed in the <a href="http://tinyurl.com/jvzzcfn/decay/tests/test_decay_nose.py"><tt>test_decay_nose.py</tt></a>
file where the tests reside.
Running <code>nosetests -s</code> will report <code>Ran 3 tests</code> and an <code>OK</code> for
success.  Everytime we modify the <code>decay_mod_unittest</code> module we can
run <code>nosetests</code> to quickly see if the edits have any impact on the
verification tests.

<h4>Installation of nose  <a name="___sec50"></a></h4>

<p>
The <code>nose</code> package does not come with a standard Python distribution and must
therefore be installed separately. The procedure is standard and
described on <a href="http://nose.readthedocs.org/en/latest/">Nose's web pages</a>.  On Debian-based Linux
systems the command is <code>sudo apt-get install python-nose</code>, and
with MacPorts you run <code>sudo port install py27-nose</code>.

<h4>Using nose to test modules with doctests  <a name="___sec51"></a></h4>

<p>
Assume that <code>mod</code> is the name of some module that contains doctests.
We may let <code>nose</code> run these doctests and report errors in the
standard way using the code set-up

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">doctest</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">mod</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_mod</span>():
    failure_count, test_count <span style="color: #666666">=</span> doctest<span style="color: #666666">.</span>testmod(m<span style="color: #666666">=</span>mod)
    nt<span style="color: #666666">.</span>assert_equal(failure_count, <span style="color: #666666">0</span>,
                    msg<span style="color: #666666">=</span><span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121"> tests out of </span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121"> failed&#39;</span> <span style="color: #666666">%</span>
                    (failure_count, test_count))
</pre></div>
<p>
The call to <code>doctest.testmod</code> runs all doctests in the module file
<code>mod.py</code> and returns the number of failures (<code>failure_count</code>)
and the total number of tests (<code>test_count</code>). A real example is
found in the file
<a href="http://tinyurl.com/jvzzcfn/decay/tests/test_decay_doctest.py"><tt>test_decay_doctest.py</tt></a>.

<h3>Classical class-based unit testing <a name="decay:prog:se:unittest"></a></h3>

<p>
The classical way of implementing unit tests derives from the JUnit
tool in Java where all tests are methods in a class for testing.
Python comes with a module <code>unittest</code> for doing this type of unit tests.
While <code>nose</code> allows simple functions for unit tests, <code>unittest</code>
requires deriving a class <code>Test*</code> from <code>unittest.TestCase</code> and
implementing each test as methods with names <code>test_*</code> in that class.
I strongly recommend to use <code>nose</code> over <code>unittest</code>, because it is
much simpler and more convenient, but class-based unit testing
is a very classical subject that computational scientists should
have some knowledge about. That is why a short introduction
to <code>unittest</code> is included below.

<h4>Basic use of unittest  <a name="___sec53"></a></h4>

<p>
We apply the <code>double</code> function in the <code>mymod</code> module introduced in the
previous section as example.
Unit testing with the aid of the <code>unittest</code> module
consists of writing a file <code>test_mymod.py</code> with the content

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">unittest</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">mymod</span>

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">TestMyCode</span>(unittest<span style="color: #666666">.</span>TestCase):
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_double</span>(<span style="color: #008000">self</span>):
        result <span style="color: #666666">=</span> mymod<span style="color: #666666">.</span>double(<span style="color: #666666">4</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>assertEqual(result, <span style="color: #666666">8</span>)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    unittest<span style="color: #666666">.</span>main()
</pre></div>
<p>
The test is run by executing the test file <code>test_mymod.py</code> as a standard
Python program. There is no support in <code>unittest</code> for automatically
locating and running all tests in all test files in a directory tree.

<p>
Those who have experience with object-oriented programming will see that
the difference between using <code>unittest</code> and <code>nose</code> is minor.

<h4>Demonstration of unittest  <a name="___sec54"></a></h4>

<p>
The same tests as shown for the nose framework are reimplemented
with the <code>TestCase</code> classes in the file <a href="http://tinyurl.com/jvzzcfn/decay/tests/test_decay_nose.py"><tt>test_decay_unittest.py</tt></a>.
The tests are identical, the only difference being that with
<code>unittest</code> we must write the tests as methods in
a class and the assert functions have
slightly different names.

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">unittest</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">decay_mod_unittest</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">decay</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_discrete_solution</span>(n, I, a, theta, dt):
    factor <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)
    <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>factor<span style="color: #666666">**</span>n

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">TestDecay</span>(unittest<span style="color: #666666">.</span>TestCase):

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_against_discrete_solution</span>(<span style="color: #008000">self</span>):
        <span style="color: #666666">...</span>
        diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u_de <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>assertAlmostEqual(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_solver</span>(<span style="color: #008000">self</span>):
        <span style="color: #666666">...</span>
        <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>:
            <span style="color: #666666">...</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>assertAlmostEqual(diff, <span style="color: #666666">0</span>, places<span style="color: #666666">=8</span>,
                                   msg<span style="color: #666666">=</span><span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> theta)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_potential_integer_division</span>():
        <span style="color: #666666">...</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>assertAlmostEqual(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_convergence_rates</span>(<span style="color: #008000">self</span>):
        <span style="color: #666666">...</span>
        <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> r:
            <span style="color: #666666">...</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>assertAlmostEqual(<span style="color: #666666">...</span>)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    unittest<span style="color: #666666">.</span>main()
</pre></div>
<p>
<!-- @@@CODE src-decay/tests/test_decay_unittest.py fromto: def test_conv@ -->

<h3>Implementing simple problem and solver classes <a name="decay:prog:se:class"></a></h3>

<p>
The \( \theta \)-rule was compactly and conveniently implemented in
a function <code>solver</code> in the section <a href="._part0002_main_decay.html#decay:py1">Making a solver function</a>.
In more complicated problems it might
be beneficial to use classes and introduce a class <code>Problem</code> to
hold the definition of the physical problem, a class <code>Solver</code>
to hold the data and methods needed to numerically solve the problem,
and a class <code>Visualizer</code> to make plots.
This idea will now be illustrated, resulting in code that represents
an alternative to the <code>solver</code> and <code>explore</code> functions found
in the <code>decay_mod</code> module.

<p>
Explaining the details of class programming in Python is considered
beyond the scope of this text.  Readers who are unfamiliar with Python
class programming should first consult one of the many electronic
Python tutorials or textbooks to come up to speed with concepts and
syntax of Python classes before reading on. The author has a gentle
introduction to class programming for scientific applications
in <a href="._part0009_main_decay.html#Langtangen_2012">[1]</a>, see Chapter 7 and 9 and Appendix E.
Other useful resources are

<p>

<ul>
 <li> The Python Tutorial: <a href="http://docs.python.org/2/tutorial/classes.html"><tt>http://docs.python.org/2/tutorial/classes.html</tt></a></li>
 <li> Wiki book on Python Programming: <a href="http://en.wikibooks.org/wiki/Python_Programming/Classes"><tt>http://en.wikibooks.org/wiki/Python_Programming/Classes</tt></a></li>
 <li> tutorialspoint.com: <a href="http://www.tutorialspoint.com/python/python_classes_objects.htm"><tt>http://www.tutorialspoint.com/python/python_classes_objects.htm</tt></a></li>
</ul>

<h4>The problem class  <a name="___sec56"></a></h4>

<p>
The purpose of the problem class is to store all information about
the mathematical model. This usually means all the physical parameters
in the problem. In the current example with exponential decay we may
also add the exact solution of the ODE to the problem class.
The simplest form of a problem class is therefore

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> exp

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Problem</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, I<span style="color: #666666">=1</span>, a<span style="color: #666666">=1</span>, T<span style="color: #666666">=10</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>T, <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a <span style="color: #666666">=</span> I, <span style="color: #008000">float</span>(a), T

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(<span style="color: #008000">self</span>, t):
        I, a <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a
        <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>
<p>
We could in the <code>exact_solution</code> method have written
<code>self.I*exp(-self.a*t)</code>, but using local variables <code>I</code> and <code>a</code> allows
the formula <code>I*exp(-a*t)</code> which looks closer to the mathematical
expression \( Ie^{-at} \).  This is not an important issue with the
current compact formula, but is beneficial in more complicated
problems with longer formulas to obtain the closest possible
relationship between code and mathematics. My coding style is to strip
off the <code>self</code> prefix when the code expresses mathematical formulas.

<p>
The class data can be set either as arguments in the constructor or
at any time later, e.g.,

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">problem <span style="color: #666666">=</span> Problem(T<span style="color: #666666">=5</span>)
problem<span style="color: #666666">.</span>T <span style="color: #666666">=</span> <span style="color: #666666">8</span>
problem<span style="color: #666666">.</span>dt <span style="color: #666666">=</span> <span style="color: #666666">1.5</span>
</pre></div>
<p>
(Some programmers prefer <code>set</code> and <code>get</code> functions for setting and getting
data in classes, often implemented via <em>properties</em> in Python, but
I consider that overkill when we just have a few data items in a class.)

<p>
It would be convenient if class <code>Problem</code> could also initialize
the data from the command line. To this end, we add a method for
defining a set of command-line options and a method that sets the
local attributes equal to what was found on the command line.
The default values associated with the command-line options are taken
as the values provided to the constructor. Class <code>Problem</code> now becomes

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Problem</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, I<span style="color: #666666">=1</span>, a<span style="color: #666666">=1</span>, T<span style="color: #666666">=10</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>T, <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a <span style="color: #666666">=</span> I, <span style="color: #008000">float</span>(a), T

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>(<span style="color: #008000">self</span>, parser<span style="color: #666666">=</span><span style="color: #008000">None</span>):
        <span style="color: #008000; font-weight: bold">if</span> parser <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
            <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">argparse</span>
            parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser()

        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--I&#39;</span>, <span style="color: #BA2121">&#39;--initial_condition&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
            default<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>I, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;initial condition, u(0)&#39;</span>,
            metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;I&#39;</span>)
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--a&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>, default<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>a,
            help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;coefficient in ODE&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;a&#39;</span>)
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--T&#39;</span>, <span style="color: #BA2121">&#39;--stop_time&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>, default<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>T,
            help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;end time of simulation&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;T&#39;</span>)
        <span style="color: #008000; font-weight: bold">return</span> parser

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">init_from_command_line</span>(<span style="color: #008000">self</span>, args):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a, <span style="color: #008000">self</span><span style="color: #666666">.</span>T <span style="color: #666666">=</span> args<span style="color: #666666">.</span>I, args<span style="color: #666666">.</span>a, args<span style="color: #666666">.</span>T

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(<span style="color: #008000">self</span>, t):
        I, a <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a
        <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>
<p>
Observe that if the user already has an <code>ArgumentParser</code> object it can be
supplied, but if she does not have any, class <code>Problem</code> makes one.
Python's <code>None</code> object is used to indicate that a variable is not
initialized with a proper value.

<h4>The solver class  <a name="___sec57"></a></h4>

<p>
The solver class stores data related to the numerical solution method
and provides a function <code>solve</code> for solving the problem.
A problem object must be given to the constructor so that the solver
can easily look up physical data. In the present example, the
data related to the numerical solution method consists of \( \Delta t \)
and \( \theta \). We add, as in the problem class, functionality for
reading \( \Delta t \) and \( \theta \) from the command line:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Solver</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, problem, dt<span style="color: #666666">=0.1</span>, theta<span style="color: #666666">=0.5</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>problem <span style="color: #666666">=</span> problem
        <span style="color: #008000">self</span><span style="color: #666666">.</span>dt, <span style="color: #008000">self</span><span style="color: #666666">.</span>theta <span style="color: #666666">=</span> <span style="color: #008000">float</span>(dt), theta

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>(<span style="color: #008000">self</span>, parser):
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--dt&#39;</span>, <span style="color: #BA2121">&#39;--time_step_value&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
            default<span style="color: #666666">=0.5</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time step value&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;dt&#39;</span>)
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--theta&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>, default<span style="color: #666666">=0.5</span>,
            help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time discretization parameter&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;dt&#39;</span>)
        <span style="color: #008000; font-weight: bold">return</span> parser

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">init_from_command_line</span>(<span style="color: #008000">self</span>, args):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>dt, <span style="color: #008000">self</span><span style="color: #666666">.</span>theta <span style="color: #666666">=</span> args<span style="color: #666666">.</span>dt, args<span style="color: #666666">.</span>theta

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solve</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">decay_mod</span> <span style="color: #008000; font-weight: bold">import</span> solver
        <span style="color: #008000">self</span><span style="color: #666666">.</span>u, <span style="color: #008000">self</span><span style="color: #666666">.</span>t <span style="color: #666666">=</span> solver(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>a, <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>T,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>dt, <span style="color: #008000">self</span><span style="color: #666666">.</span>theta)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">error</span>(<span style="color: #008000">self</span>):
        u_e <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>exact_solution(<span style="color: #008000">self</span><span style="color: #666666">.</span>t)
        e <span style="color: #666666">=</span> u_e <span style="color: #666666">-</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>u
        E <span style="color: #666666">=</span> sqrt(<span style="color: #008000">self</span><span style="color: #666666">.</span>dt<span style="color: #666666">*</span><span style="color: #008000">sum</span>(e<span style="color: #666666">**2</span>))
        <span style="color: #008000; font-weight: bold">return</span> E
</pre></div>
<p>
Note that we here simply reuse the implementation of the numerical method
from the <code>decay_mod</code> module. The <code>solve</code> function is just a <em>wrapper</em>
of the previously developed stand-alone <code>solver</code> function.

<h4>The visualizer class  <a name="___sec58"></a></h4>

<p>
The purpose of the visualizer class is to plot the numerical solution
stored in class <code>Solver</code>. We also add the possibility to plot the
exact solution. Access to the problem and solver objects is required
when making plots so the constructor must hold references to these objects:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Visualizer</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, problem, solver):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>problem, <span style="color: #008000">self</span><span style="color: #666666">.</span>solver <span style="color: #666666">=</span> problem, solver

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">plot</span>(<span style="color: #008000">self</span>, include_exact<span style="color: #666666">=</span><span style="color: #008000">True</span>, plt<span style="color: #666666">=</span><span style="color: #008000">None</span>):
        <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">        Add solver.u curve to the plotting object plt,</span>
<span style="color: #BA2121; font-style: italic">        and include the exact solution if include_exact is True.</span>
<span style="color: #BA2121; font-style: italic">        This plot function can be called several times (if</span>
<span style="color: #BA2121; font-style: italic">        the solver object has computed new solutions).</span>
<span style="color: #BA2121; font-style: italic">        &quot;&quot;&quot;</span>
        <span style="color: #008000; font-weight: bold">if</span> plt <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
            <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">scitools.std</span>  <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span> <span style="color: #408080; font-style: italic"># can use matplotlib as well</span>

        plt<span style="color: #666666">.</span>plot(<span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>t, <span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>u, <span style="color: #BA2121">&#39;--o&#39;</span>)
        plt<span style="color: #666666">.</span>hold(<span style="color: #BA2121">&#39;on&#39;</span>)
        theta2name <span style="color: #666666">=</span> {<span style="color: #666666">0</span>: <span style="color: #BA2121">&#39;FE&#39;</span>, <span style="color: #666666">1</span>: <span style="color: #BA2121">&#39;BE&#39;</span>, <span style="color: #666666">0.5</span>: <span style="color: #BA2121">&#39;CN&#39;</span>}
        name <span style="color: #666666">=</span> theta2name<span style="color: #666666">.</span>get(<span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>theta, <span style="color: #BA2121">&#39;&#39;</span>)
        legends <span style="color: #666666">=</span> [<span style="color: #BA2121">&#39;numerical </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> name]
        <span style="color: #008000; font-weight: bold">if</span> include_exact:
            t_e <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>T, <span style="color: #666666">1001</span>)
            u_e <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>exact_solution(t_e)
            plt<span style="color: #666666">.</span>plot(t_e, u_e, <span style="color: #BA2121">&#39;b-&#39;</span>)
            legends<span style="color: #666666">.</span>append(<span style="color: #BA2121">&#39;exact&#39;</span>)
        plt<span style="color: #666666">.</span>legend(legends)
        plt<span style="color: #666666">.</span>xlabel(<span style="color: #BA2121">&#39;t&#39;</span>)
        plt<span style="color: #666666">.</span>ylabel(<span style="color: #BA2121">&#39;u&#39;</span>)
        plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, dt=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span>
                  (<span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>theta, <span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>dt))
        plt<span style="color: #666666">.</span>savefig(<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (name, <span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>dt))
        <span style="color: #008000; font-weight: bold">return</span> plt
</pre></div>
<p>
The <code>plt</code> object in the <code>plot</code> method is worth a comment. The idea is
that <code>plot</code> can add a numerical solution curve to an existing
plot. Calling <code>plot</code> with a <code>plt</code> object (which has to be a
<code>matplotlib.pyplot</code> or <code>scitools.std</code> object in this implementation),
will just add the curve
<code>self.solver.u</code> as a dashed line with circles at the mesh points
(leaving the color of the curve up to the plotting tool). This
functionality allows plots with several solutions: just make a loop
where new data is set in the problem and/or solver classes, the
solver's <code>solve()</code> method is called, and the most recent numerical
solution is plotted by the <code>plot(plt)</code> method in the visualizer object
<a href="._part0005_main_decay.html#decay:exer:decay_class:exper">Exercise 6: Make use of a class implementation</a> describes a problem setting
where this functionality is explored.

<h4>Combing the objects  <a name="___sec59"></a></h4>

<p>
Eventually we need to show how the classes <code>Problem</code>, <code>Solver</code>, and
<code>Visualizer</code> play together:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>():
    problem <span style="color: #666666">=</span> Problem()
    solver <span style="color: #666666">=</span> Solver(problem)
    viz <span style="color: #666666">=</span> Visualizer(problem, solver)

    <span style="color: #408080; font-style: italic"># Read input from the command line</span>
    parser <span style="color: #666666">=</span> problem<span style="color: #666666">.</span>define_command_line_options()
    parser <span style="color: #666666">=</span> solver<span style="color: #666666">.</span> define_command_line_options(parser)
    args <span style="color: #666666">=</span> parser<span style="color: #666666">.</span>parse_args()
    problem<span style="color: #666666">.</span>init_from_command_line(args)
    solver<span style="color: #666666">.</span> init_from_command_line(args)

    <span style="color: #408080; font-style: italic"># Solve and plot</span>
    solver<span style="color: #666666">.</span>solve()
    <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>
    <span style="color: #408080; font-style: italic">#import scitools.std as plt</span>
    plt <span style="color: #666666">=</span> viz<span style="color: #666666">.</span>plot(plt<span style="color: #666666">=</span>plt)
    E <span style="color: #666666">=</span> solver<span style="color: #666666">.</span>error()
    <span style="color: #008000; font-weight: bold">if</span> E <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">None</span>:
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Error: </span><span style="color: #BB6688; font-weight: bold">%.4E</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> E
    plt<span style="color: #666666">.</span>show()
</pre></div>
<p>
The file <a href="http://tinyurl.com/jvzzcfn/decay/decay_class.py"><tt>decay_class.py</tt></a>
constitutes a module with the three classes and the <code>main</code> function.

<p>
<div class="alert alert-block alert-question alert-text-normal"><b>Test the understanding.</b>
Implement the problem in
<a href="._part0008_main_decay.html#decay:app:exer:drag:prog">Exercise 24: Make a program for vertical motion in a fluid</a> in terms of problem, solver,
and visualizer classes. Equip the classes and their methods with
doc strings with tests. Also include nose tests.
</div>
<h3>Improving the problem and solver classes <a name="decay:prog:se:class2"></a></h3>

<p>
The previous <code>Problem</code> and <code>Solver</code> classes containing parameters
soon get much repetitive code when the number of parameters increases.
Much of this code can be parameterized and be made more compact.
For this purpose, we decide to collect all parameters in a dictionary,
<code>self.prms</code>, with two associated dictionaries <code>self.types</code> and
<code>self.help</code> for holding associated object types and help strings.
Provided a problem, solver, or visualizer class defines these three
dictionaries in the constructor, using default or user-supplied values
of the parameters, we can create a super class <code>Parameters</code> with general code
for defining command-line options and reading them as well as
methods for setting and getting a parameter. A <code>Problem</code> or <code>Solver</code> class will
then inherit command-line functionality and the set/get methods from
the <code>Parameters</code> class.

<h4>A generic class for parameters  <a name="___sec61"></a></h4>

<p>
A simplified version of the parameter class looks as follows:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Parameters</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">set</span>(<span style="color: #008000">self</span>, <span style="color: #666666">**</span>parameters):
        <span style="color: #008000; font-weight: bold">for</span> name <span style="color: #AA22FF; font-weight: bold">in</span> parameters:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>prms[name] <span style="color: #666666">=</span> parameters[name]

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">get</span>(<span style="color: #008000">self</span>, name):
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>prms[name]

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>(<span style="color: #008000">self</span>, parser<span style="color: #666666">=</span><span style="color: #008000">None</span>):
        <span style="color: #008000; font-weight: bold">if</span> parser <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
            <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">argparse</span>
            parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser()

        <span style="color: #008000; font-weight: bold">for</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>prms:
            tp <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>types[name] <span style="color: #008000; font-weight: bold">if</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>types <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000">str</span>
            help <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>help[name] <span style="color: #008000; font-weight: bold">if</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>help <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000">None</span>
            parser<span style="color: #666666">.</span>add_argument(
                <span style="color: #BA2121">&#39;--&#39;</span> <span style="color: #666666">+</span> name, default<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>get(name), metavar<span style="color: #666666">=</span>name,
                <span style="color: #008000">type</span><span style="color: #666666">=</span>tp, help<span style="color: #666666">=</span>help)

        <span style="color: #008000; font-weight: bold">return</span> parser

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">init_from_command_line</span>(<span style="color: #008000">self</span>, args):
        <span style="color: #008000; font-weight: bold">for</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>prms:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>prms[name] <span style="color: #666666">=</span> <span style="color: #008000">getattr</span>(args, name)
</pre></div>
<p>
The file <a href="http://tinyurl.com/jvzzcfn/decay/class_decay_oo.py"><tt>class_decay_oo.py</tt></a> contains
a slightly more advanced version of class <code>Parameters</code> where we
in the <code>set</code> and <code>get</code> functions test for valid parameter names and
raise exceptions with informative messages if any name is not registered.

<h4>The problem class  <a name="___sec62"></a></h4>

<p>
A class <code>Problem</code> for the problem \( u'=-au \), \( u(0)=I \), \( t\in (0,T] \), with
parameters input \( a \), \( I \), and \( T \) can now be coded as

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Problem</span>(Parameters):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Physical parameters for the problem u&#39;=-a*u, u(0)=I,</span>
<span style="color: #BA2121; font-style: italic">    with t in [0,T].</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>prms <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(I<span style="color: #666666">=1</span>, a<span style="color: #666666">=1</span>, T<span style="color: #666666">=10</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>types <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(I<span style="color: #666666">=</span><span style="color: #008000">float</span>, a<span style="color: #666666">=</span><span style="color: #008000">float</span>, T<span style="color: #666666">=</span><span style="color: #008000">float</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>help <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(I<span style="color: #666666">=</span><span style="color: #BA2121">&#39;initial condition, u(0)&#39;</span>,
                         a<span style="color: #666666">=</span><span style="color: #BA2121">&#39;coefficient in ODE&#39;</span>,
                         T<span style="color: #666666">=</span><span style="color: #BA2121">&#39;end time of simulation&#39;</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(<span style="color: #008000">self</span>, t):
        I, a <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;I&#39;</span>), <span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;a&#39;</span>)
        <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>np<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>

<h4>The solver class  <a name="___sec63"></a></h4>

<p>
Also the solver class is derived from class <code>Parameters</code> and works with
the <code>prms</code>, <code>types</code>, and <code>help</code> dictionaries in the same way as class
<code>Problem</code>. Otherwise, the code is very similar to class <code>Solver</code> in
the <code>decay_class.py</code> file:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Solver</span>(Parameters):
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, problem):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>problem <span style="color: #666666">=</span> problem
        <span style="color: #008000">self</span><span style="color: #666666">.</span>prms <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(dt<span style="color: #666666">=0.5</span>, theta<span style="color: #666666">=0.5</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>types <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(dt<span style="color: #666666">=</span><span style="color: #008000">float</span>, theta<span style="color: #666666">=</span><span style="color: #008000">float</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>help <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(dt<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time step value&#39;</span>,
                         theta<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time discretization parameter&#39;</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solve</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">decay_mod</span> <span style="color: #008000; font-weight: bold">import</span> solver
        <span style="color: #008000">self</span><span style="color: #666666">.</span>u, <span style="color: #008000">self</span><span style="color: #666666">.</span>t <span style="color: #666666">=</span> solver(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;I&#39;</span>),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;a&#39;</span>),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;T&#39;</span>),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;dt&#39;</span>),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;theta&#39;</span>))

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">error</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">try</span>:
            u_e <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>exact_solution(<span style="color: #008000">self</span><span style="color: #666666">.</span>t)
            e <span style="color: #666666">=</span> u_e <span style="color: #666666">-</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>u
            E <span style="color: #666666">=</span> np<span style="color: #666666">.</span>sqrt(<span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;dt&#39;</span>)<span style="color: #666666">*</span>np<span style="color: #666666">.</span>sum(e<span style="color: #666666">**2</span>))
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">AttributeError</span>:
            E <span style="color: #666666">=</span> <span style="color: #008000">None</span>
        <span style="color: #008000; font-weight: bold">return</span> E
</pre></div>

<h4>The visualizer class  <a name="___sec64"></a></h4>

<p>
Class <code>Visualizer</code> can be identical to the one in the <code>decay_class.py</code> file
since the class does not need any parameters. However, a few
adjustments in the <code>plot</code> method is necessary since parameters are
accessed as, e.g., <code>problem.get('T')</code> rather than <code>problem.T</code>.
The details are found in the file <code>class_decay_oo.py</code>.

<p>
Finally, we need a function that solves a real problem using the
classes <code>Problem</code>, <code>Solver</code>, and <code>Visualizer</code>. This function can
be just like <code>main</code> in the <code>decay_class.py</code> file.

<p>
The advantage with the <code>Parameters</code> class is that it scales to problems
with a large number of physical and numerical parameters:
as long as the parameters are defined once via a dictionary,
the compact code in class <code>Parameters</code> can handle any collection of
parameters of any size.

<p>
<p>
<!-- begin bottom navigation -->
<a href="._part0002_main_decay.html"><img src="https://doconce.googlecode.com/hg/bundled/html_images/prev1.png" border=0 alt="previous"></a>

<a href="._part0004_main_decay.html"><img src="https://doconce.googlecode.com/hg/bundled/html_images/next1.png" border=0 alt="next"></a>
<!-- end bottom navigation -->

<!-- ------------------- end of main content --------------- -->


</body>
</html>
    

