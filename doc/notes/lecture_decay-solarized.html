<!DOCTYPE html>
<!--
Automatically generated HTML file from Doconce source
(http://code.google.com/p/doconce/)
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Doconce: http://code.google.com/p/doconce/" />
<meta name="description" content="INF5620 Lecture: Exponential Decay ODEs">
<meta name="keywords" content="modules (Python),test block (Python modules),module import,doctests,software testing doctests,unit testing,software testing nose,unit testing,problem class,solver class,visualizer class,problem class,solver class,visualizer class,numerical experiments,scientific experiments,script,Unix wildcard notation,lambda functions,method of manufactured solutions,MMS (method of manufactured solutions),backward scheme, 2-step,BDF2 scheme,Leapfrog scheme,Leapfrog scheme, filtered,Heun's method,Runge-Kutta, 2nd-order scheme,Adams-Bashforth scheme, 2nd order,Adams-Bashforth scheme, 3rd order">



<style type="text/css">
    body {
      margin:5;
      padding:0;
      border:0;	/* Remove the border around the viewport in old versions of IE */
      width:100%;
      background: #fdf6e3;
      min-width:600px;	/* Minimum width of layout - remove if not required */
      font-family: Verdana, Helvetica, Arial, sans-serif;
      font-size: 1.0em;
      line-height: 1.3em;
      color: #657b83;
    }
    a { color: #657b83; text-decoration:none; }
    a:hover { color: #b58900; background: #eee8d5; text-decoration:none; }
    h1, h2, h3 { margin:.8em 0 .2em 0; padding:0; line-height: 125%; }
    h2 { font-variant: small-caps; }
    pre {
      background: #fdf6e3;
      -webkit-box-shadow: inset 0 0 2px #000000;
      -moz-box-shadow: inset 0 0 2px #000000;
      box-shadow: inset 0 0 2px #000000;
      color: #586e75;
      margin-left: 0px;
      font-family: 'Droid Sans Mono', monospace;
      padding: 2px;
      -webkit-border-radius: 4px;
      -moz-border-radius: 4px;
      border-radius: 4px;
      -moz-background-clip: padding;
      -webkit-background-clip: padding-box;
      background-clip: padding-box;
    }
    tt { font-family: "Courier New", Courier; }
    hr { border: 0; width: 80%; border-bottom: 1px solid #aaa}
    p { text-indent: 0px; }
    p.caption { width: 80%; font-style: normal; text-align: left; }
    hr.figure { border: 0; width: 80%; border-bottom: 1px solid #aaa}

</style>

</head>

<!-- tocinfo
{'highest level': 1,
 'sections': [(' Implementation ', 1, None, '___sec0'),
              (' Implementation in Python ', 3, None, '___sec1'),
              (' Making a program ', 2, 'decay:py1', 'decay:py1'),
              (' Function for computing the numerical solution ',
               3,
               None,
               '___sec3'),
              (' Integer division ', 3, None, '___sec4'),
              (' Doc strings ', 3, None, '___sec5'),
              (' Formatting of numbers ', 3, None, '___sec6'),
              (' Running the program ', 3, None, '___sec7'),
              (' Verifying the implementation ', 2, None, '___sec8'),
              (' Simplest method: run a few algorithmic steps by hand ',
               3,
               None,
               '___sec9'),
              (' Comparison with an exact discrete solution ',
               3,
               None,
               '___sec10'),
              (' Computing the numerical error ',
               2,
               'decay:computing:error',
               'decay:computing:error'),
              (' Plotting solutions ', 2, None, '___sec12'),
              (' Plotting with SciTools ', 2, None, '___sec13'),
              (' Creating user interfaces ', 2, None, '___sec14'),
              (' Reading a sequence of command-line arguments ',
               3,
               None,
               '___sec15'),
              (' Working with an argument parser ', 3, None, '___sec16'),
              (' Computing convergence rates ', 2, None, '___sec17'),
              (' Estimating the convergence rate $r$ ', 3, None, '___sec18'),
              (' Implementation ', 3, None, '___sec19'),
              (' Verification ', 3, None, '___sec20'),
              (' Debugging via convergence rates ', 3, None, '___sec21'),
              (' Memory-saving implementation ', 2, None, '___sec22'),
              (' Software engineering ', 1, None, '___sec23'),
              (' Making a module ', 2, None, '___sec24'),
              (' Prefixing imported functions by the module name ',
               2,
               None,
               '___sec25'),
              (' Doctests ', 2, None, '___sec26'),
              (' Unit testing with nose ', 2, None, '___sec27'),
              (' Basic use of nose ', 3, None, '___sec28'),
              (' Demonstrating nose ', 3, None, '___sec29'),
              (' Classical unit testing with unittest ', 2, None, '___sec30'),
              (' Basic use of unittest ', 3, None, '___sec31'),
              (' Demonstration of unittest ', 3, None, '___sec32'),
              (' Implementing simple problem and solver classes ',
               2,
               None,
               '___sec33'),
              (' The problem class ', 3, None, '___sec34'),
              (' The solver class ', 3, None, '___sec35'),
              (' The visualizer class ', 3, None, '___sec36'),
              (' Combing the objects ', 3, None, '___sec37'),
              (' Implementing more advanced problem and solver classes ',
               2,
               None,
               '___sec38'),
              (' A generic class for parameters ', 3, None, '___sec39'),
              (' The problem class ', 3, None, '___sec40'),
              (' The solver class ', 3, None, '___sec41'),
              (' The visualizer class ', 3, None, '___sec42'),
              (' Performing scientific experiments ',
               1,
               'decay:experiments',
               'decay:experiments'),
              (' Interpreting output from other programs ',
               2,
               None,
               '___sec44'),
              (' Making a report ',
               2,
               'decay:exper:report',
               'decay:exper:report'),
              (' Publishing a complete project ',
               2,
               'decay:exper:github',
               'decay:exper:github'),
              (' Model extensions ', 1, None, '___sec47'),
              (' Extension to a variable coefficient ', 2, None, '___sec48'),
              (' Extension to a source term ',
               2,
               'decay:source',
               'decay:source'),
              (' Schemes ', 3, None, '___sec50'),
              (' Implementation of the generalized model problem ',
               2,
               'decay:general',
               'decay:general'),
              (' The Python code ', 3, None, '___sec52'),
              (' Implementations of variable coefficients ',
               3,
               None,
               '___sec53'),
              (' Verification via trivial solutions ',
               2,
               'decay:verify:trivial',
               'decay:verify:trivial'),
              (' Verification via manufactured solutions ',
               2,
               'decay:MMS',
               'decay:MMS'),
              (' Extension to systems of ODEs ', 2, None, '___sec56'),
              (' General first-order ODEs ', 1, None, '___sec57'),
              (' Generic form ', 2, None, '___sec58'),
              (' The Odespy software ', 2, None, '___sec59'),
              (' Example: Runge-Kutta methods  ', 2, None, '___sec60'),
              (' Example: Adaptive Runge-Kutta methods  ',
               2,
               None,
               '___sec61'),
              (' Other schemes ', 2, None, '___sec62'),
              (' Implicit 2-step backward scheme ', 3, None, '___sec63'),
              (' The Leapfrog scheme ', 3, None, '___sec64'),
              (' The filtered Leapfrog scheme ', 3, None, '___sec65'),
              (' 2nd-order Runge-Kutta scheme ', 3, None, '___sec66'),
              (' 2nd-order Adams-Bashforth scheme ', 3, None, '___sec67'),
              (' 3rd-order Adams-Bashforth scheme ', 3, None, '___sec68')]}
end of tocinfo -->

<body>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
     equationNumbers: {  autoNumber: "AMS"  },
     extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js"]
  }
});
</script>
<script type="text/javascript"
 src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- Fix slow MathJax rendering in IE8 -->
<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7">


<!-- newcommands_keep.tex -->
$$
\newcommand{\uex}{u_{\small\mbox{e}}}
\newcommand{\Aex}{A_{\small\mbox{e}}}
\newcommand{\half}{\frac{1}{2}}
\newcommand{\halfi}{{1/2}}
\newcommand{\ts}{\thinspace .}

\newcommand{\Ddt}[1]{\frac{D #1}{dt}}
\newcommand{\E}[1]{\hbox{E}\lbrack #1 \rbrack}
\newcommand{\Var}[1]{\hbox{Var}\lbrack #1 \rbrack}
\newcommand{\Std}[1]{\hbox{Std}\lbrack #1 \rbrack}

\newcommand{\xpoint}{\boldsymbol{x}}
\newcommand{\normalvec}{\boldsymbol{n}}
\newcommand{\Oof}[1]{{\cal O}(#1)}

\newcommand{\x}{\boldsymbol{x}}
\newcommand{\X}{\boldsymbol{X}}
\renewcommand{\u}{\boldsymbol{u}}
\renewcommand{\v}{\boldsymbol{v}}
\newcommand{\w}{\boldsymbol{w}}
\newcommand{\V}{\boldsymbol{V}}
\newcommand{\e}{\boldsymbol{e}}
\newcommand{\f}{\boldsymbol{f}}
\newcommand{\F}{\boldsymbol{F}}
\newcommand{\stress}{\boldsymbol{\sigma}}
\newcommand{\strain}{\boldsymbol{\varepsilon}}
\newcommand{\stressc}{{\sigma}}
\newcommand{\strainc}{{\varepsilon}}
\newcommand{\I}{\boldsymbol{I}}
\newcommand{\T}{\boldsymbol{T}}

% Unit vectors
\newcommand{\ii}{\boldsymbol{i}}
\newcommand{\jj}{\boldsymbol{j}}
\newcommand{\kk}{\boldsymbol{k}}
\newcommand{\ir}{\boldsymbol{i}_r}
\newcommand{\ith}{\boldsymbol{i}_{\theta}}
\newcommand{\iz}{\boldsymbol{i}_z}

% Index sets
\newcommand{\Ix}{{\cal I}_x}
\newcommand{\Iy}{{\cal I}_y}
\newcommand{\Iz}{{\cal I}_z}
\newcommand{\It}{{\cal I}_t}
\newcommand{\setb}[1]{{#1}^0}    % set begin
\newcommand{\sete}[1]{{#1}^{-1}} % set end
%\newcommand{\setl}[1]{#1\setminus\{\set1{#1}\}}
%\newcommand{\setr}[1]{#1\setminus\{\set0{#1}\}}
%\newcommand{\seti}[1]{#1\setminus\{\set0{#1},\set1{#1}\}}
\newcommand{\setl}[1]{{#1}^-}
\newcommand{\setr}[1]{{#1}^+}
\newcommand{\seti}[1]{{#1}^i}

% Finite elements
\newcommand{\basphi}{\varphi}
\newcommand{\baspsi}{\psi}
\newcommand{\refphi}{\tilde\basphi}
\newcommand{\psib}{\boldsymbol{\psi}}
\newcommand{\sinL}[1]{\sin\left((#1+1)\pi\frac{x}{L}\right)}
\newcommand{\xno}[1]{x_{#1}}
%\newcommand{\xno}[1]{x^{(#1)}}
\newcommand{\Xno}[1]{X_{(#1)}}
\newcommand{\yno}[1]{y_{#1}}
\newcommand{\Yno}[1]{Y_{(#1)}}
\newcommand{\xdno}[1]{\boldsymbol{x}_{#1}}

% FEniCS commands
\newcommand{\dX}{\, \mathrm{d}X}
\newcommand{\dx}{\, \mathrm{d}x}
\newcommand{\ds}{\, \mathrm{d}s}
\newcommand{\Real}{\mathbb{R}}
\newcommand{\Integerp}{\mathbb{N}}
\newcommand{\Integer}{\mathbb{Z}}
$$




    
<!-- ------------------- main content ---------------------- -->


<title>INF5620 Lecture: Exponential Decay ODEs</title>

<center><h1>INF5620 Lecture: Exponential Decay ODEs</h1></center>  <!-- document title -->

<p>
<center><h4>Jun 19, 2013</h4></center> <!-- date -->

<h2>Table of contents</h2>

<p>
<a href="#___sec0"> Implementation </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec1"> Implementation in Python </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:py1"> Making a program </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec3"> Function for computing the numerical solution </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec4"> Integer division </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec5"> Doc strings </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec6"> Formatting of numbers </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec7"> Running the program </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec8"> Verifying the implementation </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec9"> Simplest method: run a few algorithmic steps by hand </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec10"> Comparison with an exact discrete solution </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:computing:error"> Computing the numerical error </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec12"> Plotting solutions </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec13"> Plotting with SciTools </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec14"> Creating user interfaces </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec15"> Reading a sequence of command-line arguments </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec16"> Working with an argument parser </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec17"> Computing convergence rates </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec18"> Estimating the convergence rate \( r \) </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec19"> Implementation </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec20"> Verification </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec21"> Debugging via convergence rates </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec22"> Memory-saving implementation </a><br>
<a href="#___sec23"> Software engineering </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec24"> Making a module </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec25"> Prefixing imported functions by the module name </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec26"> Doctests </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec27"> Unit testing with nose </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec28"> Basic use of nose </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec29"> Demonstrating nose </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec30"> Classical unit testing with unittest </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec31"> Basic use of unittest </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec32"> Demonstration of unittest </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec33"> Implementing simple problem and solver classes </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec34"> The problem class </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec35"> The solver class </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec36"> The visualizer class </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec37"> Combing the objects </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec38"> Implementing more advanced problem and solver classes </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec39"> A generic class for parameters </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec40"> The problem class </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec41"> The solver class </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec42"> The visualizer class </a><br>
<a href="#decay:experiments"> Performing scientific experiments </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec44"> Interpreting output from other programs </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:exper:report"> Making a report </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:exper:github"> Publishing a complete project </a><br>
<a href="#___sec47"> Model extensions </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec48"> Extension to a variable coefficient </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:source"> Extension to a source term </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec50"> Schemes </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:general"> Implementation of the generalized model problem </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec52"> The Python code </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec53"> Implementations of variable coefficients </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:verify:trivial"> Verification via trivial solutions </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:MMS"> Verification via manufactured solutions </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec56"> Extension to systems of ODEs </a><br>
<a href="#___sec57"> General first-order ODEs </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec58"> Generic form </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec59"> The Odespy software </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec60"> Example: Runge-Kutta methods  </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec61"> Example: Adaptive Runge-Kutta methods  </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec62"> Other schemes </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec63"> Implicit 2-step backward scheme </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec64"> The Leapfrog scheme </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec65"> The filtered Leapfrog scheme </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec66"> 2nd-order Runge-Kutta scheme </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec67"> 2nd-order Adams-Bashforth scheme </a><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#___sec68"> 3rd-order Adams-Bashforth scheme </a><br>

<h2>Implementation  <a name="___sec0"></a></h2>

<p>
We address the differential equation problem
$$
u'(t) = -au(t),\quad t\in (0,T], \quad u(0)=I,
$$

where \( a>0 \) is a given constant.

<p>
The problem is solved by the numerical method

<p>
$$
u^{n+1} = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a\Delta t}u^n,
$$

for \( \theta\in [0,1] \). The classical Forward Euler, Backward Euler, and
Crank-Nicolson (midpoint) schemes are recovered through \( \theta=0,1,0.5 \) (resp.)

<p>
Tasks: Make a program that

<p>

<ul>
  <p><li> computes \( u^n \), \( n=1,2,\ldots,N_t \)</li>
  <p><li> displays the numerical and exact solution</li>
  <p><li> brings evidence to a correct implementation (<em>verification</em>)</li>
  <p><li> compares the numerical and the exact solution in a plot</li>
  <p><li> computes the error \( \uex (t_n) - u^n \)</li>
  <p><li> computes the convergence rate of the numerical scheme</li>
  <p><li> reads its input data from the command line</li>
</ul>

Tools to learn:

<p>

<ul>
  <p><li> Basic <a href="http://python.org">Python</a> programming</li>
  <p><li> Array computing with <a href="http://numpy.org/"><tt>numpy</tt></a></li>
  <p><li> Plotting with <a href="http://matplotlib.sourceforge.net/"><tt>matplotlib.pyplot</tt></a></li>
  <p><li> Plotting through <a href="http://code.google.com/p/scitools/"><tt>scitools</tt></a></li>
  <p><li> File writing and reading</li>
  <p><li> Making command-line user interface via <code>argparse.ArgumentParser</code></li>
</ul>

All programs are in the directory
<a href="https://github.com/hplgit/INF5620/tree/gh-pages/src/decay"><tt>src/decay</tt></a>.

<h4>Implementation in Python  <a name="___sec1"></a></h4>

<p>
Why Python?

<p>

<ul>
  <p><li> Python has a very clean, readable syntax (often known as
    "executable pseudo-code").</li>
  <p><li> Python code is very similar to MATLAB code (and MATLAB has a
    particularly widespread use for scientific computing).</li>
  <p><li> Python is similar to, but much simpler to work with and
    results in more reliable code than C++.</li>
  <p><li> Python is a full-fledged, very powerful programming language.</li>
  <p><li> Python has a rich set of modules for scientific computing, and its
    popularity in scientific computing is rapidly growing.</li>
  <p><li> Python was made for being combined with compiled languages
    (C, C++, Fortran) to reuse existing numerical software and to
    reach high computational performance of new implementations.</li>
  <p><li> Python has extensive support for administrative task
    needed when doing large-scale computational investigations.</li>
  <p><li> Python has extensive support for graphics (visualization,
    user interfaces, web applications).</li>
  <p><li> FEniCS, a very powerful tool for solving PDEs by
    the finite element method, is most human-efficient to operate
    from Python.</li>
</ul>

<h3>Making a program <a name="decay:py1"></a></h3>

<p>

<ul>
 <p><li> Store \( u^n \), \( n=0,1,\ldots,N_t \) in an array <code>u</code>.</li>
 <p><li> Algorithm:</li>

<ol>
  <p><li> initialize \( u^0 \)</li>
  <p><li> for \( t=t_n \), \( n=1,2,\ldots,N_t \): compute \( u_n \) using
     the \( \theta \)-rule formula</li>
</ol>

</ul>

<h4>Function for computing the numerical solution  <a name="___sec3"></a></h4>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">numpy</span> <span style="color: #8B008B; font-weight: bold">import</span> *

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">solver</span>(I, a, T, dt, theta):
    <span style="color: #CD5555">&quot;&quot;&quot;Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.&quot;&quot;&quot;</span>
    Nt = <span style="color: #658b00">int</span>(T/dt)            <span style="color: #228B22"># no of time intervals</span>
    T = Nt*dt                 <span style="color: #228B22"># adjust T to fit time step dt</span>
    u = zeros(Nt+<span style="color: #B452CD">1</span>)           <span style="color: #228B22"># array of u[n] values</span>
    t = linspace(<span style="color: #B452CD">0</span>, T, Nt+<span style="color: #B452CD">1</span>)  <span style="color: #228B22"># time mesh</span>

    u[<span style="color: #B452CD">0</span>] = I                  <span style="color: #228B22"># assign initial condition</span>
    <span style="color: #8B008B; font-weight: bold">for</span> n <span style="color: #8B008B">in</span> <span style="color: #658b00">range</span>(<span style="color: #B452CD">0</span>, Nt):    <span style="color: #228B22"># n=0,1,...,Nt-1</span>
        u[n+<span style="color: #B452CD">1</span>] = (<span style="color: #B452CD">1</span> - (<span style="color: #B452CD">1</span>-theta)*a*dt)/(<span style="color: #B452CD">1</span> + theta*dt*a)*u[n]
    <span style="color: #8B008B; font-weight: bold">return</span> u, t
</pre></div>
</td></tr></table><p>
Note about the <code>for</code> loop: <code>range(0, Nt, s)</code> generates all integers
from <code>0</code> to <code>Nt</code> in steps of <code>s</code> (default 1), <em>but not including</em> <code>Nt</code> (!).

<p>
Sample call:
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">u, t = solver(I=<span style="color: #B452CD">1</span>, a=<span style="color: #B452CD">2</span>, T=<span style="color: #B452CD">8</span>, dt=<span style="color: #B452CD">0.8</span>, theta=<span style="color: #B452CD">1</span>)
</pre></div>
</td></tr></table><h4>Integer division  <a name="___sec4"></a></h4>

<p>
Python applies integer division: <code>1/2</code> is 0, <code>1./2</code> or <code>1.0/2</code> or
<code>1/2.</code> or <code>1/2.0</code> or <code>1.0/2.0</code> gives 0.5.

<p>
A safer <code>solver</code> function:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">numpy</span> <span style="color: #8B008B; font-weight: bold">import</span> *

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">solver</span>(I, a, T, dt, theta):
    <span style="color: #CD5555">&quot;&quot;&quot;Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.&quot;&quot;&quot;</span>
    dt = <span style="color: #658b00">float</span>(dt)            <span style="color: #228B22"># avoid integer division</span>
    Nt = <span style="color: #658b00">int</span>(<span style="color: #658b00">round</span>(T/dt))     <span style="color: #228B22"># no of time intervals</span>
    T = Nt*dt                 <span style="color: #228B22"># adjust T to fit time step dt</span>
    u = zeros(Nt+<span style="color: #B452CD">1</span>)           <span style="color: #228B22"># array of u[n] values</span>
    t = linspace(<span style="color: #B452CD">0</span>, T, Nt+<span style="color: #B452CD">1</span>)  <span style="color: #228B22"># time mesh</span>

    u[<span style="color: #B452CD">0</span>] = I                  <span style="color: #228B22"># assign initial condition</span>
    <span style="color: #8B008B; font-weight: bold">for</span> n <span style="color: #8B008B">in</span> <span style="color: #658b00">range</span>(<span style="color: #B452CD">0</span>, Nt):    <span style="color: #228B22"># n=0,1,...,Nt-1</span>
        u[n+<span style="color: #B452CD">1</span>] = (<span style="color: #B452CD">1</span> - (<span style="color: #B452CD">1</span>-theta)*a*dt)/(<span style="color: #B452CD">1</span> + theta*dt*a)*u[n]
    <span style="color: #8B008B; font-weight: bold">return</span> u, t
</pre></div>
</td></tr></table><h4>Doc strings  <a name="___sec5"></a></h4>

<p>

<ul>
 <p><li> First string after the function heading</li>
 <p><li> Used for documentation the function</li>
 <p><li> Automatic documentation tools can make fancy manuals</li>
 <p><li> Can be used for automatic testing</li>
</ul>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">solver</span>(I, a, T, dt, theta):
    <span style="color: #CD5555">&quot;&quot;&quot;</span>
<span style="color: #CD5555">    Solve</span>

<span style="color: #CD5555">        u&#39;(t) = -a*u(t),</span>

<span style="color: #CD5555">    with initial condition u(0)=I, for t in the time interval</span>
<span style="color: #CD5555">    (0,T]. The time interval is divided into time steps of</span>
<span style="color: #CD5555">    length dt.</span>

<span style="color: #CD5555">    theta=1 corresponds to the Backward Euler scheme, theta=0</span>
<span style="color: #CD5555">    to the Forward Euler scheme, and theta=0.5 to the Crank-</span>
<span style="color: #CD5555">    Nicolson method.</span>
<span style="color: #CD5555">    &quot;&quot;&quot;</span>
    ...
</pre></div>
</td></tr></table><h4>Formatting of numbers  <a name="___sec6"></a></h4>

<p>
Can control formatting of reals and integers through the <em>printf</em> format:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">print</span> <span style="color: #CD5555">&#39;t=%6.3f u=%g&#39;</span> % (t[i], u[i])
</pre></div>
</td></tr></table><p>
Or the alternative <em>format string syntax</em>:
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">print</span> <span style="color: #CD5555">&#39;t={t:6.3f} u={u:g}&#39;</span>.format(t=t[i], u=u[i])
</pre></div>
</td></tr></table><h4>Running the program  <a name="___sec7"></a></h4>

<p>
Complete program file: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/decay_v1.py"><tt>decay_v1.py</tt></a>.

<p>
How to run the program:

<p>

<!-- code=bash (from !bc sys) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">Terminal&gt; python decay_v1.py
</pre></div>
</td></tr></table><p>
Can also run it as "normal" Unix programs: <code>./programname</code>:

<p>

<ol>
 <p><li> Insert first line <code>#!/usr/bin/env python</code> (program to interpret the file)</li>
 <p><li> Run <code>chmod a+rx decay_v1.py</code></li>
</ol>

Now, this works:

<p>

<!-- code=bash (from !bc sys) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">Terminal&gt; ./decay_v1.py
</pre></div>
</td></tr></table><h3>Verifying the implementation  <a name="___sec8"></a></h3>

<p>

<ul>
 <p><li> Verification = bring evidence that the program works</li>
 <p><li> Find suitable test problems</li>
 <p><li> Make function for each test problem</li>
 <p><li> Later: put the verification tests in a professional testing framework</li>
</ul>

<h4>Simplest method: run a few algorithmic steps by hand  <a name="___sec9"></a></h4>

<p>
Use a calculator:

<p>
$$ A\equiv \frac{1 - (1-\theta) a\Delta t}{1 + \theta a \Delta t} = 0.298245614035$$

$$
\begin{align*}
u^1 &= AI=0.0298245614035,\\
u^2 &= Au^1= 0.00889504462912,\\
u^3 &=Au^2= 0.00265290804728
\end{align*}
$$


<p>
Compare hand-calculated numbers with those from <code>solver</code>:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">verify_three_steps</span>():
    <span style="color: #CD5555">&quot;&quot;&quot;Compare three steps with known manual computations.&quot;&quot;&quot;</span>
    theta = <span style="color: #B452CD">0.8</span>; a = <span style="color: #B452CD">2</span>; I = <span style="color: #B452CD">0.1</span>; dt = <span style="color: #B452CD">0.8</span>
    u_by_hand = array([I,
                       <span style="color: #B452CD">0.0298245614035</span>,
                       <span style="color: #B452CD">0.00889504462912</span>,
                       <span style="color: #B452CD">0.00265290804728</span>])

    Nt = <span style="color: #B452CD">3</span>  <span style="color: #228B22"># number of time steps</span>
    u, t = solver(I=I, a=a, T=Nt*dt, dt=dt, theta=theta)

    tol = <span style="color: #B452CD">1E-15</span>  <span style="color: #228B22"># tolerance for comparing floats</span>
    difference = <span style="color: #658b00">abs</span>(u - u_by_hand).max()
    success = difference &lt;= tol
    <span style="color: #8B008B; font-weight: bold">return</span> success
</pre></div>
</td></tr></table><p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">main</span>():
    u, t = solver(I=<span style="color: #B452CD">1</span>, a=<span style="color: #B452CD">2</span>, T=<span style="color: #B452CD">8</span>, dt=<span style="color: #B452CD">0.8</span>, theta=<span style="color: #B452CD">1</span>)
    <span style="color: #228B22"># Write out a table of t and u values:</span>
    <span style="color: #8B008B; font-weight: bold">for</span> i <span style="color: #8B008B">in</span> <span style="color: #658b00">range</span>(<span style="color: #658b00">len</span>(t)):
        <span style="color: #8B008B; font-weight: bold">print</span> <span style="color: #CD5555">&#39;t=%6.3f u=%g&#39;</span> % (t[i], u[i])
        <span style="color: #228B22"># or print &#39;t={t:6.3f} u={u:g}&#39;.format(t=t[i], u=u[i])</span>
</pre></div>
</td></tr></table><p>
Force the verification to be done before a real computation:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">if</span> verify_three_steps():
    main()
<span style="color: #8B008B; font-weight: bold">else</span>:
    <span style="color: #8B008B; font-weight: bold">print</span> <span style="color: #CD5555">&#39;Bug in the implementation!&#39;</span>
</pre></div>
</td></tr></table><p>
Complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/decay_verf1.py"><tt>decay_verf1.py</tt></a>.

<h4>Comparison with an exact discrete solution  <a name="___sec10"></a></h4>

<p>

<ul>
 <p><li> Better verification: comparison of \( u^n \) from <code>solver</code>
   with a closed-form <em>exact discrete solution</em> (if possible)</li>
</ul>

Define
$$ A = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a \Delta t}\thinspace . $$

Repeated use of the \( \theta \)-rule:
$$
\begin{align*}
u^0 &= I,\\
u^1 &= Au^0 = AI,\\
u^2 &= Au^1 = A^2I,\\
&\vdots\\
u^n &= A^nu^{n-1} = A^nI \thinspace .
\end{align*}
$$


<p>
The exact discrete solution as
$$
\begin{equation}
u^n = IA^n
\label{decay:un:exact}
\thinspace .
\end{equation}
$$


<p>
Implementation:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">verify_exact_discrete_solution</span>():

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">exact_discrete_solution</span>(n, I, a, theta, dt):
        A = (<span style="color: #B452CD">1</span> - (<span style="color: #B452CD">1</span>-theta)*a*dt)/(<span style="color: #B452CD">1</span> + theta*dt*a)
        <span style="color: #8B008B; font-weight: bold">return</span> I*A**n

    theta = <span style="color: #B452CD">0.8</span>; a = <span style="color: #B452CD">2</span>; I = <span style="color: #B452CD">0.1</span>; dt = <span style="color: #B452CD">0.8</span>
    Nt = <span style="color: #658b00">int</span>(<span style="color: #B452CD">8</span>/dt)  <span style="color: #228B22"># no of steps</span>
    u, t = solver(I=I, a=a, T=Nt*dt, dt=dt, theta=theta)
    u_de = array([exact_discrete_solution(n, I, a, theta, dt)
                  <span style="color: #8B008B; font-weight: bold">for</span> n <span style="color: #8B008B">in</span> <span style="color: #658b00">range</span>(Nt+<span style="color: #B452CD">1</span>)])
    difference = <span style="color: #658b00">abs</span>(u_de - u).max()  <span style="color: #228B22"># max deviation</span>
    tol = <span style="color: #B452CD">1E-15</span>  <span style="color: #228B22"># tolerance for comparing floats</span>
    success = difference &lt;= tol
    <span style="color: #8B008B; font-weight: bold">return</span> success
</pre></div>
</td></tr></table><p>
The complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/decay_verf2.py"><tt>decay_verf2.py</tt></a>.

<h3>Computing the numerical error <a name="decay:computing:error"></a></h3>

<p>
Task: compute exact minus numerical solution, \( \uex(t_n) - u^n \)

<p>
Exact solution: \( \uex(t)=Ie^{-at} \), implemented as

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">exact_solution</span>(t, I, a):
    <span style="color: #8B008B; font-weight: bold">return</span> I*exp(-a*t)
</pre></div>
</td></tr></table><p>
Compute

<p>
$$
\begin{equation}
e_n = \uex(t_n) - u^n,\quad n=0,1,\ldots,N_t \thinspace .
\end{equation}
$$


<p>
by

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">u, t = solver(I, a, T, dt, theta)  <span style="color: #228B22"># Numerical solution</span>
u_e = exact_solution(t, I, a)
e = u_e - u
</pre></div>
</td></tr></table><p>
Note: array arithmetics - we compute on entire arrays

<p>

<ul>
 <p><li> Array <code>e</code> is the problem's discrete <em>error function</em></li>
 <p><li> Sometimes convenient with a scalar error measure (one number)</li>
 <p><li> Can integrate \( e^n \)</li>
</ul>

The Trapezoidal rule:

<p>
$$ \hat E^2 = \Delta t\left(\frac{1}{2}e_0^2 + \frac{1}{2}e_{N_t}^2
+ \sum_{n=1}^{N_t-1} e_n^2\right) $$

Common approximation (ok if used consistently in all error computations):

<p>
$$ \hat E^2 \approx E^2 = \Delta t\sum_{n=0}^{N_t} e_n^2 $$


<p>
\( E \) is the \( L_2 \) norm of the discrete error function \( e^n \).

<p>
$$
\begin{equation}
E = \sqrt{\Delta t\sum_{n=0}^{N_t} e_n^2}
\label{decay:E}
\end{equation}
$$


<p>
Python:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">E = sqrt(dt*<span style="color: #658b00">sum</span>(e**<span style="color: #B452CD">2</span>))
</pre></div>
</td></tr></table><p>
Similar element by element computation:
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">m = <span style="color: #658b00">len</span>(u)     <span style="color: #228B22"># length of u array (alt: u.size)</span>
u_e = zeros(m)
t = <span style="color: #B452CD">0</span>
<span style="color: #8B008B; font-weight: bold">for</span> i <span style="color: #8B008B">in</span> <span style="color: #658b00">range</span>(m):
    u_e[i] = exact_solution(t, a, I)
    t = t + dt
e = zeros(m)
<span style="color: #8B008B; font-weight: bold">for</span> i <span style="color: #8B008B">in</span> <span style="color: #658b00">range</span>(m):
    e[i] = u_e[i] - u[i]
s = <span style="color: #B452CD">0</span>  <span style="color: #228B22"># summation variable</span>
<span style="color: #8B008B; font-weight: bold">for</span> i <span style="color: #8B008B">in</span> <span style="color: #658b00">range</span>(m):
    s = s + e[i]**<span style="color: #B452CD">2</span>
error = sqrt(dt*s)
</pre></div>
</td></tr></table><p>
Such <em>scalar</em> computing

<p>

<ul>
 <p><li> takes more code</li>
 <p><li> is less readable</li>
 <p><li> runs much slower</li>
</ul>

Rule: Compute on entire arrays!

<h3>Plotting solutions  <a name="___sec12"></a></h3>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">matplotlib.pyplot</span> <span style="color: #8B008B; font-weight: bold">import</span> *
plot(t, u)
show()
</pre></div>
</td></tr></table><p>
Compare with \( \uex(t) \):

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">t_e = linspace(<span style="color: #B452CD">0</span>, T, <span style="color: #B452CD">1001</span>)      <span style="color: #228B22"># fine mesh</span>
u_e = exact_solution(t_e, I, a)
plot(t,   u,   <span style="color: #CD5555">&#39;r-&#39;</span>)            <span style="color: #228B22"># red  line for u</span>
plot(t_e, u_e, <span style="color: #CD5555">&#39;b-&#39;</span>)            <span style="color: #228B22"># blue line for u_e</span>
</pre></div>
</td></tr></table><p>
<center> <!-- figure -->
<hr class="figure">
<center><p class="caption">Figure 1:  The Forward Euler scheme for two values of the time step. <a name="decay:fig:FE1"></a> </p></center>
<p><img src="fig-decay/FE1.png" align="bottom" width=800,></p>
</center>

<p>
How to include such decorations:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">matplotlib.pyplot</span> <span style="color: #8B008B; font-weight: bold">import</span> *

figure()                          <span style="color: #228B22"># create new plot</span>
t_e = linspace(<span style="color: #B452CD">0</span>, T, <span style="color: #B452CD">1001</span>)        <span style="color: #228B22"># fine mesh for u_e</span>
u_e = exact_solution(t_e, I, a)
plot(t,   u,   <span style="color: #CD5555">&#39;r--o&#39;</span>)            <span style="color: #228B22"># red dashes w/circles</span>
plot(t_e, u_e, <span style="color: #CD5555">&#39;b-&#39;</span>)              <span style="color: #228B22"># blue line for exact sol.</span>
legend([<span style="color: #CD5555">&#39;numerical&#39;</span>, <span style="color: #CD5555">&#39;exact&#39;</span>])
xlabel(<span style="color: #CD5555">&#39;t&#39;</span>)
ylabel(<span style="color: #CD5555">&#39;u&#39;</span>)
title(<span style="color: #CD5555">&#39;theta=%g, dt=%g&#39;</span> % (theta, dt))
savefig(<span style="color: #CD5555">&#39;%s_%g.png&#39;</span> % (theta, dt))
show()
</pre></div>
</td></tr></table><p>
Computation and plotting:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">explore</span>(I, a, T, dt, theta=<span style="color: #B452CD">0.5</span>, makeplot=<span style="color: #658b00">True</span>):
    <span style="color: #CD5555">&quot;&quot;&quot;</span>
<span style="color: #CD5555">    Run a case with the solver, compute error measure,</span>
<span style="color: #CD5555">    and plot the numerical and exact solutions (if makeplot=True).</span>
<span style="color: #CD5555">    &quot;&quot;&quot;</span>
    u, t = solver(I, a, T, dt, theta)    <span style="color: #228B22"># Numerical solution</span>
    u_e = exact_solution(t, I, a)
    e = u_e - u
    E = sqrt(dt*<span style="color: #658b00">sum</span>(e**<span style="color: #B452CD">2</span>))
    <span style="color: #8B008B; font-weight: bold">if</span> makeplot:
        figure()                         <span style="color: #228B22"># create new plot</span>
        t_e = linspace(<span style="color: #B452CD">0</span>, T, <span style="color: #B452CD">1001</span>)       <span style="color: #228B22"># fine mesh for u_e</span>
        u_e = exact_solution(t_e, I, a)
        plot(t,   u,   <span style="color: #CD5555">&#39;r--o&#39;</span>)           <span style="color: #228B22"># red dashes w/circles</span>
        plot(t_e, u_e, <span style="color: #CD5555">&#39;b-&#39;</span>)             <span style="color: #228B22"># blue line for exact sol.</span>
        legend([<span style="color: #CD5555">&#39;numerical&#39;</span>, <span style="color: #CD5555">&#39;exact&#39;</span>])
        xlabel(<span style="color: #CD5555">&#39;t&#39;</span>)
        ylabel(<span style="color: #CD5555">&#39;u&#39;</span>)
        title(<span style="color: #CD5555">&#39;theta=%g, dt=%g&#39;</span> % (theta, dt))
        theta2name = {<span style="color: #B452CD">0</span>: <span style="color: #CD5555">&#39;FE&#39;</span>, <span style="color: #B452CD">1</span>: <span style="color: #CD5555">&#39;BE&#39;</span>, <span style="color: #B452CD">0.5</span>: <span style="color: #CD5555">&#39;CN&#39;</span>}
        savefig(<span style="color: #CD5555">&#39;%s_%g.png&#39;</span> % (theta2name[theta], dt))
        savefig(<span style="color: #CD5555">&#39;%s_%g.pdf&#39;</span> % (theta2name[theta], dt))
        savefig(<span style="color: #CD5555">&#39;%s_%g.eps&#39;</span> % (theta2name[theta], dt))
        show()
    <span style="color: #8B008B; font-weight: bold">return</span> E
</pre></div>
</td></tr></table><p>
Complete code: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/decay_plot_mpl.py"><tt>decay_plot_mpl.py</tt></a>.

<p>
<center> <!-- figure -->
<hr class="figure">
<center><p class="caption">Figure 2:  The Backward Euler scheme for two values of the time step. <a name="decay:fig:BE1"></a> </p></center>
<p><img src="fig-decay/BE1.png" align="bottom" width=800></p>
</center>

<p>
<center> <!-- figure -->
<hr class="figure">
<center><p class="caption">Figure 3:  The Crank-Nicolson scheme for two values of the time step. <a name="decay:fig:CN1"></a> </p></center>
<p><img src="fig-decay/CN1.png" align="bottom" width=800></p>
</center>

<h3>Plotting with SciTools  <a name="___sec13"></a></h3>

<p>
<a href="http://code.google.com/p/scitools">SciTools</a> provides a
unified plotting interface (Easyviz) to many different plotting
packages: Matplotlib, Gnuplot, Grace, VTK, OpenDX, ...

<p>
Can use Matplotlib syntax, or a more compact <code>plot</code> function syntax:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">scitools.std</span> <span style="color: #8B008B; font-weight: bold">import</span> *

plot(t,   u,   <span style="color: #CD5555">&#39;r--o&#39;</span>,           <span style="color: #228B22"># red dashes w/circles</span>
     t_e, u_e, <span style="color: #CD5555">&#39;b-&#39;</span>,             <span style="color: #228B22"># blue line for exact sol.</span>
     legend=[<span style="color: #CD5555">&#39;numerical&#39;</span>, <span style="color: #CD5555">&#39;exact&#39;</span>],
     xlabel=<span style="color: #CD5555">&#39;t&#39;</span>,
     ylabel=<span style="color: #CD5555">&#39;u&#39;</span>,
     title=<span style="color: #CD5555">&#39;theta=%g, dt=%g&#39;</span> % (theta, dt),
     savefig=<span style="color: #CD5555">&#39;%s_%g.png&#39;</span> % (theta2name[theta], dt),
     show=<span style="color: #658b00">True</span>)
</pre></div>
</td></tr></table><p>
Complete code in <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/decay_plot_st.py"><tt>decay_plot_st.py</tt></a>.

<p>
Change backend (plotting engine, Matplotlib by default):

<p>

<!-- code=bash (from !bc sys) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">Terminal&gt; python decay_plot_st.py --SCITOOLS_easyviz_backend gnuplot
Terminal&gt; python decay_plot_st.py --SCITOOLS_easyviz_backend grace
</pre></div>
</td></tr></table><h3>Creating user interfaces  <a name="___sec14"></a></h3>

<p>

<ul>
 <p><li> Read input from the command line!</li>
 <p><li> Or file if much input</li>
 <p><li> All command-line arguments are available in <code>sys.argv</code></li>
 <p><li> <code>sys.argv[0]</code> is the program</li>
 <p><li> <code>sys.argv[1:]</code> holds the command-line arguments</li>
 <p><li> Method 1: fixed sequence of parameters on the command line</li>
 <p><li> Method 2: <code>--option value</code> pairs on the command line (with default values)</li>
</ul>

<h4>Reading a sequence of command-line arguments  <a name="___sec15"></a></h4>

<p>
The program <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/decay_plot_mpl.py"><tt>decay_plot_mpl.py</tt></a>
needs this input: \( I \), \( a \), \( T \), an option to
turn the plot on or off (<code>makeplot</code>), and a list of \( \Delta t \) values.
Give these on the command line:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">sys</span>

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">read_command_line</span>():
    <span style="color: #8B008B; font-weight: bold">if</span> <span style="color: #658b00">len</span>(sys.argv) &lt; <span style="color: #B452CD">6</span>:
        <span style="color: #8B008B; font-weight: bold">print</span> <span style="color: #CD5555">&#39;Usage: %s I a T on/off dt1 dt2 dt3 ...&#39;</span> % \ 
              sys.argv[<span style="color: #B452CD">0</span>]; sys.exit(<span style="color: #B452CD">1</span>)  <span style="color: #228B22"># abort</span>

    I = <span style="color: #658b00">float</span>(sys.argv[<span style="color: #B452CD">1</span>])
    a = <span style="color: #658b00">float</span>(sys.argv[<span style="color: #B452CD">2</span>])
    T = <span style="color: #658b00">float</span>(sys.argv[<span style="color: #B452CD">3</span>])
    makeplot = sys.argv[<span style="color: #B452CD">4</span>] <span style="color: #8B008B">in</span> (<span style="color: #CD5555">&#39;on&#39;</span>, <span style="color: #CD5555">&#39;True&#39;</span>)
    dt_values = [<span style="color: #658b00">float</span>(arg) <span style="color: #8B008B; font-weight: bold">for</span> arg <span style="color: #8B008B">in</span> sys.argv[<span style="color: #B452CD">5</span>:]]

    <span style="color: #8B008B; font-weight: bold">return</span> I, a, T, makeplot, dt_values
</pre></div>
</td></tr></table><p>
Note:

<p>

<ul>
  <p><li> <code>sys.argv[i]</code> is <em>always a string</em></li>
  <p><li> Must explicitly convert to (e.g.) <code>float</code> for computations</li>
  <p><li> List comprehensions make lists: <code>[expression for e in somelist]</code></li>
</ul>

Complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/decay_cml.py"><tt>decay_cml.py</tt></a>.

<h4>Working with an argument parser  <a name="___sec16"></a></h4>

<p>
Example: give \( a \) as <code>--a 2.5</code> on the command line
if the default value is not suitable.

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">define_command_line_options</span>():
    <span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">argparse</span>
    parser = argparse.ArgumentParser()
    parser.add_argument(<span style="color: #CD5555">&#39;--I&#39;</span>, <span style="color: #CD5555">&#39;--initial_condition&#39;</span>, <span style="color: #658b00">type</span>=<span style="color: #658b00">float</span>,
                        default=<span style="color: #B452CD">1.0</span>, help=<span style="color: #CD5555">&#39;initial condition, u(0)&#39;</span>,
                        metavar=<span style="color: #CD5555">&#39;I&#39;</span>)
    parser.add_argument(<span style="color: #CD5555">&#39;--a&#39;</span>, <span style="color: #658b00">type</span>=<span style="color: #658b00">float</span>,
                        default=<span style="color: #B452CD">1.0</span>, help=<span style="color: #CD5555">&#39;coefficient in ODE&#39;</span>,
                        metavar=<span style="color: #CD5555">&#39;a&#39;</span>)
    parser.add_argument(<span style="color: #CD5555">&#39;--T&#39;</span>, <span style="color: #CD5555">&#39;--stop_time&#39;</span>, <span style="color: #658b00">type</span>=<span style="color: #658b00">float</span>,
                        default=<span style="color: #B452CD">1.0</span>, help=<span style="color: #CD5555">&#39;end time of simulation&#39;</span>,
                        metavar=<span style="color: #CD5555">&#39;T&#39;</span>)
    parser.add_argument(<span style="color: #CD5555">&#39;--makeplot&#39;</span>, action=<span style="color: #CD5555">&#39;store_true&#39;</span>,
                        help=<span style="color: #CD5555">&#39;display plot or not&#39;</span>)
    parser.add_argument(<span style="color: #CD5555">&#39;--dt&#39;</span>, <span style="color: #CD5555">&#39;--time_step_values&#39;</span>, <span style="color: #658b00">type</span>=<span style="color: #658b00">float</span>,
                        default=[<span style="color: #B452CD">1.0</span>], help=<span style="color: #CD5555">&#39;time step values&#39;</span>,
                        metavar=<span style="color: #CD5555">&#39;dt&#39;</span>, nargs=<span style="color: #CD5555">&#39;+&#39;</span>, dest=<span style="color: #CD5555">&#39;dt_values&#39;</span>)
    <span style="color: #8B008B; font-weight: bold">return</span> parser
</pre></div>
</td></tr></table><p>
Automatically generated help functionality:

<p>

<!-- code=bash (from !bc sys) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">Terminal&gt; python decay_argparse.py -h
  ...
  --I I, --initial_condition I
                        initial condition, u(0)
  ...
</pre></div>
</td></tr></table><p>
Structure of this help output:

<p>

<!-- code=text typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">  --I metavar, --initial_condition metavar
                        help-string
</pre></div>
</td></tr></table><p>
How to read data from the command line:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">read_command_line</span>():
    parser = define_command_line_options()
    args = parser.parse_args()
    <span style="color: #8B008B; font-weight: bold">print</span> <span style="color: #CD5555">&#39;I={}, a={}, T={}, makeplot={}, dt_values={}&#39;</span>.format(
        args.I, args.a, args.T, args.makeplot, args.dt_values)
    <span style="color: #8B008B; font-weight: bold">return</span> args.I, args.a, args.T, args.makeplot, args.dt_values
</pre></div>
</td></tr></table><p>
Complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/decay_argparse.py"><tt>decay_argparse.py</tt></a>.

<h3>Computing convergence rates  <a name="___sec17"></a></h3>

<p>
Frequent assumption on the relation between the numerical error \( E \) and
some discretization parameter \( \Delta t \):

<p>
$$
\begin{equation}
E = C\Delta t^r,
\label{decay:E:dt}
\end{equation}
$$

Unknown: \( C \) and \( r \).

<h4>Estimating the convergence rate \( r \)  <a name="___sec18"></a></h4>

<p>
Perform numerical experiments: \( (\Delta t_i, E_i) \), \( i=0,\ldots,m-1 \).

<p>

<ol>
 <p><li> Take the logarithm of \eqref{decay:E:dt}, \( \ln E = r\ln \Delta t + \ln C \),
    and fit a straight line to the data points \( (\Delta t_i, E_i) \),
    \( i=0,\ldots,m-1 \).</li>
 <p><li> Consider two consecutive experiments, \( (\Delta t_i, E_i) \) and
    \( (\Delta t_{i-1}, E_{i-1}) \). Dividing the equation
    \( E_{i-1}=C\Delta t_{i-1}^r \) by \( E_{i}=C\Delta t_{i}^r \) and solving
    for \( r \) yields</li>
</ol>

$$
\begin{equation}
r_{i-1} = \frac{\ln (E_{i-1}/E_i)}{\ln (\Delta t_{i-1}/\Delta t_i)}
\label{decay:conv:rate}
\end{equation}
$$

for \( i=1,=\ldots,m-1 \).

<p>
Method 2 is best.

<h4>Implementation  <a name="___sec19"></a></h4>

<p>
Compute \( r_0, r_1, \ldots, r_{m-2} \):

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">math</span> <span style="color: #8B008B; font-weight: bold">import</span> log

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">main</span>():
    I, a, T, makeplot, dt_values = read_command_line()
    r = {}  <span style="color: #228B22"># estimated convergence rates</span>
    <span style="color: #8B008B; font-weight: bold">for</span> theta <span style="color: #8B008B">in</span> <span style="color: #B452CD">0</span>, <span style="color: #B452CD">0.5</span>, <span style="color: #B452CD">1</span>:
        E_values = []
        <span style="color: #8B008B; font-weight: bold">for</span> dt <span style="color: #8B008B">in</span> dt_values:
            E = explore(I, a, T, dt, theta, makeplot=<span style="color: #658b00">False</span>)
            E_values.append(E)

        <span style="color: #228B22"># Compute convergence rates</span>
        m = <span style="color: #658b00">len</span>(dt_values)
        r[theta] = [log(E_values[i-<span style="color: #B452CD">1</span>]/E_values[i])/
                    log(dt_values[i-<span style="color: #B452CD">1</span>]/dt_values[i])
                    <span style="color: #8B008B; font-weight: bold">for</span> i <span style="color: #8B008B">in</span> <span style="color: #658b00">range</span>(<span style="color: #B452CD">1</span>, m, <span style="color: #B452CD">1</span>)]

    <span style="color: #8B008B; font-weight: bold">for</span> theta <span style="color: #8B008B">in</span> r:
        <span style="color: #8B008B; font-weight: bold">print</span> <span style="color: #CD5555">&#39;\nPairwise convergence rates for theta=%g:&#39;</span> % theta
        <span style="color: #8B008B; font-weight: bold">print</span> <span style="color: #CD5555">&#39; &#39;</span>.join([<span style="color: #CD5555">&#39;%.2f&#39;</span> % r_ <span style="color: #8B008B; font-weight: bold">for</span> r_ <span style="color: #8B008B">in</span> r[theta]])
    <span style="color: #8B008B; font-weight: bold">return</span> r
</pre></div>
</td></tr></table><p>
Complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/decay_convrate.py"><tt>decay_convrate.py</tt></a>.

<p>
Example on execution:

<p>

<!-- code=bash (from !bc sys) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">Terminal&gt; python decay_convrate.py --dt 0.5 0.25 0.1 0.05 0.025 0.01
...
Pairwise convergence rates <span style="color: #8B008B; font-weight: bold">for </span><span style="color: #00688B">theta</span>=0:
1.33 1.15 1.07 1.03 1.02

Pairwise convergence rates <span style="color: #8B008B; font-weight: bold">for </span><span style="color: #00688B">theta</span>=0.5:
2.14 2.07 2.03 2.01 2.01

Pairwise convergence rates <span style="color: #8B008B; font-weight: bold">for </span><span style="color: #00688B">theta</span>=1:
0.98 0.99 0.99 1.00 1.00
</pre></div>
</td></tr></table><h4>Verification  <a name="___sec20"></a></h4>

<p>
Strong verification method: verify that \( r \) has the expected value!

<h4>Debugging via convergence rates  <a name="___sec21"></a></h4>

<p>
Potential bug: missing <code>a</code> in the denominator,

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">u[n+<span style="color: #B452CD">1</span>] = (<span style="color: #B452CD">1</span> - (<span style="color: #B452CD">1</span>-theta)*a*dt)/(<span style="color: #B452CD">1</span> + theta*dt)*u[n]
</pre></div>
</td></tr></table><p>
Running <code>decay_convrate.py</code> gives same rates.

<p>
Why? The value of \( a \)... (\( a=1 \))

<p>
0 and 1 are <em>bad values</em> in tests!

<p>
Better:
<p>

<!-- code=bash (from !bc sys) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">Terminal&gt; python decay_convrate.py --a 2.1 --I 0.1  <span style="color: #CD5555">\</span>
          --dt 0.5 0.25 0.1 0.05 0.025 0.01
...
Pairwise convergence rates <span style="color: #8B008B; font-weight: bold">for </span><span style="color: #00688B">theta</span>=0:
1.49 1.18 1.07 1.04 1.02

Pairwise convergence rates <span style="color: #8B008B; font-weight: bold">for </span><span style="color: #00688B">theta</span>=0.5:
-1.42 -0.22 -0.07 -0.03 -0.01

Pairwise convergence rates <span style="color: #8B008B; font-weight: bold">for </span><span style="color: #00688B">theta</span>=1:
0.21 0.12 0.06 0.03 0.01
</pre></div>
</td></tr></table><p>
Forward Euler works...because \( \theta=0 \) hides the bug.

<p>
This bug gives \( r\approx 0 \):

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">u[n+<span style="color: #B452CD">1</span>] = ((<span style="color: #B452CD">1</span>-theta)*a*dt)/(<span style="color: #B452CD">1</span> + theta*dt*a)*u[n]
</pre></div>
</td></tr></table><h3>Memory-saving implementation  <a name="___sec22"></a></h3>

<p>

<ul>
 <p><li> Note 1: we store the entire array <code>u</code>, i.e., \( u^n \) for \( n=0,1,\ldots,N_t \)</li>
 <p><li> Note 2: the formula for \( u^{n+1} \) needs \( u^n \) only, not \( u^{n-1} \), \( u^{n-2} \), ...</li>
 <p><li> No need to store more than \( u^{n+1} \) and \( u^{n} \)</li>
 <p><li> Extremely important when solving PDEs</li>
 <p><li> No practical importance here (much memory available)</li>
 <p><li> But let's illustrate how to do save memory!</li>
 <p><li> Idea 1: store \( u^{n+1} \) in <code>u</code>, \( u^n \) in <code>u_1</code> (<code>float</code>)</li>
 <p><li> Idea 2: store <code>u</code> in a file, read file later for plotting</li>
</ul>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">solver_memsave</span>(I, a, T, dt, theta, filename=<span style="color: #CD5555">&#39;sol.dat&#39;</span>):
    <span style="color: #CD5555">&quot;&quot;&quot;</span>
<span style="color: #CD5555">    Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.</span>
<span style="color: #CD5555">    Minimum use of memory. The solution is store on file</span>
<span style="color: #CD5555">    (with name filename) for later plotting.</span>
<span style="color: #CD5555">    &quot;&quot;&quot;</span>
    dt = <span style="color: #658b00">float</span>(dt)         <span style="color: #228B22"># avoid integer division</span>
    Nt = <span style="color: #658b00">int</span>(<span style="color: #658b00">round</span>(T/dt))  <span style="color: #228B22"># no of intervals</span>

    outfile = <span style="color: #658b00">open</span>(filename, <span style="color: #CD5555">&#39;w&#39;</span>)
    <span style="color: #228B22"># u: time level n+1, u_1: time level n</span>
    t = <span style="color: #B452CD">0</span>
    u_1 = I
    outfile.write(<span style="color: #CD5555">&#39;%.16E  %.16E\n&#39;</span> % (t, u_1))
    <span style="color: #8B008B; font-weight: bold">for</span> n <span style="color: #8B008B">in</span> <span style="color: #658b00">range</span>(<span style="color: #B452CD">1</span>, Nt+<span style="color: #B452CD">1</span>):
        u = (<span style="color: #B452CD">1</span> - (<span style="color: #B452CD">1</span>-theta)*a*dt)/(<span style="color: #B452CD">1</span> + theta*dt*a)*u_1
        u_1 = u
        t += dt
        outfile.write(<span style="color: #CD5555">&#39;%.16E  %.16E\n&#39;</span> % (t, u))
    outfile.close()
    <span style="color: #8B008B; font-weight: bold">return</span> u, t
</pre></div>
</td></tr></table><p>
Reading the computed data:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">read_file</span>(filename=<span style="color: #CD5555">&#39;sol.dat&#39;</span>):
    infile = <span style="color: #658b00">open</span>(filename, <span style="color: #CD5555">&#39;r&#39;</span>)
    u = [];  t = []
    <span style="color: #8B008B; font-weight: bold">for</span> line <span style="color: #8B008B">in</span> infile:
        words = line.split()
        <span style="color: #8B008B; font-weight: bold">if</span> <span style="color: #658b00">len</span>(words) != <span style="color: #B452CD">2</span>:
            <span style="color: #8B008B; font-weight: bold">print</span> <span style="color: #CD5555">&#39;Found more than two numbers on a line!&#39;</span>, words
            sys.exit(<span style="color: #B452CD">1</span>)  <span style="color: #228B22"># abort</span>
        t.append(<span style="color: #658b00">float</span>(words[<span style="color: #B452CD">0</span>]))
        u.append(<span style="color: #658b00">float</span>(words[<span style="color: #B452CD">1</span>]))
    <span style="color: #8B008B; font-weight: bold">return</span> np.array(t), np.array(u)
</pre></div>
</td></tr></table><p>
Simpler code with <code>numpy</code> functionality for reading/writing tabular data:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">read_file_numpy</span>(filename=<span style="color: #CD5555">&#39;sol.dat&#39;</span>):
    data = np.loadtxt(filename)
    t = data[:,<span style="color: #B452CD">0</span>]
    u = data[:,<span style="color: #B452CD">1</span>]
    <span style="color: #8B008B; font-weight: bold">return</span> t, u
</pre></div>
</td></tr></table><p>
Similar function <code>np.savetxt</code>, but then we need all \( u^n \) and \( t^n \) values
in a two-dimensional array (which we try to prevent now!).

<p>
Usage:
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">explore</span>(I, a, T, dt, theta=<span style="color: #B452CD">0.5</span>, makeplot=<span style="color: #658b00">True</span>):
    filename = <span style="color: #CD5555">&#39;u.dat&#39;</span>
    u, t = solver_minmem(I, a, T, dt, theta, filename)

    t, u = read_file(filename)
    u_e = exact_solution(t, I, a)
    e = u_e - u
    E = np.sqrt(dt*np.sum(e**<span style="color: #B452CD">2</span>))
    <span style="color: #8B008B; font-weight: bold">if</span> makeplot:
        plt.figure()
        ...
</pre></div>
</td></tr></table><p>
Complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/decay_memsave.py"><tt>decay_memsave.py</tt></a>.

<h2>Software engineering  <a name="___sec23"></a></h2>

<p>
Goal: make more professional numerical software.

<p>
Topics:

<p>

<ul>
  <p><li> How to make modules (reusable libraries)</li>
  <p><li> Testing frameworks (doctest, nose, unittest)</li>
  <p><li> Implementation with classes</li>
</ul>

<h3>Making a module  <a name="___sec24"></a></h3>

<p>

<ul>
 <p><li> Previous programs: much repetitive code (esp. <code>solver</code>)</li>
 <p><li> DRY (Don' Repeat Yourself) principle: no copies of code</li>
 <p><li> A change needs to be done in one <em>and only one</em> place</li>
 <p><li> Module = just a file with functions (reused through <code>import</code>)</li>
 <p><li> Let's make a module of</li>

<ul>
   <p><li> <code>solver</code></li>
   <p><li> <code>verify_three_steps</code></li>
   <p><li> <code>verify_discrete_solution</code></li>
   <p><li> <code>explore</code></li>
   <p><li> <code>define_command_line_options</code></li>
   <p><li> <code>read_command_line</code></li>
   <p><li> <code>main</code> (with convergence rates)</li>
   <p><li> <code>verify_convergence_rate</code></li>
</ul>

</ul>

Module name: <code>decay_mod</code>, filename: <code>decay_mod.py</code>.

<p>
Sketch:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">numpy</span> <span style="color: #8B008B; font-weight: bold">import</span> *
<span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">matplotlib.pyplot</span> <span style="color: #8B008B; font-weight: bold">import</span> *
<span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">sys</span>

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">solver</span>(I, a, T, dt, theta):
    ...

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">verify_three_steps</span>():
    ...

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">verify_exact_discrete_solution</span>():
    ...

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">exact_solution</span>(t, I, a):
    ...

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">explore</span>(I, a, T, dt, theta=<span style="color: #B452CD">0.5</span>, makeplot=<span style="color: #658b00">True</span>):
    ...

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">define_command_line_options</span>():
    ...

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">read_command_line</span>(use_argparse=<span style="color: #658b00">True</span>):
    ...

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">main</span>():
    ...
</pre></div>
</td></tr></table><p>
That is! It's a module <code>decay_mod</code> in file <code>decay_mod.py</code>.

<p>
Usage in some other program:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">decay_mod</span> <span style="color: #8B008B; font-weight: bold">import</span> solver
u, t = solver(I=<span style="color: #B452CD">1.0</span>, a=<span style="color: #B452CD">3.0</span>, T=<span style="color: #B452CD">3</span>, dt=<span style="color: #B452CD">0.01</span>, theta=<span style="color: #B452CD">0.5</span>)
</pre></div>
</td></tr></table><p>
Test block:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">if</span> __name__ == <span style="color: #CD5555">&#39;__main__&#39;</span>:
    main()
</pre></div>
</td></tr></table><p>
If <code>decay_mod</code> is imported, <code>__name__</code> is <code>decay_mod</code>.

<p>
If <code>decay_mod.py</code> is run, <code>__name__</code> is <code>__main__</code>.

<p>
Use test block for testing, demo, user interface, ...

<p>
Extended test block:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">if</span> __name__ == <span style="color: #CD5555">&#39;__main__&#39;</span>:
    <span style="color: #8B008B; font-weight: bold">if</span> <span style="color: #CD5555">&#39;verify&#39;</span> <span style="color: #8B008B">in</span> sys.argv:
        <span style="color: #8B008B; font-weight: bold">if</span> verify_three_steps() <span style="color: #8B008B">and</span> verify_discrete_solution():
            <span style="color: #8B008B; font-weight: bold">pass</span> <span style="color: #228B22"># ok</span>
        <span style="color: #8B008B; font-weight: bold">else</span>:
            <span style="color: #8B008B; font-weight: bold">print</span> <span style="color: #CD5555">&#39;Bug in the implementation!&#39;</span>
    <span style="color: #8B008B; font-weight: bold">elif</span> <span style="color: #CD5555">&#39;verify_rates&#39;</span> <span style="color: #8B008B">in</span> sys.argv:
        sys.argv.remove(<span style="color: #CD5555">&#39;verify_rates&#39;</span>)
        <span style="color: #8B008B; font-weight: bold">if</span> <span style="color: #8B008B">not</span> <span style="color: #CD5555">&#39;--dt&#39;</span> <span style="color: #8B008B">in</span> sys.argv:
            <span style="color: #8B008B; font-weight: bold">print</span> <span style="color: #CD5555">&#39;Must assign several dt values&#39;</span>
            sys.exit(<span style="color: #B452CD">1</span>)  <span style="color: #228B22"># abort</span>
        <span style="color: #8B008B; font-weight: bold">if</span> verify_convergence_rate():
            <span style="color: #8B008B; font-weight: bold">pass</span>
        <span style="color: #8B008B; font-weight: bold">else</span>:
            <span style="color: #8B008B; font-weight: bold">print</span> <span style="color: #CD5555">&#39;Bug in the implementation!&#39;</span>
    <span style="color: #8B008B; font-weight: bold">else</span>:
        <span style="color: #228B22"># Perform simulations</span>
        main()
</pre></div>
</td></tr></table><h3>Prefixing imported functions by the module name  <a name="___sec25"></a></h3>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">numpy</span> <span style="color: #8B008B; font-weight: bold">import</span> *
<span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">matplotlib.pyplot</span> <span style="color: #8B008B; font-weight: bold">import</span> *
</pre></div>
</td></tr></table><p>
This imports a large number of names (<code>sin</code>, <code>exp</code>, <code>linspace</code>, <code>plot</code>, ...).

<p>
Confusion: is a function from`numpy`? Or <code>matplotlib.pyplot</code>?
Or is it our own function?

<p>
Alternative (recommended) import:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">numpy</span>
<span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">matplotlib.pyplot</span>
</pre></div>
</td></tr></table><p>
Now we need to prefix functions with module name:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">t = numpy.linspace(<span style="color: #B452CD">0</span>, T, Nt+<span style="color: #B452CD">1</span>)
u_e = I*numpy.exp(-a*t)
matplotlib.pyplot.plot(t, u_e)
</pre></div>
</td></tr></table><p>
Common standard:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">numpy</span> <span style="color: #8B008B; font-weight: bold">as</span> <span style="color: #008b45; text-decoration: underline">np</span>
<span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">matplotlib.pyplot</span> <span style="color: #8B008B; font-weight: bold">as</span> <span style="color: #008b45; text-decoration: underline">plt</span>

t = np.linspace(<span style="color: #B452CD">0</span>, T, Nt+<span style="color: #B452CD">1</span>)
u_e = I*np.exp(-a*t)
plt.plot(t, u_e)
</pre></div>
</td></tr></table><p>
Downside:
math line \( e^{-at}\sin(2\pi t) \) gets
cluttered with module names,
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">numpy.exp(-a*t)*numpy.sin(<span style="color: #B452CD">2</span>(numpy.pi*t)
<span style="color: #228B22"># or</span>
np.exp(-a*t)*np.sin(<span style="color: #B452CD">2</span>*np.pi*t)
</pre></div>
</td></tr></table><h3>Doctests  <a name="___sec26"></a></h3>

<p>
Doc strings can be equipped with interactive Python sessions for
demonstrating usage and <em>automatic testing</em> of functions.

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">solver</span>(I, a, T, dt, theta):
    <span style="color: #CD5555">&quot;&quot;&quot;</span>
<span style="color: #CD5555">    Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.</span>


<span style="color: #CD5555">    &gt;&gt;&gt; u, t = solver(I=0.8, a=1.2, T=4, dt=0.5, theta=0.5)</span>
<span style="color: #CD5555">    &gt;&gt;&gt; for t_n, u_n in zip(t, u):</span>
<span style="color: #CD5555">    ...     print &#39;t=%.1f, u=%.14f&#39; % (t_n, u_n)</span>
<span style="color: #CD5555">    t=0.0, u=0.80000000000000</span>
<span style="color: #CD5555">    t=0.5, u=0.43076923076923</span>
<span style="color: #CD5555">    t=1.0, u=0.23195266272189</span>
<span style="color: #CD5555">    t=1.5, u=0.12489758761948</span>
<span style="color: #CD5555">    t=2.0, u=0.06725254717972</span>
<span style="color: #CD5555">    t=2.5, u=0.03621291001985</span>
<span style="color: #CD5555">    t=3.0, u=0.01949925924146</span>
<span style="color: #CD5555">    t=3.5, u=0.01049960113002</span>
<span style="color: #CD5555">    t=4.0, u=0.00565363137770</span>
<span style="color: #CD5555">    &quot;&quot;&quot;</span>
    ...
</pre></div>
</td></tr></table><p>
Automatic check that the code gives the same output as above:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">Terminal&gt; python -m doctest decay_mod_doctest.py
</pre></div>
</td></tr></table><p>
Report in case of failure:

<p>

<!-- code=bash (from !bc sys) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">Terminal&gt; python -m doctest decay_mod_doctest.py
********************************************************
File <span style="color: #CD5555">&quot;decay_mod_doctest.py&quot;</span>, line 12, in decay_mod_doctest....
Failed example:
    <span style="color: #8B008B; font-weight: bold">for </span>t_n, u_n in zip(t, u):
        print <span style="color: #CD5555">&#39;t=%.1f, u=%.14f&#39;</span> % (t_n, u_n)
Expected:
    <span style="color: #00688B">t</span>=0.0, <span style="color: #00688B">u</span>=0.80000000000000
    <span style="color: #00688B">t</span>=0.5, <span style="color: #00688B">u</span>=0.43076923076923
    <span style="color: #00688B">t</span>=1.0, <span style="color: #00688B">u</span>=0.23195266272189
    <span style="color: #00688B">t</span>=1.5, <span style="color: #00688B">u</span>=0.12489758761948
    <span style="color: #00688B">t</span>=2.0, <span style="color: #00688B">u</span>=0.06725254717972
    <span style="color: #00688B">t</span>=2.5, <span style="color: #00688B">u</span>=0.03621291001985
    <span style="color: #00688B">t</span>=3.0, <span style="color: #00688B">u</span>=0.01949925924146
    <span style="color: #00688B">t</span>=3.5, <span style="color: #00688B">u</span>=0.01049960113002
    <span style="color: #00688B">t</span>=4.0, <span style="color: #00688B">u</span>=0.00565363137770
Got:
    <span style="color: #00688B">t</span>=0.0, <span style="color: #00688B">u</span>=0.80000000000000
    <span style="color: #00688B">t</span>=0.5, <span style="color: #00688B">u</span>=0.43076923076923
    <span style="color: #00688B">t</span>=1.0, <span style="color: #00688B">u</span>=0.23195266272189
    <span style="color: #00688B">t</span>=1.5, <span style="color: #00688B">u</span>=0.12489758761948
    <span style="color: #00688B">t</span>=2.0, <span style="color: #00688B">u</span>=0.06725254717972
********************************************************
1 items had failures:
   1 of   2 in decay_mod_doctest.solver
***Test Failed*** 1 failures.
</pre></div>
</td></tr></table><p>
Limit the number of digits in the output in doctests! Otherwise,
round-off errors on a different machine may ruin the test.

<p>
Another example on using doctests:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">explore</span>(I, a, T, dt, theta=<span style="color: #B452CD">0.5</span>, makeplot=<span style="color: #658b00">True</span>):
    <span style="color: #CD5555">&quot;&quot;&quot;</span>
<span style="color: #CD5555">    Run a case with the solver, compute error measure,</span>
<span style="color: #CD5555">    and plot the numerical and exact solutions (if makeplot=True).</span>

<span style="color: #CD5555">    &gt;&gt;&gt; for theta in 0, 0.5, 1:</span>
<span style="color: #CD5555">    ...    E = explore(I=1.9, a=2.1, T=5, dt=0.1, theta=theta,</span>
<span style="color: #CD5555">    ...                makeplot=False)</span>
<span style="color: #CD5555">    ...    print &#39;%.10E&#39; % E</span>
<span style="color: #CD5555">    ...</span>
<span style="color: #CD5555">    7.3565079236E-02</span>
<span style="color: #CD5555">    2.4183893110E-03</span>
<span style="color: #CD5555">    6.5013039886E-02</span>
<span style="color: #CD5555">    &quot;&quot;&quot;</span>
    ...
</pre></div>
</td></tr></table><p>
Complete program: <a href="${src_decay}/decay_mod_doctest.py"><tt>decay_mod_doctest.py</tt></a>.

<p>
Avoid doctests in functions using <code>sys.argv</code> and <code>print</code> (possible,
but needs careful coding).

<h3>Unit testing with nose  <a name="___sec27"></a></h3>

<p>

<ul>
 <p><li> Nose is a very user-friendly testing framework</li>
 <p><li> Based on <em>unit testing</em></li>
 <p><li> Identify small units of code</li>
 <p><li> Test each unit</li>
 <p><li> Nose automates running all tests</li>
 <p><li> Good habit: make a small edit in a code, run all tests</li>
 <p><li> Even better habit: write tests before the code</li>
 <p><li> Unit testing in scientific computing is not well so established</li>
</ul>

<h4>Basic use of nose  <a name="___sec28"></a></h4>

<p>

<ol>
 <p><li> Implement tests in functions with names starting with <code>test_</code>.</li>
 <p><li> Test functions perform assertions on computed results
    using <code>assert</code> functions from the <code>nose.tools</code> module.</li>
 <p><li> Test functions can be in the source code files or be
    collected in separate files, usually with names starting with <code>test_</code>.</li>
</ol>

Very simple illustration of module <code>mymod</code>:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">double</span>(n):
    <span style="color: #8B008B; font-weight: bold">return</span> <span style="color: #B452CD">2</span>*n
</pre></div>
</td></tr></table><p>
Either in this file or in a separate file <code>test_mymod.py</code>, we
implement a test function for checking that
<code>double</code> works:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">nose.tools</span> <span style="color: #8B008B; font-weight: bold">as</span> <span style="color: #008b45; text-decoration: underline">nt</span>

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">test_double</span>():
    result = mymod.double(<span style="color: #B452CD">4</span>)
    nt.assert_equal(result, <span style="color: #B452CD">8</span>)
</pre></div>
</td></tr></table><p>
(Need <code>import mymod</code> if the test is in <code>test_mymod.py</code>.)

<p>
Running

<p>

<!-- code=bash (from !bc sys) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">Terminal&gt; nosetests
</pre></div>
</td></tr></table><p>
makes the <code>nose</code> tool look for Python files with <code>test_*()</code>
functions and run these functions.

<p>
Main point with a test function: raise <code>AssertionError</code> exception if the
test fails.

<p>
Alternative:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">if</span> result != <span style="color: #B452CD">8</span>:
    <span style="color: #8B008B; font-weight: bold">raise</span> <span style="color: #008b45; font-weight: bold">AssertionError</span>()
</pre></div>
</td></tr></table><p>
Advantage of nose:

<p>

<ul>
  <p><li> tests are written and collected in a structured way</li>
  <p><li> large collections of tests, scattered throughout a tree of folders,
    can be executed with one command (<code>nosetests</code>).</li>
</ul>

<h4>Demonstrating nose  <a name="___sec29"></a></h4>

<p>
Back to the exponential decay problem and the <code>solver</code> function.

<p>
We design three unit tests:

<p>

<ol>
 <p><li> A comparison between the computed \( u^n \) values and the
    exact discrete solution.</li>
 <p><li> A comparison between the computed \( u^n \) values and precomputed,
    verified reference values.</li>
 <p><li> A comparison between observed and expected convergence rates.</li>
</ol>

These tests follow very closely the previous <code>verify*</code> functions.

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">nose.tools</span> <span style="color: #8B008B; font-weight: bold">as</span> <span style="color: #008b45; text-decoration: underline">nt</span>
<span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">sys</span>, <span style="color: #008b45; text-decoration: underline">os</span>
sys.path.insert(<span style="color: #B452CD">0</span>, os.pardir)
<span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">decay_mod_unittest</span> <span style="color: #8B008B; font-weight: bold">as</span> <span style="color: #008b45; text-decoration: underline">decay_mod</span>
<span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">numpy</span> <span style="color: #8B008B; font-weight: bold">as</span> <span style="color: #008b45; text-decoration: underline">np</span>

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">exact_discrete_solution</span>(n, I, a, theta, dt):
    <span style="color: #CD5555">&quot;&quot;&quot;Return exact discrete solution of the theta scheme.&quot;&quot;&quot;</span>
    dt = <span style="color: #658b00">float</span>(dt)  <span style="color: #228B22"># avoid integer division</span>
    factor = (<span style="color: #B452CD">1</span> - (<span style="color: #B452CD">1</span>-theta)*a*dt)/(<span style="color: #B452CD">1</span> + theta*dt*a)
    <span style="color: #8B008B; font-weight: bold">return</span> I*factor**n

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">test_against_discrete_solution</span>():
    <span style="color: #CD5555">&quot;&quot;&quot;</span>
<span style="color: #CD5555">    Compare result from solver against</span>
<span style="color: #CD5555">    formula for the discrete solution.</span>
<span style="color: #CD5555">    &quot;&quot;&quot;</span>
    theta = <span style="color: #B452CD">0.8</span>; a = <span style="color: #B452CD">2</span>; I = <span style="color: #B452CD">0.1</span>; dt = <span style="color: #B452CD">0.8</span>
    N = <span style="color: #658b00">int</span>(<span style="color: #B452CD">8</span>/dt)  <span style="color: #228B22"># no of steps</span>
    u, t = decay_mod.solver(I=I, a=a, T=N*dt, dt=dt, theta=theta)
    u_de = np.array([exact_discrete_solution(n, I, a, theta, dt)
                     <span style="color: #8B008B; font-weight: bold">for</span> n <span style="color: #8B008B">in</span> <span style="color: #658b00">range</span>(N+<span style="color: #B452CD">1</span>)])
    diff = np.abs(u_de - u).max()
    nt.assert_almost_equal(diff, <span style="color: #B452CD">0</span>, delta=<span style="color: #B452CD">1E-14</span>)
</pre></div>
</td></tr></table><p>
<code>nt.assert_almost_equal</code>: compare two floats and avoid
differences due to round-off errors.

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">test_solver</span>():
    <span style="color: #CD5555">&quot;&quot;&quot;</span>
<span style="color: #CD5555">    Compare result from solver against</span>
<span style="color: #CD5555">    precomputed arrays for theta=0, 0.5, 1.</span>
<span style="color: #CD5555">    &quot;&quot;&quot;</span>
    I=<span style="color: #B452CD">0.8</span>; a=<span style="color: #B452CD">1.2</span>; T=<span style="color: #B452CD">4</span>; dt=<span style="color: #B452CD">0.5</span>  <span style="color: #228B22"># fixed parameters</span>
    precomputed = {
        <span style="color: #CD5555">&#39;t&#39;</span>: np.array([ <span style="color: #B452CD">0.</span> ,  <span style="color: #B452CD">0.5</span>,  <span style="color: #B452CD">1.</span> ,  <span style="color: #B452CD">1.5</span>,  <span style="color: #B452CD">2.</span> ,  <span style="color: #B452CD">2.5</span>,
                        <span style="color: #B452CD">3.</span> ,  <span style="color: #B452CD">3.5</span>,  <span style="color: #B452CD">4.</span> ]),
        <span style="color: #B452CD">0.5</span>: np.array(
            [ <span style="color: #B452CD">0.8</span>       ,  <span style="color: #B452CD">0.43076923</span>,  <span style="color: #B452CD">0.23195266</span>, <span style="color: #B452CD">0.12489759</span>,
              <span style="color: #B452CD">0.06725255</span>,  <span style="color: #B452CD">0.03621291</span>,  <span style="color: #B452CD">0.01949926</span>, <span style="color: #B452CD">0.0104996</span> ,
              <span style="color: #B452CD">0.00565363</span>]),
        <span style="color: #B452CD">0</span>: np.array(
            [  <span style="color: #B452CD">8.00000000e-01</span>,   <span style="color: #B452CD">3.20000000e-01</span>,
               <span style="color: #B452CD">1.28000000e-01</span>,   <span style="color: #B452CD">5.12000000e-02</span>,
               <span style="color: #B452CD">2.04800000e-02</span>,   <span style="color: #B452CD">8.19200000e-03</span>,
               <span style="color: #B452CD">3.27680000e-03</span>,   <span style="color: #B452CD">1.31072000e-03</span>,
               <span style="color: #B452CD">5.24288000e-04</span>]),
        <span style="color: #B452CD">1</span>: np.array(
            [ <span style="color: #B452CD">0.8</span>       ,  <span style="color: #B452CD">0.5</span>       ,  <span style="color: #B452CD">0.3125</span>    ,  <span style="color: #B452CD">0.1953125</span> ,
              <span style="color: #B452CD">0.12207031</span>,  <span style="color: #B452CD">0.07629395</span>,  <span style="color: #B452CD">0.04768372</span>,  <span style="color: #B452CD">0.02980232</span>,
              <span style="color: #B452CD">0.01862645</span>]),
        }
    <span style="color: #8B008B; font-weight: bold">for</span> theta <span style="color: #8B008B">in</span> <span style="color: #B452CD">0</span>, <span style="color: #B452CD">0.5</span>, <span style="color: #B452CD">1</span>:
        u, t = decay_mod.solver(I, a, T, dt, theta=theta)
        diff = np.abs(u - precomputed[theta]).max()
        <span style="color: #228B22"># Precomputed numbers are known to 8 decimal places</span>
        nt.assert_almost_equal(diff, <span style="color: #B452CD">0</span>, places=<span style="color: #B452CD">8</span>,
                               msg=<span style="color: #CD5555">&#39;theta=%s&#39;</span> % theta)
</pre></div>
</td></tr></table><p>

<ul>
 <p><li> Testing for special type of input data that may cause trouble is important</li>
 <p><li> Here: the formula for \( u^{n+1} \) may involve integer division</li>
</ul>

Example:
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">theta = <span style="color: #B452CD">1</span>; a = <span style="color: #B452CD">1</span>; I = <span style="color: #B452CD">1</span>; dt = <span style="color: #B452CD">2</span>
</pre></div>
</td></tr></table><p>
lead to integer division:
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">(<span style="color: #B452CD">1</span> - (<span style="color: #B452CD">1</span>-theta)*a*dt)  <span style="color: #228B22"># becomes 1</span>
(<span style="color: #B452CD">1</span> + theta*dt*a)      <span style="color: #228B22"># becomes 2</span>
(<span style="color: #B452CD">1</span> - (<span style="color: #B452CD">1</span>-theta)*a*dt)/(<span style="color: #B452CD">1</span> + theta*dt*a)  <span style="color: #228B22"># becomes 0 (!)</span>
</pre></div>
</td></tr></table><p>
Unit test for this issue:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">test_potential_integer_division</span>():
    <span style="color: #CD5555">&quot;&quot;&quot;Choose variables that can trigger integer division.&quot;&quot;&quot;</span>
    theta = <span style="color: #B452CD">1</span>; a = <span style="color: #B452CD">1</span>; I = <span style="color: #B452CD">1</span>; dt = <span style="color: #B452CD">2</span>
    N = <span style="color: #B452CD">4</span>
    u, t = decay_mod.solver(I=I, a=a, T=N*dt, dt=dt, theta=theta)
    u_de = np.array([exact_discrete_solution(n, I, a, theta, dt)
                     <span style="color: #8B008B; font-weight: bold">for</span> n <span style="color: #8B008B">in</span> <span style="color: #658b00">range</span>(N+<span style="color: #B452CD">1</span>)])
    diff = np.abs(u_de - u).max()
    nt.assert_almost_equal(diff, <span style="color: #B452CD">0</span>, delta=<span style="color: #B452CD">1E-14</span>)
</pre></div>
</td></tr></table><p>
Test convergence rates:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">test_convergence_rates</span>():
    <span style="color: #CD5555">&quot;&quot;&quot;Compare empirical convergence rates to exact ones.&quot;&quot;&quot;</span>
    <span style="color: #228B22"># Set command-line arguments directly in sys.argv</span>
    sys.argv[<span style="color: #B452CD">1</span>:] = <span style="color: #CD5555">&#39;--I 0.8 --a 2.1 --T 5 &#39;</span>\ 
                   <span style="color: #CD5555">&#39;--dt 0.4 0.2 0.1 0.05 0.025&#39;</span>.split()
    <span style="color: #228B22"># Suppress output from decay_mod.main()</span>
    stdout = sys.stdout  <span style="color: #228B22"># save standard output for later use</span>
    scratchfile = <span style="color: #658b00">open</span>(<span style="color: #CD5555">&#39;.tmp&#39;</span>, <span style="color: #CD5555">&#39;w&#39;</span>)  <span style="color: #228B22"># fake standard output</span>
    sys.stdout = scratchfile

    r = decay_mod.main()
    <span style="color: #8B008B; font-weight: bold">for</span> theta <span style="color: #8B008B">in</span> r:
        nt.assert_true(r[theta])  <span style="color: #228B22"># check for non-empty list</span>

    scratchfile.close()
    sys.stdout = stdout  <span style="color: #228B22"># restore standard output</span>

    expected_rates = {<span style="color: #B452CD">0</span>: <span style="color: #B452CD">1</span>, <span style="color: #B452CD">1</span>: <span style="color: #B452CD">1</span>, <span style="color: #B452CD">0.5</span>: <span style="color: #B452CD">2</span>}
    <span style="color: #8B008B; font-weight: bold">for</span> theta <span style="color: #8B008B">in</span> r:
        r_final = r[theta][-<span style="color: #B452CD">1</span>]
        <span style="color: #228B22"># Compare to 1 decimal place</span>
        nt.assert_almost_equal(expected_rates[theta], r_final,
                               places=<span style="color: #B452CD">1</span>, msg=<span style="color: #CD5555">&#39;theta=%s&#39;</span> % theta)

<span style="color: #228B22"># no need for any main</span>
</pre></div>
</td></tr></table><p>
Complete program: <a href="${src_decay}/test/test_decay_nose.py"><tt>test_decay_nose.py</tt></a>.

<h3>Classical unit testing with unittest  <a name="___sec30"></a></h3>

<p>

<ul>
 <p><li> <code>unittest</code> is a Python module mimicing the classical JUnit
   class-based unit testing framework from Java</li>
 <p><li> This is how unit testing is normally done</li>
 <p><li> Requires knowledge of object-oriented programming</li>
</ul>

<h4>Basic use of unittest  <a name="___sec31"></a></h4>

<p>
Write file <code>test_mymod.py</code>:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">unittest</span>
<span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">mymod</span>

<span style="color: #8B008B; font-weight: bold">class</span> <span style="color: #008b45; font-weight: bold">TestMyCode</span>(unittest.TestCase):
    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">test_double</span>(<span style="color: #658b00">self</span>):
        result = mymod.double(<span style="color: #B452CD">4</span>)
        <span style="color: #658b00">self</span>.assertEqual(result, <span style="color: #B452CD">8</span>)

<span style="color: #8B008B; font-weight: bold">if</span> __name__ == <span style="color: #CD5555">&#39;__main__&#39;</span>:
    unittest.main()
</pre></div>
</td></tr></table><h4>Demonstration of unittest  <a name="___sec32"></a></h4>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">unittest</span>
<span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">decay_mod_unittest</span> <span style="color: #8B008B; font-weight: bold">as</span> <span style="color: #008b45; text-decoration: underline">decay</span>
<span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">numpy</span> <span style="color: #8B008B; font-weight: bold">as</span> <span style="color: #008b45; text-decoration: underline">np</span>

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">exact_discrete_solution</span>(n, I, a, theta, dt):
    factor = (<span style="color: #B452CD">1</span> - (<span style="color: #B452CD">1</span>-theta)*a*dt)/(<span style="color: #B452CD">1</span> + theta*dt*a)
    <span style="color: #8B008B; font-weight: bold">return</span> I*factor**n

<span style="color: #8B008B; font-weight: bold">class</span> <span style="color: #008b45; font-weight: bold">TestDecay</span>(unittest.TestCase):

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">test_against_discrete_solution</span>(<span style="color: #658b00">self</span>):
        ...
        diff = np.abs(u_de - u).max()
        <span style="color: #658b00">self</span>.assertAlmostEqual(diff, <span style="color: #B452CD">0</span>, delta=<span style="color: #B452CD">1E-14</span>)

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">test_solver</span>(<span style="color: #658b00">self</span>):
        ...
        <span style="color: #8B008B; font-weight: bold">for</span> theta <span style="color: #8B008B">in</span> <span style="color: #B452CD">0</span>, <span style="color: #B452CD">0.5</span>, <span style="color: #B452CD">1</span>:
            ...
            <span style="color: #658b00">self</span>.assertAlmostEqual(diff, <span style="color: #B452CD">0</span>, places=<span style="color: #B452CD">8</span>,
                                   msg=<span style="color: #CD5555">&#39;theta=%s&#39;</span> % theta)

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">test_potential_integer_division</span>():
        ...
        <span style="color: #658b00">self</span>.assertAlmostEqual(diff, <span style="color: #B452CD">0</span>, delta=<span style="color: #B452CD">1E-14</span>)

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">test_convergence_rates</span>(<span style="color: #658b00">self</span>):
        ...
        <span style="color: #8B008B; font-weight: bold">for</span> theta <span style="color: #8B008B">in</span> r:
            ...
            <span style="color: #658b00">self</span>.assertAlmostEqual(...)

<span style="color: #8B008B; font-weight: bold">if</span> __name__ == <span style="color: #CD5555">&#39;__main__&#39;</span>:
    unittest.main()
</pre></div>
</td></tr></table><p>
<!-- @@@CODE src-decay/test/test_decay_unittest.py fromto: def test_conv@ -->

<p>
Complete program: <a href="${src_decay}/test/test_decay_nose.py"><tt>test_decay_unittest.py</tt></a>.

<h3>Implementing simple problem and solver classes  <a name="___sec33"></a></h3>

<p>

<ul>
 <p><li> So far: programs are built of Python functions</li>
 <p><li> New focus: alternative implementations using classes</li>
 <p><li> Class-based implementations are very popular,
   especially in business/adm applications</li>
 <p><li> Class-based implementations scales better to large and
   compliex scientific applications</li>
</ul>

Tasks:

<p>

<ul>
 <p><li> Explain basic use of classes to build a differential equation solver</li>
 <p><li> Introduce concepts that make such programs easily scale to
   more complex applications</li>
 <p><li> Demonstrate the advantage of using classes</li>
 <p><li> Idea: classes for Problem, Solver, and Visualizer</li>
 <p><li> Problem: all the physics information about the problem</li>
 <p><li> Solver: all the numerics information + numerical computations</li>
 <p><li> Visualizer: plot the solution and other quantities</li>
</ul>

<h4>The problem class  <a name="___sec34"></a></h4>

<p>

<ul>
 <p><li> Model problem: \( u'=-au \), \( u(0)=I \), for \( t\in (0,T] \).</li>
 <p><li> Class <code>Problem</code> stores the physical parameters \( a \), \( I \), \( T \)</li>
 <p><li> May also offer other data, e.g., \( \uex(t)=Ie^{-at} \)</li>
</ul>

Implementation:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">numpy</span> <span style="color: #8B008B; font-weight: bold">import</span> exp

<span style="color: #8B008B; font-weight: bold">class</span> <span style="color: #008b45; font-weight: bold">Problem</span>:
    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">__init__</span>(<span style="color: #658b00">self</span>, I=<span style="color: #B452CD">1</span>, a=<span style="color: #B452CD">1</span>, T=<span style="color: #B452CD">10</span>):
        <span style="color: #658b00">self</span>.T, <span style="color: #658b00">self</span>.I, <span style="color: #658b00">self</span>.a = I, <span style="color: #658b00">float</span>(a), T

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">exact_solution</span>(<span style="color: #658b00">self</span>, t):
        I, a = <span style="color: #658b00">self</span>.I, <span style="color: #658b00">self</span>.a     <span style="color: #228B22"># extract local variables</span>
        <span style="color: #8B008B; font-weight: bold">return</span> I*exp(-a*t)
</pre></div>
</td></tr></table><p>
Basic usage:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">problem = Problem(T=<span style="color: #B452CD">5</span>)
problem.T = <span style="color: #B452CD">8</span>
problem.dt = <span style="color: #B452CD">1.5</span>
</pre></div>
</td></tr></table><p>
Improvement: read data from the command line.

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">class</span> <span style="color: #008b45; font-weight: bold">Problem</span>:
    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">__init__</span>(<span style="color: #658b00">self</span>, I=<span style="color: #B452CD">1</span>, a=<span style="color: #B452CD">1</span>, T=<span style="color: #B452CD">10</span>):
        <span style="color: #658b00">self</span>.T, <span style="color: #658b00">self</span>.I, <span style="color: #658b00">self</span>.a = I, <span style="color: #658b00">float</span>(a), T

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">define_command_line_options</span>(<span style="color: #658b00">self</span>, parser=<span style="color: #658b00">None</span>):
        <span style="color: #8B008B; font-weight: bold">if</span> parser <span style="color: #8B008B">is</span> <span style="color: #658b00">None</span>:
            <span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">argparse</span>
            parser = argparse.ArgumentParser()

        parser.add_argument(
            <span style="color: #CD5555">&#39;--I&#39;</span>, <span style="color: #CD5555">&#39;--initial_condition&#39;</span>, <span style="color: #658b00">type</span>=<span style="color: #658b00">float</span>,
            default=<span style="color: #658b00">self</span>.I, help=<span style="color: #CD5555">&#39;initial condition, u(0)&#39;</span>,
            metavar=<span style="color: #CD5555">&#39;I&#39;</span>)
        parser.add_argument(
            <span style="color: #CD5555">&#39;--a&#39;</span>, <span style="color: #658b00">type</span>=<span style="color: #658b00">float</span>, default=<span style="color: #658b00">self</span>.a,
            help=<span style="color: #CD5555">&#39;coefficient in ODE&#39;</span>, metavar=<span style="color: #CD5555">&#39;a&#39;</span>)
        parser.add_argument(
            <span style="color: #CD5555">&#39;--T&#39;</span>, <span style="color: #CD5555">&#39;--stop_time&#39;</span>, <span style="color: #658b00">type</span>=<span style="color: #658b00">float</span>, default=<span style="color: #658b00">self</span>.T,
            help=<span style="color: #CD5555">&#39;end time of simulation&#39;</span>, metavar=<span style="color: #CD5555">&#39;T&#39;</span>)
        <span style="color: #8B008B; font-weight: bold">return</span> parser

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">init_from_command_line</span>(<span style="color: #658b00">self</span>, args):
        <span style="color: #658b00">self</span>.I, <span style="color: #658b00">self</span>.a, <span style="color: #658b00">self</span>.T = args.I, args.a, args.T

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">exact_solution</span>(<span style="color: #658b00">self</span>, t):
        I, a = <span style="color: #658b00">self</span>.I, <span style="color: #658b00">self</span>.a
        <span style="color: #8B008B; font-weight: bold">return</span> I*exp(-a*t)
</pre></div>
</td></tr></table><p>
Observe

<p>

<ul>
 <p><li> Can utilize user's <code>ArgumentParser</code>, or make one</li>
 <p><li> <code>None</code> is used to indicate an "empty" (non-initialized) variable</li>
</ul>

<h4>The solver class  <a name="___sec35"></a></h4>

<p>

<ul>
 <p><li> Store numerical data \( \Delta t \), \( \theta \)</li>
 <p><li> Compute solution and quantities derived from the solution</li>
</ul>

Implementation:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">class</span> <span style="color: #008b45; font-weight: bold">Solver</span>:
    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">__init__</span>(<span style="color: #658b00">self</span>, problem, dt=<span style="color: #B452CD">0.1</span>, theta=<span style="color: #B452CD">0.5</span>):
        <span style="color: #658b00">self</span>.problem = problem
        <span style="color: #658b00">self</span>.dt, <span style="color: #658b00">self</span>.theta = <span style="color: #658b00">float</span>(dt), theta

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">define_command_line_options</span>(<span style="color: #658b00">self</span>, parser):
        parser.add_argument(
            <span style="color: #CD5555">&#39;--dt&#39;</span>, <span style="color: #CD5555">&#39;--time_step_value&#39;</span>, <span style="color: #658b00">type</span>=<span style="color: #658b00">float</span>,
            default=<span style="color: #B452CD">0.5</span>, help=<span style="color: #CD5555">&#39;time step value&#39;</span>, metavar=<span style="color: #CD5555">&#39;dt&#39;</span>)
        parser.add_argument(
            <span style="color: #CD5555">&#39;--theta&#39;</span>, <span style="color: #658b00">type</span>=<span style="color: #658b00">float</span>, default=<span style="color: #B452CD">0.5</span>,
            help=<span style="color: #CD5555">&#39;time discretization parameter&#39;</span>, metavar=<span style="color: #CD5555">&#39;dt&#39;</span>)
        <span style="color: #8B008B; font-weight: bold">return</span> parser

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">init_from_command_line</span>(<span style="color: #658b00">self</span>, args):
        <span style="color: #658b00">self</span>.dt, <span style="color: #658b00">self</span>.theta = args.dt, args.theta

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">solve</span>(<span style="color: #658b00">self</span>):
        <span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">decay_mod</span> <span style="color: #8B008B; font-weight: bold">import</span> solver
        <span style="color: #658b00">self</span>.u, <span style="color: #658b00">self</span>.t = solver(
            <span style="color: #658b00">self</span>.problem.I, <span style="color: #658b00">self</span>.problem.a, <span style="color: #658b00">self</span>.problem.T,
            <span style="color: #658b00">self</span>.dt, <span style="color: #658b00">self</span>.theta)

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">error</span>(<span style="color: #658b00">self</span>):
        u_e = <span style="color: #658b00">self</span>.problem.exact_solution(<span style="color: #658b00">self</span>.t)
        e = u_e - <span style="color: #658b00">self</span>.u
        E = sqrt(<span style="color: #658b00">self</span>.dt*<span style="color: #658b00">sum</span>(e**<span style="color: #B452CD">2</span>))
        <span style="color: #8B008B; font-weight: bold">return</span> E
</pre></div>
</td></tr></table><p>
Note: reuse of the numerical algorithm from the <code>decay_mod</code> module.

<h4>The visualizer class  <a name="___sec36"></a></h4>

<p>

<ul>
 <p><li> Store data about what to plot (if any)</li>
 <p><li> Offer different types of plots</li>
 <p><li> Here: make just the same plot as in the previous <code>explore</code> function</li>
</ul>

Implementation:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">class</span> <span style="color: #008b45; font-weight: bold">Visualizer</span>:
    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">__init__</span>(<span style="color: #658b00">self</span>, problem, solver):
        <span style="color: #658b00">self</span>.problem, <span style="color: #658b00">self</span>.solver = problem, solver

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">plot</span>(<span style="color: #658b00">self</span>, include_exact=<span style="color: #658b00">True</span>, plt=<span style="color: #658b00">None</span>):
        <span style="color: #CD5555">&quot;&quot;&quot;</span>
<span style="color: #CD5555">        Add solver.u curve to scitools plotting object plt,</span>
<span style="color: #CD5555">        and include the exact solution if include_exact is True.</span>
<span style="color: #CD5555">        This plot function can be called several times (if</span>
<span style="color: #CD5555">        the solver object has computed new solutions).</span>
<span style="color: #CD5555">        &quot;&quot;&quot;</span>
        <span style="color: #8B008B; font-weight: bold">if</span> plt <span style="color: #8B008B">is</span> <span style="color: #658b00">None</span>:
            <span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">scitools.std</span>
            plt = scitools.std

        plt.plot(<span style="color: #658b00">self</span>.solver.t, <span style="color: #658b00">self</span>.solver.u, <span style="color: #CD5555">&#39;--o&#39;</span>)
        plt.hold(<span style="color: #CD5555">&#39;on&#39;</span>)
        theta2name = {<span style="color: #B452CD">0</span>: <span style="color: #CD5555">&#39;FE&#39;</span>, <span style="color: #B452CD">1</span>: <span style="color: #CD5555">&#39;BE&#39;</span>, <span style="color: #B452CD">0.5</span>: <span style="color: #CD5555">&#39;CN&#39;</span>}
        name = <span style="color: #658b00">self</span>.solver.theta2name.get(<span style="color: #658b00">self</span>.solver.theta, <span style="color: #CD5555">&#39;&#39;</span>)
        plt.legend(<span style="color: #CD5555">&#39;numerical %s&#39;</span> % name)
        <span style="color: #8B008B; font-weight: bold">if</span> include_exact:
            t_e = linspace(<span style="color: #B452CD">0</span>, <span style="color: #658b00">self</span>.problem.T, <span style="color: #B452CD">1001</span>)
            u_e = <span style="color: #658b00">self</span>.problem.exact_solution(t_e)
            plt.plot(t_e, u_e, <span style="color: #CD5555">&#39;b-&#39;</span>)
            plt.legend(<span style="color: #CD5555">&#39;exact&#39;</span>)
        plt.xlabel(<span style="color: #CD5555">&#39;t&#39;</span>)
        plt.ylabel(<span style="color: #CD5555">&#39;u&#39;</span>)
        plt.title(<span style="color: #CD5555">&#39;theta=%g, dt=%g&#39;</span> %
                  (<span style="color: #658b00">self</span>.solver.theta, <span style="color: #658b00">self</span>.solver.dt))
        plt.savefig(<span style="color: #CD5555">&#39;%s_%g.png&#39;</span> % (name, <span style="color: #658b00">self</span>.solver.dt))
        <span style="color: #8B008B; font-weight: bold">return</span> plt
</pre></div>
</td></tr></table><p>
Note:

<ul>
  <p><li> The <code>plt</code> object in <code>plot</code> adds a new curve to a plot,
    which enables comparing different solutions from different
    runs of <code>Solver.solve</code></li>
  <p><li> Such different curves gets different colors</li>
</ul>

<h4>Combing the objects  <a name="___sec37"></a></h4>

<p>
Let <code>Problem</code>, <code>Solver</code>, and <code>Visualizer</code> play together:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">main</span>():
    problem = Problem()
    solver = Solver(problem)
    viz = Visualizer(problem, solver)

    <span style="color: #228B22"># Read input from the command line</span>
    parser = problem.define_command_line_options()
    parser = solver. define_command_line_options(parser)
    args = parser.parse_args()
    problem.init_from_command_line(args)
    solver. init_from_command_line(args)

    <span style="color: #228B22"># Solve and plot</span>
    solver.solve()
    plt = viz.plot()
    E = solver.error()
    <span style="color: #8B008B; font-weight: bold">if</span> E <span style="color: #8B008B">is</span> <span style="color: #8B008B">not</span> <span style="color: #658b00">None</span>:
        <span style="color: #8B008B; font-weight: bold">print</span> <span style="color: #CD5555">&#39;Error: %.4E&#39;</span> % E
    plt.show()
</pre></div>
</td></tr></table><p>
Complete program: <a href="${src_decay}/decay_class.py"><tt>decay_class.py</tt></a>.

<h3>Implementing more advanced problem and solver classes  <a name="___sec38"></a></h3>

<p>

<ul>
 <p><li> The previous <code>Problem</code> and <code>Solver</code> classes soon contain
   much repetitive code when the number of parameters increases</li>
 <p><li> Much of such code can be parameterized and be made more compact</li>
 <p><li> Idea: collect all parameters in a dictionary <code>self.prms</code>,
   with two associated dictionaries <code>self.types</code> and
   <code>self.help</code> for holding associated object types and help strings</li>
 <p><li> Collect common code in class <code>Parameters</code></li>
 <p><li> Let <code>Problem</code>, <code>Solver</code>, and maybe <code>Visualizer</code> be subclasses
   of class <code>Parameters</code>, basically defining <code>self.prms</code>, <code>self.types</code>,
   <code>self.help</code></li>
</ul>

<h4>A generic class for parameters  <a name="___sec39"></a></h4>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">class</span> <span style="color: #008b45; font-weight: bold">Parameters</span>:
    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">set</span>(<span style="color: #658b00">self</span>, **parameters):
        <span style="color: #8B008B; font-weight: bold">for</span> name <span style="color: #8B008B">in</span> parameters:
            <span style="color: #658b00">self</span>.prms[name] = parameters[name]

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">get</span>(<span style="color: #658b00">self</span>, name):
        <span style="color: #8B008B; font-weight: bold">return</span> <span style="color: #658b00">self</span>.prms[name]

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">define_command_line_options</span>(<span style="color: #658b00">self</span>, parser=<span style="color: #658b00">None</span>):
        <span style="color: #8B008B; font-weight: bold">if</span> parser <span style="color: #8B008B">is</span> <span style="color: #658b00">None</span>:
            <span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">argparse</span>
            parser = argparse.ArgumentParser()

        <span style="color: #8B008B; font-weight: bold">for</span> name <span style="color: #8B008B">in</span> <span style="color: #658b00">self</span>.prms:
            tp = <span style="color: #658b00">self</span>.types[name] <span style="color: #8B008B; font-weight: bold">if</span> name <span style="color: #8B008B">in</span> <span style="color: #658b00">self</span>.types <span style="color: #8B008B; font-weight: bold">else</span> <span style="color: #658b00">str</span>
            help = <span style="color: #658b00">self</span>.help[name] <span style="color: #8B008B; font-weight: bold">if</span> name <span style="color: #8B008B">in</span> <span style="color: #658b00">self</span>.help <span style="color: #8B008B; font-weight: bold">else</span> <span style="color: #658b00">None</span>
            parser.add_argument(
                <span style="color: #CD5555">&#39;--&#39;</span> + name, default=<span style="color: #658b00">self</span>.get(name), metavar=name,
                <span style="color: #658b00">type</span>=tp, help=help)

        <span style="color: #8B008B; font-weight: bold">return</span> parser

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">init_from_command_line</span>(<span style="color: #658b00">self</span>, args):
        <span style="color: #8B008B; font-weight: bold">for</span> name <span style="color: #8B008B">in</span> <span style="color: #658b00">self</span>.prms:
            <span style="color: #658b00">self</span>.prms[name] = <span style="color: #658b00">getattr</span>(args, name)
</pre></div>
</td></tr></table><p>
Slightly more advanced version in <a href="${src_decay}/class_decay_verf1.py"><tt>class_decay_verf1.py</tt></a>.

<h4>The problem class  <a name="___sec40"></a></h4>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">class</span> <span style="color: #008b45; font-weight: bold">Problem</span>(Parameters):
    <span style="color: #CD5555">&quot;&quot;&quot;</span>
<span style="color: #CD5555">    Physical parameters for the problem u&#39;=-a*u, u(0)=I,</span>
<span style="color: #CD5555">    with t in [0,T].</span>
<span style="color: #CD5555">    &quot;&quot;&quot;</span>
    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">__init__</span>(<span style="color: #658b00">self</span>):
        <span style="color: #658b00">self</span>.prms = <span style="color: #658b00">dict</span>(I=<span style="color: #B452CD">1</span>, a=<span style="color: #B452CD">1</span>, T=<span style="color: #B452CD">10</span>)
        <span style="color: #658b00">self</span>.types = <span style="color: #658b00">dict</span>(I=<span style="color: #658b00">float</span>, a=<span style="color: #658b00">float</span>, T=<span style="color: #658b00">float</span>)
        <span style="color: #658b00">self</span>.help = <span style="color: #658b00">dict</span>(I=<span style="color: #CD5555">&#39;initial condition, u(0)&#39;</span>,
                         a=<span style="color: #CD5555">&#39;coefficient in ODE&#39;</span>,
                         T=<span style="color: #CD5555">&#39;end time of simulation&#39;</span>)

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">exact_solution</span>(<span style="color: #658b00">self</span>, t):
        I, a = <span style="color: #658b00">self</span>.get(<span style="color: #CD5555">&#39;I&#39;</span>), <span style="color: #658b00">self</span>.get(<span style="color: #CD5555">&#39;a&#39;</span>)
        <span style="color: #8B008B; font-weight: bold">return</span> I*np.exp(-a*t)
</pre></div>
</td></tr></table><h4>The solver class  <a name="___sec41"></a></h4>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">class</span> <span style="color: #008b45; font-weight: bold">Solver</span>(Parameters):
    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">__init__</span>(<span style="color: #658b00">self</span>, problem):
        <span style="color: #658b00">self</span>.problem = problem
        <span style="color: #658b00">self</span>.prms = <span style="color: #658b00">dict</span>(dt=<span style="color: #B452CD">0.5</span>, theta=<span style="color: #B452CD">0.5</span>)
        <span style="color: #658b00">self</span>.types = <span style="color: #658b00">dict</span>(dt=<span style="color: #658b00">float</span>, theta=<span style="color: #658b00">float</span>)
        <span style="color: #658b00">self</span>.help = <span style="color: #658b00">dict</span>(dt=<span style="color: #CD5555">&#39;time step value&#39;</span>,
                         theta=<span style="color: #CD5555">&#39;time discretization parameter&#39;</span>)

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">solve</span>(<span style="color: #658b00">self</span>):
        <span style="color: #228B22">#from decay_mod import solver</span>
        <span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">decay_theta</span> <span style="color: #8B008B; font-weight: bold">import</span> solver
        <span style="color: #658b00">self</span>.u, <span style="color: #658b00">self</span>.t = solver(
            <span style="color: #658b00">self</span>.problem.get(<span style="color: #CD5555">&#39;I&#39;</span>),
            <span style="color: #658b00">self</span>.problem.get(<span style="color: #CD5555">&#39;a&#39;</span>),
            <span style="color: #658b00">self</span>.problem.get(<span style="color: #CD5555">&#39;T&#39;</span>),
            <span style="color: #658b00">self</span>.get(<span style="color: #CD5555">&#39;dt&#39;</span>),
            <span style="color: #658b00">self</span>.get(<span style="color: #CD5555">&#39;theta&#39;</span>))

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">error</span>(<span style="color: #658b00">self</span>):
        <span style="color: #8B008B; font-weight: bold">try</span>:
            u_e = <span style="color: #658b00">self</span>.problem.exact_solution(<span style="color: #658b00">self</span>.t)
            e = u_e - <span style="color: #658b00">self</span>.u
            E = np.sqrt(<span style="color: #658b00">self</span>.get(<span style="color: #CD5555">&#39;dt&#39;</span>)*np.sum(e**<span style="color: #B452CD">2</span>))
        <span style="color: #8B008B; font-weight: bold">except</span> <span style="color: #008b45; font-weight: bold">AttributeError</span>:
            E = <span style="color: #658b00">None</span>
        <span style="color: #8B008B; font-weight: bold">return</span> E
</pre></div>
</td></tr></table><h4>The visualizer class  <a name="___sec42"></a></h4>

<p>

<ul>
 <p><li> No parameters needed (for this simple problem), no need to inherit
   class <code>Parameters</code></li>
 <p><li> Same code as previously shown class <code>Visualizer</code></li>
 <p><li> Same code as previously shown for combining <code>Problem</code>, <code>Solver</code>, and
   <code>Visualizer</code></li>
</ul>

<h2>Performing scientific experiments <a name="decay:experiments"></a></h2>

<p>
Goal: explore the behavior of a numerical
method for a differential equation and show how scientific experiments
can be set up and reported.

<p>
Tasks:

<p>

<ul>
  <p><li> Write scripts to automate experiments</li>
  <p><li> Generate scientific reports from scripts</li>
</ul>

Tools to learn:

<p>

<ul>
  <p><li> <code>os.system</code> for running other programs</li>
  <p><li> <code>subprocess</code> for running other programs and extracting the output</li>
  <p><li> List comprehensions</li>
  <p><li> Formats for scientific reports: HTML w/MathJax, LaTeX, Sphinx, Doconce</li>
</ul>

Problem:

<p>
$$
\begin{equation}
u'(t) = -au(t),\quad u(0)=I,\ 0< t \leq T,
\label{decay:experiments:model}
\end{equation}
$$


<p>
Solution method (\( \theta \)-rule):

<p>
$$
u^{n+1} = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a\Delta t}u^n,
\quad u^0=I\thinspace .
$$


<p>
Tasks:

<p>

<ul>
 <p><li> Plot \( u^n \) against \( \uex = Ie^{-at} \) for
   various choices of the parameters
   \( I \), \( a \), \( \Delta t \), and \( \theta \)</li>
 <p><li> How does the discrete solution compare with the exact solution
   when \( \Delta t \) is varied and \( \theta=0,0.5,1 \)?</li>
 <p><li> Use the <a href="${src_decay}/decay_mod.py"><tt>decay_mod.py</tt></a> module (little modification of the plotting, see <a href="${src_decay}/experiments/decay_mod.py"><tt>experiments/decay_mod.py</tt></a>)</li>
 <p><li> Make separate program for running (automating) the experiments (<em>script</em>)</li>

<ol>
   <p><li> <code>python decay_mod.py --I 1 --a 2 --makeplot --T 5 --dt 0.5 0.25 0.1 0.05</code></li>
   <p><li> Combine generated figures <code>FE_*.png</code>, <code>BE_*.png</code>, and <code>CN_*.png</code>
      to new figures with multiple plots</li>
   <p><li> Run script as <code>python decay_exper0.py 0.5 0.25 0.1 0.05</code> (\( \Delta t \) values on the command line)</li>
</ol>

</ul>

<center> <!-- figure -->
<hr class="figure">
<center><p class="caption">Figure 4:  Illustration of the Backward Euler method for four time step values. <a name="decay:experiments:fig:BE4a"></a> </p></center>
<p><img src="fig-decay/BE4a.png" align="bottom" width=800,></p>
</center>

<p>

<!-- code=python (from !bc pypro) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">os</span>, <span style="color: #008b45; text-decoration: underline">sys</span>

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">run_experiments</span>(I=<span style="color: #B452CD">1</span>, a=<span style="color: #B452CD">2</span>, T=<span style="color: #B452CD">5</span>):
    <span style="color: #228B22"># The command line must contain dt values</span>
    <span style="color: #8B008B; font-weight: bold">if</span> <span style="color: #658b00">len</span>(sys.argv) &gt; <span style="color: #B452CD">1</span>:
        dt_values = [<span style="color: #658b00">float</span>(arg) <span style="color: #8B008B; font-weight: bold">for</span> arg <span style="color: #8B008B">in</span> sys.argv[<span style="color: #B452CD">1</span>:]]
    <span style="color: #8B008B; font-weight: bold">else</span>:
        <span style="color: #8B008B; font-weight: bold">print</span> <span style="color: #CD5555">&#39;Usage: %s dt1 dt2 dt3 ...&#39;</span> %  sys.argv[<span style="color: #B452CD">0</span>]
        sys.exit(<span style="color: #B452CD">1</span>)  <span style="color: #228B22"># abort</span>

    <span style="color: #228B22"># Run module file as a stand-alone application</span>
    cmd = <span style="color: #CD5555">&#39;python decay_mod.py --I %g --a %g --makeplot --T %g&#39;</span> % \
          (I, a, T)
    dt_values_str = <span style="color: #CD5555">&#39; &#39;</span>.join([<span style="color: #658b00">str</span>(v) <span style="color: #8B008B; font-weight: bold">for</span> v <span style="color: #8B008B">in</span> dt_values])
    cmd += <span style="color: #CD5555">&#39; --dt %s&#39;</span> % dt_values_str
    <span style="color: #8B008B; font-weight: bold">print</span> cmd
    failure = os.system(cmd)
    <span style="color: #8B008B; font-weight: bold">if</span> failure:
        <span style="color: #8B008B; font-weight: bold">print</span> <span style="color: #CD5555">&#39;Command failed:&#39;</span>, cmd; sys.exit(<span style="color: #B452CD">1</span>)

    <span style="color: #228B22"># Combine images into rows with 2 plots in each row</span>
    image_commands = []
    <span style="color: #8B008B; font-weight: bold">for</span> method <span style="color: #8B008B">in</span> <span style="color: #CD5555">&#39;BE&#39;</span>, <span style="color: #CD5555">&#39;CN&#39;</span>, <span style="color: #CD5555">&#39;FE&#39;</span>:
        pdf_files = <span style="color: #CD5555">&#39; &#39;</span>.join([<span style="color: #CD5555">&#39;%s_%g.pdf&#39;</span> % (method, dt)
                              <span style="color: #8B008B; font-weight: bold">for</span> dt <span style="color: #8B008B">in</span> dt_values])
        png_files = <span style="color: #CD5555">&#39; &#39;</span>.join([<span style="color: #CD5555">&#39;%s_%g.png&#39;</span> % (method, dt)
                              <span style="color: #8B008B; font-weight: bold">for</span> dt <span style="color: #8B008B">in</span> dt_values])
        image_commands.append(
            <span style="color: #CD5555">&#39;montage -background white -geometry 100%&#39;</span> +
            <span style="color: #CD5555">&#39; -tile 2x %s %s.png&#39;</span> % (png_files, method))
        image_commands.append(
            <span style="color: #CD5555">&#39;convert -trim %s.png %s.png&#39;</span> % (method, method))
        image_commands.append(
            <span style="color: #CD5555">&#39;convert %s.png -transparent white %s.png&#39;</span> %
            (method, method))
        image_commands.append(
            <span style="color: #CD5555">&#39;pdftk %s output tmp.pdf&#39;</span> % pdf_files)
        num_rows = <span style="color: #658b00">int</span>(<span style="color: #658b00">round</span>(<span style="color: #658b00">len</span>(dt_values)/<span style="color: #B452CD">2.0</span>))
        image_commands.append(
            <span style="color: #CD5555">&#39;pdfnup --nup 2x%d tmp.pdf&#39;</span> % num_rows)
        image_commands.append(
            <span style="color: #CD5555">&#39;pdfcrop tmp-nup.pdf %s.pdf&#39;</span> % method)

    <span style="color: #8B008B; font-weight: bold">for</span> cmd <span style="color: #8B008B">in</span> image_commands:
        <span style="color: #8B008B; font-weight: bold">print</span> cmd
        failure = os.system(cmd)
        <span style="color: #8B008B; font-weight: bold">if</span> failure:
            <span style="color: #8B008B; font-weight: bold">print</span> <span style="color: #CD5555">&#39;Command failed:&#39;</span>, cmd; sys.exit(<span style="color: #B452CD">1</span>)

    <span style="color: #228B22"># Remove the files generated above and by decay_mod.py</span>
    <span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">glob</span> <span style="color: #8B008B; font-weight: bold">import</span> glob
    filenames = glob(<span style="color: #CD5555">&#39;*_*.png&#39;</span>) + glob(<span style="color: #CD5555">&#39;*_*.pdf&#39;</span>) + \
                glob(<span style="color: #CD5555">&#39;*_*.eps&#39;</span>) + glob(<span style="color: #CD5555">&#39;tmp*.pdf&#39;</span>)
    <span style="color: #8B008B; font-weight: bold">for</span> filename <span style="color: #8B008B">in</span> filenames:
        os.remove(filename)

<span style="color: #8B008B; font-weight: bold">if</span> __name__ == <span style="color: #CD5555">&#39;__main__&#39;</span>:
    run_experiments()
</pre></div>
</td></tr></table><p>
Complete program: <a href="${src_decay}/experiments/decay_exper0.py"><tt>experiments/decay_exper0.py</tt></a>.

<p>
Many useful constructs in the program above:

<p>

<ul>
 <p><li> <code>[float(arg) for arg in sys.argv[1:]]</code> builds a list of real numbers
   from all the command-line arguments</li>
 <p><li> <code>failure = os.system(cmd)</code> runs an operating system command
   (e.g., another program)</li>
 <p><li> <code>sys.exit(1)</code> aborts the program</li>
 <p><li> <code>['%s_%s.png' % (method, dt) for dt in dt_values]</code> builds a list of
   filenames from a list of numbers (<code>dt_values</code>)</li>
 <p><li> All <code>montage</code> commands for creating composite figures are stored in a
   list and thereafter executed in a loop</li>
 <p><li> <code>glob.glob('*_*.png')</code> returns a list of the names of all files in the
   current folder where the filename matches the <em>Unix wildcard notation</em>
   <code>*_*.png</code> (meaning "any text, underscore, any text, and then `.png`")</li>
 <p><li> <code>os.remove(filename)</code> removes the file with name <code>filename</code></li>
</ul>

<h3>Interpreting output from other programs  <a name="___sec44"></a></h3>

<p>
Programs that run other programs, like <code>decay_exper0.py</code> does, will often
need to interpret output from the other programs.
For example,

<p>

<!-- code=bash (from !bc sys) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">Terminal&gt; python decay_plot_mpl.py
0.0   0.40:    2.105E-01
0.0   0.04:    1.449E-02
0.5   0.40:    3.362E-02
0.5   0.04:    1.887E-04
1.0   0.40:    1.030E-01
1.0   0.04:    1.382E-02
</pre></div>
</td></tr></table><p>
Tasks:

<p>

<ul>
  <p><li> read the output from the <code>decay_mod.py</code> program</li>
  <p><li> interpret this output and store the \( E \) values in arrays for each
    \( \theta \) value</li>
  <p><li> plot \( E \) versus \( \Delta t \), for each \( \theta \), in a log-log plot</li>
</ul>

Must replace <code>os.system(cmd)</code> by use of the <code>subprocess</code> module:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">    <span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">subprocess</span> <span style="color: #8B008B; font-weight: bold">import</span> Popen, PIPE, STDOUT
    p = Popen(cmd, shell=<span style="color: #658b00">True</span>, stdout=PIPE, stderr=STDOUT)
    output, dummy = p.communicate()
    failure = p.returncode
    <span style="color: #8B008B; font-weight: bold">if</span> failure:
        <span style="color: #8B008B; font-weight: bold">print</span> <span style="color: #CD5555">&#39;Command failed:&#39;</span>, cmd; sys.exit(<span style="color: #B452CD">1</span>)
</pre></div>
</td></tr></table><p>
Note: The command stored in <code>cmd</code> is run and all text that is written to
the standard output <em>and</em> the standard error is available in the
string <code>output</code>. The text in <code>output</code> is what appeared in the
terminal window while running <code>cmd</code>.

<p>
Next tasks:

<p>

<ul>
 <p><li> Run through the <code>output</code> string, line by line</li>
 <p><li> If the current line prints \( \theta \), \( \Delta t \), and \( E \),
   split the line into these three pieces and store the data</li>
 <p><li> Store data in a dictionary <code>errors</code> with keys <code>dt</code> and
   the three \( \theta \) values</li>
</ul>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">errors = {<span style="color: #CD5555">&#39;dt&#39;</span>: dt_values, <span style="color: #B452CD">1</span>: [], <span style="color: #B452CD">0</span>: [], <span style="color: #B452CD">0.5</span>: []}
<span style="color: #8B008B; font-weight: bold">for</span> line <span style="color: #8B008B">in</span> output.splitlines():
    words = line.split()
    <span style="color: #8B008B; font-weight: bold">if</span> words[<span style="color: #B452CD">0</span>] <span style="color: #8B008B">in</span> (<span style="color: #CD5555">&#39;0.0&#39;</span>, <span style="color: #CD5555">&#39;0.5&#39;</span>, <span style="color: #CD5555">&#39;1.0&#39;</span>):  <span style="color: #228B22"># line with E?</span>
        <span style="color: #228B22"># typical line: 0.0   1.25:    7.463E+00</span>
        theta = <span style="color: #658b00">float</span>(words[<span style="color: #B452CD">0</span>])
        E = <span style="color: #658b00">float</span>(words[<span style="color: #B452CD">2</span>])
        errors[theta].append(E)
</pre></div>
</td></tr></table><p>

<ul>
 <p><li> Plot \( E \) versus \( \Delta t \) for \( \theta=0,0.5,1 \)</li>
</ul>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">matplotlib.pyplot</span> <span style="color: #8B008B; font-weight: bold">as</span> <span style="color: #008b45; text-decoration: underline">plt</span>
<span style="color: #228B22">#import scitools.std as plt</span>
plt.loglog(errors[<span style="color: #CD5555">&#39;dt&#39;</span>], errors[<span style="color: #B452CD">0</span>], <span style="color: #CD5555">&#39;ro-&#39;</span>)
plt.hold(<span style="color: #CD5555">&#39;on&#39;</span>)  <span style="color: #228B22"># MATLAB style...</span>
plt.loglog(errors[<span style="color: #CD5555">&#39;dt&#39;</span>], errors[<span style="color: #B452CD">0.5</span>], <span style="color: #CD5555">&#39;b+-&#39;</span>)
plt.loglog(errors[<span style="color: #CD5555">&#39;dt&#39;</span>], errors[<span style="color: #B452CD">1</span>], <span style="color: #CD5555">&#39;gx-&#39;</span>)
plt.legend([<span style="color: #CD5555">&#39;FE&#39;</span>, <span style="color: #CD5555">&#39;CN&#39;</span>, <span style="color: #CD5555">&#39;BE&#39;</span>], loc=<span style="color: #CD5555">&#39;upper left&#39;</span>)
plt.xlabel(<span style="color: #CD5555">&#39;log(time step)&#39;</span>)
plt.ylabel(<span style="color: #CD5555">&#39;log(error)&#39;</span>)
plt.title(<span style="color: #CD5555">&#39;Error vs time step&#39;</span>)
plt.savefig(<span style="color: #CD5555">&#39;error_BE_CN_FE.png&#39;</span>)
</pre></div>
</td></tr></table><p>
This is a log-log plot because we expect \( E\sim\Delta t^r \).

<p>
<center> <!-- figure -->
<hr class="figure">
<center><p class="caption">Figure 5:  Default plot (left) and manually adjusted plot (right). <a name="decay:exper:Evsdt"></a> </p></center>
<p><img src="fig-decay/error_plot_improvement.png" align="bottom" width=800,></p>
</center>

<p>
Complete program: <a href="${src_decay}/experiments/decay_exper1.py"><tt>experiments/decay_exper1.py</tt></a>.
Fine recipe for

<p>

<ul>
  <p><li> how to run other programs</li>
  <p><li> how to extract and interpret output from other programs</li>
  <p><li> how to automate many manual steps in creating simulations and figures</li>
</ul>

<h3>Making a report <a name="decay:exper:report"></a></h3>

<p>

<ul>
 <p><li> Scientific investigations are best documented in a report!</li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/sphinx-cloud/">A sample report</a></li>
 <p><li> How can we write such a report?</li>
 <p><li> First problem: what format should I write in?</li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report_html.html">Plain HTML</a>, generated by <a href="${src_decay}/experiments/decay_exper1_html.py"><tt>decay_exper1_html.py</tt></a></li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report_html_mathjax.html">HTML with MathJax</a>, generated by <a href="${src_decay}/experiments/decay_exper1_html.py"><tt>decay_exper1_mathjax.py</tt></a></li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report.pdf">LaTeX PDF</a>, based on <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report.tex.html">LaTeX source</a></li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/sphinx-cloud/index.html">Sphinx HTML</a>, based on <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report_sphinx.rst.html">reStructuredText</a></li>
 <p><li> Markdown, MediaWiki, ...</li>
 <p><li> <a href="http://code.google.com/p/doconce">Doconce</a> can generate LaTeX, HTML w/MathJax, Sphinx, Markdown, MediaWiki, ... (<a href="http://hplgit.github.com/INF5620/doc/writing_reports/report.do.txt.html">Doconce source</a> for the examples above, and Python program for <a href="${src_decay}/experiments/decay_exper1_do.py">generating the Doconce source</a>)</li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/">Examples on different report formats</a></li>
</ul>

<h3>Publishing a complete project <a name="decay:exper:github"></a></h3>

<p>

<ul>
 <p><li> Make folder (directory) tree</li>
 <p><li> Keep track of all files via a <em>version control system</em> (Mercurial, Git, ...)</li>
 <p><li> Publish as private or public repository</li>
 <p><li> Utilize Bitbucket, Googlecode, GitHub, or similar</li>
 <p><li> See the <a href="http://hplgit.github.com/teamods/bitgit/html/">intro to such tools</a></li>
</ul>

<h2>Model extensions  <a name="___sec47"></a></h2>

<h3>Extension to a variable coefficient  <a name="___sec48"></a></h3>

<p>
$$
\begin{equation}
u'(t) = -a(t)u(t),\quad t\in (0,T],\quad u(0)=I \thinspace .
\label{decay:problem:a}
\end{equation}
$$


<p>
The Forward Euler scheme:

<p>
$$
\begin{equation}
\frac{u^{n+1} - u^n}{\Delta t} = -a(t_n)u^n
\thinspace .
\end{equation}
$$


<p>
The Backward Euler scheme:
$$
\begin{equation}
\frac{u^{n} - u^{n-1}}{\Delta t} = -a(t_n)u^n
\thinspace .
\end{equation}
$$


<p>
The Crank-Nicolson scheme (evaluting \( a(t_{n+\frac{1}{2}}) \) and
using an average for \( u \)):
$$
\begin{equation}
\frac{u^{n+1} - u^{n}}{\Delta t} = -a(t_{n+\frac{1}{2}})\frac{1}{2}(u^n + u^{n+1})
\thinspace .
\end{equation}
$$


<p>
The Crank-Nicolson scheme (using
using an average for \( a \) and \( u \)):
$$
\begin{equation}
\frac{u^{n+1} - u^{n}}{\Delta t} = -\frac{1}{2}(a(t_n)u^n + a(t_{n+1})u^{n+1})
\thinspace .
\end{equation}
$$


<p>
The \( \theta \)-rule unifies the three mentioned schemes,

<p>
$$
\begin{equation}
\frac{u^{n+1} - u^{n}}{\Delta t} = -a((1-\theta)t_n + \theta t_{n+1})((1-\theta) u^n + \theta u^{n+1})
\thinspace .
\end{equation}
$$

or,
$$
\begin{equation}
\frac{u^{n+1} - u^{n}}{\Delta t} = -(1-\theta) a(t_n)u^n - \theta
a(t_{n+1})u^{n+1}
\thinspace .
\end{equation}
$$


<p>
Operator notation:

<p>
$$
\begin{align*}
\lbrack D^+_t u &= -au\rbrack^n,\\
\lbrack D^-_t u &= -au\rbrack^n,\\
\lbrack D_t u &= -a\overline{u}^t\rbrack^{n+\frac{1}{2}},\\
\lbrack D_t u &= -\overline{au}^t\rbrack^{n+\frac{1}{2}},\\
\lbrack D_t u &= -a\overline{u}^{t,\theta}\rbrack^{n+\theta},\\
\lbrack D_t u &= -\overline{au}^{t,\theta}\rbrack^{n+\theta}
\thinspace .
\end{align*}
$$

<h3>Extension to a source term <a name="decay:source"></a></h3>

<p>
$$
\begin{equation}
u'(t) = -a(t)u(t) + b(t),\quad t\in (0,T],\quad u(0)=I
\thinspace .
\label{decay:problem:ab}
\end{equation}
$$

<h4>Schemes  <a name="___sec50"></a></h4>

<p>
$$
\begin{align*}
\lbrack D^+_t u &= -au + b\rbrack^n,\\
\lbrack D^-_t u &= -au + b\rbrack^n,\\
\lbrack D_t u   &= -a\overline{u}^t + b\rbrack^{n+\frac{1}{2}},\\
\lbrack D_t u   &= \overline{-au+b}^t\rbrack^{n+\frac{1}{2}},\\
\lbrack D_t u   &= -a\overline{u}^{t,\theta} + b\rbrack^{n+\theta},\\
\lbrack D_t u   &= \overline{-au+b}^{t,\theta}\rbrack^{n+\theta}
\thinspace .
\end{align*}
$$

<h3>Implementation of the generalized model problem <a name="decay:general"></a></h3>

<p>
$$
\begin{equation}
u^{n+1} = ((1 - \Delta t(1-\theta)a^n)u^n
+ \Delta t(\theta b^{n+1} + (1-\theta)b^n))(1 + \Delta t\theta a^{n+1})^{-1}
\thinspace .
\end{equation}
$$

<h4>The Python code  <a name="___sec52"></a></h4>

<p>
Implementation where \( a(t) \) and \( b(t) \) are given as
Python functions (see file <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/decay_vc.py"><tt>decay_vc.py</tt></a>):

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">solver</span>(I, a, b, T, dt, theta):
    <span style="color: #CD5555">&quot;&quot;&quot;</span>
<span style="color: #CD5555">    Solve u&#39;=-a(t)*u + b(t), u(0)=I,</span>
<span style="color: #CD5555">    for t in (0,T] with steps of dt.</span>
<span style="color: #CD5555">    a and b are Python functions of t.</span>
<span style="color: #CD5555">    &quot;&quot;&quot;</span>
    dt = <span style="color: #658b00">float</span>(dt)            <span style="color: #228B22"># avoid integer division</span>
    Nt = <span style="color: #658b00">int</span>(<span style="color: #658b00">round</span>(T/dt))     <span style="color: #228B22"># no of time intervals</span>
    T = Nt*dt                 <span style="color: #228B22"># adjust T to fit time step dt</span>
    u = zeros(Nt+<span style="color: #B452CD">1</span>)           <span style="color: #228B22"># array of u[n] values</span>
    t = linspace(<span style="color: #B452CD">0</span>, T, Nt+<span style="color: #B452CD">1</span>)  <span style="color: #228B22"># time mesh</span>

    u[<span style="color: #B452CD">0</span>] = I                  <span style="color: #228B22"># assign initial condition</span>
    <span style="color: #8B008B; font-weight: bold">for</span> n <span style="color: #8B008B">in</span> <span style="color: #658b00">range</span>(<span style="color: #B452CD">0</span>, Nt):    <span style="color: #228B22"># n=0,1,...,Nt-1</span>
        u[n+<span style="color: #B452CD">1</span>] = ((<span style="color: #B452CD">1</span> - dt*(<span style="color: #B452CD">1</span>-theta)*a(t[n]))*u[n] + \ 
                  dt*(theta*b(t[n+<span style="color: #B452CD">1</span>]) + (<span style="color: #B452CD">1</span>-theta)*b(t[n])))/\ 
                  (<span style="color: #B452CD">1</span> + dt*theta*a(t[n+<span style="color: #B452CD">1</span>]))
    <span style="color: #8B008B; font-weight: bold">return</span> u, t
</pre></div>
</td></tr></table><h4>Implementations of variable coefficients  <a name="___sec53"></a></h4>

<p>
Plain functions:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">a</span>(t):
    <span style="color: #8B008B; font-weight: bold">return</span> a_0 <span style="color: #8B008B; font-weight: bold">if</span> t &lt; tp <span style="color: #8B008B; font-weight: bold">else</span> k*a_0

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">b</span>(t):
    <span style="color: #8B008B; font-weight: bold">return</span> <span style="color: #B452CD">1</span>
</pre></div>
</td></tr></table><p>
Better implementation: class with the parameters <code>a0</code>, <code>tp</code>, and <code>k</code>
as attributes and a <em>special method</em> <code>__call__</code> for evaluating \( a(t) \):

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">class</span> <span style="color: #008b45; font-weight: bold">A</span>:
    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">__init__</span>(<span style="color: #658b00">self</span>, a0=<span style="color: #B452CD">1</span>, k=<span style="color: #B452CD">2</span>):
        <span style="color: #658b00">self</span>.a0, <span style="color: #658b00">self</span>.k = a0, k

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">__call__</span>(<span style="color: #658b00">self</span>, t):
        <span style="color: #8B008B; font-weight: bold">return</span> <span style="color: #658b00">self</span>.a0 <span style="color: #8B008B; font-weight: bold">if</span> t &lt; <span style="color: #658b00">self</span>.tp <span style="color: #8B008B; font-weight: bold">else</span> <span style="color: #658b00">self</span>.k*<span style="color: #658b00">self</span>.a0

a = A(a0=<span style="color: #B452CD">2</span>, k=<span style="color: #B452CD">1</span>)  <span style="color: #228B22"># a behaves as a function a(t)</span>
</pre></div>
</td></tr></table><p>
Use one-liner <em>lambda function</em>:
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">a = <span style="color: #8B008B; font-weight: bold">lambda</span> t: a_0 <span style="color: #8B008B; font-weight: bold">if</span> t &lt; tp <span style="color: #8B008B; font-weight: bold">else</span> k*a_0
</pre></div>
</td></tr></table><p>
In general,
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">f = <span style="color: #8B008B; font-weight: bold">lambda</span> arg1, arg2, ...: expressin
</pre></div>
</td></tr></table><p>
is equivalent to
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">f</span>(arg1, arg2, ...):
    <span style="color: #8B008B; font-weight: bold">return</span> expression
</pre></div>
</td></tr></table><p>
One can use lambda functions directly in calls:
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">u, t = solver(<span style="color: #B452CD">1</span>, <span style="color: #8B008B; font-weight: bold">lambda</span> t: <span style="color: #B452CD">1</span>, <span style="color: #8B008B; font-weight: bold">lambda</span> t: <span style="color: #B452CD">1</span>, T, dt, theta)
</pre></div>
</td></tr></table><p>
for a problem \( u'=-u+1 \), \( u(0)=1 \).

<p>
A lambda function can appear anywhere where a variable can appear.

<h3>Verification via trivial solutions <a name="decay:verify:trivial"></a></h3>

<p>

<ul>
 <p><li> Start debugging of a new code with trying a problem
   where \( u=\hbox{const} \neq 0 \).</li>
 <p><li> Choose \( u=C \) (a constant). Choose any \( a(t) \) and set
   \( b=a(t)C \) and
   \( I=C \).</li>
 <p><li> "All" numerical methods will reproduce \( u=_{\hbox{const}} \)
   exactly (machine precision).</li>
 <p><li> Often \( u=C \) eases debugging.</li>
 <p><li> In this example: <em>any error</em> in the formula for \( u^{n+1} \)
   make \( u\neq C \)!</li>
</ul>

Verification function as a nose test:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">nose.tools</span> <span style="color: #8B008B; font-weight: bold">as</span> <span style="color: #008b45; text-decoration: underline">nt</span>

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">test_constant_solution</span>():
    <span style="color: #CD5555">&quot;&quot;&quot;</span>
<span style="color: #CD5555">    Test problem where u=u_const is the exact solution, to be</span>
<span style="color: #CD5555">    reproduced (to machine precision) by any relevant method.</span>
<span style="color: #CD5555">    &quot;&quot;&quot;</span>
    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">exact_solution</span>(t):
        <span style="color: #8B008B; font-weight: bold">return</span> u_const

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">a</span>(t):
        <span style="color: #8B008B; font-weight: bold">return</span> <span style="color: #B452CD">2.5</span>*(<span style="color: #B452CD">1</span>+t**<span style="color: #B452CD">3</span>)  <span style="color: #228B22"># can be arbitrary</span>

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">b</span>(t):
        <span style="color: #8B008B; font-weight: bold">return</span> a(t)*u_const

    u_const = <span style="color: #B452CD">2.15</span>
    theta = <span style="color: #B452CD">0.4</span>; I = u_const; dt = <span style="color: #B452CD">4</span>
    Nt = <span style="color: #B452CD">4</span>  <span style="color: #228B22"># enough with a few steps</span>
    u, t = solver(I=I, a=a, b=b, T=Nt*dt, dt=dt, theta=theta)
    <span style="color: #8B008B; font-weight: bold">print</span> u
    u_e = exact_solution(t)
    difference = <span style="color: #658b00">abs</span>(u_e - u).max()  <span style="color: #228B22"># max deviation</span>
    nt.assert_almost_equal(difference, <span style="color: #B452CD">0</span>, places=<span style="color: #B452CD">14</span>)
</pre></div>
</td></tr></table><h3>Verification via manufactured solutions <a name="decay:MMS"></a></h3>

<p>

<ul>
 <p><li> Choose <em>any</em> formula for \( u(t) \).</li>
 <p><li> Fit I, \( a(t) \), and \( b(t) \) in \( u'=-au+b \), \( u(0)=I \),
   to make the chosen formula a solution of the ODE problem.</li>
 <p><li> Then we can always have an analytical solution (!).</li>
 <p><li> Ideal for verification: testing convergence rates.</li>
 <p><li> Called the <em>method of manufactured solutions</em> (MMS)</li>
 <p><li> Special case: \( u \) linear in \( t \), because all sound numerical
   methods will reproduce a linear \( u \) exactly (machine precision).</li>
 <p><li> \( u(t) = ct + d \). \( u(0)=0 \) means \( d=I \).</li>
 <p><li> ODE implies \( c = -a(t)u + b(t) \).</li>
 <p><li> Choose \( a(t) \) and \( c \), and set \( b(t) = c + a(t)(ct + I) \).</li>
 <p><li> Any error in the formula for \( u^{n+1} \) makes \( u\neq ct+I \)!</li>
</ul>

We can easily show that a linear \( u^n = ct_n+I \) fulfills the discrete
equations for the Forward Euler, Backward Euler, and Crank-Nicolson
schemes. First,

<p>
$$
\begin{align}
\lbrack D_t^+ t\rbrack^n = \frac{t_{n+1}-t_n}{\Delta t}=\frac{(n+1)\Delta t - n\Delta t}{\Delta t}=1,\label{decay:fd2:Dop:tn:fw}\\
\lbrack D_t^- t\rbrack^n = \frac{t_{n}-t_{n-1}}{\Delta t}=\frac{n\Delta t - (n-1)\Delta t}{\Delta t}=1,\label{decay:fd2:Dop:tn:bw}\\
\lbrack D_t t\rbrack^n = \frac{t_{n+\frac{1}{2}}-t_{n-\frac{1}{2}}{\Delta t}=\frac{(n+\frac{1}{2})\Delta t - (n-\frac{1}{2})\Delta t}{\Delta t}=1\label{decay:fd2:Dop:tn:cn}
\thinspace .
\end{align}
$$

The difference equation for the Forward Euler scheme

<p>
$$ [D_^+ u = -au + b]^n, $$

with \( a^n=a(t_n) \), \( b^n=c + a(t_n)(ct_n + I) \), and \( u^n=ct_n + I \)
then results in

<p>
$$ c = -a(t_n)(ct_n+I) + c + a(t_n)(ct_n + I) = c $$


<p>
Verification function as a nose test:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%"><span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">test_linear_solution</span>():
    <span style="color: #CD5555">&quot;&quot;&quot;</span>
<span style="color: #CD5555">    Test problem where u=c*t+I is the exact solution, to be</span>
<span style="color: #CD5555">    reproduced (to machine precision) by any relevant method.</span>
<span style="color: #CD5555">    &quot;&quot;&quot;</span>
    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">exact_solution</span>(t):
        <span style="color: #8B008B; font-weight: bold">return</span> c*t + I

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">a</span>(t):
        <span style="color: #8B008B; font-weight: bold">return</span> t**<span style="color: #B452CD">0.5</span>  <span style="color: #228B22"># can be arbitrary</span>

    <span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">b</span>(t):
        <span style="color: #8B008B; font-weight: bold">return</span> c + a(t)*exact_solution(t)

    theta = <span style="color: #B452CD">0.4</span>; I = <span style="color: #B452CD">0.1</span>; dt = <span style="color: #B452CD">0.1</span>; c = -<span style="color: #B452CD">0.5</span>
    T = <span style="color: #B452CD">4</span>
    Nt = <span style="color: #658b00">int</span>(T/dt)  <span style="color: #228B22"># no of steps</span>
    u, t = solver(I=I, a=a, b=b, T=Nt*dt, dt=dt, theta=theta)
    u_e = exact_solution(t)
    difference = <span style="color: #658b00">abs</span>(u_e - u).max()  <span style="color: #228B22"># max deviation</span>
    <span style="color: #8B008B; font-weight: bold">print</span> difference
    <span style="color: #228B22"># No of decimal places for comparison depend on size of c</span>
    nt.assert_almost_equal(difference, <span style="color: #B452CD">0</span>, places=<span style="color: #B452CD">14</span>)
</pre></div>
</td></tr></table><h3>Extension to systems of ODEs  <a name="___sec56"></a></h3>

<p>
Sample system:

<p>
$$
\begin{align}
u' &= -a_u u + a_vv,\\
v' &= -a_vv + a_uu,
\end{align}
$$

for constants \( a_u, a_v>0 \).

<p>
The Forward Euler method:

<p>
$$
\begin{align}
u^{n+1} &= u^n + \Delta t (-a_u u^n + a_vv^n),\\
v^{n+1} &= u^n + \Delta t (-a_vv^n + a_uu^n)
\thinspace .
\end{align}
$$


<p>
The Backward Euler scheme:
$$
\begin{align}
u^{n+1} &= u^n + \Delta t (-a_u u^{n+1} + a_vv^{n+1}),\\
v^{n+1} &= v^n + \Delta t (-a_vv^{n+1} + a_uu^{n+1}),
\thinspace .
\end{align}
$$

which is a \( 2\times 2 \) linear system:
in
$$
\begin{align}
(1 + \Delta t a_u)u^{n+1} + a_vv^{n+1}) &= u^n ,\\
a_uu^{n+1} + (1 + \Delta t a_v) v^{n+1} &= v^n
\thinspace .
\end{align}
$$

<h2>General first-order ODEs  <a name="___sec57"></a></h2>

<h3>Generic form  <a name="___sec58"></a></h3>

<p>
The standard form for ODEs:
$$
\begin{equation}
u' = f(u,t),\quad u(0)=I,
\label{decay:ode:general}
\end{equation}
$$


<p>
\( u \) and \( f \): scalar or vector.

<p>
Vectors in case of ODE systems:
$$ u(t) = (u^{(0)}(t),u^{(1)}(t),\ldots,u^{(m-1)}(t)) \thinspace . $$


<p>
$$
\begin{align*}
f(u, t) = ( & f^{(0)}(u^{(0)}(t),\ldots,u^{(m-1)}(t)),\\
            & f^{(1)}(u^{(0)}(t),\ldots,u^{(m-1)}(t)),\\
            & \vdots\\
            & f^{(m-1)}(u^{(0)}(t),\ldots,u^{(m-1)}(t)))
\thinspace .
\end{align*}
$$


<p>
Higher-order ODEs are most often expressed as first-order systems.

<h3>The Odespy software  <a name="___sec59"></a></h3>

<p>
<a href="https://github.com/hplgit/odespy">Odespy</a>
features simple Python implementations of the most fundamental
schemes as well as Python interfaces to several famous packages for
solving ODEs: <a href="https://computation.llnl.gov/casc/odepack/odepack_home.html">ODEPACK</a>,
<a href="https://computation.llnl.gov/casc/odepack/odepack_home.html">Vode</a>,
<a href="http://www.netlib.org/ode/rkc.f">rkc.f</a>,
<a href="http://www.netlib.org/ode/rkf45.f">rkf45.f</a>,
<a href="http://www.unige.ch/~hairer/software.html">Radau5</a>, as well
as the ODE solvers in
<a href="http://docs.scipy.org/doc/scipy/reference/generated/scipy.integrate.ode.html">SciPy</a>,
<a href="http://docs.sympy.org/dev/modules/mpmath/calculus/odes.html">SymPy</a>, and
<a href="http://olivierverdier.github.com/odelab/">odelab</a>.

<p>
Typical usage:

<p>

<!-- code=text typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">def f(u, t):
    return -a*u

import odespy
import numpy as np

I = 1; a = 2; T = 6; dt = 1

solver = odespy.RK4(f)
solver.set_initial_condition(I)

t_mesh = np.linspace(0, T, Nt+1)

u, t = solver.solve(t_mesh)
</pre></div>
</td></tr></table><h3>Example: Runge-Kutta methods   <a name="___sec60"></a></h3>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "perldoc" -->
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight" style="background: #eeeedd"><pre style="line-height: 125%">solvers = [odespy.RK2(f),
           odespy.RK3(f),
           odespy.RK4(f),
           odespy.BackwardEuler(f, nonlinear_solver=<span style="color: #CD5555">&#39;Newton&#39;</span>)]

<span style="color: #8B008B; font-weight: bold">for</span> solver <span style="color: #8B008B">in</span> solvers:
    solver.set_initial_condition(I)
    u, t = solver.solve(t)

<span style="color: #228B22"># + lots of plot code...</span>
</pre></div>
</td></tr></table><p>
<center> <!-- figure -->
<hr class="figure">
<center><p class="caption">Figure 6:  Behavior of different schemes for the decay equation. <a name="decay:odespy:fig1"></a> </p></center>
<p><img src="fig-decay/decay_odespy1_png.png" align="bottom" width=800></p>
</center>

<p>
The 4-th order Runge-Kutta method (<code>RK4</code>) is the method of choice!

<h3>Example: Adaptive Runge-Kutta methods   <a name="___sec61"></a></h3>

<p>

<ul>
 <p><li> Adaptive methods find "optimal" locations of the mesh points
   to ensure that the error is less than a given tolerance.</li>
 <p><li> Downside: approximate error estimation, not always optimal
   location of points.</li>
 <p><li> "Industry standard ODE solver": Dormand-Prince 4/5-th order
   Runge-Kutta (MATLAB's famous <code>ode45</code>).</li>
</ul>

<center> <!-- figure -->
<hr class="figure">
<center><p class="caption">Figure 7:  Choice of adaptive time mesh by the Dormand-Prince method for difference tolerances. <a name="decay:odespy:fig2"></a> </p></center>
<p><img src="fig-decay/decay_DormandPrince_adaptivity.png" align="bottom" width=800></p>
</center>

<h3>Other schemes  <a name="___sec62"></a></h3>

<h4>Implicit 2-step backward scheme  <a name="___sec63"></a></h4>

<p>
$$ u'(t_{n+1}) \approx \frac{3u^{n+1} - 4u^{n} + u^{n-1}}{2\Delta t},$$


<p>
Scheme:
$$ u^{n+1} = \frac{4}{3}u^n - \frac{1}{3}u^{n-1} +
\frac{2}{3}\Delta t f(u^{n+1}, t_{n+1})
\thinspace .
\label{decay:fd2:bw:2step}
$$

<h4>The Leapfrog scheme  <a name="___sec64"></a></h4>

<p>
$$
\begin{equation}
u'(t_n)\approx \frac{u^{n+1}-u^{n-1}}{2\Delta t} = [D_{2t} u]^n,
\end{equation}
$$


<p>
Scheme:

<p>
$$ [D_{2t} u = -a + b]^n,$$

or, if we write out and solve for the unknown \( u^{n+1} \),
$$
\begin{equation}
u^{n+1} = u^{n-1} + \Delta t f(u^n, t_n)
\thinspace .
\label{decay:fd2:leapfrog}
\end{equation}
$$


<p>

<ul>
 <p><li> Some other scheme must be used as starter (\( u^1 \)).</li>
 <p><li> Leapfrog is an explicit scheme - a nonlinear \( f \) (in \( u \)) is trivial
   to handle.</li>
 <p><li> Leapfrog is unstable after some time.</li>
</ul>

<h4>The filtered Leapfrog scheme  <a name="___sec65"></a></h4>

<p>
After computing \( u^{n+1} \), stabilize Leapfrog by
$$
\begin{equation}
u^n\ \leftarrow\ u^n + \gamma (u^{n-1} - 2u^n + u^{n+1})
\label{decay:fd2:leapfrog:filtered}
\thinspace .
\end{equation}
$$

<h4>2nd-order Runge-Kutta scheme  <a name="___sec66"></a></h4>

<p>
Forward-Euler + approximate Crank-Nicolson:
$$
\begin{align}
u^* &= u^n + \Delta t f(u^n, t_n),
\label{decay:fd2:RK2:s1}\\
u^{n+1} &= u^n + \Delta t \frac{1}{2} \left( f(u^n, t_n) + f(u^*, t_{n+1})
\right),
\label{decay:fd2:RK2:s2}
\end{align}
$$

<h4>2nd-order Adams-Bashforth scheme  <a name="___sec67"></a></h4>

<p>
$$
\begin{equation}
u^{n+1} = u^n + \frac{1}{2}\Delta t\left( 3f(u^n, t_n) - f(u^{n-1}, t_{n-1})
\right)
\thinspace .
\label{decay:fd2:AB2}
\end{equation}
$$

<h4>3rd-order Adams-Bashforth scheme  <a name="___sec68"></a></h4>

<p>
$$
\begin{equation}
u^{n+1} = u^n + \frac{1}{12}\left( 23f(u^n, t_n) - 16 f(u^{n-1},t_{n-1})
+ 5f(u^{n-2}, t_{n-2})\right)
\thinspace .
\label{decay:fd2:AB3}
\end{equation}
$$


<p>
<!-- RK4 -->

<!-- ------------------- end of main content --------------- -->


</body>
</html>
    

