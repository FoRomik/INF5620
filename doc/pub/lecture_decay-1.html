<!DOCTYPE html>
<!--
Automatically generated HTML file from Doconce source
(https://github.com/hplgit/doconce/)
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Doconce: https://github.com/hplgit/doconce/" />
<meta name="description" content="Study Guide: Intro to Computing with Finite Difference Methods">
<meta name="keywords" content="decay (problem),exponential decay,mesh,grid,mesh function,finite differences,difference equation,discrete equation,algebraic equation,finite difference scheme,Forward Euler scheme,backward scheme, 1-step,Backward Euler scheme,Crank-Nicolson scheme,weighted average,theta-rule,$\theta$-rule,finite difference operator notation,operator notation, finite differences,modules (Python),test block (Python modules),module import,doctests,software testing doctests,unit testing,software testing nose,unit testing,problem class,solver class,visualizer class,problem class,solver class,visualizer class,numerical experiments,scientific experiments,Unix wildcard notation,stability,consistency,stability,convergence,lambda functions,method of manufactured solutions,MMS (method of manufactured solutions),implicit schemes,explicit schemes,theta-rule,$\theta$-rule,backward scheme, 2-step,BDF2 scheme,Leapfrog scheme,Leapfrog scheme, filtered,Heun's method,Runge-Kutta, 2nd-order scheme,Adams-Bashforth scheme, 2nd order,Adams-Bashforth scheme, 3rd order">



<style type="text/css">
    /* bloodish style */

    body {
      font-family: Helvetica, Verdana, Arial, Sans-serif;
      color: #404040;
      background: #ffffff;
    }
    h1 { font-size: 1.8em;  color: #8A0808; }
    h2 { font-size: 1.5em;  color: #8A0808; }
    h3, h4 { color: #8A0808; }
    a { color: #8A0808; text-decoration:none; }
    tt { font-family: "Courier New", Courier; }
    
    p { text-indent: 0px; }
    hr { border: 0; width: 80%; border-bottom: 1px solid #aaa}
    p.caption { width: 80%; font-style: normal; text-align: left; }
    hr.figure { border: 0; width: 80%; border-bottom: 1px solid #aaa}
    .alert-text-small   { font-size: 80%;  }
    .alert-text-large   { font-size: 130%; }
    .alert-text-normal  { font-size: 90%;  }
    .alert {
             padding:8px 35px 8px 14px; margin-bottom:18px;
             text-shadow:0 1px 0 rgba(255,255,255,0.5);
             border:1px solid #bababa;
             -webkit-border-radius: 4px; -moz-border-radius: 4px;
             border-radius: 4px
             color: #555;
             background-color: #f8f8f8;
             background-position: 10px 5px;
             background-repeat: no-repeat;
             background-size: 38px;
             padding-left: 55px;
             width: 75%;
     }
     .alert-block {padding-top:14px; padding-bottom:14px}
     .alert-block > p, .alert-block > ul {margin-bottom:1em}
     .alert li {margin-top: 1em}
     .alert-block p+p {margin-top:5px}
     .alert-notice { background-image: url(https://doconce.googlecode.com/hg/bundled/html_images/small_gray_notice.png); }
     .alert-summary  { background-image:url(https://doconce.googlecode.com/hg/bundled/html_images/small_gray_summary.png); }
     .alert-warning { background-image: url(https://doconce.googlecode.com/hg/bundled/html_images/small_gray_warning.png); }
     .alert-question {background-image:url(https://doconce.googlecode.com/hg/bundled/html_images/small_gray_question.png); }

</style>

</head>

<!-- tocinfo
{'highest level': 1,
 'sections': [(' INF5620 in a nutshell ', 1, '5620:about', '5620:about'),
              (' The new official six-point course description ',
               2,
               None,
               '___sec1'),
              (' More specific description of the contents; part 1 ',
               2,
               None,
               '___sec2'),
              (' More specific description of the contents; part 2 ',
               2,
               None,
               '___sec3'),
              (' Philosophy: simplify, understand, generalize ',
               2,
               None,
               '___sec4'),
              (' The exam ', 2, None, '___sec5'),
              (' Required software ', 2, None, '___sec6'),
              (' Assumed/ideal background ', 2, None, '___sec7'),
              (' Start-up example for the course ', 2, None, '___sec8'),
              (' Start-up example ', 2, None, '___sec9'),
              (' What to learn in the start-up example; standard topics ',
               2,
               None,
               '___sec10'),
              (' What to learn in the start-up example; programming topics ',
               2,
               None,
               '___sec11'),
              (' What to learn in the start-up example; mathematical analysis ',
               2,
               None,
               '___sec12'),
              (' What to learn in the start-up example; generalizations ',
               2,
               None,
               '___sec13'),
              (' Finite difference methods  ', 1, 'decay:fdm', 'decay:fdm'),
              (' Topics in the first intro to the finite difference method ',
               2,
               None,
               '___sec15'),
              (' A basic model for exponential decay ',
               2,
               'decay:model',
               'decay:model'),
              (' Applications ', 2, None, '___sec17'),
              (' Continuous problem ', 2, None, '___sec18'),
              (' Discrete problem ', 2, None, '___sec19'),
              (' The steps in the finite difference method ',
               2,
               'decay:schemes:keysteps',
               'decay:schemes:keysteps'),
              (' Step 1: Discretizing the domain ', 2, None, '___sec21'),
              (' Step 1: Discretizing the domain ', 2, None, '___sec22'),
              (' What about a mesh function between the mesh points? ',
               2,
               None,
               '___sec23'),
              (' Step 2: Fulfilling the equation at discrete time points ',
               2,
               None,
               '___sec24'),
              (' Step 3: Replacing derivatives by finite differences ',
               2,
               None,
               '___sec25'),
              (' Step 3: Replacing derivatives by finite differences ',
               2,
               None,
               '___sec26'),
              (' Step 4: Formulating a recursive algorithm ',
               2,
               None,
               '___sec27'),
              (' Let us apply the scheme ', 2, None, '___sec28'),
              (' A backward difference ', 2, None, '___sec29'),
              (' The Backward Euler scheme ', 2, None, '___sec30'),
              (' A centered difference ', 2, None, '___sec31'),
              (' The Crank-Nicolson scheme; part 1 ',
               2,
               'decay:schemes:CN',
               'decay:schemes:CN'),
              (' The Crank-Nicolson scheme; part 2 ', 2, None, '___sec33'),
              (' The unifying $\\theta$-rule ',
               2,
               'decay:schemes:theta',
               'decay:schemes:theta'),
              (' Constant time step ', 2, None, '___sec35'),
              (' Test the understanding! ', 2, None, '___sec36'),
              (' Compact operator notation for finite differences ',
               2,
               'decay:fd:op',
               'decay:fd:op'),
              (' Compact operator notation for difference operators ',
               2,
               None,
               '___sec38'),
              (' The Backward Euler scheme with operator notation ',
               2,
               None,
               '___sec39'),
              (' The Forward Euler scheme with operator notation ',
               2,
               None,
               '___sec40'),
              (' The Crank-Nicolson scheme with operator notation ',
               2,
               None,
               '___sec41'),
              (' Implementation ', 1, 'decay:impl1', 'decay:impl1'),
              (' Requirements of a program ', 2, None, '___sec43'),
              (' Tools to learn ', 2, None, '___sec44'),
              (' Why implement in Python? ', 2, None, '___sec45'),
              (' Why implement in Python? ', 2, None, '___sec46'),
              (' Algorithm ', 2, 'decay:py1', 'decay:py1'),
              (' Translation to Python function ', 2, None, '___sec48'),
              (' Integer division ', 2, None, '___sec49'),
              (' Doc strings ', 2, None, '___sec50'),
              (' Formatting of numbers ', 2, None, '___sec51'),
              (' Running the program ', 2, None, '___sec52'),
              (' Verifying the implementation ',
               1,
               'decay:verification',
               'decay:verification'),
              (' Simplest method: run a few algorithmic steps by hand ',
               2,
               None,
               '___sec54'),
              (' Comparison with an exact discrete solution ',
               2,
               None,
               '___sec55'),
              (' Making a test based on an exact discrete solution ',
               2,
               None,
               '___sec56'),
              (' Test the understanding! ', 2, None, '___sec57'),
              (' Computing the numerical error as a mesh function ',
               2,
               'decay:computing:error',
               'decay:computing:error'),
              (' Computing the norm of the error ',
               2,
               'decay:computing:error:norm',
               'decay:computing:error:norm'),
              (' Norms of mesh functions ', 2, None, '___sec60'),
              (' Implementation of the norm of the error ',
               2,
               None,
               '___sec61'),
              (' Comment on array vs scalar computation ',
               2,
               None,
               '___sec62'),
              (' Plotting solutions ', 1, 'decay:plotting', 'decay:plotting'),
              (' Decorating a plot ', 2, None, '___sec64'),
              (' How the plots look like ', 2, None, '___sec65'),
              (' Plotting with SciTools ', 2, None, '___sec66'),
              (' Creating user interfaces ', 1, 'decay:GUI', 'decay:GUI'),
              (' Accessing command-line arguments ', 2, None, '___sec68'),
              (' Reading a sequence of command-line arguments ',
               2,
               None,
               '___sec69'),
              (' Implementation ', 2, None, '___sec70'),
              (' Working with an argument parser ', 2, None, '___sec71'),
              (' Reading option-values pairs ', 2, None, '___sec72'),
              (' A graphical user interface ', 2, None, '___sec73'),
              (' The Parampool package ', 2, None, '___sec74'),
              (' Making a compute function ', 2, None, '___sec75'),
              (' The hard part of the compute function: the HTML code ',
               2,
               None,
               '___sec76'),
              (' How to embed a PNG plot in HTML code ', 2, None, '___sec77'),
              (' Generating the user interface ', 2, None, '___sec78'),
              (' Running the web application ', 2, None, '___sec79'),
              (' More advanced use ', 2, None, '___sec80'),
              (' Computing convergence rates ',
               1,
               'decay:convrates',
               'decay:convrates'),
              (' Estimating the convergence rate $r$ ', 2, None, '___sec82'),
              (' Implementation ', 2, None, '___sec83'),
              (' Execution ', 2, None, '___sec84'),
              (' Debugging via convergence rates ', 2, None, '___sec85'),
              (' Memory-saving implementation ', 2, None, '___sec86'),
              (' Memory-saving solver function ', 2, None, '___sec87'),
              (' Reading computed data from file ', 2, None, '___sec88'),
              (' Usage of memory-saving code ', 2, None, '___sec89'),
              (' Software engineering ', 1, 'decay:softeng', 'decay:softeng'),
              (' Making a module ', 2, None, '___sec91'),
              (' Test block ', 2, None, '___sec92'),
              (' Prefixing imported functions by the module name ',
               2,
               None,
               '___sec93'),
              (' Downside of module prefix notation ', 2, None, '___sec94'),
              (' Doctests ', 2, None, '___sec95'),
              (' Running doctests ', 2, None, '___sec96'),
              (' Unit testing with nose ', 2, None, '___sec97'),
              (' Basic use of nose ', 2, None, '___sec98'),
              (' Example on a nose test in the source code ',
               2,
               None,
               '___sec99'),
              (' Example on a nose test in a separate file ',
               2,
               None,
               '___sec100'),
              (' The habit of writing nose tests ', 2, None, '___sec101'),
              (' Purpose of a test function: raise AssertionError if failure ',
               2,
               None,
               '___sec102'),
              (' Advantages of nose ', 2, None, '___sec103'),
              (' Demonstrating nose (ideas) ', 2, None, '___sec104'),
              (' Demonstrating nose (code) ', 2, None, '___sec105'),
              (' Floats as test results require careful comparison ',
               2,
               None,
               '___sec106'),
              (' Test of wrong use ', 2, None, '___sec107'),
              (' Test of convergence rates ', 2, None, '___sec108'),
              (' Classical unit testing with unittest ',
               2,
               None,
               '___sec109'),
              (' Basic use of unittest ', 2, None, '___sec110'),
              (' Demonstration of unittest ', 2, None, '___sec111'),
              (' Implementing simple problem and solver classes ',
               1,
               'decay:classes',
               'decay:classes'),
              (' What to learn ', 2, None, '___sec113'),
              (' The problem class ', 2, None, '___sec114'),
              (' Improved problem class ', 2, None, '___sec115'),
              (' The solver class ', 2, None, '___sec116'),
              (' The visualizer class ', 2, None, '___sec117'),
              (' Combing the classes ', 2, None, '___sec118'),
              (' Implementing more advanced problem and solver classes ',
               1,
               'decay:classes2',
               'decay:classes2'),
              (' A generic class for parameters ', 2, None, '___sec120'),
              (' The problem class ', 2, None, '___sec121'),
              (' The solver class ', 2, None, '___sec122'),
              (' The visualizer class ', 2, None, '___sec123'),
              (' Performing scientific experiments ',
               1,
               'decay:experiments',
               'decay:experiments'),
              (' Model problem and numerical solution method ',
               2,
               None,
               '___sec125'),
              (' Plan for the experiments ', 2, None, '___sec126'),
              (' Typical plot summarizing the results ',
               2,
               None,
               '___sec127'),
              (' Script code ', 2, None, '___sec128'),
              (' Comments to the code ', 2, None, '___sec129'),
              (' Interpreting output from other programs ',
               2,
               None,
               '___sec130'),
              (' Code for grabbing output from another program ',
               2,
               None,
               '___sec131'),
              (' Code for interpreting the grabbed output ',
               2,
               None,
               '___sec132'),
              (' Making a report ',
               2,
               'decay:exper:report',
               'decay:exper:report'),
              (' Publishing a complete project ',
               2,
               'decay:exper:github',
               'decay:exper:github'),
              (' Analysis of finite difference equations ',
               1,
               'decay:analysis',
               'decay:analysis'),
              (' Encouraging numerical solutions ', 2, None, '___sec136'),
              (' Discouraging numerical solutions; Crank-Nicolson ',
               2,
               None,
               '___sec137'),
              (' Discouraging numerical solutions; Forward Euler ',
               2,
               None,
               '___sec138'),
              (' Summary of observations ', 2, None, '___sec139'),
              (' Problem setting ', 2, None, '___sec140'),
              (' Experimental investigation of oscillatory solutions ',
               2,
               None,
               '___sec141'),
              (' Exact numerical solution ', 2, None, '___sec142'),
              (' Stability ', 2, None, '___sec143'),
              (' Computation of stability in this problem ',
               2,
               None,
               '___sec144'),
              (' Computation of stability in this problem ',
               2,
               None,
               '___sec145'),
              (' Explanation of problems with Forward Euler ',
               2,
               None,
               '___sec146'),
              (' Explanation of problems with Crank-Nicolson ',
               2,
               None,
               '___sec147'),
              (' Summary of stability ', 2, None, '___sec148'),
              (' Comparing amplification factors ', 2, None, '___sec149'),
              (' Plot of amplification factors ', 2, None, '___sec150'),
              (' Series expansion of amplification factors ',
               2,
               None,
               '___sec151'),
              (' Error in amplification factors ', 2, None, '___sec152'),
              (' The fraction of numerical and exact amplification factors ',
               2,
               None,
               '___sec153'),
              (' The true/global error at a point ',
               2,
               'decay:analysis:gobal:error',
               'decay:analysis:gobal:error'),
              (' Computing the global error at a point ',
               2,
               None,
               '___sec155'),
              (' Convergence ', 2, None, '___sec156'),
              (' Integrated errors ', 2, None, '___sec157'),
              (' Truncation error ', 2, None, '___sec158'),
              (' Computation of the truncation error ', 2, None, '___sec159'),
              (' The truncation error for other schemes ',
               2,
               None,
               '___sec160'),
              (' Consistency, stability, and convergence ',
               2,
               None,
               '___sec161'),
              (' Model extensions ',
               1,
               'decay:generalizations',
               'decay:generalizations'),
              (' Extension to a variable coefficient; Forward and Backward Euler ',
               2,
               None,
               '___sec163'),
              (' Extension to a variable coefficient; Crank-Nicolson ',
               2,
               None,
               '___sec164'),
              (' Extension to a variable coefficient; $\\theta$-rule ',
               2,
               None,
               '___sec165'),
              (' Extension to a variable coefficient; operator notation ',
               2,
               None,
               '___sec166'),
              (' Extension to a source term ',
               2,
               'decay:source',
               'decay:source'),
              (' Implementation of the generalized model problem ',
               2,
               'decay:general',
               'decay:general'),
              (' Implementations of variable coefficients; functions ',
               2,
               None,
               '___sec169'),
              (' Implementations of variable coefficients; classes ',
               2,
               None,
               '___sec170'),
              (' Implementations of variable coefficients; lambda function ',
               2,
               None,
               '___sec171'),
              (' Verification via trivial solutions ',
               2,
               'decay:verify:trivial',
               'decay:verify:trivial'),
              (' Verification via trivial solutions; nose test ',
               2,
               None,
               '___sec173'),
              (' Verification via manufactured solutions ',
               2,
               'decay:MMS',
               'decay:MMS'),
              (' Linear manufactured solution ', 2, None, '___sec175'),
              (' Nose test for linear manufactured solution ',
               2,
               None,
               '___sec176'),
              (' Extension to systems of ODEs ', 2, None, '___sec177'),
              (' The Backward Euler method gives a system of algebraic equations ',
               2,
               None,
               '___sec178'),
              (' General first-order ODEs ',
               1,
               'decay:1stODEs',
               'decay:1stODEs'),
              (' Generic form ', 2, None, '___sec180'),
              (' The $\\theta$-rule ', 2, None, '___sec181'),
              (' Implicit 2-step backward scheme ', 2, None, '___sec182'),
              (' The Leapfrog scheme ', 2, None, '___sec183'),
              (' The filtered Leapfrog scheme ', 2, None, '___sec184'),
              (' 2nd-order Runge-Kutta scheme ', 2, None, '___sec185'),
              (' 4th-order Runge-Kutta scheme ',
               2,
               'decay:fd2:RK4',
               'decay:fd2:RK4'),
              (' 2nd-order Adams-Bashforth scheme ', 2, None, '___sec187'),
              (' 3rd-order Adams-Bashforth scheme ', 2, None, '___sec188'),
              (' The Odespy software ', 2, None, '___sec189'),
              (' Example: Runge-Kutta methods  ', 2, None, '___sec190'),
              (' Plots from the experiments ', 2, None, '___sec191'),
              (' Example: Adaptive Runge-Kutta methods  ',
               2,
               None,
               '___sec192')]}
end of tocinfo -->

<body>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
     equationNumbers: {  autoNumber: "AMS"  },
     extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js"]
  }
});
</script>
<script type="text/javascript"
 src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- Fix slow MathJax rendering in IE8 -->
<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7">


<!-- newcommands_keep.tex -->
$$
\newcommand{\uex}{u_{\small\mbox{e}}}
\newcommand{\Aex}{A_{\small\mbox{e}}}
\newcommand{\half}{\frac{1}{2}}
\newcommand{\halfi}{{1/2}}
\newcommand{\ts}{\thinspace .}

\newcommand{\Ddt}[1]{\frac{D #1}{dt}}
\newcommand{\E}[1]{\hbox{E}\lbrack #1 \rbrack}
\newcommand{\Var}[1]{\hbox{Var}\lbrack #1 \rbrack}
\newcommand{\Std}[1]{\hbox{Std}\lbrack #1 \rbrack}

\newcommand{\xpoint}{\boldsymbol{x}}
\newcommand{\normalvec}{\boldsymbol{n}}
\newcommand{\Oof}[1]{\mathcal{O}(#1)}

\newcommand{\x}{\boldsymbol{x}}
\newcommand{\X}{\boldsymbol{X}}
\renewcommand{\u}{\boldsymbol{u}}
\renewcommand{\v}{\boldsymbol{v}}
\newcommand{\w}{\boldsymbol{w}}
\newcommand{\V}{\boldsymbol{V}}
\newcommand{\e}{\boldsymbol{e}}
\newcommand{\f}{\boldsymbol{f}}
\newcommand{\F}{\boldsymbol{F}}
\newcommand{\stress}{\boldsymbol{\sigma}}
\newcommand{\strain}{\boldsymbol{\varepsilon}}
\newcommand{\stressc}{{\sigma}}
\newcommand{\strainc}{{\varepsilon}}
\newcommand{\I}{\boldsymbol{I}}
\newcommand{\T}{\boldsymbol{T}}

% Unit vectors
\newcommand{\ii}{\boldsymbol{i}}
\newcommand{\jj}{\boldsymbol{j}}
\newcommand{\kk}{\boldsymbol{k}}
\newcommand{\ir}{\boldsymbol{i}_r}
\newcommand{\ith}{\boldsymbol{i}_{\theta}}
\newcommand{\iz}{\boldsymbol{i}_z}

% Index sets
\newcommand{\Ix}{\mathcal{I}_x}
\newcommand{\Iy}{\mathcal{I}_y}
\newcommand{\Iz}{\mathcal{I}_z}
\newcommand{\It}{\mathcal{I}_t}
\newcommand{\setb}[1]{{#1}^0}    % set begin
\newcommand{\sete}[1]{{#1}^{-1}} % set end
%\newcommand{\setl}[1]{#1\setminus\{\set1{#1}\}}
%\newcommand{\setr}[1]{#1\setminus\{\set0{#1}\}}
%\newcommand{\seti}[1]{#1\setminus\{\set0{#1},\set1{#1}\}}
\newcommand{\setl}[1]{{#1}^-}
\newcommand{\setr}[1]{{#1}^+}
\newcommand{\seti}[1]{{#1}^i}

% Finite elements
\newcommand{\basphi}{\varphi}
\newcommand{\baspsi}{\psi}
\newcommand{\refphi}{\tilde\basphi}
\newcommand{\psib}{\boldsymbol{\psi}}
\newcommand{\sinL}[1]{\sin\left((#1+1)\pi\frac{x}{L}\right)}
\newcommand{\xno}[1]{x_{#1}}
%\newcommand{\xno}[1]{x^{(#1)}}
\newcommand{\Xno}[1]{X_{(#1)}}
\newcommand{\yno}[1]{y_{#1}}
\newcommand{\Yno}[1]{Y_{(#1)}}
\newcommand{\xdno}[1]{\boldsymbol{x}_{#1}}

% FEniCS commands
\newcommand{\dX}{\, \mathrm{d}X}
\newcommand{\dx}{\, \mathrm{d}x}
\newcommand{\ds}{\, \mathrm{d}s}
\newcommand{\Real}{\mathbb{R}}
\newcommand{\Integerp}{\mathbb{N}}
\newcommand{\Integer}{\mathbb{Z}}
$$




    
<!-- ------------------- main content ---------------------- -->


<title>Study Guide: Intro to Computing with Finite Difference Methods</title>

<center><h1>Study Guide: Intro to Computing with Finite Difference Methods</h1></center>  <!-- document title -->

<p>
<!-- author(s): Hans Petter Langtangen -->

<center>
<b>Hans Petter Langtangen</b> [1, 2]
</center>


<p>
<!-- institution(s) -->

<center>[1] <b>Center for Biomedical Computing, Simula Research Laboratory</b></center>
<center>[2] <b>Department of Informatics, University of Oslo</b></center>
<p>
<center><h4>Sep 13, 2013</h4></center> <!-- date -->
<p>
<!-- !split -->

<h2>Table of contents</h2>

<p>
<a href="#5620:about"> INF5620 in a nutshell </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec1"> The new official six-point course description </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec2"> More specific description of the contents; part 1 </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec3"> More specific description of the contents; part 2 </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec4"> Philosophy: simplify, understand, generalize </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec5"> The exam </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec6"> Required software </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec7"> Assumed/ideal background </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec8"> Start-up example for the course </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec9"> Start-up example </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec10"> What to learn in the start-up example; standard topics </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec11"> What to learn in the start-up example; programming topics </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec12"> What to learn in the start-up example; mathematical analysis </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec13"> What to learn in the start-up example; generalizations </a><br>
<a href="#decay:fdm"> Finite difference methods  </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec15"> Topics in the first intro to the finite difference method </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:model"> A basic model for exponential decay </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec17"> Applications </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec18"> Continuous problem </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec19"> Discrete problem </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:schemes:keysteps"> The steps in the finite difference method </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec21"> Step 1: Discretizing the domain </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec22"> Step 1: Discretizing the domain </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec23"> What about a mesh function between the mesh points? </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec24"> Step 2: Fulfilling the equation at discrete time points </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec25"> Step 3: Replacing derivatives by finite differences </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec26"> Step 3: Replacing derivatives by finite differences </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec27"> Step 4: Formulating a recursive algorithm </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec28"> Let us apply the scheme </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec29"> A backward difference </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec30"> The Backward Euler scheme </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec31"> A centered difference </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:schemes:CN"> The Crank-Nicolson scheme; part 1 </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec33"> The Crank-Nicolson scheme; part 2 </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:schemes:theta"> The unifying \( \theta \)-rule </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec35"> Constant time step </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec36"> Test the understanding! </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:fd:op"> Compact operator notation for finite differences </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec38"> Compact operator notation for difference operators </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec39"> The Backward Euler scheme with operator notation </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec40"> The Forward Euler scheme with operator notation </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec41"> The Crank-Nicolson scheme with operator notation </a><br>
<a href="#decay:impl1"> Implementation </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec43"> Requirements of a program </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec44"> Tools to learn </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec45"> Why implement in Python? </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec46"> Why implement in Python? </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:py1"> Algorithm </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec48"> Translation to Python function </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec49"> Integer division </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec50"> Doc strings </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec51"> Formatting of numbers </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec52"> Running the program </a><br>
<a href="#decay:verification"> Verifying the implementation </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec54"> Simplest method: run a few algorithmic steps by hand </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec55"> Comparison with an exact discrete solution </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec56"> Making a test based on an exact discrete solution </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec57"> Test the understanding! </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:computing:error"> Computing the numerical error as a mesh function </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:computing:error:norm"> Computing the norm of the error </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec60"> Norms of mesh functions </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec61"> Implementation of the norm of the error </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec62"> Comment on array vs scalar computation </a><br>
<a href="#decay:plotting"> Plotting solutions </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec64"> Decorating a plot </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec65"> How the plots look like </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec66"> Plotting with SciTools </a><br>
<a href="#decay:GUI"> Creating user interfaces </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec68"> Accessing command-line arguments </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec69"> Reading a sequence of command-line arguments </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec70"> Implementation </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec71"> Working with an argument parser </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec72"> Reading option-values pairs </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec73"> A graphical user interface </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec74"> The Parampool package </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec75"> Making a compute function </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec76"> The hard part of the compute function: the HTML code </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec77"> How to embed a PNG plot in HTML code </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec78"> Generating the user interface </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec79"> Running the web application </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec80"> More advanced use </a><br>
<a href="#decay:convrates"> Computing convergence rates </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec82"> Estimating the convergence rate \( r \) </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec83"> Implementation </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec84"> Execution </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec85"> Debugging via convergence rates </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec86"> Memory-saving implementation </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec87"> Memory-saving solver function </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec88"> Reading computed data from file </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec89"> Usage of memory-saving code </a><br>
<a href="#decay:softeng"> Software engineering </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec91"> Making a module </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec92"> Test block </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec93"> Prefixing imported functions by the module name </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec94"> Downside of module prefix notation </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec95"> Doctests </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec96"> Running doctests </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec97"> Unit testing with nose </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec98"> Basic use of nose </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec99"> Example on a nose test in the source code </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec100"> Example on a nose test in a separate file </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec101"> The habit of writing nose tests </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec102"> Purpose of a test function: raise AssertionError if failure </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec103"> Advantages of nose </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec104"> Demonstrating nose (ideas) </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec105"> Demonstrating nose (code) </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec106"> Floats as test results require careful comparison </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec107"> Test of wrong use </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec108"> Test of convergence rates </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec109"> Classical unit testing with unittest </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec110"> Basic use of unittest </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec111"> Demonstration of unittest </a><br>
<a href="#decay:classes"> Implementing simple problem and solver classes </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec113"> What to learn </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec114"> The problem class </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec115"> Improved problem class </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec116"> The solver class </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec117"> The visualizer class </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec118"> Combing the classes </a><br>
<a href="#decay:classes2"> Implementing more advanced problem and solver classes </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec120"> A generic class for parameters </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec121"> The problem class </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec122"> The solver class </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec123"> The visualizer class </a><br>
<a href="#decay:experiments"> Performing scientific experiments </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec125"> Model problem and numerical solution method </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec126"> Plan for the experiments </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec127"> Typical plot summarizing the results </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec128"> Script code </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec129"> Comments to the code </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec130"> Interpreting output from other programs </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec131"> Code for grabbing output from another program </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec132"> Code for interpreting the grabbed output </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:exper:report"> Making a report </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:exper:github"> Publishing a complete project </a><br>
<a href="#decay:analysis"> Analysis of finite difference equations </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec136"> Encouraging numerical solutions </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec137"> Discouraging numerical solutions; Crank-Nicolson </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec138"> Discouraging numerical solutions; Forward Euler </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec139"> Summary of observations </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec140"> Problem setting </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec141"> Experimental investigation of oscillatory solutions </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec142"> Exact numerical solution </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec143"> Stability </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec144"> Computation of stability in this problem </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec145"> Computation of stability in this problem </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec146"> Explanation of problems with Forward Euler </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec147"> Explanation of problems with Crank-Nicolson </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec148"> Summary of stability </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec149"> Comparing amplification factors </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec150"> Plot of amplification factors </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec151"> Series expansion of amplification factors </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec152"> Error in amplification factors </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec153"> The fraction of numerical and exact amplification factors </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:analysis:gobal:error"> The true/global error at a point </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec155"> Computing the global error at a point </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec156"> Convergence </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec157"> Integrated errors </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec158"> Truncation error </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec159"> Computation of the truncation error </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec160"> The truncation error for other schemes </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec161"> Consistency, stability, and convergence </a><br>
<a href="#decay:generalizations"> Model extensions </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec163"> Extension to a variable coefficient; Forward and Backward Euler </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec164"> Extension to a variable coefficient; Crank-Nicolson </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec165"> Extension to a variable coefficient; \( \theta \)-rule </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec166"> Extension to a variable coefficient; operator notation </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:source"> Extension to a source term </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:general"> Implementation of the generalized model problem </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec169"> Implementations of variable coefficients; functions </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec170"> Implementations of variable coefficients; classes </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec171"> Implementations of variable coefficients; lambda function </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:verify:trivial"> Verification via trivial solutions </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec173"> Verification via trivial solutions; nose test </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:MMS"> Verification via manufactured solutions </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec175"> Linear manufactured solution </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec176"> Nose test for linear manufactured solution </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec177"> Extension to systems of ODEs </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec178"> The Backward Euler method gives a system of algebraic equations </a><br>
<a href="#decay:1stODEs"> General first-order ODEs </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec180"> Generic form </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec181"> The \( \theta \)-rule </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec182"> Implicit 2-step backward scheme </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec183"> The Leapfrog scheme </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec184"> The filtered Leapfrog scheme </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec185"> 2nd-order Runge-Kutta scheme </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:fd2:RK4"> 4th-order Runge-Kutta scheme </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec187"> 2nd-order Adams-Bashforth scheme </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec188"> 3rd-order Adams-Bashforth scheme </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec189"> The Odespy software </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec190"> Example: Runge-Kutta methods  </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec191"> Plots from the experiments </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec192"> Example: Adaptive Runge-Kutta methods  </a><br>

<p>
<!-- !split -->

<h2>INF5620 in a nutshell <a name="5620:about"></a></h2>

<p>

<ul>
 <p><li> Numerical methods for partial differential equations (PDEs)</li>
 <p><li> How to we solve a PDE in practice and produce numbers?</li>
 <p><li> How to we trust the answer?</li>
 <p><li> Approach: <em>simplify, understand, generalize</em></li>
</ul>

<div class="alert alert-block alert-summary alert-text-normal"><b>After the course.</b>
You see a PDE and can't wait to program a method
and visualize a solution! Somebody asks if the solution is right
and you can give convincing answer.
</div>
<p>
<!-- !split -->

<h3>The new official six-point course description  <a name="___sec1"></a></h3>

<p>
After having completed INF5620 you

<p>
<!-- !bpop -->

<ul>
 <p><li> can derive methods and implement them to solve frequently
   arising partial differential equations (PDEs) from physics and mechanics.</li>
 <p><li> have a good understanding of finite difference and finite element
   methods and how they are applied in linear and nonlinear PDE problems.</li>
 <p><li> can identify numerical artifacts and perform mathematical analysis
   to understand and cure non-physical effects.</li>
 <p><li> can apply sophisticated programming techniques in Python, combined
   with Cython, C, C++, and Fortran code, to create modern,
   flexible simulation programs.</li>
 <p><li> can construct verification tests and automate them.</li>
 <p><li> have experience with project hosting sites (Bitbucket, GitHub),
   version control systems (Git), report writing (LaTeX),
   and Python scripting for performing reproducible computational science.</li>
</ul>

<!-- !epop -->

<p>
<!-- !split -->

<h3>More specific description of the contents; part 1  <a name="___sec2"></a></h3>

<p>
<div class="alert alert-block alert-block alert-text-normal"><b></b>

<ul>
 <p><li> Finite difference methods</li>

<ul>
   <p><li> ODEs</li>
   <p><li> the wave equation \( u_{tt}=u_{xx} \) in 1D, 2D, 3D</li>
   <p><li> the diffusion equation \( u_t=u_{xx} \) in 1D, 2D, 3D</li>
   <p><li> write your own software from scratch</li>
   <p><li> understand how the methods work and why they fail</li>
</ul>

</ul>
</div>
<p>
<div class="alert alert-block alert-block alert-text-normal"><b></b>

<ul>
 <p><li> Finite element methods for</li>

<ul>
   <p><li> stationary diffusion equations \( u_{xx}=f \) in 1D</li>
   <p><li> time-dependent diffusion and wave equations in 1D</li>
   <p><li> PDEs in 2D and 3D by use of the FEniCS software</li>
   <p><li> perform hand-calculations, write your own software (1D)</li>
   <p><li> understand how the methods work and why they fail</li>
</ul>

</ul>
</div>
<p>
<!-- !split -->

<h3>More specific description of the contents; part 2  <a name="___sec3"></a></h3>

<p>
<div class="alert alert-block alert-block alert-text-normal"><b></b>

<ul>
 <p><li> Nonlinear PDEs</li>

<ul>
   <p><li> Newton and Picard iteration methods, finite differences and elements</li>
</ul>

 <p><li> More advanced PDEs for fluid flow and elasticity</li>
 <p><li> Parallel computing</li>
</ul>
</div>
<p>
<!-- !split -->

<h3>Philosophy: simplify, understand, generalize  <a name="___sec4"></a></h3>

<p>

<ul>
 <p><li> Start with simplified ODE/PDE problems</li>
 <p><li> Learn to reason about the discretization</li>
 <p><li> Learn to implement, verify, and experiment</li>
 <p><li> Understand the method, program, and results</li>
 <p><li> Generalize the problem, method, and program</li>
</ul>

This is the power of applied mathematics!

<p>
<!-- !split -->

<h3>The exam  <a name="___sec5"></a></h3>

<p>
<!-- !bpop -->

<ul>
 <p><li> Oral exam</li>
 <p><li> 6 problems (topics) are announced two weeks before the exam</li>
 <p><li> Work out a 20 min presentations (talks) for each problem</li>
 <p><li> At the exam: throw a die to pick your problem to be presented</li>
 <p><li> Aids: plots, computer programs</li>
 <p><li> Why? Very effective way of learning</li>
 <p><li> Sure? Excellent results over 15 years</li>
 <p><li> When? Late december</li>
</ul>

<!-- !epop -->

<p>
<!-- !split -->

<h3>Required software  <a name="___sec6"></a></h3>

<p>

<ul>
 <p><li> Our software platform: Python (sometimes combined with Cython,
   Fortran, C, C++)</li>
 <p><li> Important Python packages: <code>numpy</code>, <code>scipy</code>, <code>matplotlib</code>,
   <code>sympy</code>, <code>fenics</code>, <code>scitools</code>, ...</li>
 <p><li> Suggested installation: Run Ubuntu in a virtual machine</li>
 <p><li> Alternative: run a (course-specific) Vagrant machine</li>
</ul>

<!-- !split -->

<h3>Assumed/ideal background  <a name="___sec7"></a></h3>

<p>

<ul>
 <p><li> INF1100: Python programming, solution of ODEs</li>
 <p><li> Some experience with finite difference methods</li>
 <p><li> Some analytical and numerical knowledge of PDEs</li>
 <p><li> Much experience with calculus and linear algebra</li>
 <p><li> Much experience with programming of mathematical problems</li>
 <p><li> Experience with mathematical modeling with PDEs
   (from physics, mechanics, geophysics, or ...)</li>
</ul>

<!-- !split -->

<h3>Start-up example for the course  <a name="___sec8"></a></h3>

<p>
What if you don't have this ideal background?

<p>

<ul>
 <p><li> Students come to this course with very different backgrounds</li>
 <p><li> First task: summarize assumed background knowledge by going through
   a simple example</li>
 <p><li> Also in this example:</li>

<ul>
   <p><li> Some fundamental material on software implementation
     and software testing</li>
   <p><li> Material on analyzing numerical methods to understand
     why they can fail</li>
   <p><li> Applications to real-world problems</li>
</ul>

</ul>

<!-- !split -->

<h3>Start-up example  <a name="___sec9"></a></h3>

<p>
<div class="alert alert-block alert-notice alert-text-normal"><b>ODE problem.</b>
$$ u'=-au,\quad u(0)=I,\ t\in (0,T],$$

where \( a>0 \) is a constant.
</div>
<p>
Everything we do is motivated by what we need as building blocks for
solving PDEs!

<p>
<!-- !split -->

<h3>What to learn in the start-up example; standard topics  <a name="___sec10"></a></h3>

<p>

<ul>
 <p><li> How to think when constructing finite difference methods, with special focus
   on the Forward Euler, Backward Euler, and Crank-Nicolson (midpoint)
   schemes</li>
 <p><li> How to formulate a computational algorithm and translate it into
   Python code</li>
 <p><li> How to make curve plots of the solutions</li>
 <p><li> How to compute numerical errors</li>
 <p><li> How to compute convergence rates</li>
</ul>

<!-- !split -->

<h3>What to learn in the start-up example; programming topics  <a name="___sec11"></a></h3>

<p>

<ul>
 <p><li> How to verify an implementation and automate verification
   through nose tests in Python</li>
 <p><li> How to structure code in terms of functions, classes, and modules</li>
 <p><li> How to work with Python concepts such as arrays, lists, dictionaries,
   lambda functions, functions in functions (closures), doctests,
   unit tests, command-line interfaces, graphical user interfaces</li>
 <p><li> How to perform array computing and understand the difference from
   scalar computing</li>
 <p><li> How to conduct and automate large-scale numerical experiments</li>
 <p><li> How to generate scientific reports</li>
</ul>

<!-- !split -->

<h3>What to learn in the start-up example; mathematical analysis  <a name="___sec12"></a></h3>

<p>

<ul>
 <p><li> How to uncover numerical artifacts in the computed solution</li>
 <p><li> How to analyze the numerical schemes mathematically to understand
   why artifacts occur</li>
 <p><li> How to derive mathematical expressions for various measures of
   the error in numerical methods, frequently by using the <code>sympy</code> software
   for symbolic computation</li>
 <p><li> Introduce concepts such as finite difference operators,
   mesh (grid), mesh functions,
   stability, truncation error, consistency, and convergence</li>
</ul>

<!-- !split -->

<h3>What to learn in the start-up example; generalizations  <a name="___sec13"></a></h3>

<p>

<ul>
 <p><li> Generalize the example to \( u'(t)=-a(t)u(t) + b(t) \)</li>
 <p><li> Present additional methods for the general nonlinear ODE \( u'=f(u,t) \),
   which is either a scalar ODE or a system of ODEs</li>
 <p><li> How to access professional packages for solving ODEs</li>
 <p><li> How our model equations like \( u'=-au \) arises in a wide range
   of phenomena in physics, biology, and finance</li>
</ul>

<!-- !split -->

<h2>Finite difference methods <a name="decay:fdm"></a></h2>

<p>

<ul>
 <p><li> The finite difference method is the simplest method
   for solving differential equations</li>
 <p><li> Fast to learn, derive, and implement</li>
 <p><li> A very useful tool to know, even if you aim at using the finite element
   or the finite volume method</li>
</ul>

<center><p><img src="fig-decay/fdm_u_uei.png" align="bottom" width=400></p></center>

<p>
<!-- !split -->

<h3>Topics in the first intro to the finite difference method  <a name="___sec15"></a></h3>

<p>

<ul>
 <p><li> How to derive a finite difference discretization of an ODE</li>
 <p><li> Key concepts: mesh, mesh function, finite difference approximations</li>
 <p><li> The Forward Euler, Backward Euler, and Crank-Nicolson methods</li>
 <p><li> Finite difference operator notation</li>
 <p><li> How to derive an algorithm and implement it in Python</li>
 <p><li> How to test the implementation</li>
</ul>

<!-- !split -->

<h3>A basic model for exponential decay <a name="decay:model"></a></h3>

<p>
The world's simplest (?) ODE:

<p>
$$
\begin{equation*}
u'(t) = -au(t),\quad u(0)=I,\ t\in (0,T]\ts
\end{equation*}
$$


<p>
<div class="alert alert-block alert-notice alert-text-normal"><b>Observation.</b>
We can learn a lot about numerical methods, computer implementation,
program testing, and real applications of these tools by using
this very simple ODE as example. The teaching principle is to keep the math as
simple as possible while learning computer tools.
</div>
<p>
<center><p><img src="fig-decay/FE1.png" align="bottom" width=600></p></center>

<p>
<!-- !split -->

<h3>Applications  <a name="___sec17"></a></h3>

<p>

<ul>
 <p><li> Growth and decay of populations (cells, animals, human)</li>
 <p><li> Growth and decay of a fortune</li>
 <p><li> Radioactive decay</li>
 <p><li> Cooling/heating of an object</li>
 <p><li> Pressure variation in the atmosphere</li>
 <p><li> Vertical motion of a body in water/air</li>
 <p><li> Time-discretization of diffusion PDEs by Fourier techniques</li>
</ul>

See the <a href="http://tinyurl.com/k3sdbuv/pub/decay-sphinx/._part0008_main_decay.html">text</a> for details.

<p>
<!-- !split -->

<h3>Continuous problem  <a name="___sec18"></a></h3>

<p>
$$
\begin{equation}
u' = -au,\ t\in (0,T], \quad u(0)=I\thinspace .  \label{decay:problem}
\end{equation}
$$


<p>
Solution of the continuous problem ("continuous solution"):

<p>
$$
\begin{equation*} u(t) = Ie^{-at}\ts\end{equation*}
$$

(special case that we can derive a formula for the discrete solution)

<p>
<!-- !split -->

<h3>Discrete problem  <a name="___sec19"></a></h3>

<p>
\( u^n\approx u(t_n) \) means that \( u \) is found at discrete time points
\( t_1,t_2,t_3,\ldots \)

<p>
Typical computational formula:
$$
\begin{equation*} u^{n+1} = Au^n\ts\end{equation*}
$$

The constant \( A \) depends on the type of finite difference method.

<p>
Solution of the discrete problem ("discrete solution"):

<p>
$$
\begin{equation*} u^{n+1} = IA^n\ts\end{equation*}
$$

(special case that we can derive a formula for the discrete solution)

<p>
<!-- !split -->

<h3>The steps in the finite difference method <a name="decay:schemes:keysteps"></a></h3>

<p>
Solving a differential equation by a finite difference method
consists of four steps:

<p>

<ol>
<p><li> discretizing the domain,</li>
<p><li> fulfilling the equation at discrete time points,</li>
<p><li> replacing derivatives by finite differences,</li>
<p><li> formulating a recursive algorithm.</li>
</ol>

<!-- !split -->

<h3>Step 1: Discretizing the domain  <a name="___sec21"></a></h3>

<p>
The time domain \( [0,T] \) is represented by a <em>mesh</em>: a finite number of
\( N_t+1 \) points

<p>
$$0 = t_0 < t_1 < t_2 < \cdots < t_{N_t-1} < t_{N_t} = T\ts$$


<p>

<ul>
 <p><li> We seek the solution \( u \) at the mesh points: \( u(t_n) \), \( n=1,2,\ldots,N_t \).</li>
 <p><li> Note: \( u^0 \) is known as \( I \).</li>
 <p><li> Notational short-form for the numerical approximation to \( u(t_n) \): \( u^n \)</li>
 <p><li> In the differential equation: \( u \) is the exact solution</li>
 <p><li> In the numerical method and implementation: \( u^n \) is the numerical
   approximation, \( \uex(t) \) is the exact solution</li>
</ul>

<!-- !split -->

<h3>Step 1: Discretizing the domain  <a name="___sec22"></a></h3>

<p>
\( u^n \) is a mesh function, defined at the mesh points \( t_n \), \( n=0,\ldots,N_t \)
only.

<p>
<center><p><img src="fig-decay/fdm_u_ue.png" align="bottom" width=600></p></center>

<p>
<!-- !split -->

<h3>What about a mesh function between the mesh points?  <a name="___sec23"></a></h3>

<p>
Can extend the mesh function to yield values between mesh points
by <em>linear interpolation</em>:

<p>
$$
\begin{equation}
u(t) \approx u^n + \frac{u^{n+1}-u^n}{t_{n+1}-t_n}(t - t_n)\thinspace .
\end{equation}
$$


<p>
<center><p><img src="fig-decay/fdm_u_uei.png" align="bottom" width=500></p></center>

<p>
<!-- !split -->

<h3>Step 2: Fulfilling the equation at discrete time points  <a name="___sec24"></a></h3>

<p>

<ul>
 <p><li> The ODE holds for all \( t\in (0,T] \) (infinite no of points)</li>
 <p><li> Idea: let the ODE be valid at the mesh points only (finite no of points)</li>
</ul>

$$
\begin{equation}
u'(t_n) = -au(t_n),\quad n=1,\ldots,N_t\thinspace .
\label{decay:step2}
\end{equation}
$$


<p>
<!-- !split -->

<h3>Step 3: Replacing derivatives by finite differences  <a name="___sec25"></a></h3>

<p>
Now it is time for the <em>finite difference</em> approximations of
derivatives:

<p>
$$
\begin{equation}
u'(t_n) \approx \frac{u^{n+1}-u^{n}}{t_{n+1}-t_n}\thinspace .
\label{decay:FEdiff}
\end{equation}
$$


<p>
<center><p><img src="fig-decay/fd_forward.png" align="bottom" width=400></p></center>

<p>
<!-- !split -->

<h3>Step 3: Replacing derivatives by finite differences  <a name="___sec26"></a></h3>

<p>
Inserting the finite difference approximation in

<p>
$$ u'(t_n) = -au(t_n),$$

gives

<p>
$$
\begin{equation}
\frac{u^{n+1}-u^{n}}{t_{n+1}-t_n} = -au^{n},\quad n=0,1,\ldots,N_t-1\thinspace .
\label{decay:step3}
\end{equation}
$$


<p>
This is the

<p>

<ul>
 <p><li> discrete equation</li>
 <p><li> discrete problem</li>
 <p><li> finite difference method</li>
 <p><li> finite difference scheme</li>
</ul>

<!-- !split -->

<h3>Step 4: Formulating a recursive algorithm  <a name="___sec27"></a></h3>

<p>

<ul>
 <p><li> How can we actually compute the \( u^n \) values?</li>
 <p><li> Fundamental structure:</li>

<ul>
   <p><li> given \( u^0=I \)</li>
   <p><li> compute \( u^1 \) from \( u^0 \)</li>
   <p><li> compute \( u^2 \) from \( u^1 \)</li>
   <p><li> compute \( u^3 \) from \( u^2 \) (and so forth)</li>
</ul>

 <p><li> In general: we have \( u^n \) and seek \( u^{n+1} \)</li>
</ul>

<div class="alert alert-block alert-notice alert-text-normal"><b>The Forward Euler scheme.</b>
Solve wrt \( u^{n+1} \) to get the computational formula:

<p>
$$
\begin{equation}
u^{n+1} = u^n - a(t_{n+1} -t_n)u^n\thinspace .
\label{decay:FE}
\end{equation}
$$
</div>
<p>
<!-- !split -->

<h3>Let us apply the scheme  <a name="___sec28"></a></h3>

<p>
Assume constant time spacing: \( \Delta t = t_{n+1}-t_n=\mbox{const} \)

<p>
$$
\begin{align*}
u_0 &= I,\\ 
u_1 & = u^0 - a\Delta t u^0 = I(1-a\Delta t),\\ 
u_2 & = I(1-a\Delta t)^2,\\ 
u^3 &= I(1-a\Delta t)^3,\\ 
&\vdots\\ 
u^{N_t} &= I(1-a\Delta t)^{N_t}\thinspace .
\end{align*}
$$


<p>
Ooops - we can find the numerical solution by hand (in this simple
example)! No need for a computer (yet)...

<p>
<!-- !split -->

<h3>A backward difference  <a name="___sec29"></a></h3>

<p>
Here is another finite difference approximation to the
derivative (backward difference):

<p>
$$
\begin{equation}
u'(t_n) \approx \frac{u^{n}-u^{n-1}}{t_{n}-t_{n-1}}\thinspace .
\label{decay:BEdiff}
\end{equation}
$$


<p>
<center><p><img src="fig-decay/fd_backward.png" align="bottom" width=400></p></center>

<p>
<!-- !split -->

<h3>The Backward Euler scheme  <a name="___sec30"></a></h3>

<p>
Inserting the finite difference approximation in \( u'(t_n)=-au(t_n) \) yields
the Backward Euler (BE) scheme:

<p>
$$
\begin{equation}
\frac{u^{n}-u^{n-1}}{t_{n}-t_{n-1}} = -a u^n\thinspace .
\label{decay:BE0}
\end{equation}
$$

Solve with respect to the unknown \( u^{n+1} \):

<p>
$$
\begin{equation}
u^{n+1} = \frac{1}{1+ a(t_{n+1}-t_n)} u^n\thinspace .
\label{decay:BE}
\end{equation}
$$


<p>
<!-- !split -->

<h3>A centered difference  <a name="___sec31"></a></h3>

<p>
Centered differences are better approximations than forward or
backward differences.

<p>
<center><p><img src="fig-decay/fd_centered.png" align="bottom" width=400></p></center>

<p>
<!-- !split -->

<h3>The Crank-Nicolson scheme; part 1 <a name="decay:schemes:CN"></a></h3>

<p>
Idea 1: let the ODE hold at \( t_{n+1/2} \)

<p>
$$ u'(t_{n+1/2} = -au(t_{n+1/2})\ts$$


<p>
Idea 2: approximate \( u'(t_{n+1/2} \) by a centered difference

<p>
$$
\begin{equation}
u'(t_{n+\frac{1}{2}}) \approx \frac{u^{n+1}-u^n}{t_{n+1}-t_n}\thinspace .
\label{decay:CNdiff}
\end{equation}
$$


<p>
Problem: \( u(t_{n+1/2}) \) is not defined, only \( u^n=u(t_n) \) and \( u^{n+1}=u(t_{n+1}) \)

<p>
Solution:

<p>
$$ u(t_{n+1/2}) \approx \frac{1}{2}(u^n + u^{n+1}) $$


<p>
<!-- !split -->

<h3>The Crank-Nicolson scheme; part 2  <a name="___sec33"></a></h3>

<p>
Result:

<p>
$$
\begin{equation}
\frac{u^{n+1}-u^n}{t_{n+1}-t_n} = -a\frac{1}{2} (u^n + u^{n+1})\thinspace .
\label{decay:CN1}
\end{equation}
$$


<p>
Solve wrt to \( u^{n+1} \):

<p>
$$
\begin{equation}
u^{n+1} = \frac{1-\frac{1}{2} a(t_{n+1}-t_n)}{1 + \frac{1}{2} a(t_{n+1}-t_n)}u^n\thinspace .
\label{decay:CN}
\end{equation}
$$

This is a Crank-Nicolson (CN) scheme or a midpoint or centered scheme.

<p>
<!-- !split -->

<h3>The unifying \( \theta \)-rule <a name="decay:schemes:theta"></a></h3>

<p>
The Forward Euler, Backward Euler, and Crank-Nicolson schemes can be
formulated as one scheme with a varying parameter \( \theta \):

<p>
$$
\begin{equation}
\frac{u^{n+1}-u^{n}}{t_{n+1}-t_n} = -a (\theta u^{n+1} + (1-\theta) u^{n})
\label{decay:th0}
\thinspace .
\end{equation}
$$


<p>

<ul>
 <p><li> \( \theta =0 \): Forward Euler</li>
 <p><li> \( \theta =1 \): Backward Euler</li>
 <p><li> \( \theta =1/2 \): Crank-Nicolson</li>
 <p><li> We may alternatively choose any \( \theta\in [0,1] \).</li>
</ul>

\( u^n \) is known, solve for \( u^{n+1} \):

<p>
$$
\begin{equation}
u^{n+1} = \frac{1 - (1-\theta) a(t_{n+1}-t_n)}{1 + \theta a(t_{n+1}-t_n)}\thinspace .
\label{decay:th}
\end{equation}
$$


<p>
<!-- !split -->

<h3>Constant time step  <a name="___sec35"></a></h3>

<p>
Very common assumption (not important, but exclusively used for
simplicity hereafter): constant time step \( t_{n+1}-t_n\equiv\Delta t \)

<p>
<div class="alert alert-block alert-summary alert-text-normal"><b>Summary of schemes for constant time step.</b>
$$
\begin{align}
u^{n+1} &= (1 - a\Delta t )u^n  \quad (\hbox{FE})
\label{decay:FE:u}\\ 
u^{n+1} &= \frac{1}{1+ a\Delta t} u^n  \quad (\hbox{BE})
\label{decay:BE:u}\\ 
u^{n+1} &= \frac{1-\frac{1}{2} a\Delta t}{1 + \frac{1}{2} a\Delta t} u^n \quad (\hbox{CN})
\label{decay:CN:u}\\ 
u^{n+1} &= \frac{1 - (1-\theta) a\Delta t}{1 + \theta a\Delta t}u^n \quad (\theta-\hbox{rule})
\label{decay:th:u}
\end{align}
$$
</div>
<p>
<!-- !split -->

<h3>Test the understanding!  <a name="___sec36"></a></h3>

<p>
Derive Forward Euler, Backward Euler, and Crank-Nicolson schemes for
Newton's law of cooling:

<p>
$$ T' = -k(T-T_s),\quad T(0)=T_0,\ t\in (0,t_{\mbox{end}}]\ts$$


<p>
Physical quantities:

<p>

<ul>
 <p><li> \( T(t) \): temperature of an object at time \( t \)</li>
 <p><li> \( k \): parameter expressing heat loss to the surroundings</li>
 <p><li> \( T_s \): temperature of the surroundings</li>
 <p><li> \( T_0 \): initial temperature</li>
</ul>

<!-- !split -->

<h3>Compact operator notation for finite differences <a name="decay:fd:op"></a></h3>

<p>

<ul>
 <p><li> Finite difference formulas can be tedious to write and read/understand</li>
 <p><li> Handy tool: finite difference operator notation</li>
 <p><li> Advantage: communicates the nature of the difference in a compact way</li>
</ul>

$$
\begin{equation}
[D_t^- u  = -au]^n \thinspace .
\end{equation}
$$


<p>
<!-- !split -->

<h3>Compact operator notation for difference operators  <a name="___sec38"></a></h3>

<p>
Forward difference:

<p>
$$
\begin{equation}
[D_t^+u]^n = \frac{u^{n+1} - u^{n}}{\Delta t}
\approx \frac{d}{dt} u(t_n) \label{fd:D:f}
\thinspace .
\end{equation}
$$

Centered difference:

<p>
$$
\begin{equation}
[D_tu]^n = \frac{u^{n+\frac{1}{2}} - u^{n-\frac{1}{2}}}{\Delta t}
\approx \frac{d}{dt} u(t_n), \label{fd:D:c}
\end{equation}
$$


<p>
Backward difference:
$$
\begin{equation}
[D_t^-u]^n = \frac{u^{n} - u^{n-1}}{\Delta t}
\approx \frac{d}{dt} u(t_n) \label{fd:D:b}
\end{equation}
$$


<p>
<!-- !split -->

<h3>The Backward Euler scheme with operator notation  <a name="___sec39"></a></h3>

<p>
$$
\begin{equation*}
[D_t^-u]^n = -au^n \thinspace .
\end{equation*}
$$


<p>
Common to put the whole equation inside square brackets:

<p>
$$
\begin{equation}
[D_t^- u  = -au]^n \thinspace .
\end{equation}
$$


<p>
<!-- !split -->

<h3>The Forward Euler scheme with operator notation  <a name="___sec40"></a></h3>

<p>
$$
\begin{equation}
[D_t^+ u  = -au]^n\ts
\end{equation}
$$


<p>
<!-- !split -->

<h3>The Crank-Nicolson scheme with operator notation  <a name="___sec41"></a></h3>

<p>
Introduce an averaging operator:

<p>
$$
\begin{equation}
[\overline{u}^{t}]^n = \frac{1}{2} (u^{n-\frac{1}{2}} + u^{n+\frac{1}{2}} )
\approx u(t_n) \label{fd:mean:a}
\end{equation}
$$


<p>
The Crank-Nicolson scheme can then be written as

<p>
$$
\begin{equation}
[D_t u = -a\overline{u}^t]^{n+\frac{1}{2}}\thinspace .
\label{fd:compact:ex:CN}
\end{equation}
$$


<p>
Test: use the definitions and write out the above formula to see that
it really is the Crank-Nicolson scheme!

<p>
<!-- !split -->

<h2>Implementation <a name="decay:impl1"></a></h2>

<p>
Model:
$$
u'(t) = -au(t),\quad t\in (0,T], \quad u(0)=I,
$$


<p>
Numerical method:

<p>
$$
u^{n+1} = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a\Delta t}u^n,
$$

for \( \theta\in [0,1] \). Note

<p>

<ul>
 <p><li> \( \theta=0 \) gives Forward Euler</li>
 <p><li> \( \theta=1 \) gives Backward Euler</li>
 <p><li> \( \theta=1/2 \) gives Crank-Nicolson</li>
</ul>

<!-- !split -->

<h3>Requirements of a program  <a name="___sec43"></a></h3>

<p>

<ul>
  <p><li> Compute the numerical solution \( u^n \), \( n=1,2,\ldots,N_t \)</li>
  <p><li> Display the numerical and exact solution \( \uex(t)=e^{-at} \)</li>
  <p><li> Bring evidence to a correct implementation (<em>verification</em>)</li>
  <p><li> Compare the numerical and the exact solution in a plot</li>
  <p><li> computes the error \( \uex (t_n) - u^n \)</li>
  <p><li> computes the convergence rate of the numerical scheme</li>
  <p><li> reads its input data from the command line</li>
</ul>

<!-- !split -->

<h3>Tools to learn  <a name="___sec44"></a></h3>

<p>

<ul>
  <p><li> Basic <a href="http://python.org">Python</a> programming</li>
  <p><li> Array computing with <a href="http://numpy.org/"><tt>numpy</tt></a></li>
  <p><li> Plotting with <a href="http://matplotlib.sourceforge.net/"><tt>matplotlib.pyplot</tt></a> and <a href="http://code.google.com/p/scitools/"><tt>scitools</tt></a></li>
  <p><li> File writing and reading</li>
  <p><li> Making command-line user interface via <code>argparse.ArgumentParser</code></li>
  <p><li> Making graphical user interfaces via <a href="https://github.com/hplgit/parampool">Parampool</a></li>
</ul>

<div class="alert alert-block alert-notice alert-text-normal"><b>Notice.</b>
All programs are in the directory
<a href="http://tinyurl.com/jvzzcfn/decay"><tt>src/decay</tt></a>.
</div>
<p>
<!-- !split -->

<h3>Why implement in Python?  <a name="___sec45"></a></h3>

<p>

<ul>
  <p><li> Python has a very clean, readable syntax (often known as
    "executable pseudo-code").</li>
  <p><li> Python code is very similar to MATLAB code (and MATLAB has a
    particularly widespread use for scientific computing).</li>
  <p><li> Python is a full-fledged, very powerful programming language.</li>
  <p><li> Python is similar to, but much simpler to work with and
    results in more reliable code than C++.</li>
</ul>

<!-- !split -->

<h3>Why implement in Python?  <a name="___sec46"></a></h3>

<p>

<ul>
  <p><li> Python has a rich set of modules for scientific computing, and its
    popularity in scientific computing is rapidly growing.</li>
  <p><li> Python was made for being combined with compiled languages
    (C, C++, Fortran) to reuse existing numerical software and to
    reach high computational performance of new implementations.</li>
  <p><li> Python has extensive support for administrative task
    needed when doing large-scale computational investigations.</li>
  <p><li> Python has extensive support for graphics (visualization,
    user interfaces, web applications).</li>
  <p><li> FEniCS, a very powerful tool for solving PDEs by
    the finite element method, is most human-efficient to operate
    from Python.</li>
</ul>

<!-- !split -->

<h3>Algorithm <a name="decay:py1"></a></h3>

<p>

<ul>
 <p><li> Store \( u^n \), \( n=0,1,\ldots,N_t \) in an array <code>u</code>.</li>
 <p><li> Algorithm:</li>

<ol>
  <p><li> initialize \( u^0 \)</li>
  <p><li> for \( t=t_n \), \( n=1,2,\ldots,N_t \): compute \( u_n \) using
     the \( \theta \)-rule formula</li>
</ol>

</ul>

<!-- !split -->

<h3>Translation to Python function  <a name="___sec48"></a></h3>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, a, T, dt, theta):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.&quot;&quot;&quot;</span>
    Nt <span style="color: #666666">=</span> <span style="color: #008000">int</span>(T<span style="color: #666666">/</span>dt)            <span style="color: #408080; font-style: italic"># no of time intervals</span>
    T <span style="color: #666666">=</span> Nt<span style="color: #666666">*</span>dt                 <span style="color: #408080; font-style: italic"># adjust T to fit time step dt</span>
    u <span style="color: #666666">=</span> zeros(Nt<span style="color: #666666">+1</span>)           <span style="color: #408080; font-style: italic"># array of u[n] values</span>
    t <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, Nt<span style="color: #666666">+1</span>)  <span style="color: #408080; font-style: italic"># time mesh</span>

    u[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> I                  <span style="color: #408080; font-style: italic"># assign initial condition</span>
    <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">0</span>, Nt):    <span style="color: #408080; font-style: italic"># n=0,1,...,Nt-1</span>
        u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)<span style="color: #666666">*</span>u[n]
    <span style="color: #008000; font-weight: bold">return</span> u, t
</pre></div>
<p>
Note about the <code>for</code> loop: <code>range(0, Nt, s)</code> generates all integers
from <code>0</code> to <code>Nt</code> in steps of <code>s</code> (default 1), <em>but not including</em> <code>Nt</code> (!).

<p>
Sample call:
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=1</span>, a<span style="color: #666666">=2</span>, T<span style="color: #666666">=8</span>, dt<span style="color: #666666">=0.8</span>, theta<span style="color: #666666">=1</span>)
</pre></div>
<p>
<!-- !split -->

<h3>Integer division  <a name="___sec49"></a></h3>

<p>
Python applies integer division: <code>1/2</code> is 0, while <code>1./2</code> or <code>1.0/2</code> or
<code>1/2.</code> or <code>1/2.0</code> or <code>1.0/2.0</code> all give 0.5.

<p>
A safer <code>solver</code> function (<code>dt = float(dt)</code> - guarantee float):

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, a, T, dt, theta):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.&quot;&quot;&quot;</span>
    dt <span style="color: #666666">=</span> <span style="color: #008000">float</span>(dt)            <span style="color: #408080; font-style: italic"># avoid integer division</span>
    Nt <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #008000">round</span>(T<span style="color: #666666">/</span>dt))     <span style="color: #408080; font-style: italic"># no of time intervals</span>
    T <span style="color: #666666">=</span> Nt<span style="color: #666666">*</span>dt                 <span style="color: #408080; font-style: italic"># adjust T to fit time step dt</span>
    u <span style="color: #666666">=</span> zeros(Nt<span style="color: #666666">+1</span>)           <span style="color: #408080; font-style: italic"># array of u[n] values</span>
    t <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, Nt<span style="color: #666666">+1</span>)  <span style="color: #408080; font-style: italic"># time mesh</span>

    u[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> I                  <span style="color: #408080; font-style: italic"># assign initial condition</span>
    <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">0</span>, Nt):    <span style="color: #408080; font-style: italic"># n=0,1,...,Nt-1</span>
        u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)<span style="color: #666666">*</span>u[n]
    <span style="color: #008000; font-weight: bold">return</span> u, t
</pre></div>
<p>
<!-- !split -->

<h3>Doc strings  <a name="___sec50"></a></h3>

<p>

<ul>
 <p><li> First string after the function heading</li>
 <p><li> Used for documenting the function</li>
 <p><li> Automatic documentation tools can make fancy manuals for you</li>
 <p><li> Can be used for automatic testing</li>
</ul>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, a, T, dt, theta):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Solve</span>

<span style="color: #BA2121; font-style: italic">        u&#39;(t) = -a*u(t),</span>

<span style="color: #BA2121; font-style: italic">    with initial condition u(0)=I, for t in the time interval</span>
<span style="color: #BA2121; font-style: italic">    (0,T]. The time interval is divided into time steps of</span>
<span style="color: #BA2121; font-style: italic">    length dt.</span>

<span style="color: #BA2121; font-style: italic">    theta=1 corresponds to the Backward Euler scheme, theta=0</span>
<span style="color: #BA2121; font-style: italic">    to the Forward Euler scheme, and theta=0.5 to the Crank-</span>
<span style="color: #BA2121; font-style: italic">    Nicolson method.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #666666">...</span>
</pre></div>
<p>
<!-- !split -->

<h3>Formatting of numbers  <a name="___sec51"></a></h3>

<p>
Can control formatting of reals and integers through the <em>printf</em> format:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;t=</span><span style="color: #BB6688; font-weight: bold">%6.3f</span><span style="color: #BA2121"> u=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> (t[i], u[i])
</pre></div>
<p>
Or the alternative <em>format string syntax</em>:
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;t={t:6.3f} u={u:g}&#39;</span><span style="color: #666666">.</span>format(t<span style="color: #666666">=</span>t[i], u<span style="color: #666666">=</span>u[i])
</pre></div>
<p>
<!-- !split -->

<h3>Running the program  <a name="___sec52"></a></h3>

<p>
How to run the program <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/decay_v1.py"><tt>decay_v1.py</tt></a>:

<p>

<!-- code=bash (from !bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python decay_v1.py
</pre></div>
<p>
Can also run it as "normal" Unix programs: <code>./decay_v1.py</code> if the
first line is

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #BA2121">`#!/usr/bin/env python`</span>
</pre></div>
<p>
Then
<p>

<!-- code=bash (from !bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; chmod a+rx decay_v1.py
Terminal&gt; ./decay_v1.py
</pre></div>
<p>
<!-- !split -->

<h2>Verifying the implementation <a name="decay:verification"></a></h2>

<p>

<ul>
 <p><li> Verification = bring evidence that the program works</li>
 <p><li> Find suitable test problems</li>
 <p><li> Make function for each test problem</li>
 <p><li> Later: put the verification tests in a professional testing framework</li>
</ul>

<!-- !split -->

<h3>Simplest method: run a few algorithmic steps by hand  <a name="___sec54"></a></h3>

<p>
Use a calculator (\( I=0.1 \), \( \theta=0.8 \), \( \Delta t =0.8 \)):

<p>
$$ A\equiv \frac{1 - (1-\theta) a\Delta t}{1 + \theta a \Delta t} = 0.298245614035$$


<p>
$$
\begin{align*}
u^1 &= AI=0.0298245614035,\\ 
u^2 &= Au^1= 0.00889504462912,\\ 
u^3 &=Au^2= 0.00265290804728
\end{align*}
$$


<p>
See the function <code>verify_three_steps</code> in <a href="http://tinyurl.com/jvzzcfn/decay/decay_verf1.py"><tt>decay_verf1.py</tt></a>.

<p>
<!-- !split -->

<h3>Comparison with an exact discrete solution  <a name="___sec55"></a></h3>

<p>
<div class="alert alert-block alert-notice alert-text-normal"><b>Best verification.</b>
Compare computed numerical solution
with a closed-form <em>exact discrete solution</em> (if possible).
</div>
<p>
Define
$$ A = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a \Delta t}\thinspace . $$

Repeated use of the \( \theta \)-rule:
$$
\begin{align*}
u^0 &= I,\\ 
u^1 &= Au^0 = AI,\\ 
u^n &= A^nu^{n-1} = A^nI \thinspace .
\end{align*}
$$


<p>
<!-- !split -->

<h3>Making a test based on an exact discrete solution  <a name="___sec56"></a></h3>

<p>
The exact discrete solution as
$$
\begin{equation}
u^n = IA^n
\label{decay:un:exact}
\thinspace .
\end{equation}
$$


<p>
<div class="alert alert-block alert-question alert-text-normal"><b>Question.</b>
Understand what \( n \) in \( u^n \) and in \( A^n \) means!
</div>
<p>
Test if

<p>
$$ \max_n |u^n - \uex(t_n)| < \epsilon\sim 10^{-15}$$


<p>
Implementation in <a href="http://tinyurl.com/jvzzcfn/decay/decay_verf2.py"><tt>decay_verf2.py</tt></a>.

<p>
<!-- !split -->

<h3>Test the understanding!  <a name="___sec57"></a></h3>

<p>
Make a program for solving
Newton's law of cooling

<p>
$$ T' = -k(T-T_s),\quad T(0)=T_0,\ t\in (0,t_{\mbox{end}}]\ts$$

with the Forward Euler, Backward Euler, and Crank-Nicolson schemes
(or a \( \theta \) scheme). Verify the implementation.

<p>
<!-- !split -->

<h3>Computing the numerical error as a mesh function <a name="decay:computing:error"></a></h3>

<p>
Task: compute the numerical error \( e^n = \uex(t_n) - u^n \)

<p>
Exact solution: \( \uex(t)=Ie^{-at} \), implemented as

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(t, I, a):
    <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>
<p>
Compute \( e^n \) by

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">u, t <span style="color: #666666">=</span> solver(I, a, T, dt, theta)  <span style="color: #408080; font-style: italic"># Numerical solution</span>
u_e <span style="color: #666666">=</span> exact_solution(t, I, a)
e <span style="color: #666666">=</span> u_e <span style="color: #666666">-</span> u
</pre></div>
<p>
<div class="alert alert-block alert-notice alert-text-normal"><b>Array arithmetics - we compute on entire arrays!</b>

<p>

<ul>
 <p><li> <code>exact_solution(t, I, a)</code> works with <code>t</code> as array</li>
 <p><li> Must have <code>exp</code> from <code>numpy</code> (not <code>math</code>)</li>
 <p><li> <code>e = u_e - u</code>: array subtraction</li>
 <p><li> Array arithmetics gives shorter and much faster code</li>
</ul>
</div>
<p>
<!-- !split -->

<h3>Computing the norm of the error <a name="decay:computing:error:norm"></a></h3>

<p>

<ul>
 <p><li> \( e^n \) is a mesh function</li>
 <p><li> Usually we want one number for the error</li>
 <p><li> Use a norm of \( e^n \)</li>
</ul>

Norms of a function \( f(t) \):

<p>
$$
\begin{align}
||f||_{L^2} &= \left( \int_0^T f(t)^2 dt\right)^{1/2}
\label{decay:norms:L2}\\ 
||f||_{L^1} &= \int_0^T |f(t)| dt
\label{decay:norms:L1}\\ 
||f||_{L^\infty} &= \max_{t\in [0,T]}|f(t)|
\label{decay:norms:Linf}
\end{align}
$$


<p>
<!-- !split -->

<h3>Norms of mesh functions  <a name="___sec60"></a></h3>

<p>

<ul>
 <p><li> Problem: \( f^n =f(t_n) \) is a mesh function and hence not defined for all \( t \).
   How to integrate \( f^n \)?</li>
 <p><li> Idea: Apply a numerical integration rule, using only
   the mesh points of the mesh function.</li>
</ul>

The Trapezoidal rule:

<p>
$$ ||f^n|| = \left(\Delta t\left(\frac{1}{2}(f^0)^2 + \frac{1}{2}(f^{N_t})^2
+ \sum_{n=1}^{N_t-1} (f^n)^2\right)\right)^{1/2} $$


<p>
Common simplification yields the \( L^2 \) norm of a mesh function:

<p>
$$ ||f^n||_{\ell^2} = \left(\Delta t\sum_{n=0}^{N_t} (f^n)^2\right)^{1/2} \ts$$


<p>
<!-- !split -->

<h3>Implementation of the norm of the error  <a name="___sec61"></a></h3>

<p>
$$ E = ||e^n||_{\ell^2}  = \sqrt{\Delta t\sum_{n=0}^{N_t} (e^n)^2}$$


<p>
Python w/array arithmetics:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">e <span style="color: #666666">=</span> u_exact(t) <span style="color: #666666">-</span> u
E <span style="color: #666666">=</span> sqrt(dt<span style="color: #666666">*</span><span style="color: #008000">sum</span>(e<span style="color: #666666">**2</span>))
</pre></div>
<p>
<!-- !split -->

<h3>Comment on array vs scalar computation  <a name="___sec62"></a></h3>

<p>
Scalar computing of <code>E = sqrt(dt*sum(e**2))</code>:
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">m <span style="color: #666666">=</span> <span style="color: #008000">len</span>(u)     <span style="color: #408080; font-style: italic"># length of u array (alt: u.size)</span>
u_e <span style="color: #666666">=</span> zeros(m)
t <span style="color: #666666">=</span> <span style="color: #666666">0</span>
<span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(m):
    u_e[i] <span style="color: #666666">=</span> exact_solution(t, a, I)
    t <span style="color: #666666">=</span> t <span style="color: #666666">+</span> dt
e <span style="color: #666666">=</span> zeros(m)
<span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(m):
    e[i] <span style="color: #666666">=</span> u_e[i] <span style="color: #666666">-</span> u[i]
s <span style="color: #666666">=</span> <span style="color: #666666">0</span>  <span style="color: #408080; font-style: italic"># summation variable</span>
<span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(m):
    s <span style="color: #666666">=</span> s <span style="color: #666666">+</span> e[i]<span style="color: #666666">**2</span>
error <span style="color: #666666">=</span> sqrt(dt<span style="color: #666666">*</span>s)
</pre></div>
<p>
Obviously, scalar computing

<p>

<ul>
 <p><li> takes more code</li>
 <p><li> is less readable</li>
 <p><li> runs much slower</li>
</ul>

<div class="alert alert-block alert-notice alert-text-normal"><b>Rule.</b>
Compute on entire arrays (when possible)!
</div>
<p>
<!-- !split -->

<h2>Plotting solutions <a name="decay:plotting"></a></h2>

<p>
Basic plotting with Matplotlib is much like MATLAB plotting

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
plot(t, u)
show()
</pre></div>
<p>
Compare <code>u</code> curve with \( \uex(t) \):

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">t_e <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, <span style="color: #666666">1001</span>)      <span style="color: #408080; font-style: italic"># fine mesh</span>
u_e <span style="color: #666666">=</span> exact_solution(t_e, I, a)
plot(t_e, u_e, <span style="color: #BA2121">&#39;b-&#39;</span>)            <span style="color: #408080; font-style: italic"># blue line for u_e</span>
plot(t,   u,   <span style="color: #BA2121">&#39;r--o&#39;</span>)          <span style="color: #408080; font-style: italic"># red dashes w/circles</span>
</pre></div>
<p>
<center><p><img src="fig-decay/FE1.png" align="bottom" width=800,></p></center>

<p>
<!-- !split -->

<h3>Decorating a plot  <a name="___sec64"></a></h3>

<p>

<ul>
 <p><li> Use different line types</li>
 <p><li> Add axis labels</li>
 <p><li> Add curve legends</li>
 <p><li> Add plot title</li>
 <p><li> Save plot to file</li>
</ul>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>

figure()                          <span style="color: #408080; font-style: italic"># create new plot</span>
t_e <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, <span style="color: #666666">1001</span>)        <span style="color: #408080; font-style: italic"># fine mesh for u_e</span>
u_e <span style="color: #666666">=</span> exact_solution(t_e, I, a)
plot(t,   u,   <span style="color: #BA2121">&#39;r--o&#39;</span>)            <span style="color: #408080; font-style: italic"># red dashes w/circles</span>
plot(t_e, u_e, <span style="color: #BA2121">&#39;b-&#39;</span>)              <span style="color: #408080; font-style: italic"># blue line for exact sol.</span>
legend([<span style="color: #BA2121">&#39;numerical&#39;</span>, <span style="color: #BA2121">&#39;exact&#39;</span>])
xlabel(<span style="color: #BA2121">&#39;t&#39;</span>)
ylabel(<span style="color: #BA2121">&#39;u&#39;</span>)
title(<span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, dt=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> (theta, dt))
savefig(<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (theta, dt))
show()
</pre></div>
<p>
See complete code in <a href="http://tinyurl.com/jvzzcfn/decay/decay_plot_mpl.py"><tt>decay_plot_mpl.py</tt></a>.

<p>
<!-- !split -->

<h3>How the plots look like  <a name="___sec65"></a></h3>

<p>
<center><p><img src="fig-decay/BE1.png" align="bottom" width=800></p></center>

<p>
<!-- !split -->

<h3>Plotting with SciTools  <a name="___sec66"></a></h3>

<p>
<a href="http://code.google.com/p/scitools">SciTools</a> provides a
unified plotting interface (Easyviz) to many different plotting
packages: Matplotlib, Gnuplot, Grace, VTK, OpenDX, ...

<p>
Can use Matplotlib (MATLAB-like) syntax,
or a more compact <code>plot</code> function syntax:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">scitools.std</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>

plot(t,   u,   <span style="color: #BA2121">&#39;r--o&#39;</span>,           <span style="color: #408080; font-style: italic"># red dashes w/circles</span>
     t_e, u_e, <span style="color: #BA2121">&#39;b-&#39;</span>,             <span style="color: #408080; font-style: italic"># blue line for exact sol.</span>
     legend<span style="color: #666666">=</span>[<span style="color: #BA2121">&#39;numerical&#39;</span>, <span style="color: #BA2121">&#39;exact&#39;</span>],
     xlabel<span style="color: #666666">=</span><span style="color: #BA2121">&#39;t&#39;</span>,
     ylabel<span style="color: #666666">=</span><span style="color: #BA2121">&#39;u&#39;</span>,
     title<span style="color: #666666">=</span><span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, dt=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> (theta, dt),
     savefig<span style="color: #666666">=</span><span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (theta2name[theta], dt),
     show<span style="color: #666666">=</span><span style="color: #008000">True</span>)
</pre></div>
<p>
Complete code in <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/decay_plot_st.py"><tt>decay_plot_st.py</tt></a>.

<p>
Change backend (plotting engine, Matplotlib by default):

<p>

<!-- code=bash (from !bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python decay_plot_st.py --SCITOOLS_easyviz_backend gnuplot
Terminal&gt; python decay_plot_st.py --SCITOOLS_easyviz_backend grace
</pre></div>
<p>
<!-- !split -->

<h2>Creating user interfaces <a name="decay:GUI"></a></h2>

<p>

<ul>
 <p><li> Never edit the program to change input!</li>
 <p><li> Set input data on the command line or in a graphical user interface</li>
 <p><li> How is explained next</li>
</ul>

<!-- !split -->

<h3>Accessing command-line arguments  <a name="___sec68"></a></h3>

<p>

<ul>
 <p><li> All command-line arguments are available in <code>sys.argv</code></li>
 <p><li> <code>sys.argv[0]</code> is the program</li>
 <p><li> <code>sys.argv[1:]</code> holds the command-line arguments</li>
 <p><li> Method 1: fixed sequence of parameters on the command line</li>
 <p><li> Method 2: <code>--option value</code> pairs on the command line (with default values)</li>
</ul>

<p>

<!-- code=bash (from !bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python myprog.py 1.5 2 0.5 0.8 0.4
Terminal&gt; python myprog.py --I 1.5 --a 2 --dt 0.8 0.4
</pre></div>
<p>
<!-- !split -->

<h3>Reading a sequence of command-line arguments  <a name="___sec69"></a></h3>

<p>
The program <a href="http://tinyurl.com/jvzzcfn/decay/decay_plot_mpl.py"><tt>decay_plot_mpl.py</tt></a>
needs this input:

<p>

<ul>
 <p><li> \( I \)</li>
 <p><li> \( a \)</li>
 <p><li> \( T \)</li>
 <p><li> an option to turn the plot on or off (<code>makeplot</code>)</li>
 <p><li> a list of \( \Delta t \) values</li>
</ul>

Give these on the command line in correct sequence

<p>

<!-- code=bash (from !bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python decay_cml.py 1.5 2 0.5 0.8 0.4
</pre></div>
<p>
<!-- !split -->

<h3>Implementation  <a name="___sec70"></a></h3>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">read_command_line</span>():
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(sys<span style="color: #666666">.</span>argv) <span style="color: #666666">&lt;</span> <span style="color: #666666">6</span>:
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Usage: </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> I a T on/off dt1 dt2 dt3 ...&#39;</span> <span style="color: #666666">%</span> \ 
              sys<span style="color: #666666">.</span>argv[<span style="color: #666666">0</span>]; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)  <span style="color: #408080; font-style: italic"># abort</span>

    I <span style="color: #666666">=</span> <span style="color: #008000">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>])
    a <span style="color: #666666">=</span> <span style="color: #008000">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">2</span>])
    T <span style="color: #666666">=</span> <span style="color: #008000">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">3</span>])
    makeplot <span style="color: #666666">=</span> sys<span style="color: #666666">.</span>argv[<span style="color: #666666">4</span>] <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #BA2121">&#39;on&#39;</span>, <span style="color: #BA2121">&#39;True&#39;</span>)
    dt_values <span style="color: #666666">=</span> [<span style="color: #008000">float</span>(arg) <span style="color: #008000; font-weight: bold">for</span> arg <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv[<span style="color: #666666">5</span>:]]

    <span style="color: #008000; font-weight: bold">return</span> I, a, T, makeplot, dt_values
</pre></div>
<p>
Note:

<p>

<ul>
  <p><li> <code>sys.argv[i]</code> is <em>always a string</em></li>
  <p><li> Must explicitly convert to (e.g.) <code>float</code> for computations</li>
  <p><li> List comprehensions make lists: <code>[expression for e in somelist]</code></li>
</ul>

Complete program: <a href="http://tinyurl.com/jvzzcfn/decay/decay_cml.py"><tt>decay_cml.py</tt></a>.

<p>
<!-- !split -->

<h3>Working with an argument parser  <a name="___sec71"></a></h3>

<p>
Set option-value pairs on the command line if the default value is not
suitable:
<p>

<!-- code=bash (from !bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python decay_argparse.py --I 1.5 --a 2 --dt 0.8 0.4
</pre></div>
<p>
Code:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>():
    <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">argparse</span>
    parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser()
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--I&#39;</span>, <span style="color: #BA2121">&#39;--initial_condition&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
                        default<span style="color: #666666">=1.0</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;initial condition, u(0)&#39;</span>,
                        metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;I&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--a&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
                        default<span style="color: #666666">=1.0</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;coefficient in ODE&#39;</span>,
                        metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;a&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--T&#39;</span>, <span style="color: #BA2121">&#39;--stop_time&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
                        default<span style="color: #666666">=1.0</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;end time of simulation&#39;</span>,
                        metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;T&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--makeplot&#39;</span>, action<span style="color: #666666">=</span><span style="color: #BA2121">&#39;store_true&#39;</span>,
                        help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;display plot or not&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--dt&#39;</span>, <span style="color: #BA2121">&#39;--time_step_values&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
                        default<span style="color: #666666">=</span>[<span style="color: #666666">1.0</span>], help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time step values&#39;</span>,
                        metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;dt&#39;</span>, nargs<span style="color: #666666">=</span><span style="color: #BA2121">&#39;+&#39;</span>, dest<span style="color: #666666">=</span><span style="color: #BA2121">&#39;dt_values&#39;</span>)
    <span style="color: #008000; font-weight: bold">return</span> parser
</pre></div>
<p>
(<code>metavar</code> is the symbol used in help output)

<p>
<!-- !split -->

<h3>Reading option-values pairs  <a name="___sec72"></a></h3>

<p>
<code>argparse.ArgumentParser</code> parses the command-line arguments:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">read_command_line</span>():
    parser <span style="color: #666666">=</span> define_command_line_options()
    args <span style="color: #666666">=</span> parser<span style="color: #666666">.</span>parse_args()
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;I={}, a={}, T={}, makeplot={}, dt_values={}&#39;</span><span style="color: #666666">.</span>format(
        args<span style="color: #666666">.</span>I, args<span style="color: #666666">.</span>a, args<span style="color: #666666">.</span>T, args<span style="color: #666666">.</span>makeplot, args<span style="color: #666666">.</span>dt_values)
    <span style="color: #008000; font-weight: bold">return</span> args<span style="color: #666666">.</span>I, args<span style="color: #666666">.</span>a, args<span style="color: #666666">.</span>T, args<span style="color: #666666">.</span>makeplot, args<span style="color: #666666">.</span>dt_values
</pre></div>
<p>
Complete program: <a href="http://tinyurl.com/jvzzcfn/decay/decay_argparse.py"><tt>decay_argparse.py</tt></a>.

<p>
<!-- !split -->

<h3>A graphical user interface  <a name="___sec73"></a></h3>

<p>
<center><p><img src="fig-decay/decay_GUI.png" align="bottom" width=800></p></center>

<p>
Normally very much programming required - and much competence on
graphical user interfaces.

<p>
Here: use a tool to automatically create it in a few minutes (!)

<p>
<!-- !split -->

<h3>The Parampool package  <a name="___sec74"></a></h3>

<p>

<ul>
 <p><li> <a href="https://github.com/hplgit/parampool">Parampool</a> is a package
   for handling a large pool of input parameters in simulation programs</li>
 <p><li> Parampool can automatically create a sophisticated web-based
   graphical user interface (GUI) to set parameters and view solutions</li>
</ul>

<div class="alert alert-block alert-warning alert-text-normal"><b>Remark.</b>
The forthcoming material aims at those with particular interest in
equipping their programs with a GUI - others can safely skip it.
</div>
<p>
<!-- !split -->

<h3>Making a compute function  <a name="___sec75"></a></h3>

<p>

<ul>
 <p><li> Key concept: a <em>compute function</em> that takes all input data as arguments
   and returning HTML code for viewing the results (e.g., plots and numbers)</li>
 <p><li> What we have: <a href="http://tinyurl.com/jvzzcfn/decay/decay_plot_mpl.py"><tt>decay_plot_mpl.py</tt></a></li>
 <p><li> <code>main</code> function carries out simulations and plotting for a
   series of \( \Delta t \) values</li>
 <p><li> Goal: steer and view these experiments from a web GUI</li>
 <p><li> What to do:</li>

<ul>
   <p><li> create a compute function</li>
   <p><li> call <code>parampool</code> functionality</li>
</ul>

</ul>

The compute function <code>main_GUI</code>:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main_GUI</span>(I<span style="color: #666666">=1.0</span>, a<span style="color: #666666">=.2</span>, T<span style="color: #666666">=4.0</span>,
         dt_values<span style="color: #666666">=</span>[<span style="color: #666666">1.25</span>, <span style="color: #666666">0.75</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">0.1</span>],
         theta_values<span style="color: #666666">=</span>[<span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>]):
</pre></div>
<p>
<!-- !split -->

<h3>The hard part of the compute function: the HTML code  <a name="___sec76"></a></h3>

<p>

<ul>
 <p><li> The results are to be displayed in a web page</li>
 <p><li> Only you know what to display in your problem</li>
 <p><li> Therefore, you need to specify the HTML code</li>
</ul>

Suppose <code>explore</code> solves the problem, makes a plot, computes the
error <em>and</em> returns appropriate HTML code with the plot. Embed
error and plots in a table:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main_GUI</span>(I<span style="color: #666666">=1.0</span>, a<span style="color: #666666">=.2</span>, T<span style="color: #666666">=4.0</span>,
         dt_values<span style="color: #666666">=</span>[<span style="color: #666666">1.25</span>, <span style="color: #666666">0.75</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">0.1</span>],
         theta_values<span style="color: #666666">=</span>[<span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>]):
    <span style="color: #408080; font-style: italic"># Build HTML code for web page. Arrange plots in columns</span>
    <span style="color: #408080; font-style: italic"># corresponding to the theta values, with dt down the rows</span>
    theta2name <span style="color: #666666">=</span> {<span style="color: #666666">0</span>: <span style="color: #BA2121">&#39;FE&#39;</span>, <span style="color: #666666">1</span>: <span style="color: #BA2121">&#39;BE&#39;</span>, <span style="color: #666666">0.5</span>: <span style="color: #BA2121">&#39;CN&#39;</span>}
    html_text <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;&lt;table&gt;</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span>
    <span style="color: #008000; font-weight: bold">for</span> dt <span style="color: #AA22FF; font-weight: bold">in</span> dt_values:
        html_text <span style="color: #666666">+=</span> <span style="color: #BA2121">&#39;&lt;tr&gt;</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span>
        <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> theta_values:
            E, html <span style="color: #666666">=</span> explore(I, a, T, dt, theta, makeplot<span style="color: #666666">=</span><span style="color: #008000">True</span>)
            html_text <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;&quot;&quot;</span>
<span style="color: #BA2121">&lt;td&gt;</span>
<span style="color: #BA2121">&lt;center&gt;&lt;b&gt;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">, dt=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, error: </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&lt;/b&gt;&lt;/center&gt;&lt;br&gt;</span>
<span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"></span>
<span style="color: #BA2121">&lt;/td&gt;</span>
<span style="color: #BA2121">&quot;&quot;&quot;</span> <span style="color: #666666">%</span> (theta2name[theta], dt, E, html)
        html_text <span style="color: #666666">+=</span> <span style="color: #BA2121">&#39;&lt;/tr&gt;</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span>
    html_text <span style="color: #666666">+=</span> <span style="color: #BA2121">&#39;&lt;/table&gt;</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span>
    <span style="color: #008000; font-weight: bold">return</span> html_text
</pre></div>
<p>
<!-- !split -->

<h3>How to embed a PNG plot in HTML code  <a name="___sec77"></a></h3>

<p>
In <code>explore</code>:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>
<span style="color: #666666">...</span>
<span style="color: #408080; font-style: italic"># plot</span>
plt<span style="color: #666666">.</span>plot(t, u, r<span style="color: #666666">-</span><span style="color: #BA2121">&#39;)</span>
plt<span style="color: #666666">.</span>xlabel(<span style="color: #BA2121">&#39;t&#39;</span>)
plt<span style="color: #666666">.</span>ylabel(<span style="color: #BA2121">&#39;u&#39;</span>)
<span style="color: #666666">...</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">parampool.utils</span> <span style="color: #008000; font-weight: bold">import</span> save_png_to_str
html_text <span style="color: #666666">=</span> save_png_to_str(plt, plotwidth<span style="color: #666666">=400</span>)
</pre></div>
<p>
If you know HTML, you can return more sophisticated layout etc.

<p>
<!-- !split -->

<h3>Generating the user interface  <a name="___sec78"></a></h3>

<p>
Make a file <code>decay_GUI_generate.py</code>:

<p>

<!-- code=python (from !bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">parampool.generator.flask</span> <span style="color: #008000; font-weight: bold">import</span> generate
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">decay_GUI</span> <span style="color: #008000; font-weight: bold">import</span> main
generate(main,
         output_controller<span style="color: #666666">=</span><span style="color: #BA2121">&#39;decay_GUI_controller.py&#39;</span>,
         output_template<span style="color: #666666">=</span><span style="color: #BA2121">&#39;decay_GUI_view.py&#39;</span>,
         output_model<span style="color: #666666">=</span><span style="color: #BA2121">&#39;decay_GUI_model.py&#39;</span>)
</pre></div>
<p>
Running <code>decay_GUI_generate.py</code> results in

<p>

<ol>
 <p><li> <code>decay_GUI_model.py</code> defines HTML widgets to be used to set
    input data in the web interface,</li>
 <p><li> <code>templates/decay_GUI_views.py</code> defines the layout of the web page,</li>
 <p><li> <code>decay_GUI_controller.py</code> runs the web application.</li>
</ol>

Good news: we only need to run <code>decay_GUI_controller.py</code>
and there is no need to look into any of these files!

<p>
<!-- !split -->

<h3>Running the web application  <a name="___sec79"></a></h3>

<p>
Start the GUI

<p>

<!-- code=bash (from !bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python decay_GUI_controller.py
</pre></div>
<p>
Open a web browser at <code>127.0.0.1:5000</code>

<p>
<center><p><img src="fig-decay/decay_GUI.png" align="bottom" width=800></p></center>

<p>
<!-- !split -->

<h3>More advanced use  <a name="___sec80"></a></h3>

<p>

<ul>
 <p><li> The compute function can have arguments of type float, int, string,
   list, dict, numpy array, filename (file upload)</li>
 <p><li> Alternative: specify a hierarchy of input parameters with name,
   default value, data type, widget type, unit (m, kg, s), validity check</li>
 <p><li> The generated web GUI can have user accounts with login and storage
   of results in a database</li>
</ul>

<!-- !split -->

<h2>Computing convergence rates <a name="decay:convrates"></a></h2>

<p>
Frequent assumption on the relation between the numerical error \( E \) and
some discretization parameter \( \Delta t \):

<p>
$$
\begin{equation}
E = C\Delta t^r,
\label{decay:E:dt}
\end{equation}
$$


<p>

<ul>
 <p><li> Unknown: \( C \) and \( r \).</li>
 <p><li> Goal: estimate \( r \) (and \( C \)) from numerical experiments</li>
</ul>

<!-- !split -->

<h3>Estimating the convergence rate \( r \)  <a name="___sec82"></a></h3>

<p>
Perform numerical experiments: \( (\Delta t_i, E_i) \), \( i=0,\ldots,m-1 \).
Two methods for finding \( r \) (and \( C \)):

<p>

<ol>
 <p><li> Take the logarithm of \eqref{decay:E:dt}, \( \ln E = r\ln \Delta t + \ln C \),
    and fit a straight line to the data points \( (\Delta t_i, E_i) \),
    \( i=0,\ldots,m-1 \).</li>
 <p><li> Consider two consecutive experiments, \( (\Delta t_i, E_i) \) and
    \( (\Delta t_{i-1}, E_{i-1}) \). Dividing the equation
    \( E_{i-1}=C\Delta t_{i-1}^r \) by \( E_{i}=C\Delta t_{i}^r \) and solving
    for \( r \) yields</li>
</ol>

$$
\begin{equation}
r_{i-1} = \frac{\ln (E_{i-1}/E_i)}{\ln (\Delta t_{i-1}/\Delta t_i)}
\label{decay:conv:rate}
\end{equation}
$$

for \( i=1,=\ldots,m-1 \).

<p>
Method 2 is best.

<p>
<!-- !split -->

<h3>Implementation  <a name="___sec83"></a></h3>

<p>
Compute \( r_0, r_1, \ldots, r_{m-2} \):

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">math</span> <span style="color: #008000; font-weight: bold">import</span> log

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>():
    I, a, T, makeplot, dt_values <span style="color: #666666">=</span> read_command_line()
    r <span style="color: #666666">=</span> {}  <span style="color: #408080; font-style: italic"># estimated convergence rates</span>
    <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>:
        E_values <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> dt <span style="color: #AA22FF; font-weight: bold">in</span> dt_values:
            E <span style="color: #666666">=</span> explore(I, a, T, dt, theta, makeplot<span style="color: #666666">=</span><span style="color: #008000">False</span>)
            E_values<span style="color: #666666">.</span>append(E)

        <span style="color: #408080; font-style: italic"># Compute convergence rates</span>
        m <span style="color: #666666">=</span> <span style="color: #008000">len</span>(dt_values)
        r[theta] <span style="color: #666666">=</span> [log(E_values[i<span style="color: #666666">-1</span>]<span style="color: #666666">/</span>E_values[i])<span style="color: #666666">/</span>
                    log(dt_values[i<span style="color: #666666">-1</span>]<span style="color: #666666">/</span>dt_values[i])
                    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">1</span>, m, <span style="color: #666666">1</span>)]

    <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> r:
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">Pairwise convergence rates for theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">:&#39;</span> <span style="color: #666666">%</span> theta
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39; &#39;</span><span style="color: #666666">.</span>join([<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%.2f</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> r_ <span style="color: #008000; font-weight: bold">for</span> r_ <span style="color: #AA22FF; font-weight: bold">in</span> r[theta]])
    <span style="color: #008000; font-weight: bold">return</span> r
</pre></div>
<p>
Complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/decay_convrate.py"><tt>decay_convrate.py</tt></a>.

<p>
<!-- !split -->

<h3>Execution  <a name="___sec84"></a></h3>

<p>

<!-- code=bash (from !bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python decay_convrate.py --dt 0.5 0.25 0.1 0.05 0.025 0.01
...
Pairwise convergence rates <span style="color: #008000; font-weight: bold">for </span><span style="color: #19177C">theta</span><span style="color: #666666">=</span>0:
1.33 1.15 1.07 1.03 1.02

Pairwise convergence rates <span style="color: #008000; font-weight: bold">for </span><span style="color: #19177C">theta</span><span style="color: #666666">=</span>0.5:
2.14 2.07 2.03 2.01 2.01

Pairwise convergence rates <span style="color: #008000; font-weight: bold">for </span><span style="color: #19177C">theta</span><span style="color: #666666">=</span>1:
0.98 0.99 0.99 1.00 1.00
</pre></div>
<p>
<div class="alert alert-block alert-notice alert-text-normal"><b>Strong verification method.</b>
Verify that \( r \) has the expected value!
</div>
<p>
<!-- !split -->

<h3>Debugging via convergence rates  <a name="___sec85"></a></h3>

<p>
Potential bug: missing <code>a</code> in the denominator,

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt)<span style="color: #666666">*</span>u[n]
</pre></div>
<p>
Running <code>decay_convrate.py</code> gives same rates.

<p>
Why? The value of \( a \)... (\( a=1 \))

<p>
0 and 1 are <em>bad values</em> in tests!

<p>
Better:
<p>

<!-- code=bash (from !bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python decay_convrate.py --a 2.1 --I 0.1  <span style="color: #BB6622; font-weight: bold">\ </span>
          --dt 0.5 0.25 0.1 0.05 0.025 0.01
...
Pairwise convergence rates <span style="color: #008000; font-weight: bold">for </span><span style="color: #19177C">theta</span><span style="color: #666666">=</span>0:
1.49 1.18 1.07 1.04 1.02

Pairwise convergence rates <span style="color: #008000; font-weight: bold">for </span><span style="color: #19177C">theta</span><span style="color: #666666">=</span>0.5:
-1.42 -0.22 -0.07 -0.03 -0.01

Pairwise convergence rates <span style="color: #008000; font-weight: bold">for </span><span style="color: #19177C">theta</span><span style="color: #666666">=</span>1:
0.21 0.12 0.06 0.03 0.01
</pre></div>
<p>
Forward Euler works...because \( \theta=0 \) hides the bug.

<p>
This bug gives \( r\approx 0 \):

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> ((<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)<span style="color: #666666">*</span>u[n]
</pre></div>
<p>
<!-- !split -->

<h3>Memory-saving implementation  <a name="___sec86"></a></h3>

<p>

<ul>
 <p><li> Note 1: we store the entire array <code>u</code>, i.e., \( u^n \) for \( n=0,1,\ldots,N_t \)</li>
 <p><li> Note 2: the formula for \( u^{n+1} \) needs \( u^n \) only, not \( u^{n-1} \), \( u^{n-2} \), ...</li>
 <p><li> No need to store more than \( u^{n+1} \) and \( u^{n} \)</li>
 <p><li> Extremely important when solving PDEs</li>
 <p><li> No practical importance here (much memory available)</li>
 <p><li> But let's illustrate how to do save memory!</li>
 <p><li> Idea 1: store \( u^{n+1} \) in <code>u</code>, \( u^n \) in <code>u_1</code> (<code>float</code>)</li>
 <p><li> Idea 2: store <code>u</code> in a file, read file later for plotting</li>
</ul>

<!-- !split -->

<h3>Memory-saving solver function  <a name="___sec87"></a></h3>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver_memsave</span>(I, a, T, dt, theta, filename<span style="color: #666666">=</span><span style="color: #BA2121">&#39;sol.dat&#39;</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.</span>
<span style="color: #BA2121; font-style: italic">    Minimum use of memory. The solution is stored in a file</span>
<span style="color: #BA2121; font-style: italic">    (with name filename) for later plotting.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    dt <span style="color: #666666">=</span> <span style="color: #008000">float</span>(dt)         <span style="color: #408080; font-style: italic"># avoid integer division</span>
    Nt <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #008000">round</span>(T<span style="color: #666666">/</span>dt))  <span style="color: #408080; font-style: italic"># no of intervals</span>

    outfile <span style="color: #666666">=</span> <span style="color: #008000">open</span>(filename, <span style="color: #BA2121">&#39;w&#39;</span>)
    <span style="color: #408080; font-style: italic"># u: time level n+1, u_1: time level n</span>
    t <span style="color: #666666">=</span> <span style="color: #666666">0</span>
    u_1 <span style="color: #666666">=</span> I
    outfile<span style="color: #666666">.</span>write(<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%.16E</span><span style="color: #BA2121">  </span><span style="color: #BB6688; font-weight: bold">%.16E</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> (t, u_1))
    <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">1</span>, Nt<span style="color: #666666">+1</span>):
        u <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)<span style="color: #666666">*</span>u_1
        u_1 <span style="color: #666666">=</span> u
        t <span style="color: #666666">+=</span> dt
        outfile<span style="color: #666666">.</span>write(<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%.16E</span><span style="color: #BA2121">  </span><span style="color: #BB6688; font-weight: bold">%.16E</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> (t, u))
    outfile<span style="color: #666666">.</span>close()
    <span style="color: #008000; font-weight: bold">return</span> u, t
</pre></div>
<p>
<!-- !split -->

<h3>Reading computed data from file  <a name="___sec88"></a></h3>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">read_file</span>(filename<span style="color: #666666">=</span><span style="color: #BA2121">&#39;sol.dat&#39;</span>):
    infile <span style="color: #666666">=</span> <span style="color: #008000">open</span>(filename, <span style="color: #BA2121">&#39;r&#39;</span>)
    u <span style="color: #666666">=</span> [];  t <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> line <span style="color: #AA22FF; font-weight: bold">in</span> infile:
        words <span style="color: #666666">=</span> line<span style="color: #666666">.</span>split()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(words) <span style="color: #666666">!=</span> <span style="color: #666666">2</span>:
            <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Found more than two numbers on a line!&#39;</span>, words
            sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)  <span style="color: #408080; font-style: italic"># abort</span>
        t<span style="color: #666666">.</span>append(<span style="color: #008000">float</span>(words[<span style="color: #666666">0</span>]))
        u<span style="color: #666666">.</span>append(<span style="color: #008000">float</span>(words[<span style="color: #666666">1</span>]))
    <span style="color: #008000; font-weight: bold">return</span> np<span style="color: #666666">.</span>array(t), np<span style="color: #666666">.</span>array(u)
</pre></div>
<p>
Simpler code with <code>numpy</code> functionality for reading/writing tabular data:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">read_file_numpy</span>(filename<span style="color: #666666">=</span><span style="color: #BA2121">&#39;sol.dat&#39;</span>):
    data <span style="color: #666666">=</span> np<span style="color: #666666">.</span>loadtxt(filename)
    t <span style="color: #666666">=</span> data[:,<span style="color: #666666">0</span>]
    u <span style="color: #666666">=</span> data[:,<span style="color: #666666">1</span>]
    <span style="color: #008000; font-weight: bold">return</span> t, u
</pre></div>
<p>
Similar function <code>np.savetxt</code>, but then we need all \( u^n \) and \( t^n \) values
in a two-dimensional array (which we try to prevent now!).

<p>
<!-- !split -->

<h3>Usage of memory-saving code  <a name="___sec89"></a></h3>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">explore</span>(I, a, T, dt, theta<span style="color: #666666">=0.5</span>, makeplot<span style="color: #666666">=</span><span style="color: #008000">True</span>):
    filename <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;u.dat&#39;</span>
    u, t <span style="color: #666666">=</span> solver_memsave(I, a, T, dt, theta, filename)

    t, u <span style="color: #666666">=</span> read_file(filename)
    u_e <span style="color: #666666">=</span> exact_solution(t, I, a)
    e <span style="color: #666666">=</span> u_e <span style="color: #666666">-</span> u
    E <span style="color: #666666">=</span> np<span style="color: #666666">.</span>sqrt(dt<span style="color: #666666">*</span>np<span style="color: #666666">.</span>sum(e<span style="color: #666666">**2</span>))
    <span style="color: #008000; font-weight: bold">if</span> makeplot:
        plt<span style="color: #666666">.</span>figure()
        <span style="color: #666666">...</span>
</pre></div>
<p>
Complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/decay_memsave.py"><tt>decay_memsave.py</tt></a>.

<p>
<!-- !split -->

<h2>Software engineering <a name="decay:softeng"></a></h2>

<p>
Goal: make more professional numerical software.

<p>
Topics:

<p>

<ul>
  <p><li> How to make modules (reusable libraries)</li>
  <p><li> Testing frameworks (doctest, nose, unittest)</li>
  <p><li> Implementation with classes</li>
</ul>

<!-- !split -->

<h3>Making a module  <a name="___sec91"></a></h3>

<p>

<ul>
 <p><li> Previous programs: much repetitive code (esp. <code>solver</code>)</li>
 <p><li> DRY (Don't Repeat Yourself) principle: no copies of code</li>
 <p><li> A change needs to be done in one <em>and only one</em> place</li>
 <p><li> Module = just a file with functions (reused through <code>import</code>)</li>
 <p><li> Let's make a module by putting these functions in a file:</li>

<ul>
   <p><li> <code>solver</code></li>
   <p><li> <code>verify_three_steps</code></li>
   <p><li> <code>verify_discrete_solution</code></li>
   <p><li> <code>explore</code></li>
   <p><li> <code>define_command_line_options</code></li>
   <p><li> <code>read_command_line</code></li>
   <p><li> <code>main</code> (with convergence rates)</li>
   <p><li> <code>verify_convergence_rate</code></li>
</ul>

</ul>

Module name: <code>decay_mod</code>, filename: <code>decay_mod.py</code>.

<p>
Sketch:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, a, T, dt, theta):
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">verify_three_steps</span>():
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">verify_exact_discrete_solution</span>():
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(t, I, a):
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">explore</span>(I, a, T, dt, theta<span style="color: #666666">=0.5</span>, makeplot<span style="color: #666666">=</span><span style="color: #008000">True</span>):
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>():
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">read_command_line</span>(use_argparse<span style="color: #666666">=</span><span style="color: #008000">True</span>):
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>():
    <span style="color: #666666">...</span>
</pre></div>
<p>
That is! It's a module <code>decay_mod</code> in file <code>decay_mod.py</code>.

<p>
Usage in some other program:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">decay_mod</span> <span style="color: #008000; font-weight: bold">import</span> solver
u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=1.0</span>, a<span style="color: #666666">=3.0</span>, T<span style="color: #666666">=3</span>, dt<span style="color: #666666">=0.01</span>, theta<span style="color: #666666">=0.5</span>)
</pre></div>

<h3>Test block  <a name="___sec92"></a></h3>

<p>
At the end of a module it is common to include a <em>test block</em>:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    main()
</pre></div>
<p>

<ul>
 <p><li> If <code>decay_mod</code> is imported, <code>__name__</code> is <code>decay_mod</code>.</li>
 <p><li> If <code>decay_mod.py</code> is run, <code>__name__</code> is <code>__main__</code>.</li>
 <p><li> Use test block for testing, demo, user interface, ...</li>
</ul>

Extended test block:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&#39;verify&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv:
        <span style="color: #008000; font-weight: bold">if</span> verify_three_steps() <span style="color: #AA22FF; font-weight: bold">and</span> verify_discrete_solution():
            <span style="color: #008000; font-weight: bold">pass</span> <span style="color: #408080; font-style: italic"># ok</span>
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Bug in the implementation!&#39;</span>
    <span style="color: #008000; font-weight: bold">elif</span> <span style="color: #BA2121">&#39;verify_rates&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv:
        sys<span style="color: #666666">.</span>argv<span style="color: #666666">.</span>remove(<span style="color: #BA2121">&#39;verify_rates&#39;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #BA2121">&#39;--dt&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv:
            <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Must assign several dt values&#39;</span>
            sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)  <span style="color: #408080; font-style: italic"># abort</span>
        <span style="color: #008000; font-weight: bold">if</span> verify_convergence_rate():
            <span style="color: #008000; font-weight: bold">pass</span>
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Bug in the implementation!&#39;</span>
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #408080; font-style: italic"># Perform simulations</span>
        main()
</pre></div>
<p>
<!-- !split -->

<h3>Prefixing imported functions by the module name  <a name="___sec93"></a></h3>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
</pre></div>
<p>
This imports a large number of names (<code>sin</code>, <code>exp</code>, <code>linspace</code>, <code>plot</code>, ...).

<p>
Confusion: is a function from`numpy`? Or <code>matplotlib.pyplot</code>?

<p>
Alternative (recommended) import:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span>
</pre></div>
<p>
Now we need to prefix functions with module name:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">t <span style="color: #666666">=</span> numpy<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, Nt<span style="color: #666666">+1</span>)
u_e <span style="color: #666666">=</span> I<span style="color: #666666">*</span>numpy<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
matplotlib<span style="color: #666666">.</span>pyplot<span style="color: #666666">.</span>plot(t, u_e)
</pre></div>
<p>
Common standard:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>

t <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, Nt<span style="color: #666666">+1</span>)
u_e <span style="color: #666666">=</span> I<span style="color: #666666">*</span>np<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
plt<span style="color: #666666">.</span>plot(t, u_e)
</pre></div>
<p>
<!-- !split -->

<h3>Downside of module prefix notation  <a name="___sec94"></a></h3>

<p>
A math line like \( e^{-at}\sin(2\pi t) \) gets
cluttered with module names,
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">numpy<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)<span style="color: #666666">*</span>numpy<span style="color: #666666">.</span>sin(<span style="color: #666666">2</span>(numpy<span style="color: #666666">.</span>pi<span style="color: #666666">*</span>t)
<span style="color: #408080; font-style: italic"># or</span>
np<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)<span style="color: #666666">*</span>np<span style="color: #666666">.</span>sin(<span style="color: #666666">2*</span>np<span style="color: #666666">.</span>pi<span style="color: #666666">*</span>t)
</pre></div>
<p>
Solution (much used in this course): do two imports

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> exp, sin, pi
<span style="color: #666666">...</span>
t <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, Nt<span style="color: #666666">+1</span>)
u_e <span style="color: #666666">=</span> exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)<span style="color: #666666">*</span>sin(<span style="color: #666666">2*</span>pi<span style="color: #666666">*</span>t)
</pre></div>
<p>
<!-- !split -->

<h3>Doctests  <a name="___sec95"></a></h3>

<p>
Doc strings can be equipped with interactive Python sessions for
demonstrating usage and <em>automatic testing</em> of functions.

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, a, T, dt, theta):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.</span>


<span style="color: #BA2121; font-style: italic">    &gt;&gt;&gt; u, t = solver(I=0.8, a=1.2, T=4, dt=0.5, theta=0.5)</span>
<span style="color: #BA2121; font-style: italic">    &gt;&gt;&gt; for t_n, u_n in zip(t, u):</span>
<span style="color: #BA2121; font-style: italic">    ...     print &#39;t=%.1f, u=%.14f&#39; % (t_n, u_n)</span>
<span style="color: #BA2121; font-style: italic">    t=0.0, u=0.80000000000000</span>
<span style="color: #BA2121; font-style: italic">    t=0.5, u=0.43076923076923</span>
<span style="color: #BA2121; font-style: italic">    t=1.0, u=0.23195266272189</span>
<span style="color: #BA2121; font-style: italic">    t=1.5, u=0.12489758761948</span>
<span style="color: #BA2121; font-style: italic">    t=2.0, u=0.06725254717972</span>
<span style="color: #BA2121; font-style: italic">    t=2.5, u=0.03621291001985</span>
<span style="color: #BA2121; font-style: italic">    t=3.0, u=0.01949925924146</span>
<span style="color: #BA2121; font-style: italic">    t=3.5, u=0.01049960113002</span>
<span style="color: #BA2121; font-style: italic">    t=4.0, u=0.00565363137770</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #666666">...</span>
</pre></div>
<p>
<!-- !split -->

<h3>Running doctests  <a name="___sec96"></a></h3>

<p>
Automatic check that the code reproduces the doctest output:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal<span style="color: #666666">&gt;</span> python <span style="color: #666666">-</span>m doctest decay_mod_doctest<span style="color: #666666">.</span>py
</pre></div>
<p>
Report in case of failure:

<p>

<!-- code=bash (from !bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python -m doctest decay_mod_doctest.py
********************************************************
File <span style="color: #BA2121">&quot;decay_mod_doctest.py&quot;</span>, line 12, in decay_mod_doctest....
Failed example:
    <span style="color: #008000; font-weight: bold">for </span>t_n, u_n in zip<span style="color: #666666">(</span>t, u<span style="color: #666666">)</span>:
        print <span style="color: #BA2121">&#39;t=%.1f, u=%.14f&#39;</span> % <span style="color: #666666">(</span>t_n, u_n<span style="color: #666666">)</span>
Expected:
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>0.0, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.80000000000000
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>0.5, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.43076923076923
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>1.0, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.23195266272189
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>1.5, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.12489758761948
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>2.0, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.06725254717972
Got:
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>0.0, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.80000000000000
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>0.5, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.43076923076923
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>1.0, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.23195266272189
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>1.5, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.12489758761948
    <span style="color: #19177C">t</span><span style="color: #666666">=</span>2.0, <span style="color: #19177C">u</span><span style="color: #666666">=</span>0.06725254718756
********************************************************
1 items had failures:
   1 of   2 in decay_mod_doctest.solver
***Test Failed*** 1 failures.
</pre></div>
<p>
<div class="alert alert-block alert-warning alert-text-normal"><b>Floats are difficult to compare.</b>
Limit the number of digits in the output in doctests! Otherwise,
round-off errors on a different machine may ruin the test.
</div>
<p>
Complete program: <a href="http://tinyurl.com/jvzzcfn/decay/decay_mod_doctest.py"><tt>decay_mod_doctest.py</tt></a>.

<p>
<!-- !split -->

<h3>Unit testing with nose  <a name="___sec97"></a></h3>

<p>

<ul>
 <p><li> Nose is a very user-friendly testing framework</li>
 <p><li> Based on <em>unit testing</em></li>
 <p><li> Identify (small) units of code and test each unit</li>
 <p><li> Nose automates running all tests</li>
 <p><li> Good habit: run all tests after (small) edits of a code</li>
 <p><li> Even better habit: write tests <em>before</em> the code (!)</li>
 <p><li> Remark: unit testing in scientific computing is not yet well established</li>
</ul>

<!-- !split -->

<h3>Basic use of nose  <a name="___sec98"></a></h3>

<p>

<ol>
 <p><li> Implement tests in <em>test functions</em> with names starting with <code>test_</code>.</li>
 <p><li> Test functions cannot have arguments.</li>
 <p><li> Test functions perform assertions on computed results
    using <code>assert</code> functions from the <code>nose.tools</code> module.</li>
 <p><li> Test functions can be in the source code files or be
    collected in separate files <code>test*.py</code>.</li>
</ol>

<!-- !split -->

<h3>Example on a nose test in the source code  <a name="___sec99"></a></h3>

<p>
Very simple module <code>mymod</code> (in file <code>mymod.py</code>):

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">double</span>(n):
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">2*</span>n
</pre></div>
<p>
Write test function in <code>mymod.py</code>:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">double</span>(n):
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">2*</span>n

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">nose.tools</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">nt</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_double</span>():
    result <span style="color: #666666">=</span> double(<span style="color: #666666">4</span>)
    nt<span style="color: #666666">.</span>assert_equal(result, <span style="color: #666666">8</span>)
</pre></div>
<p>
Running

<p>

<!-- code=bash (from !bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; nosetests -s mymod
</pre></div>
<p>
makes the <code>nose</code> tool run all <code>test_*()</code> functions in <code>mymod.py</code>.

<p>
<!-- !split -->

<h3>Example on a nose test in a separate file  <a name="___sec100"></a></h3>

<p>
Write the test in a separate file, say <code>test_mymod.py</code>:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">nose.tools</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">nt</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">mymod</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_double</span>():
    result <span style="color: #666666">=</span> mymod<span style="color: #666666">.</span>double(<span style="color: #666666">4</span>)
    nt<span style="color: #666666">.</span>assert_equal(result, <span style="color: #666666">8</span>)
</pre></div>
<p>
Running

<p>

<!-- code=bash (from !bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; nosetests -s
</pre></div>
<p>
makes the <code>nose</code> tool run all <code>test_*()</code> functions in all files
<code>test*.py</code> in the current directory and in all subdirectories (recursevely)
with names <code>tests</code> or <code>*_tests</code>.

<p>
<div class="alert alert-block alert-notice alert-text-normal"><b>Tip.</b>
Start with test functions in the source code file. When the file
contains many tests, or when you have many source code files,
move tests to separate files.
</div>
<p>
<!-- !split -->

<h3>The habit of writing nose tests  <a name="___sec101"></a></h3>

<p>

<ul>
 <p><li> Put <code>test_*()</code> functions in the module</li>
 <p><li> When you get many <code>test_*()</code> functions, collect them in
   <code>tests/test*.py</code></li>
</ul>

<!-- !split -->

<h3>Purpose of a test function: raise AssertionError if failure  <a name="___sec102"></a></h3>

<p>
Alternative ways of raising AssertionError if <code>result</code> is not <code>8</code>:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">nose.tools</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">nt</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_double</span>():
    result <span style="color: #666666">=</span> <span style="color: #666666">...</span>

    nt<span style="color: #666666">.</span>assert_equal(result, <span style="color: #666666">8</span>)    <span style="color: #408080; font-style: italic"># alternative 1</span>

    <span style="color: #008000; font-weight: bold">assert</span> result <span style="color: #666666">==</span> <span style="color: #666666">8</span>            <span style="color: #408080; font-style: italic"># alternative 2</span>

    <span style="color: #008000; font-weight: bold">if</span> result <span style="color: #666666">!=</span> <span style="color: #666666">8</span>:               <span style="color: #408080; font-style: italic"># alternative 3</span>
        <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #D2413A; font-weight: bold">AssertionError</span>()
</pre></div>
<p>
<!-- !split -->

<h3>Advantages of nose  <a name="___sec103"></a></h3>

<p>

<ul>
  <p><li> Easier to use than other test frameworks</li>
  <p><li> Tests are written and collected in a <em>compact</em> and structured way</li>
  <p><li> Large collections of tests, scattered throughout a directory tree
    can be executed with one command (<code>nosetests -s</code>)</li>
  <p><li> Nose is a much-adopted standard</li>
</ul>

<!-- !split -->

<h3>Demonstrating nose (ideas)  <a name="___sec104"></a></h3>

<p>
Aim: test function <code>solver</code> for \( u'=-au \), \( u(0)=I \).

<p>
We design three unit tests:

<p>

<ol>
 <p><li> A comparison between the computed \( u^n \) values and the
    exact discrete solution</li>
 <p><li> A comparison between the computed \( u^n \) values and precomputed
    verified reference values</li>
 <p><li> A comparison between observed and expected convergence rates</li>
</ol>

These tests follow very closely the previous <code>verify*</code> functions.

<p>
<!-- !split -->

<h3>Demonstrating nose (code)  <a name="___sec105"></a></h3>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">nose.tools</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">nt</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">decay_mod_unittest</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">decay_mod</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_discrete_solution</span>(n, I, a, theta, dt):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return exact discrete solution of the theta scheme.&quot;&quot;&quot;</span>
    dt <span style="color: #666666">=</span> <span style="color: #008000">float</span>(dt)  <span style="color: #408080; font-style: italic"># avoid integer division</span>
    factor <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)
    <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>factor<span style="color: #666666">**</span>n

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_exact_discrete_solution</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Compare result from solver against</span>
<span style="color: #BA2121; font-style: italic">    formula for the discrete solution.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    theta <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>; a <span style="color: #666666">=</span> <span style="color: #666666">2</span>; I <span style="color: #666666">=</span> <span style="color: #666666">0.1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>
    N <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #666666">8/</span>dt)  <span style="color: #408080; font-style: italic"># no of steps</span>
    u, t <span style="color: #666666">=</span> decay_mod<span style="color: #666666">.</span>solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, T<span style="color: #666666">=</span>N<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)
    u_de <span style="color: #666666">=</span> np<span style="color: #666666">.</span>array([exact_discrete_solution(n, I, a, theta, dt)
                     <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(N<span style="color: #666666">+1</span>)])
    diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u_de <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()
    nt<span style="color: #666666">.</span>assert_almost_equal(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)
</pre></div>
<p>
<!-- !split -->

<h3>Floats as test results require careful comparison  <a name="___sec106"></a></h3>

<p>

<ul>
 <p><li> Round-off errors make exact comparison of floats unreliable</li>
 <p><li> <code>nt.assert_almost_equal</code>: compare two floats to some digits
   or precision</li>
</ul>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_solver</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Compare result from solver against</span>
<span style="color: #BA2121; font-style: italic">    precomputed arrays for theta=0, 0.5, 1.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    I<span style="color: #666666">=0.8</span>; a<span style="color: #666666">=1.2</span>; T<span style="color: #666666">=4</span>; dt<span style="color: #666666">=0.5</span>  <span style="color: #408080; font-style: italic"># fixed parameters</span>
    precomputed <span style="color: #666666">=</span> {
        <span style="color: #BA2121">&#39;t&#39;</span>: np<span style="color: #666666">.</span>array([ <span style="color: #666666">0.</span> ,  <span style="color: #666666">0.5</span>,  <span style="color: #666666">1.</span> ,  <span style="color: #666666">1.5</span>,  <span style="color: #666666">2.</span> ,  <span style="color: #666666">2.5</span>,
                        <span style="color: #666666">3.</span> ,  <span style="color: #666666">3.5</span>,  <span style="color: #666666">4.</span> ]),
        <span style="color: #666666">0.5</span>: np<span style="color: #666666">.</span>array(
            [ <span style="color: #666666">0.8</span>       ,  <span style="color: #666666">0.43076923</span>,  <span style="color: #666666">0.23195266</span>, <span style="color: #666666">0.12489759</span>,
              <span style="color: #666666">0.06725255</span>,  <span style="color: #666666">0.03621291</span>,  <span style="color: #666666">0.01949926</span>, <span style="color: #666666">0.0104996</span> ,
              <span style="color: #666666">0.00565363</span>]),
        <span style="color: #666666">0</span>: <span style="color: #666666">...</span>,
        <span style="color: #666666">1</span>: <span style="color: #666666">...</span>
        }
    <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>:
        u, t <span style="color: #666666">=</span> decay_mod<span style="color: #666666">.</span>solver(I, a, T, dt, theta<span style="color: #666666">=</span>theta)
        diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u <span style="color: #666666">-</span> precomputed[theta])<span style="color: #666666">.</span>max()
        <span style="color: #408080; font-style: italic"># Precomputed numbers are known to 8 decimal places</span>
        nt<span style="color: #666666">.</span>assert_almost_equal(diff, <span style="color: #666666">0</span>, places<span style="color: #666666">=8</span>,
                               msg<span style="color: #666666">=</span><span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> theta)
</pre></div>
<p>
<!-- !split -->

<h3>Test of wrong use  <a name="___sec107"></a></h3>

<p>

<ul>
 <p><li> Find input data that may cause trouble and test such cases</li>
 <p><li> Here: the formula for \( u^{n+1} \) may involve integer division</li>
</ul>

Example:
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">theta <span style="color: #666666">=</span> <span style="color: #666666">1</span>; a <span style="color: #666666">=</span> <span style="color: #666666">1</span>; I <span style="color: #666666">=</span> <span style="color: #666666">1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">2</span>
</pre></div>
<p>
may lead to integer division:
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">(<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)  <span style="color: #408080; font-style: italic"># becomes 1</span>
(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)      <span style="color: #408080; font-style: italic"># becomes 2</span>
(<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)  <span style="color: #408080; font-style: italic"># becomes 0 (!)</span>
</pre></div>
<p>
Test that <code>solver</code> does not suffer from such integer division:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_potential_integer_division</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Choose variables that can trigger integer division.&quot;&quot;&quot;</span>
    theta <span style="color: #666666">=</span> <span style="color: #666666">1</span>; a <span style="color: #666666">=</span> <span style="color: #666666">1</span>; I <span style="color: #666666">=</span> <span style="color: #666666">1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">2</span>
    N <span style="color: #666666">=</span> <span style="color: #666666">4</span>
    u, t <span style="color: #666666">=</span> decay_mod<span style="color: #666666">.</span>solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, T<span style="color: #666666">=</span>N<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)
    u_de <span style="color: #666666">=</span> np<span style="color: #666666">.</span>array([exact_discrete_solution(n, I, a, theta, dt)
                     <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(N<span style="color: #666666">+1</span>)])
    diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u_de <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()
    nt<span style="color: #666666">.</span>assert_almost_equal(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)
</pre></div>
<p>
<!-- !split -->

<h3>Test of convergence rates  <a name="___sec108"></a></h3>

<p>
Convergence rate tests are very common for differential equation solvers.

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_convergence_rates</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Compare empirical convergence rates to exact ones.&quot;&quot;&quot;</span>
    <span style="color: #408080; font-style: italic"># Set command-line arguments directly in sys.argv</span>
    <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span>
    sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>:] <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;--I 0.8 --a 2.1 --T 5 &#39;</span>\ 
                   <span style="color: #BA2121">&#39;--dt 0.4 0.2 0.1 0.05 0.025&#39;</span><span style="color: #666666">.</span>split()
    r <span style="color: #666666">=</span> decay_mod<span style="color: #666666">.</span>main()
    <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> r:
        nt<span style="color: #666666">.</span>assert_true(r[theta])  <span style="color: #408080; font-style: italic"># check for non-empty list</span>

    expected_rates <span style="color: #666666">=</span> {<span style="color: #666666">0</span>: <span style="color: #666666">1</span>, <span style="color: #666666">1</span>: <span style="color: #666666">1</span>, <span style="color: #666666">0.5</span>: <span style="color: #666666">2</span>}
    <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> r:
        r_final <span style="color: #666666">=</span> r[theta][<span style="color: #666666">-1</span>]
        <span style="color: #408080; font-style: italic"># Compare to 1 decimal place</span>
        nt<span style="color: #666666">.</span>assert_almost_equal(expected_rates[theta], r_final,
                               places<span style="color: #666666">=1</span>, msg<span style="color: #666666">=</span><span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> theta)
</pre></div>
<p>
Complete program: <a href="http://tinyurl.com/jvzzcfn/decay/tests/test_decay_nose.py"><tt>test_decay_nose.py</tt></a>.

<p>
<!-- !split -->

<h3>Classical unit testing with unittest  <a name="___sec109"></a></h3>

<p>

<ul>
 <p><li> <code>unittest</code> is a Python module mimicing the classical JUnit
   class-based unit testing framework from Java</li>
 <p><li> This is how unit testing is normally done</li>
 <p><li> Requires knowledge of object-oriented programming</li>
</ul>

<div class="alert alert-block alert-warning alert-text-normal"><b>Remark.</b>
You will probably not use it, but you're not educated unless
you know what unit testing with classes is.
</div>
<p>
<!-- !split -->

<h3>Basic use of unittest  <a name="___sec110"></a></h3>

<p>
Write file <code>test_mymod.py</code>:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">unittest</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">mymod</span>

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">TestMyCode</span>(unittest<span style="color: #666666">.</span>TestCase):
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_double</span>(<span style="color: #008000">self</span>):
        result <span style="color: #666666">=</span> mymod<span style="color: #666666">.</span>double(<span style="color: #666666">4</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>assertEqual(result, <span style="color: #666666">8</span>)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    unittest<span style="color: #666666">.</span>main()
</pre></div>
<p>
<!-- !split -->

<h3>Demonstration of unittest  <a name="___sec111"></a></h3>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">unittest</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">decay_mod_unittest</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">decay</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_discrete_solution</span>(n, I, a, theta, dt):
    factor <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)
    <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>factor<span style="color: #666666">**</span>n

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">TestDecay</span>(unittest<span style="color: #666666">.</span>TestCase):

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_exact_discrete_solution</span>(<span style="color: #008000">self</span>):
        <span style="color: #666666">...</span>
        diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u_de <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>assertAlmostEqual(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_solver</span>(<span style="color: #008000">self</span>):
        <span style="color: #666666">...</span>
        <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>:
            <span style="color: #666666">...</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>assertAlmostEqual(diff, <span style="color: #666666">0</span>, places<span style="color: #666666">=8</span>,
                                   msg<span style="color: #666666">=</span><span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> theta)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_potential_integer_division</span>():
        <span style="color: #666666">...</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>assertAlmostEqual(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_convergence_rates</span>(<span style="color: #008000">self</span>):
        <span style="color: #666666">...</span>
        <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> r:
            <span style="color: #666666">...</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>assertAlmostEqual(<span style="color: #666666">...</span>)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    unittest<span style="color: #666666">.</span>main()
</pre></div>
<p>
<!-- @@@CODE src-decay/tests/test_decay_unittest.py fromto: def test_conv@ -->

<p>
Complete program: <a href="http://tinyurl.com/jvzzcfn/decay/tests/test_decay_nose.py"><tt>test_decay_unittest.py</tt></a>.

<p>
<!-- !split -->

<h2>Implementing simple problem and solver classes <a name="decay:classes"></a></h2>

<p>

<ul>
 <p><li> So far: programs are built of Python functions</li>
 <p><li> New focus: alternative implementations using classes</li>
 <p><li> Class-based implementations are very popular,
   especially in business/adm applications</li>
 <p><li> Class-based implementations scales better to large and
   complex scientific applications</li>
</ul>

<!-- !split -->

<h3>What to learn  <a name="___sec113"></a></h3>

<p>
Tasks:

<p>

<ul>
 <p><li> Explain basic use of classes to build a differential equation solver</li>
 <p><li> Introduce concepts that make such programs easily scale to
   more complex applications</li>
 <p><li> Demonstrate the advantage of using classes</li>
</ul>

Ideas:

<p>

<ul>
 <p><li> Classes for Problem, Solver, and Visualizer</li>
 <p><li> Problem: all the physics information about the problem</li>
 <p><li> Solver: all the numerics information + numerical computations</li>
 <p><li> Visualizer: plot the solution and other quantities</li>
</ul>

<!-- !split -->

<h3>The problem class  <a name="___sec114"></a></h3>

<p>

<ul>
 <p><li> Model problem: \( u'=-au \), \( u(0)=I \), for \( t\in (0,T] \).</li>
 <p><li> Class <code>Problem</code> stores the physical parameters \( a \), \( I \), \( T \)</li>
 <p><li> May also offer other data, e.g., \( \uex(t)=Ie^{-at} \)</li>
</ul>

Implementation:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> exp

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Problem</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, I<span style="color: #666666">=1</span>, a<span style="color: #666666">=1</span>, T<span style="color: #666666">=10</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>T, <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a <span style="color: #666666">=</span> I, <span style="color: #008000">float</span>(a), T

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(<span style="color: #008000">self</span>, t):
        I, a <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a     <span style="color: #408080; font-style: italic"># extract local variables</span>
        <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>
<p>
Basic usage:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">problem <span style="color: #666666">=</span> Problem(T<span style="color: #666666">=5</span>)
problem<span style="color: #666666">.</span>T <span style="color: #666666">=</span> <span style="color: #666666">8</span>
problem<span style="color: #666666">.</span>dt <span style="color: #666666">=</span> <span style="color: #666666">1.5</span>
</pre></div>
<p>
<!-- !split -->

<h3>Improved problem class  <a name="___sec115"></a></h3>

<p>
More flexible input from the command line:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Problem</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, I<span style="color: #666666">=1</span>, a<span style="color: #666666">=1</span>, T<span style="color: #666666">=10</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>T, <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a <span style="color: #666666">=</span> I, <span style="color: #008000">float</span>(a), T

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>(<span style="color: #008000">self</span>, parser<span style="color: #666666">=</span><span style="color: #008000">None</span>):
        <span style="color: #008000; font-weight: bold">if</span> parser <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
            <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">argparse</span>
            parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser()

        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--I&#39;</span>, <span style="color: #BA2121">&#39;--initial_condition&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
            default<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>I, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;initial condition, u(0)&#39;</span>,
            metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;I&#39;</span>)
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--a&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>, default<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>a,
            help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;coefficient in ODE&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;a&#39;</span>)
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--T&#39;</span>, <span style="color: #BA2121">&#39;--stop_time&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>, default<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>T,
            help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;end time of simulation&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;T&#39;</span>)
        <span style="color: #008000; font-weight: bold">return</span> parser

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">init_from_command_line</span>(<span style="color: #008000">self</span>, args):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a, <span style="color: #008000">self</span><span style="color: #666666">.</span>T <span style="color: #666666">=</span> args<span style="color: #666666">.</span>I, args<span style="color: #666666">.</span>a, args<span style="color: #666666">.</span>T

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(<span style="color: #008000">self</span>, t):
        I, a <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a
        <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>
<p>

<ul>
 <p><li> Can utilize user's <code>ArgumentParser</code>, or make one</li>
 <p><li> <code>None</code> is used to indicate a non-initialized variable</li>
</ul>

<!-- !split -->

<h3>The solver class  <a name="___sec116"></a></h3>

<p>

<ul>
 <p><li> Store numerical data \( \Delta t \), \( \theta \)</li>
 <p><li> Compute solution and quantities derived from the solution</li>
</ul>

Implementation:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Solver</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, problem, dt<span style="color: #666666">=0.1</span>, theta<span style="color: #666666">=0.5</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>problem <span style="color: #666666">=</span> problem
        <span style="color: #008000">self</span><span style="color: #666666">.</span>dt, <span style="color: #008000">self</span><span style="color: #666666">.</span>theta <span style="color: #666666">=</span> <span style="color: #008000">float</span>(dt), theta

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>(<span style="color: #008000">self</span>, parser):
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--dt&#39;</span>, <span style="color: #BA2121">&#39;--time_step_value&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
            default<span style="color: #666666">=0.5</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time step value&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;dt&#39;</span>)
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--theta&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>, default<span style="color: #666666">=0.5</span>,
            help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time discretization parameter&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;dt&#39;</span>)
        <span style="color: #008000; font-weight: bold">return</span> parser

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">init_from_command_line</span>(<span style="color: #008000">self</span>, args):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>dt, <span style="color: #008000">self</span><span style="color: #666666">.</span>theta <span style="color: #666666">=</span> args<span style="color: #666666">.</span>dt, args<span style="color: #666666">.</span>theta

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solve</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">decay_mod</span> <span style="color: #008000; font-weight: bold">import</span> solver
        <span style="color: #008000">self</span><span style="color: #666666">.</span>u, <span style="color: #008000">self</span><span style="color: #666666">.</span>t <span style="color: #666666">=</span> solver(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>a, <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>T,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>dt, <span style="color: #008000">self</span><span style="color: #666666">.</span>theta)
</pre></div>
<p>
Note: reuse of the numerical algorithm from the <code>decay_mod</code> module
(i.e., the class is a wrapper of the procedural implementation).

<p>
<!-- !split -->

<h3>The visualizer class  <a name="___sec117"></a></h3>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Visualizer</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, problem, solver):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>problem, <span style="color: #008000">self</span><span style="color: #666666">.</span>solver <span style="color: #666666">=</span> problem, solver

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">plot</span>(<span style="color: #008000">self</span>, include_exact<span style="color: #666666">=</span><span style="color: #008000">True</span>, plt<span style="color: #666666">=</span><span style="color: #008000">None</span>):
        <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">        Add solver.u curve to the plotting object plt,</span>
<span style="color: #BA2121; font-style: italic">        and include the exact solution if include_exact is True.</span>
<span style="color: #BA2121; font-style: italic">        This plot function can be called several times (if</span>
<span style="color: #BA2121; font-style: italic">        the solver object has computed new solutions).</span>
<span style="color: #BA2121; font-style: italic">        &quot;&quot;&quot;</span>
        <span style="color: #008000; font-weight: bold">if</span> plt <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
            <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">scitools.std</span>  <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span> <span style="color: #408080; font-style: italic"># can use matplotlib as well</span>

        plt<span style="color: #666666">.</span>plot(<span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>t, <span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>u, <span style="color: #BA2121">&#39;--o&#39;</span>)
        plt<span style="color: #666666">.</span>hold(<span style="color: #BA2121">&#39;on&#39;</span>)
        theta2name <span style="color: #666666">=</span> {<span style="color: #666666">0</span>: <span style="color: #BA2121">&#39;FE&#39;</span>, <span style="color: #666666">1</span>: <span style="color: #BA2121">&#39;BE&#39;</span>, <span style="color: #666666">0.5</span>: <span style="color: #BA2121">&#39;CN&#39;</span>}
        name <span style="color: #666666">=</span> theta2name<span style="color: #666666">.</span>get(<span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>theta, <span style="color: #BA2121">&#39;&#39;</span>)
        legends <span style="color: #666666">=</span> [<span style="color: #BA2121">&#39;numerical </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> name]
        <span style="color: #008000; font-weight: bold">if</span> include_exact:
            t_e <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>T, <span style="color: #666666">1001</span>)
            u_e <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>exact_solution(t_e)
            plt<span style="color: #666666">.</span>plot(t_e, u_e, <span style="color: #BA2121">&#39;b-&#39;</span>)
            legends<span style="color: #666666">.</span>append(<span style="color: #BA2121">&#39;exact&#39;</span>)
        plt<span style="color: #666666">.</span>legend(legends)
        plt<span style="color: #666666">.</span>xlabel(<span style="color: #BA2121">&#39;t&#39;</span>)
        plt<span style="color: #666666">.</span>ylabel(<span style="color: #BA2121">&#39;u&#39;</span>)
        plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, dt=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span>
                  (<span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>theta, <span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>dt))
        plt<span style="color: #666666">.</span>savefig(<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (name, <span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>dt))
        <span style="color: #008000; font-weight: bold">return</span> plt
</pre></div>
<p>
Remark: The <code>plt</code> object in <code>plot</code> adds a new curve to a plot,
which enables comparing different solutions from different
runs of <code>Solver.solve</code>

<p>
<!-- !split -->

<h3>Combing the classes  <a name="___sec118"></a></h3>

<p>
Let <code>Problem</code>, <code>Solver</code>, and <code>Visualizer</code> play together:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>():
    problem <span style="color: #666666">=</span> Problem()
    solver <span style="color: #666666">=</span> Solver(problem)
    viz <span style="color: #666666">=</span> Visualizer(problem, solver)

    <span style="color: #408080; font-style: italic"># Read input from the command line</span>
    parser <span style="color: #666666">=</span> problem<span style="color: #666666">.</span>define_command_line_options()
    parser <span style="color: #666666">=</span> solver<span style="color: #666666">.</span> define_command_line_options(parser)
    args <span style="color: #666666">=</span> parser<span style="color: #666666">.</span>parse_args()
    problem<span style="color: #666666">.</span>init_from_command_line(args)
    solver<span style="color: #666666">.</span> init_from_command_line(args)

    <span style="color: #408080; font-style: italic"># Solve and plot</span>
    solver<span style="color: #666666">.</span>solve()
    <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>
    <span style="color: #408080; font-style: italic">#import scitools.std as plt</span>
    plt <span style="color: #666666">=</span> viz<span style="color: #666666">.</span>plot(plt<span style="color: #666666">=</span>plt)
    E <span style="color: #666666">=</span> solver<span style="color: #666666">.</span>error()
    <span style="color: #008000; font-weight: bold">if</span> E <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">None</span>:
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Error: </span><span style="color: #BB6688; font-weight: bold">%.4E</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> E
    plt<span style="color: #666666">.</span>show()
</pre></div>
<p>
Complete program: <a href="http://tinyurl.com/jvzzcfn/decay/decay_class.py"><tt>decay_class.py</tt></a>.

<p>
<!-- !split -->

<h2>Implementing more advanced problem and solver classes <a name="decay:classes2"></a></h2>

<p>

<ul>
 <p><li> The previous <code>Problem</code> and <code>Solver</code> classes soon contain
   much repetitive code when the number of parameters increases</li>
 <p><li> Much of such code can be parameterized and be made more compact</li>
 <p><li> Idea: collect all parameters in a dictionary <code>self.prms</code>,
   with two associated dictionaries <code>self.types</code> and
   <code>self.help</code> for holding associated object types and help strings</li>
 <p><li> Collect common code in class <code>Parameters</code></li>
 <p><li> Let <code>Problem</code>, <code>Solver</code>, and maybe <code>Visualizer</code> be subclasses
   of class <code>Parameters</code>, basically defining <code>self.prms</code>, <code>self.types</code>,
   <code>self.help</code></li>
</ul>

<!-- !split -->

<h3>A generic class for parameters  <a name="___sec120"></a></h3>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Parameters</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">set</span>(<span style="color: #008000">self</span>, <span style="color: #666666">**</span>parameters):
        <span style="color: #008000; font-weight: bold">for</span> name <span style="color: #AA22FF; font-weight: bold">in</span> parameters:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>prms[name] <span style="color: #666666">=</span> parameters[name]

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">get</span>(<span style="color: #008000">self</span>, name):
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>prms[name]

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>(<span style="color: #008000">self</span>, parser<span style="color: #666666">=</span><span style="color: #008000">None</span>):
        <span style="color: #008000; font-weight: bold">if</span> parser <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
            <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">argparse</span>
            parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser()

        <span style="color: #008000; font-weight: bold">for</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>prms:
            tp <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>types[name] <span style="color: #008000; font-weight: bold">if</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>types <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000">str</span>
            help <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>help[name] <span style="color: #008000; font-weight: bold">if</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>help <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000">None</span>
            parser<span style="color: #666666">.</span>add_argument(
                <span style="color: #BA2121">&#39;--&#39;</span> <span style="color: #666666">+</span> name, default<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>get(name), metavar<span style="color: #666666">=</span>name,
                <span style="color: #008000">type</span><span style="color: #666666">=</span>tp, help<span style="color: #666666">=</span>help)

        <span style="color: #008000; font-weight: bold">return</span> parser

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">init_from_command_line</span>(<span style="color: #008000">self</span>, args):
        <span style="color: #008000; font-weight: bold">for</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>prms:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>prms[name] <span style="color: #666666">=</span> <span style="color: #008000">getattr</span>(args, name)
</pre></div>
<p>
Slightly more advanced version in <a href="http://tinyurl.com/jvzzcfn/decay/class_decay_verf1.py"><tt>class_decay_verf1.py</tt></a>.

<p>
<!-- !split -->

<h3>The problem class  <a name="___sec121"></a></h3>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Problem</span>(Parameters):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Physical parameters for the problem u&#39;=-a*u, u(0)=I,</span>
<span style="color: #BA2121; font-style: italic">    with t in [0,T].</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>prms <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(I<span style="color: #666666">=1</span>, a<span style="color: #666666">=1</span>, T<span style="color: #666666">=10</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>types <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(I<span style="color: #666666">=</span><span style="color: #008000">float</span>, a<span style="color: #666666">=</span><span style="color: #008000">float</span>, T<span style="color: #666666">=</span><span style="color: #008000">float</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>help <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(I<span style="color: #666666">=</span><span style="color: #BA2121">&#39;initial condition, u(0)&#39;</span>,
                         a<span style="color: #666666">=</span><span style="color: #BA2121">&#39;coefficient in ODE&#39;</span>,
                         T<span style="color: #666666">=</span><span style="color: #BA2121">&#39;end time of simulation&#39;</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(<span style="color: #008000">self</span>, t):
        I, a <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;I&#39;</span>), <span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;a&#39;</span>)
        <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>np<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>
<p>
<!-- !split -->

<h3>The solver class  <a name="___sec122"></a></h3>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Solver</span>(Parameters):
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, problem):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>problem <span style="color: #666666">=</span> problem
        <span style="color: #008000">self</span><span style="color: #666666">.</span>prms <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(dt<span style="color: #666666">=0.5</span>, theta<span style="color: #666666">=0.5</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>types <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(dt<span style="color: #666666">=</span><span style="color: #008000">float</span>, theta<span style="color: #666666">=</span><span style="color: #008000">float</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>help <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(dt<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time step value&#39;</span>,
                         theta<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time discretization parameter&#39;</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solve</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">decay_mod</span> <span style="color: #008000; font-weight: bold">import</span> solver
        <span style="color: #008000">self</span><span style="color: #666666">.</span>u, <span style="color: #008000">self</span><span style="color: #666666">.</span>t <span style="color: #666666">=</span> solver(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;I&#39;</span>),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;a&#39;</span>),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;T&#39;</span>),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;dt&#39;</span>),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;theta&#39;</span>))

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">error</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">try</span>:
            u_e <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>exact_solution(<span style="color: #008000">self</span><span style="color: #666666">.</span>t)
            e <span style="color: #666666">=</span> u_e <span style="color: #666666">-</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>u
            E <span style="color: #666666">=</span> np<span style="color: #666666">.</span>sqrt(<span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;dt&#39;</span>)<span style="color: #666666">*</span>np<span style="color: #666666">.</span>sum(e<span style="color: #666666">**2</span>))
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">AttributeError</span>:
            E <span style="color: #666666">=</span> <span style="color: #008000">None</span>
        <span style="color: #008000; font-weight: bold">return</span> E
</pre></div>
<p>
<!-- !split -->

<h3>The visualizer class  <a name="___sec123"></a></h3>

<p>

<ul>
 <p><li> No parameters needed (for this simple problem), no need to inherit
   class <code>Parameters</code></li>
 <p><li> Same code as previously shown class <code>Visualizer</code></li>
 <p><li> Same code as previously shown for combining <code>Problem</code>, <code>Solver</code>, and
   <code>Visualizer</code></li>
</ul>

<!-- !split -->

<h2>Performing scientific experiments <a name="decay:experiments"></a></h2>

<p>
Goal: explore the behavior of a numerical
method for a differential equation and show how scientific experiments
can be set up and reported.

<p>
Tasks:

<p>

<ul>
  <p><li> Write scripts to automate experiments</li>
  <p><li> Generate scientific reports from scripts</li>
</ul>

Tools to learn:

<p>

<ul>
  <p><li> <code>os.system</code> for running other programs</li>
  <p><li> <code>subprocess</code> for running other programs and extracting the output</li>
  <p><li> List comprehensions</li>
  <p><li> Formats for scientific reports: HTML w/MathJax, LaTeX, Sphinx, Doconce</li>
</ul>

<!-- !split -->

<h3>Model problem and numerical solution method  <a name="___sec125"></a></h3>

<p>
Problem:

<p>
$$
\begin{equation}
u'(t) = -au(t),\quad u(0)=I,\ 0< t \leq T,
\label{decay:experiments:model}
\end{equation}
$$


<p>
Solution method (\( \theta \)-rule):

<p>
$$
u^{n+1} = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a\Delta t}u^n,
\quad u^0=I\thinspace .
$$


<p>
<!-- !split -->

<h3>Plan for the experiments  <a name="___sec126"></a></h3>

<p>

<ul>
 <p><li> Plot \( u^n \) against \( \uex = Ie^{-at} \) for
   various choices of the parameters
   \( I \), \( a \), \( \Delta t \), and \( \theta \)</li>
 <p><li> How does the discrete solution compare with the exact solution
   when \( \Delta t \) is varied and \( \theta=0,0.5,1 \)?</li>
 <p><li> Use the <a href="http://tinyurl.com/jvzzcfn/decay/decay_mod.py"><tt>decay_mod.py</tt></a> module (little modification of the plotting, see <a href="http://tinyurl.com/jvzzcfn/decay/experiments/decay_mod.py"><tt>experiments/decay_mod.py</tt></a>)</li>
 <p><li> Make separate program for running (automating) the experiments (<em>script</em>)</li>

<ol>
   <p><li> <code>python decay_mod.py --I 1 --a 2 --makeplot --T 5 --dt 0.5 0.25 0.1 0.05</code></li>
   <p><li> Combine generated figures <code>FE_*.png</code>, <code>BE_*.png</code>, and <code>CN_*.png</code>
      to new figures with multiple plots</li>
   <p><li> Run script as <code>python decay_exper0.py 0.5 0.25 0.1 0.05</code> (\( \Delta t \) values on the command line)</li>
</ol>

</ul>

<!-- !split -->

<h3>Typical plot summarizing the results  <a name="___sec127"></a></h3>

<p>
<center><p><img src="fig-decay/BE4a.png" align="bottom" width=800,></p></center>

<p>
<!-- !split -->

<h3>Script code  <a name="___sec128"></a></h3>

<p>
Typical <em>script</em> (small administering program) for running the experiments:

<p>

<!-- code=python (from !bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">os</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">sys</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">run_experiments</span>(I<span style="color: #666666">=1</span>, a<span style="color: #666666">=2</span>, T<span style="color: #666666">=5</span>):
    <span style="color: #408080; font-style: italic"># The command line must contain dt values</span>
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(sys<span style="color: #666666">.</span>argv) <span style="color: #666666">&gt;</span> <span style="color: #666666">1</span>:
        dt_values <span style="color: #666666">=</span> [<span style="color: #008000">float</span>(arg) <span style="color: #008000; font-weight: bold">for</span> arg <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>:]]
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Usage: </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> dt1 dt2 dt3 ...&#39;</span> <span style="color: #666666">%</span>  sys<span style="color: #666666">.</span>argv[<span style="color: #666666">0</span>]
        sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)  <span style="color: #408080; font-style: italic"># abort</span>

    <span style="color: #408080; font-style: italic"># Run module file as a stand-alone application</span>
    cmd <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;python decay_mod.py --I </span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121"> --a </span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121"> --makeplot --T </span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> \
          (I, a, T)
    dt_values_str <span style="color: #666666">=</span> <span style="color: #BA2121">&#39; &#39;</span><span style="color: #666666">.</span>join([<span style="color: #008000">str</span>(v) <span style="color: #008000; font-weight: bold">for</span> v <span style="color: #AA22FF; font-weight: bold">in</span> dt_values])
    cmd <span style="color: #666666">+=</span> <span style="color: #BA2121">&#39; --dt </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> dt_values_str
    <span style="color: #008000; font-weight: bold">print</span> cmd
    failure <span style="color: #666666">=</span> os<span style="color: #666666">.</span>system(cmd)
    <span style="color: #008000; font-weight: bold">if</span> failure:
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Command failed:&#39;</span>, cmd; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)

    <span style="color: #408080; font-style: italic"># Combine images into rows with 2 plots in each row</span>
    image_commands <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> method <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #BA2121">&#39;BE&#39;</span>, <span style="color: #BA2121">&#39;CN&#39;</span>, <span style="color: #BA2121">&#39;FE&#39;</span>:
        pdf_files <span style="color: #666666">=</span> <span style="color: #BA2121">&#39; &#39;</span><span style="color: #666666">.</span>join([<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">.pdf&#39;</span> <span style="color: #666666">%</span> (method, dt)
                              <span style="color: #008000; font-weight: bold">for</span> dt <span style="color: #AA22FF; font-weight: bold">in</span> dt_values])
        png_files <span style="color: #666666">=</span> <span style="color: #BA2121">&#39; &#39;</span><span style="color: #666666">.</span>join([<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (method, dt)
                              <span style="color: #008000; font-weight: bold">for</span> dt <span style="color: #AA22FF; font-weight: bold">in</span> dt_values])
        image_commands<span style="color: #666666">.</span>append(
            <span style="color: #BA2121">&#39;montage -background white -geometry 100%&#39;</span> <span style="color: #666666">+</span>
            <span style="color: #BA2121">&#39; -tile 2x </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (png_files, method))
        image_commands<span style="color: #666666">.</span>append(
            <span style="color: #BA2121">&#39;convert -trim </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.png </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (method, method))
        image_commands<span style="color: #666666">.</span>append(
            <span style="color: #BA2121">&#39;convert </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.png -transparent white </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span>
            (method, method))
        image_commands<span style="color: #666666">.</span>append(
            <span style="color: #BA2121">&#39;pdftk </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> output tmp.pdf&#39;</span> <span style="color: #666666">%</span> pdf_files)
        num_rows <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #008000">round</span>(<span style="color: #008000">len</span>(dt_values)<span style="color: #666666">/2.0</span>))
        image_commands<span style="color: #666666">.</span>append(
            <span style="color: #BA2121">&#39;pdfnup --nup 2x</span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121"> tmp.pdf&#39;</span> <span style="color: #666666">%</span> num_rows)
        image_commands<span style="color: #666666">.</span>append(
            <span style="color: #BA2121">&#39;pdfcrop tmp-nup.pdf </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.pdf&#39;</span> <span style="color: #666666">%</span> method)

    <span style="color: #008000; font-weight: bold">for</span> cmd <span style="color: #AA22FF; font-weight: bold">in</span> image_commands:
        <span style="color: #008000; font-weight: bold">print</span> cmd
        failure <span style="color: #666666">=</span> os<span style="color: #666666">.</span>system(cmd)
        <span style="color: #008000; font-weight: bold">if</span> failure:
            <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Command failed:&#39;</span>, cmd; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)

    <span style="color: #408080; font-style: italic"># Remove the files generated above and by decay_mod.py</span>
    <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">glob</span> <span style="color: #008000; font-weight: bold">import</span> glob
    filenames <span style="color: #666666">=</span> glob(<span style="color: #BA2121">&#39;*_*.png&#39;</span>) <span style="color: #666666">+</span> glob(<span style="color: #BA2121">&#39;*_*.pdf&#39;</span>) <span style="color: #666666">+</span> \
                glob(<span style="color: #BA2121">&#39;*_*.eps&#39;</span>) <span style="color: #666666">+</span> glob(<span style="color: #BA2121">&#39;tmp*.pdf&#39;</span>)
    <span style="color: #008000; font-weight: bold">for</span> filename <span style="color: #AA22FF; font-weight: bold">in</span> filenames:
        os<span style="color: #666666">.</span>remove(filename)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    run_experiments()
</pre></div>
<p>
Complete program: <a href="http://tinyurl.com/jvzzcfn/decay/experiments/decay_exper0.py"><tt>experiments/decay_exper0.py</tt></a>.

<p>
<!-- !split -->

<h3>Comments to the code  <a name="___sec129"></a></h3>

<p>
Many useful constructs in the previous script:

<p>

<ul>
 <p><li> <code>[float(arg) for arg in sys.argv[1:]]</code> builds a list of real numbers
   from all the command-line arguments</li>
 <p><li> <code>failure = os.system(cmd)</code> runs an operating system command
   (e.g., another program)</li>
 <p><li> <code>sys.exit(1)</code> aborts the program</li>
 <p><li> <code>['%s_%s.png' % (method, dt) for dt in dt_values]</code> builds a list of
   filenames from a list of numbers (<code>dt_values</code>)</li>
 <p><li> All <code>montage</code> commands for creating composite figures are stored in a
   list and thereafter executed in a loop</li>
 <p><li> <code>glob.glob('*_*.png')</code> returns a list of the names of all files in the
   current folder where the filename matches the <em>Unix wildcard notation</em>
   <code>*_*.png</code> (meaning "any text, underscore, any text, and then `.png`")</li>
 <p><li> <code>os.remove(filename)</code> removes the file with name <code>filename</code></li>
</ul>

<!-- !split -->

<h3>Interpreting output from other programs  <a name="___sec130"></a></h3>

<p>
In <code>decay_exper0.py</code> we run a program (<code>os.system</code>) and
want to grab the output, e.g.,

<p>

<!-- code=bash (from !bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python decay_plot_mpl.py
0.0   0.40:    2.105E-01
0.0   0.04:    1.449E-02
0.5   0.40:    3.362E-02
0.5   0.04:    1.887E-04
1.0   0.40:    1.030E-01
1.0   0.04:    1.382E-02
</pre></div>
<p>
Tasks:

<p>

<ul>
  <p><li> read the output from the <code>decay_mod.py</code> program</li>
  <p><li> interpret this output and store the \( E \) values in arrays for each
    \( \theta \) value</li>
  <p><li> plot \( E \) versus \( \Delta t \), for each \( \theta \), in a log-log plot</li>
</ul>

<!-- !split -->

<h3>Code for grabbing output from another program  <a name="___sec131"></a></h3>

<p>
Use the <code>subprocess</code> module to grab output:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">    <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">subprocess</span> <span style="color: #008000; font-weight: bold">import</span> Popen, PIPE, STDOUT
    p <span style="color: #666666">=</span> Popen(cmd, shell<span style="color: #666666">=</span><span style="color: #008000">True</span>, stdout<span style="color: #666666">=</span>PIPE, stderr<span style="color: #666666">=</span>STDOUT)
    output, dummy <span style="color: #666666">=</span> p<span style="color: #666666">.</span>communicate()
    failure <span style="color: #666666">=</span> p<span style="color: #666666">.</span>returncode
    <span style="color: #008000; font-weight: bold">if</span> failure:
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Command failed:&#39;</span>, cmd; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)
</pre></div>
<p>
<!-- !split -->

<h3>Code for interpreting the grabbed output  <a name="___sec132"></a></h3>

<p>

<ul>
 <p><li> Run through the <code>output</code> string, line by line</li>
 <p><li> If the current line prints \( \theta \), \( \Delta t \), and \( E \),
   split the line into these three pieces and store the data</li>
 <p><li> Store data in a dictionary <code>errors</code> with keys <code>dt</code> and
   the three \( \theta \) values</li>
</ul>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">errors <span style="color: #666666">=</span> {<span style="color: #BA2121">&#39;dt&#39;</span>: dt_values, <span style="color: #666666">1</span>: [], <span style="color: #666666">0</span>: [], <span style="color: #666666">0.5</span>: []}
<span style="color: #008000; font-weight: bold">for</span> line <span style="color: #AA22FF; font-weight: bold">in</span> output<span style="color: #666666">.</span>splitlines():
    words <span style="color: #666666">=</span> line<span style="color: #666666">.</span>split()
    <span style="color: #008000; font-weight: bold">if</span> words[<span style="color: #666666">0</span>] <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #BA2121">&#39;0.0&#39;</span>, <span style="color: #BA2121">&#39;0.5&#39;</span>, <span style="color: #BA2121">&#39;1.0&#39;</span>):  <span style="color: #408080; font-style: italic"># line with E?</span>
        <span style="color: #408080; font-style: italic"># typical line: 0.0   1.25:    7.463E+00</span>
        theta <span style="color: #666666">=</span> <span style="color: #008000">float</span>(words[<span style="color: #666666">0</span>])
        E <span style="color: #666666">=</span> <span style="color: #008000">float</span>(words[<span style="color: #666666">2</span>])
        errors[theta]<span style="color: #666666">.</span>append(E)
</pre></div>
<p>
Next: plot \( E \) versus \( \Delta t \) for \( \theta=0,0.5,1 \)

<p>
Complete program: <a href="http://tinyurl.com/jvzzcfn/decay/experiments/decay_exper1.py"><tt>experiments/decay_exper1.py</tt></a>.
Fine recipe for

<p>

<ul>
  <p><li> how to run other programs</li>
  <p><li> how to extract and interpret output from other programs</li>
  <p><li> how to automate many manual steps in creating simulations and figures</li>
</ul>

<!-- !split -->

<h3>Making a report <a name="decay:exper:report"></a></h3>

<p>

<ul>
 <p><li> Scientific investigations are best documented in a report!</li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/sphinx-cloud/">A sample report</a></li>
 <p><li> How can we write such a report?</li>
 <p><li> First problem: what format should I write in?</li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report_html.html">Plain HTML</a>, generated by <a href="http://tinyurl.com/jvzzcfn/decay/experiments/decay_exper1_html.py"><tt>decay_exper1_html.py</tt></a></li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report_html_mathjax.html">HTML with MathJax</a>, generated by <a href="http://tinyurl.com/jvzzcfn/decay/experiments/decay_exper1_html.py"><tt>decay_exper1_mathjax.py</tt></a></li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report.pdf">LaTeX PDF</a>, based on <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report.tex.html">LaTeX source</a></li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/sphinx-cloud/index.html">Sphinx HTML</a>, based on <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report_sphinx.rst.html">reStructuredText</a></li>
 <p><li> Markdown, MediaWiki, ...</li>
 <p><li> <a href="https://github.com/hplgit/doconce">Doconce</a> can generate LaTeX, HTML w/MathJax, Sphinx, Markdown, MediaWiki, ... (<a href="http://hplgit.github.com/INF5620/doc/writing_reports/report.do.txt.html">Doconce source</a> for the examples above, and Python program for <a href="http://tinyurl.com/jvzzcfn/decay/experiments/decay_exper1_do.py">generating the Doconce source</a>)</li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/">Examples on different report formats</a></li>
</ul>

<!-- !split -->

<h3>Publishing a complete project <a name="decay:exper:github"></a></h3>

<p>

<ul>
 <p><li> Make folder (directory) tree</li>
 <p><li> Keep track of all files via a <em>version control system</em> (Mercurial, Git, ...)</li>
 <p><li> Publish as private or public repository</li>
 <p><li> Utilize Bitbucket, Googlecode, GitHub, or similar</li>
 <p><li> See the <a href="http://hplgit.github.com/teamods/bitgit/html/">intro to such tools</a></li>
</ul>

<!-- !split -->

<h2>Analysis of finite difference equations <a name="decay:analysis"></a></h2>

<p>
Model:
$$
\begin{equation}
u'(t) = -au(t),\quad u(0)=I,
\end{equation}
$$


<p>
Method:
$$
\begin{equation}
u^{n+1} = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a\Delta t}u^n
\label{decay:analysis:scheme}
\end{equation}
$$


<p>
<div class="alert alert-block alert-question alert-text-normal"><b>Problem setting.</b>
How good is this method? Is it safe to use it?
</div>
<p>
<!-- !split -->

<h3>Encouraging numerical solutions  <a name="___sec136"></a></h3>

<p>
\( I=1 \), \( a=2 \), \( \theta =1,0.5, 0 \), \( \Delta t=1.25, 0.75, 0.5, 0.1 \).

<p>
<center><p><img src="fig-decay/BE4c.png" align="bottom" width=600,></p></center>

<p>
<!-- !split -->

<h3>Discouraging numerical solutions; Crank-Nicolson  <a name="___sec137"></a></h3>

<p>
<center><p><img src="fig-decay/CN4c.png" align="bottom" width=600,></p></center>

<p>
<!-- !split -->

<h3>Discouraging numerical solutions; Forward Euler  <a name="___sec138"></a></h3>

<p>
<center><p><img src="fig-decay/FE4c.png" align="bottom" width=600,></p></center>

<p>
<!-- !split -->

<h3>Summary of observations  <a name="___sec139"></a></h3>

<p>
The characteristics of the displayed curves can be summarized as follows:

<p>

<ul>
  <p><li> The Backward Euler scheme <em>always</em> gives a monotone solution, lying above
    the exact curve.</li>
  <p><li> The Crank-Nicolson scheme gives the most accurate results, but for
    \( \Delta t=1.25 \) the solution oscillates.</li>
  <p><li> The Forward Euler scheme gives a growing, oscillating solution for
    \( \Delta t=1.25 \); a decaying, oscillating solution for \( \Delta t=0.75 \);
    a strange solution \( u^n=0 \) for \( n\geq 1 \) when \( \Delta t=0.5 \); and
    a solution seemingly as accurate as the one by the Backward Euler
    scheme for \( \Delta t = 0.1 \), but the curve lies <em>below</em> the exact
    solution.</li>
</ul>

<!-- !split -->

<h3>Problem setting  <a name="___sec140"></a></h3>

<p>
<div class="alert alert-block alert-notice alert-text-normal"><b>Goal.</b>
We ask the question

<p>

<ul>
  <p><li> Under what circumstances, i.e., values of
    the input data \( I \), \( a \), and \( \Delta t \) will the Forward Euler and
    Crank-Nicolson schemes result in undesired oscillatory solutions?</li>
</ul>

Techniques of investigation:

<p>

<ul>
 <p><li> Numerical experiments</li>
 <p><li> Mathematical analysis</li>
</ul>

Another question to be raised is

<p>

<ul>
 <p><li> How does \( \Delta t \) impact the error in the numerical solution?</li>
</ul>
</div>
<p>
<!-- !split -->

<h3>Experimental investigation of oscillatory solutions  <a name="___sec141"></a></h3>

<p>
The solution is oscillatory if
$$ u^{n} > u^{n-1},$$


<p>
<center><p><img src="fig-decay/osc_region_FE.png" align="bottom" width=400></p></center>

<p>
Seems that \( a\Delta t < 1 \) for FE and 2 for CN.

<p>
<!-- !split -->

<h3>Exact numerical solution  <a name="___sec142"></a></h3>

<p>
Starting with \( u^0=I \), the simple recursion \eqref{decay:analysis:scheme}
can be applied repeatedly \( n \) times, with the result that

<p>
$$
\begin{equation}
u^{n} = IA^n,\quad A = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a\Delta t}\thinspace .
\label{decay:analysis:unex}
\end{equation}
$$


<p>
Such an exact discrete solution is unusual, but very handy for analysis.

<p>
<!-- !split -->

<h3>Stability  <a name="___sec143"></a></h3>

<p>
Since \( u^n\sim A^n \),

<p>

<ul>
 <p><li> \( A<0 \) gives a factor \( (-1)^n \) and oscillatory solutions</li>
 <p><li> \( |A|>1 \) gives growing solutions</li>
 <p><li> Recall: the exact solution is <em>monotone</em> and <em>decaying</em></li>
 <p><li> If these qualitative properties are not met, we say that the
   numerical solution is <em>unstable</em></li>
</ul>

<!-- !split -->

<h3>Computation of stability in this problem  <a name="___sec144"></a></h3>

<p>
\( A<0 \) if

<p>
$$
\frac{1 - (1-\theta) a\Delta t}{1 + \theta a\Delta t} < 0
$$

To avoid oscillatory solutions we must have \( A> 0 \) and

<p>
$$
\begin{equation}
\Delta t < \frac{1}{(1-\theta)a}\thinspace .
\end{equation}
$$


<p>

<ul>
 <p><li> Always fulfilled for Backward Euler</li>
 <p><li> \( \Delta t \leq 1/a \) for Forward Euler</li>
 <p><li> \( \Delta t \leq 2/a \) for Crank-Nicolson</li>
</ul>

<!-- !split -->

<h3>Computation of stability in this problem  <a name="___sec145"></a></h3>

<p>
\( |A|\leq 1 \) means \( -1\leq A\leq 1 \)

<p>
$$
\begin{equation}
-1\leq\frac{1 - (1-\theta) a\Delta t}{1 + \theta a\Delta t} \leq 1\ts
\label{decay:th:stability}
\end{equation}
$$

\( -1 \) is the critical limit:

<p>
$$
\begin{align*}
\Delta t &\leq \frac{2}{(1-2\theta)a},\quad \theta < \frac{1}{2}\\ 
\Delta t &\geq \frac{2}{(1-2\theta)a},\quad \theta > \frac{1}{2}
\end{align*}
$$


<p>

<ul>
 <p><li> Always fulfilled for Backward Euler and Crank-Nicolson</li>
 <p><li> \( \Delta t \leq 2/a \) for Forward Euler</li>
</ul>

<!-- !split -->

<h3>Explanation of problems with Forward Euler  <a name="___sec146"></a></h3>

<p>
<center><p><img src="fig-decay/FE4c.png" align="bottom" width=500,></p></center>

<p>

<ul>
 <p><li> \( a\Delta t= 2\cdot 1.25=2.5 \) and \( A=-1.5 \): oscillations and growth</li>
 <p><li> \( a\Delta t = 2\cdot 0.75=1.5 \) and \( A=-0.5 \): oscillations and decay</li>
 <p><li> \( \Delta t=0.5 \) and \( A=0 \): \( u^n=0 \) for \( n>0 \)</li>
 <p><li> Smaller \( Delta t \): qualitatively correct solution</li>
</ul>

<!-- !split -->

<h3>Explanation of problems with Crank-Nicolson  <a name="___sec147"></a></h3>

<p>
<center><p><img src="fig-decay/CN4c.png" align="bottom" width=500,></p></center>

<p>

<ul>
 <p><li> \( \Delta t=1.25 \) and \( A=-0.25 \): oscillatory solution</li>
 <p><li> Never any growing solution</li>
</ul>

<!-- !split -->

<h3>Summary of stability  <a name="___sec148"></a></h3>

<p>

<ol>
<p><li> Forward Euler is <em>conditionally stable</em></li>

<ul>
   <p><li> \( \Delta t < 2/a \) for avoiding growth</li>
   <p><li> \( \Delta t\leq 1/a \) for avoiding oscillations</li>
</ul>

<p><li> The Crank-Nicolson is <em>unconditionally stable</em> wrt growth
   and conditionally stable wrt oscillations</li>

<ul>
   <p><li> \( \Delta t < 2/a \) for avoiding oscillations</li>
</ul>

<p><li> Backward Euler is unconditionally stable</li>
</ol>

<!-- !split -->

<h3>Comparing amplification factors  <a name="___sec149"></a></h3>

<p>
\( u^{n+1} \) is an amplification \( A \) of \( u^n \):

<p>
$$ u^{n+1} = Au^n,\quad A = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a\Delta t} $$


<p>
The exact solution is also an amplification:

<p>
$$ u(t_{n+1}) = \Aex u(t_n), \quad \Aex = e^{-a\Delta t}$$


<p>
A possible measure of accuracy: \( \Aex - A \)

<p>
<!-- !split -->

<h3>Plot of amplification factors  <a name="___sec150"></a></h3>

<p>
<center><p><img src="fig-decay/A_factors.png" align="bottom" width=600></p></center>

<p>
<!-- !split -->

<h3>Series expansion of amplification factors  <a name="___sec151"></a></h3>

<p>
To investigate \( \Aex - A \) mathematically, we
can Taylor expand the expression, using \( p=a\Delta t \) as variable.

<p>

<!-- code=text (from !bc ipy) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">&gt;&gt;&gt; from sympy import *
&gt;&gt;&gt; # Create p as a mathematical symbol with name &#39;p&#39;
&gt;&gt;&gt; p = Symbol(&#39;p&#39;)
&gt;&gt;&gt; # Create a mathematical expression with p
&gt;&gt;&gt; A_e = exp(-p)
&gt;&gt;&gt;
&gt;&gt;&gt; # Find the first 6 terms of the Taylor series of A_e
&gt;&gt;&gt; A_e.series(p, 6)
1 + (1/2)*p**2 - p - 1/6*p**3 - 1/120*p**5 + (1/24)*p**4 + O(p**6)

&gt;&gt;&gt; theta = Symbol(&#39;theta&#39;)
&gt;&gt;&gt; A = (1-(1-theta)*p)/(1+theta*p)
&gt;&gt;&gt; FE = A_e.series(p, 4) - A.subs(theta, 0).series(p, 4)
&gt;&gt;&gt; BE = A_e.series(p, 4) - A.subs(theta, 1).series(p, 4)
&gt;&gt;&gt; half = Rational(1,2)  # exact fraction 1/2
&gt;&gt;&gt; CN = A_e.series(p, 4) - A.subs(theta, half).series(p, 4)
&gt;&gt;&gt; FE
(1/2)*p**2 - 1/6*p**3 + O(p**4)
&gt;&gt;&gt; BE
-1/2*p**2 + (5/6)*p**3 + O(p**4)
&gt;&gt;&gt; CN
(1/12)*p**3 + O(p**4)
</pre></div>
<p>
<!-- !split -->

<h3>Error in amplification factors  <a name="___sec152"></a></h3>

<p>
Focus: the error measure \( A-\Aex \) as function of \( \Delta t \) (recall that \( p=a\Delta t \)):

<p>
$$
\begin{equation}
A-\Aex = \left\lbrace\begin{array}{ll}
\Oof{\Delta t^2}, & \hbox{Forward and Backward Euler},\\ 
\Oof{\Delta t^3}, & \hbox{Crank-Nicolson}
\end{array}\right.
\end{equation}
$$


<p>
<!-- !split -->

<h3>The fraction of numerical and exact amplification factors  <a name="___sec153"></a></h3>

<p>
Focus: the error measure \( 1-A/\Aex \) as function of \( p=a\Delta t \):

<p>

<!-- code=text (from !bc ipy) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">&gt;&gt;&gt; FE = 1 - (A.subs(theta, 0)/A_e).series(p, 4)
&gt;&gt;&gt; BE = 1 - (A.subs(theta, 1)/A_e).series(p, 4)
&gt;&gt;&gt; CN = 1 - (A.subs(theta, half)/A_e).series(p, 4)
&gt;&gt;&gt; FE
(1/2)*p**2 + (1/3)*p**3 + O(p**4)
&gt;&gt;&gt; BE
-1/2*p**2 + (1/3)*p**3 + O(p**4)
&gt;&gt;&gt; CN
(1/12)*p**3 + O(p**4)
</pre></div>
<p>
Same leading-order terms as for the error measure \( A-\Aex \).

<p>
<!-- !split -->

<h3>The true/global error at a point <a name="decay:analysis:gobal:error"></a></h3>

<p>

<ul>
 <p><li> The error in \( A \) reflects the <em>local error</em> when going from one
   time step to the next</li>
 <p><li> What is the <em>global (true) error</em> at \( t_n \)?
   \( e^n = \uex(t_n) - u^n = Ie^{-at_n} - IA^n \)</li>
 <p><li> Taylor series expansions of \( e^n \) simplify the expression</li>
</ul>

<!-- !split -->

<h3>Computing the global error at a point  <a name="___sec155"></a></h3>

<p>

<!-- code=text (from !bc ipy) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">&gt;&gt;&gt; n = Symbol(&#39;n&#39;)
&gt;&gt;&gt; u_e = exp(-p*n)   # I=1
&gt;&gt;&gt; u_n = A**n        # I=1
&gt;&gt;&gt; FE = u_e.series(p, 4) - u_n.subs(theta, 0).series(p, 4)
&gt;&gt;&gt; BE = u_e.series(p, 4) - u_n.subs(theta, 1).series(p, 4)
&gt;&gt;&gt; CN = u_e.series(p, 4) - u_n.subs(theta, half).series(p, 4)
&gt;&gt;&gt; FE
(1/2)*n*p**2 - 1/2*n**2*p**3 + (1/3)*n*p**3 + O(p**4)
&gt;&gt;&gt; BE
(1/2)*n**2*p**3 - 1/2*n*p**2 + (1/3)*n*p**3 + O(p**4)
&gt;&gt;&gt; CN
(1/12)*n*p**3 + O(p**4)
</pre></div>
<p>
Substitute \( n \) by \( t/\Delta t \):

<p>

<ul>
 <p><li> Forward and Backward Euler: leading order term \( \frac{1}{2}ta^2\Delta t \)</li>
 <p><li> Crank-Nicolson: leading order term \( \frac{1}{12}ta^3\Delta t^2 \)</li>
</ul>

<!-- !split -->

<h3>Convergence  <a name="___sec156"></a></h3>

<p>
The numerical scheme is convergent if the global error
\( e^n\rightarrow 0 \) as \( \Delta t\rightarrow 0 \).
If the error has a leading order term \( \Delta t^r \), the
convergence rate is of order \( r \).

<p>
<!-- !split -->

<h3>Integrated errors  <a name="___sec157"></a></h3>

<p>
Focus: norm of the numerical error

<p>
$$ ||e^n||_{\ell^2} = \sqrt{\Delta t\sum_{n=0}^{N_t} ({\uex}(t_n) - u^n)^2}
\ts $$


<p>
Forward and Backward Euler:

<p>
$$ ||e^n||_{\ell^2} = \frac{1}{4}\sqrt{\frac{T^3}{3}} a^2\Delta t\ts$$


<p>
Crank-Nicolson:

<p>
$$ ||e^n||_{\ell^2} = \frac{1}{12}\sqrt{\frac{T^3}{3}}a^3\Delta t^2\ts$$


<p>
<div class="alert alert-block alert-summary alert-text-normal"><b>Summary of errors.</b>
Analysis of both the pointwise and the time-integrated true errors:

<p>

<ul>
  <p><li> 1st order for Forward and Backward Euler</li>
  <p><li> 2nd order for Crank-Nicolson</li>
</ul>
</div>
<p>
<!-- !split -->

<h3>Truncation error  <a name="___sec158"></a></h3>

<p>

<ul>
 <p><li> How good is the discrete equation?</li>
 <p><li> Possible answer: see how well \( \uex \) fits the discrete equation</li>
</ul>

$$ \lbrack D_t u = -au\rbrack^n,$$

i.e.,

<p>
$$ \frac{u^{n+1}-u^n}{\Delta t} = -au^n\ts$$

Insert \( \uex \) (which does not in general fulfill this equation):

<p>
$$
\begin{equation}
\frac{\uex(t_{n+1})-\uex(t_n)}{\Delta t} + a\uex(t_n) = R^n \neq 0
\ts
\label{decay:analysis:trunc:Req}
\end{equation}
$$


<p>
<!-- !split -->

<h3>Computation of the truncation error  <a name="___sec159"></a></h3>

<p>

<ul>
 <p><li> The residual \( R^n \) is the <em>truncation error</em>.</li>
 <p><li> How does \( R^n \) vary with \( \Delta t \)?</li>
</ul>

Tool: Taylor expand \( \uex \) around the point where the ODE is sampled
(here \( t_n \))

<p>
$$ \uex(t_{n+1}) = \uex(t_n) + \uex'(t_n)\Delta t + \frac{1}{2}\uex''(t_n)
\Delta t^2 + \cdots $$

Inserting this Taylor series in \eqref{decay:analysis:trunc:Req} gives

<p>
$$ R^n = \uex'(t_n) + \frac{1}{2}\uex''(t_n)\Delta t + \ldots + a\uex(t_n)\ts$$

Now, \( \uex \) solves the ODE \( \uex'=-a\uex \), and then

<p>
$$ R^n \approx \frac{1}{2}\uex''(t_n)\Delta t \ts $$

This is a mathematical expression for the truncation error.

<p>
<!-- !split -->

<h3>The truncation error for other schemes  <a name="___sec160"></a></h3>

<p>
Backward Euler:

<p>
$$ R^n \approx -\frac{1}{2}\uex''(t_n)\Delta t, $$


<p>
Crank-Nicolson:

<p>
$$ R^{n+1/2} \approx \frac{1}{24}\uex'''(t_{n+\frac{1}{2}})\Delta t^2\ts$$


<p>
<!-- !split -->

<h3>Consistency, stability, and convergence  <a name="___sec161"></a></h3>

<p>

<ul>
  <p><li> Truncation error measures the residual in the difference equations.
    The scheme is <em>consistent</em> if the truncation error goes to 0
    as \( \Delta t\rightarrow 0 \). Importance: the difference equations
    approaches the differential equation as \( \Delta t\rightarrow 0 \).</li>
  <p><li> <em>Stability</em> means that the numerical solution exhibits the same
    qualitative properties as the exact solution. Here: monotone,
    decaying function.</li>
  <p><li> <em>Convergence</em> implies that the true (global) error
    \( e^n =\uex(t_n)-u^n\rightarrow 0 \) as \( \Delta t\rightarrow 0 \).
    This is really what we want!</li>
</ul>

The Lax equivalence theorem for <em>linear</em> differential equations:
consistency + stability is equivalent with convergence.

<p>
(Consistency and stability is in most problems
much easier to establish than
convergence.)

<p>
<!-- !split -->

<h2>Model extensions <a name="decay:generalizations"></a></h2>

<p>
<!-- !split -->

<h3>Extension to a variable coefficient; Forward and Backward Euler  <a name="___sec163"></a></h3>

<p>
$$
\begin{equation}
u'(t) = -a(t)u(t),\quad t\in (0,T],\quad u(0)=I \thinspace .
\label{decay:problem:a}
\end{equation}
$$


<p>
The Forward Euler scheme:

<p>
$$
\begin{equation}
\frac{u^{n+1} - u^n}{\Delta t} = -a(t_n)u^n
\thinspace .
\end{equation}
$$


<p>
The Backward Euler scheme:
$$
\begin{equation}
\frac{u^{n} - u^{n-1}}{\Delta t} = -a(t_n)u^n
\thinspace .
\end{equation}
$$


<p>
<!-- !split -->

<h3>Extension to a variable coefficient; Crank-Nicolson  <a name="___sec164"></a></h3>

<p>
Eevaluting \( a(t_{n+\frac{1}{2}}) \) and
using an average for \( u \):
$$
\begin{equation}
\frac{u^{n+1} - u^{n}}{\Delta t} = -a(t_{n+\frac{1}{2}})\frac{1}{2}(u^n + u^{n+1})
\thinspace .
\end{equation}
$$


<p>
Using an average for \( a \) and \( u \):
$$
\begin{equation}
\frac{u^{n+1} - u^{n}}{\Delta t} = -\frac{1}{2}(a(t_n)u^n + a(t_{n+1})u^{n+1})
\thinspace .
\end{equation}
$$


<p>
<!-- !split -->

<h3>Extension to a variable coefficient; \( \theta \)-rule  <a name="___sec165"></a></h3>

<p>
The \( \theta \)-rule unifies the three mentioned schemes,

<p>
$$
\begin{equation}
\frac{u^{n+1} - u^{n}}{\Delta t} = -a((1-\theta)t_n + \theta t_{n+1})((1-\theta) u^n + \theta u^{n+1})
\thinspace .
\end{equation}
$$

or,
$$
\begin{equation}
\frac{u^{n+1} - u^{n}}{\Delta t} = -(1-\theta) a(t_n)u^n - \theta
a(t_{n+1})u^{n+1}
\thinspace .
\end{equation}
$$


<p>
<!-- !split -->

<h3>Extension to a variable coefficient; operator notation  <a name="___sec166"></a></h3>

<p>
$$
\begin{align*}
\lbrack D^+_t u &= -au\rbrack^n,\\ 
\lbrack D^-_t u &= -au\rbrack^n,\\ 
\lbrack D_t u &= -a\overline{u}^t\rbrack^{n+\frac{1}{2}},\\ 
\lbrack D_t u &= -\overline{au}^t\rbrack^{n+\frac{1}{2}},\\ 
\thinspace .
\end{align*}
$$


<p>
<!-- !split -->

<h3>Extension to a source term <a name="decay:source"></a></h3>

<p>
$$
\begin{equation}
u'(t) = -a(t)u(t) + b(t),\quad t\in (0,T],\quad u(0)=I
\thinspace .
\label{decay:problem:ab}
\end{equation}
$$


<p>
$$
\begin{align*}
\lbrack D^+_t u &= -au + b\rbrack^n,\\ 
\lbrack D^-_t u &= -au + b\rbrack^n,\\ 
\lbrack D_t u   &= -a\overline{u}^t + b\rbrack^{n+\frac{1}{2}},\\ 
\lbrack D_t u   &= \overline{-au+b}^t\rbrack^{n+\frac{1}{2}}
\thinspace .
\end{align*}
$$


<p>
<!-- !split -->

<h3>Implementation of the generalized model problem <a name="decay:general"></a></h3>

<p>
$$
\begin{equation}
u^{n+1} = ((1 - \Delta t(1-\theta)a^n)u^n
+ \Delta t(\theta b^{n+1} + (1-\theta)b^n))(1 + \Delta t\theta a^{n+1})^{-1}
\thinspace .
\end{equation}
$$


<p>
Implementation where \( a(t) \) and \( b(t) \) are given as
Python functions (see file <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/decay_vc.py"><tt>decay_vc.py</tt></a>):

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, a, b, T, dt, theta):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Solve u&#39;=-a(t)*u + b(t), u(0)=I,</span>
<span style="color: #BA2121; font-style: italic">    for t in (0,T] with steps of dt.</span>
<span style="color: #BA2121; font-style: italic">    a and b are Python functions of t.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    dt <span style="color: #666666">=</span> <span style="color: #008000">float</span>(dt)            <span style="color: #408080; font-style: italic"># avoid integer division</span>
    Nt <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #008000">round</span>(T<span style="color: #666666">/</span>dt))     <span style="color: #408080; font-style: italic"># no of time intervals</span>
    T <span style="color: #666666">=</span> Nt<span style="color: #666666">*</span>dt                 <span style="color: #408080; font-style: italic"># adjust T to fit time step dt</span>
    u <span style="color: #666666">=</span> zeros(Nt<span style="color: #666666">+1</span>)           <span style="color: #408080; font-style: italic"># array of u[n] values</span>
    t <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, Nt<span style="color: #666666">+1</span>)  <span style="color: #408080; font-style: italic"># time mesh</span>

    u[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> I                  <span style="color: #408080; font-style: italic"># assign initial condition</span>
    <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">0</span>, Nt):    <span style="color: #408080; font-style: italic"># n=0,1,...,Nt-1</span>
        u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> ((<span style="color: #666666">1</span> <span style="color: #666666">-</span> dt<span style="color: #666666">*</span>(<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a(t[n]))<span style="color: #666666">*</span>u[n] <span style="color: #666666">+</span> \ 
                  dt<span style="color: #666666">*</span>(theta<span style="color: #666666">*</span>b(t[n<span style="color: #666666">+1</span>]) <span style="color: #666666">+</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>b(t[n])))<span style="color: #666666">/</span>\ 
                  (<span style="color: #666666">1</span> <span style="color: #666666">+</span> dt<span style="color: #666666">*</span>theta<span style="color: #666666">*</span>a(t[n<span style="color: #666666">+1</span>]))
    <span style="color: #008000; font-weight: bold">return</span> u, t
</pre></div>
<p>
<!-- !split -->

<h3>Implementations of variable coefficients; functions  <a name="___sec169"></a></h3>

<p>
Plain functions:

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">a</span>(t):
    <span style="color: #008000; font-weight: bold">return</span> a_0 <span style="color: #008000; font-weight: bold">if</span> t <span style="color: #666666">&lt;</span> tp <span style="color: #008000; font-weight: bold">else</span> k<span style="color: #666666">*</span>a_0

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">b</span>(t):
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">1</span>
</pre></div>
<p>
<!-- !split -->

<h3>Implementations of variable coefficients; classes  <a name="___sec170"></a></h3>

<p>
Better implementation: class with the parameters <code>a0</code>, <code>tp</code>, and <code>k</code>
as attributes and a <em>special method</em> <code>__call__</code> for evaluating \( a(t) \):

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">A</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, a0<span style="color: #666666">=1</span>, k<span style="color: #666666">=2</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>a0, <span style="color: #008000">self</span><span style="color: #666666">.</span>k <span style="color: #666666">=</span> a0, k

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__call__</span>(<span style="color: #008000">self</span>, t):
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>a0 <span style="color: #008000; font-weight: bold">if</span> t <span style="color: #666666">&lt;</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>tp <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>k<span style="color: #666666">*</span><span style="color: #008000">self</span><span style="color: #666666">.</span>a0

a <span style="color: #666666">=</span> A(a0<span style="color: #666666">=2</span>, k<span style="color: #666666">=1</span>)  <span style="color: #408080; font-style: italic"># a behaves as a function a(t)</span>
</pre></div>
<p>
<!-- !split -->

<h3>Implementations of variable coefficients; lambda function  <a name="___sec171"></a></h3>

<p>
Quick writing: a one-liner <em>lambda function</em>
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">a <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">lambda</span> t: a_0 <span style="color: #008000; font-weight: bold">if</span> t <span style="color: #666666">&lt;</span> tp <span style="color: #008000; font-weight: bold">else</span> k<span style="color: #666666">*</span>a_0
</pre></div>
<p>
In general,
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">f <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">lambda</span> arg1, arg2, <span style="color: #666666">...</span>: expressin
</pre></div>
<p>
is equivalent to
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">f</span>(arg1, arg2, <span style="color: #666666">...</span>):
    <span style="color: #008000; font-weight: bold">return</span> expression
</pre></div>
<p>
One can use lambda functions directly in calls:
<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">u, t <span style="color: #666666">=</span> solver(<span style="color: #666666">1</span>, <span style="color: #008000; font-weight: bold">lambda</span> t: <span style="color: #666666">1</span>, <span style="color: #008000; font-weight: bold">lambda</span> t: <span style="color: #666666">1</span>, T, dt, theta)
</pre></div>
<p>
for a problem \( u'=-u+1 \), \( u(0)=1 \).

<p>
A lambda function can appear anywhere where a variable can appear.

<p>
<!-- !split -->

<h3>Verification via trivial solutions <a name="decay:verify:trivial"></a></h3>

<p>

<ul>
 <p><li> Start debugging of a new code with trying a problem
   where \( u=\hbox{const} \neq 0 \).</li>
 <p><li> Choose \( u=C \) (a constant). Choose any \( a(t) \) and set
   \( b=a(t)C \) and
   \( I=C \).</li>
 <p><li> "All" numerical methods will reproduce \( u=_{\hbox{const}} \)
   exactly (machine precision).</li>
 <p><li> Often \( u=C \) eases debugging.</li>
 <p><li> In this example: <em>any error</em> in the formula for \( u^{n+1} \)
   make \( u\neq C \)!</li>
</ul>

<!-- !split -->

<h3>Verification via trivial solutions; nose test  <a name="___sec173"></a></h3>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">nose.tools</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">nt</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_constant_solution</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Test problem where u=u_const is the exact solution, to be</span>
<span style="color: #BA2121; font-style: italic">    reproduced (to machine precision) by any relevant method.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(t):
        <span style="color: #008000; font-weight: bold">return</span> u_const

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">a</span>(t):
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">2.5*</span>(<span style="color: #666666">1+</span>t<span style="color: #666666">**3</span>)  <span style="color: #408080; font-style: italic"># can be arbitrary</span>

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">b</span>(t):
        <span style="color: #008000; font-weight: bold">return</span> a(t)<span style="color: #666666">*</span>u_const

    u_const <span style="color: #666666">=</span> <span style="color: #666666">2.15</span>
    theta <span style="color: #666666">=</span> <span style="color: #666666">0.4</span>; I <span style="color: #666666">=</span> u_const; dt <span style="color: #666666">=</span> <span style="color: #666666">4</span>
    Nt <span style="color: #666666">=</span> <span style="color: #666666">4</span>  <span style="color: #408080; font-style: italic"># enough with a few steps</span>
    u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, b<span style="color: #666666">=</span>b, T<span style="color: #666666">=</span>Nt<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)
    <span style="color: #008000; font-weight: bold">print</span> u
    u_e <span style="color: #666666">=</span> exact_solution(t)
    difference <span style="color: #666666">=</span> <span style="color: #008000">abs</span>(u_e <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()  <span style="color: #408080; font-style: italic"># max deviation</span>
    nt<span style="color: #666666">.</span>assert_almost_equal(difference, <span style="color: #666666">0</span>, places<span style="color: #666666">=14</span>)
</pre></div>
<p>
<!-- !split -->

<h3>Verification via manufactured solutions <a name="decay:MMS"></a></h3>

<p>

<ul>
 <p><li> Choose <em>any</em> formula for \( u(t) \).</li>
 <p><li> Fit \( I \), \( a(t) \), and \( b(t) \) in \( u'=-au+b \), \( u(0)=I \),
   to make the chosen formula a solution of the ODE problem.</li>
 <p><li> Then we can always have an analytical solution (!).</li>
 <p><li> Ideal for verification: testing convergence rates.</li>
 <p><li> Called the <em>method of manufactured solutions</em> (MMS)</li>
 <p><li> Special case: \( u \) linear in \( t \), because all sound numerical
   methods will reproduce a linear \( u \) exactly (machine precision).</li>
 <p><li> \( u(t) = ct + d \). \( u(0)=0 \) means \( d=I \).</li>
 <p><li> ODE implies \( c = -a(t)u + b(t) \).</li>
 <p><li> Choose \( a(t) \) and \( c \), and set \( b(t) = c + a(t)(ct + I) \).</li>
 <p><li> Any error in the formula for \( u^{n+1} \) makes \( u\neq ct+I \)!</li>
</ul>

<!-- !split -->

<h3>Linear manufactured solution  <a name="___sec175"></a></h3>

<p>
\( u^n = ct_n+I \) fulfills the discrete
equations!

<p>
First,
$$
\begin{align}
\lbrack D_t^+ t\rbrack^n &= \frac{t_{n+1}-t_n}{\Delta t}=1,
\label{decay:fd2:Dop:tn:fw}\\ 
\lbrack D_t^- t\rbrack^n &= \frac{t_{n}-t_{n-1}}{\Delta t}=1,
\label{decay:fd2:Dop:tn:bw}\\ 
\lbrack D_t t\rbrack^n &= \frac{t_{n+\frac{1}{2}}-t_{n-\frac{1}{2}}}{\Delta t}=\frac{(n+\frac{1}{2})\Delta t - (n-\frac{1}{2})\Delta t}{\Delta t}=1\label{decay:fd2:Dop:tn:cn}
\thinspace .
\end{align}
$$


<p>
Forward Euler:

<p>
$$ [D^+ u = -au + b]^n, $$


<p>
\( a^n=a(t_n) \), \( b^n=c + a(t_n)(ct_n + I) \), and \( u^n=ct_n + I \)
results in

<p>
$$ c = -a(t_n)(ct_n+I) + c + a(t_n)(ct_n + I) = c $$


<p>
<!-- !split -->

<h3>Nose test for linear manufactured solution  <a name="___sec176"></a></h3>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_linear_solution</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Test problem where u=c*t+I is the exact solution, to be</span>
<span style="color: #BA2121; font-style: italic">    reproduced (to machine precision) by any relevant method.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(t):
        <span style="color: #008000; font-weight: bold">return</span> c<span style="color: #666666">*</span>t <span style="color: #666666">+</span> I

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">a</span>(t):
        <span style="color: #008000; font-weight: bold">return</span> t<span style="color: #666666">**0.5</span>  <span style="color: #408080; font-style: italic"># can be arbitrary</span>

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">b</span>(t):
        <span style="color: #008000; font-weight: bold">return</span> c <span style="color: #666666">+</span> a(t)<span style="color: #666666">*</span>exact_solution(t)

    theta <span style="color: #666666">=</span> <span style="color: #666666">0.4</span>; I <span style="color: #666666">=</span> <span style="color: #666666">0.1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">0.1</span>; c <span style="color: #666666">=</span> <span style="color: #666666">-0.5</span>
    T <span style="color: #666666">=</span> <span style="color: #666666">4</span>
    Nt <span style="color: #666666">=</span> <span style="color: #008000">int</span>(T<span style="color: #666666">/</span>dt)  <span style="color: #408080; font-style: italic"># no of steps</span>
    u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, b<span style="color: #666666">=</span>b, T<span style="color: #666666">=</span>Nt<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)
    u_e <span style="color: #666666">=</span> exact_solution(t)
    difference <span style="color: #666666">=</span> <span style="color: #008000">abs</span>(u_e <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()  <span style="color: #408080; font-style: italic"># max deviation</span>
    <span style="color: #008000; font-weight: bold">print</span> difference
    <span style="color: #408080; font-style: italic"># No of decimal places for comparison depend on size of c</span>
    nt<span style="color: #666666">.</span>assert_almost_equal(difference, <span style="color: #666666">0</span>, places<span style="color: #666666">=14</span>)
</pre></div>
<p>
<!-- !split -->

<h3>Extension to systems of ODEs  <a name="___sec177"></a></h3>

<p>
Sample system:

<p>
$$
\begin{align}
u' &= a u + bv,\\ 
v' &= cu +  dv,
\end{align}
$$


<p>
The Forward Euler method:

<p>
$$
\begin{align}
u^{n+1} &= u^n + \Delta t (a u^n + b v^n),\\ 
v^{n+1} &= u^n + \Delta t (cu^n + dv^n)
\thinspace .
\end{align}
$$


<p>
<!-- !split -->

<h3>The Backward Euler method gives a system of algebraic equations  <a name="___sec178"></a></h3>

<p>
The Backward Euler scheme:

<p>
$$
\begin{align}
u^{n+1} &= u^n + \Delta t (a u^{n+1} + b v^{n+1}),\\ 
v^{n+1} &= v^n + \Delta t (c u^{n+1} + d v^{n+1})\ts
\end{align}
$$

which is a \( 2\times 2 \) linear system:

<p>
$$
\begin{align}
(1 - \Delta t a)u^{n+1} + bv^{n+1} &= u^n ,\\ 
c u^{n+1} + (1 - \Delta t d) v^{n+1} &= v^n ,
\end{align}
$$


<p>
Crank-Nicolson also gives a \( 2\times 2 \) linear system.

<p>
<!-- !split -->

<h2>General first-order ODEs <a name="decay:1stODEs"></a></h2>

<p>
<!-- !split -->

<h3>Generic form  <a name="___sec180"></a></h3>

<p>
The standard form for ODEs:
$$
\begin{equation}
u' = f(u,t),\quad u(0)=I,
\label{decay:ode:general}
\end{equation}
$$


<p>
\( u \) and \( f \): scalar or vector.

<p>
Vectors in case of ODE systems:
$$ u(t) = (u^{(0)}(t),u^{(1)}(t),\ldots,u^{(m-1)}(t)) \thinspace . $$


<p>
$$
\begin{align*}
f(u, t) = ( & f^{(0)}(u^{(0)},\ldots,u^{(m-1)}),\\ 
            & f^{(1)}(u^{(0)},\ldots,u^{(m-1)}),\\ 
            & \vdots\\ 
            & f^{(m-1)}(u^{(0)}(t),\ldots,u^{(m-1)}(t)))
\thinspace .
\end{align*}
$$


<p>
<!-- !split -->

<h3>The \( \theta \)-rule  <a name="___sec181"></a></h3>

<p>
$$
\begin{equation}
\frac{u^{n+1}-u^n}{\Delta t} = \theta f(u^{n+1},t_{n+1}) +
(1-\theta)f(u^n, t_n)\ts
\label{decay:fd2:theta}
\end{equation}
$$

Bringing the unknown \( u^{n+1} \) to the left-hand side and the known terms
on the right-hand side gives

<p>
$$
\begin{equation}
u^{n+1} - \Delta t \theta f(u^{n+1},t_{n+1}) =
u^n + \Delta t(1-\theta)f(u^n, t_n)\ts
\end{equation}
$$

This is a <em>nonlinear</em> equation in \( u^{n+1} \) (unless \( f \) is linear in \( u \))!

<p>
<!-- !split -->

<h3>Implicit 2-step backward scheme  <a name="___sec182"></a></h3>

<p>
$$ u'(t_{n+1}) \approx \frac{3u^{n+1} - 4u^{n} + u^{n-1}}{2\Delta t},$$


<p>
Scheme:
$$ u^{n+1} = \frac{4}{3}u^n - \frac{1}{3}u^{n-1} +
\frac{2}{3}\Delta t f(u^{n+1}, t_{n+1})
\thinspace .
\label{decay:fd2:bw:2step}
$$

Nonlinear equation for \( u^{n+1} \).

<h3>The Leapfrog scheme  <a name="___sec183"></a></h3>

<p>
Idea:
$$
\begin{equation}
u'(t_n)\approx \frac{u^{n+1}-u^{n-1}}{2\Delta t} = [D_{2t} u]^n,
\end{equation}
$$


<p>
Scheme:

<p>
$$ [D_{2t} u = f(u,t)]^n,$$

or written out,
$$
\begin{equation}
u^{n+1} = u^{n-1} + \Delta t f(u^n, t_n)
\thinspace .
\label{decay:fd2:leapfrog}
\end{equation}
$$


<p>

<ul>
 <p><li> Some other scheme must be used as starter (\( u^1 \)).</li>
 <p><li> Explicit scheme - a nonlinear \( f \) (in \( u \)) is trivial to handle.</li>
 <p><li> Downside: Leapfrog is always unstable after some time.</li>
</ul>

<!-- !split -->

<h3>The filtered Leapfrog scheme  <a name="___sec184"></a></h3>

<p>
After computing \( u^{n+1} \), stabilize Leapfrog by
$$
\begin{equation}
u^n\ \leftarrow\ u^n + \gamma (u^{n-1} - 2u^n + u^{n+1})
\label{decay:fd2:leapfrog:filtered}
\thinspace .
\end{equation}
$$


<p>
<!-- !split -->

<h3>2nd-order Runge-Kutta scheme  <a name="___sec185"></a></h3>

<p>
Forward-Euler + approximate Crank-Nicolson:
$$
\begin{align}
u^* &= u^n + \Delta t f(u^n, t_n),
\label{decay:fd2:RK2:s1}\\ 
u^{n+1} &= u^n + \Delta t \frac{1}{2} \left( f(u^n, t_n) + f(u^*, t_{n+1})
\right),
\label{decay:fd2:RK2:s2}
\end{align}
$$


<p>
<!-- !split -->

<h3>4th-order Runge-Kutta scheme <a name="decay:fd2:RK4"></a></h3>

<p>

<ul>
 <p><li> The most famous and widely used ODE method</li>
 <p><li> 4 evaluations of \( f \) per time step</li>
 <p><li> Its <a href="http://tinyurl.com/k3sdbuv/pub/decay-sphinx/._part0007_main_decay.html#th-order-runge-kutta-scheme">derivation</a> is a very good illustration of numerical thinking!</li>
</ul>

<!-- !split -->

<h3>2nd-order Adams-Bashforth scheme  <a name="___sec187"></a></h3>

<p>
$$
\begin{equation}
u^{n+1} = u^n + \frac{1}{2}\Delta t\left( 3f(u^n, t_n) - f(u^{n-1}, t_{n-1})
\right)
\thinspace .
\label{decay:fd2:AB2}
\end{equation}
$$


<p>
<!-- !split -->

<h3>3rd-order Adams-Bashforth scheme  <a name="___sec188"></a></h3>

<p>
$$
\begin{equation}
u^{n+1} = u^n + \frac{1}{12}\left( 23f(u^n, t_n) - 16 f(u^{n-1},t_{n-1})
+ 5f(u^{n-2}, t_{n-2})\right)
\thinspace .
\label{decay:fd2:AB3}
\end{equation}
$$


<p>
<!-- !split -->

<h3>The Odespy software  <a name="___sec189"></a></h3>

<p>
<a href="https://github.com/hplgit/odespy">Odespy</a>
features simple Python implementations of the most fundamental
schemes as well as Python interfaces to several famous packages for
solving ODEs: <a href="https://computation.llnl.gov/casc/odepack/odepack_home.html">ODEPACK</a>,
<a href="https://computation.llnl.gov/casc/odepack/odepack_home.html">Vode</a>,
<a href="http://www.netlib.org/ode/rkc.f">rkc.f</a>,
<a href="http://www.netlib.org/ode/rkf45.f">rkf45.f</a>,
<a href="http://www.unige.ch/~hairer/software.html">Radau5</a>, as well
as the ODE solvers in
<a href="http://docs.scipy.org/doc/scipy/reference/generated/scipy.integrate.ode.html">SciPy</a>,
<a href="http://docs.sympy.org/dev/modules/mpmath/calculus/odes.html">SymPy</a>, and
<a href="http://olivierverdier.github.com/odelab/">odelab</a>.

<p>
Typical usage:

<p>

<!-- code=text typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"># Define right-hand side of ODE
def f(u, t):
    return -a*u

import odespy
import numpy as np

# Set parameters and time mesh
I = 1; a = 2; T = 6; dt = 1.0
Nt = int(round(T/dt))
t_mesh = np.linspace(0, T, Nt+1)

# Use a 4th-order Runge-Kutta method
solver = odespy.RK4(f)
solver.set_initial_condition(I)
u, t = solver.solve(t_mesh)
</pre></div>
<p>
<!-- !split -->

<h3>Example: Runge-Kutta methods   <a name="___sec190"></a></h3>

<p>

<!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">solvers <span style="color: #666666">=</span> [odespy<span style="color: #666666">.</span>RK2(f),
           odespy<span style="color: #666666">.</span>RK3(f),
           odespy<span style="color: #666666">.</span>RK4(f),
           odespy<span style="color: #666666">.</span>BackwardEuler(f, nonlinear_solver<span style="color: #666666">=</span><span style="color: #BA2121">&#39;Newton&#39;</span>)]

<span style="color: #008000; font-weight: bold">for</span> solver <span style="color: #AA22FF; font-weight: bold">in</span> solvers:
    solver<span style="color: #666666">.</span>set_initial_condition(I)
    u, t <span style="color: #666666">=</span> solver<span style="color: #666666">.</span>solve(t)

<span style="color: #408080; font-style: italic"># + lots of plot code...</span>
</pre></div>
<p>
<!-- !split -->

<h3>Plots from the experiments  <a name="___sec191"></a></h3>

<p>
<center><p><img src="fig-decay/decay_odespy1_png.png" align="bottom" width=800></p></center>

<p>
The 4-th order Runge-Kutta method (<code>RK4</code>) is the method of choice!

<p>
<!-- !split -->

<h3>Example: Adaptive Runge-Kutta methods   <a name="___sec192"></a></h3>

<p>

<ul>
 <p><li> Adaptive methods find "optimal" locations of the mesh points
   to ensure that the error is less than a given tolerance.</li>
 <p><li> Downside: approximate error estimation, not always optimal
   location of points.</li>
 <p><li> "Industry standard ODE solver": Dormand-Prince 4/5-th order
   Runge-Kutta (MATLAB's famous <code>ode45</code>).</li>
</ul>

<center><p><img src="fig-decay/decay_DormandPrince_adaptivity.png" align="bottom" width=800></p></center>

<p>

<!-- ------------------- end of main content --------------- -->


</body>
</html>
    

