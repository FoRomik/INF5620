<!--
Automatically generated HTML file from DocOnce source
(https://github.com/hplgit/doconce/)
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="DocOnce: https://github.com/hplgit/doconce/" />
<meta name="description" content="Study Guide: Scientific software engineering for a simple ODE problem">
<meta name="keywords" content="modules (Python),test block (Python modules),module import,doctests,software testing doctests,unit testing,software testing nose,unit testing,problem class,solver class,visualizer class,problem class,solver class,visualizer class,numerical experiments,scientific experiments,Unix wildcard notation">

<title>Study Guide: Scientific software engineering for a simple ODE problem</title>


<style type="text/css">
/* bloodish style */

body {
  font-family: Helvetica, Verdana, Arial, Sans-serif;
  color: #404040;
  background: #ffffff;
}
h1 { font-size: 1.8em;  color: #8A0808; }
h2 { font-size: 1.6em;  color: #8A0808; }
h3 { font-size: 1.4em;  color: #8A0808; }
h4 { color: #8A0808; }
a { color: #8A0808; text-decoration:none; }
tt { font-family: "Courier New", Courier; }

p { text-indent: 0px; }
hr { border: 0; width: 80%; border-bottom: 1px solid #aaa}
p.caption { width: 80%; font-style: normal; text-align: left; }
hr.figure { border: 0; width: 80%; border-bottom: 1px solid #aaa}
.alert-text-small   { font-size: 80%;  }
.alert-text-large   { font-size: 130%; }
.alert-text-normal  { font-size: 90%;  }
.alert {
  padding:8px 35px 8px 14px; margin-bottom:18px;
  text-shadow:0 1px 0 rgba(255,255,255,0.5);
  border:1px solid #bababa;
  border-radius: 4px;
  -webkit-border-radius: 4px;
  -moz-border-radius: 4px;
  color: #555;
  background-color: #f8f8f8;
  background-position: 10px 5px;
  background-repeat: no-repeat;
  background-size: 38px;
  padding-left: 55px;
  width: 75%;
 }
.alert-block {padding-top:14px; padding-bottom:14px}
.alert-block > p, .alert-block > ul {margin-bottom:1em}
.alert li {margin-top: 1em}
.alert-block p+p {margin-top:5px}
.alert-notice { background-image: url(https://raw.github.com/hplgit/doconce/master/bundled/html_images/small_gray_notice.png); }
.alert-summary  { background-image:url(https://raw.github.com/hplgit/doconce/master/bundled/html_images/small_gray_summary.png); }
.alert-warning { background-image: url(https://raw.github.com/hplgit/doconce/master/bundled/html_images/small_gray_warning.png); }
.alert-question {background-image:url(https://raw.github.com/hplgit/doconce/master/bundled/html_images/small_gray_question.png); }

div { text-align: justify; text-justify: inter-word; }
</style>


</head>

<!-- tocinfo
{'highest level': 1,
 'sections': [(' Creating user interfaces ', 1, 'decay:GUI', 'decay:GUI'),
              (' Accessing command-line arguments ', 2, None, '___sec1'),
              (' Reading a sequence of command-line arguments ',
               2,
               None,
               '___sec2'),
              (' Implementation ', 2, None, '___sec3'),
              (' Working with an argument parser ', 2, None, '___sec4'),
              (' Reading option-values pairs ', 2, None, '___sec5'),
              (' A graphical user interface ', 2, None, '___sec6'),
              (' The Parampool package ', 2, None, '___sec7'),
              (' Making a compute function ', 2, None, '___sec8'),
              (' The hard part of the compute function: the HTML code ',
               2,
               None,
               '___sec9'),
              (' How to embed a PNG plot in HTML code ', 2, None, '___sec10'),
              (' Generating the user interface ', 2, None, '___sec11'),
              (' Running the web application ', 2, None, '___sec12'),
              (' More advanced use ', 2, None, '___sec13'),
              (' Computing convergence rates ',
               1,
               'decay:convrates',
               'decay:convrates'),
              (' Estimating the convergence rate $r$ ', 2, None, '___sec15'),
              (' Implementation ', 2, None, '___sec16'),
              (' Execution ', 2, None, '___sec17'),
              (' Debugging via convergence rates ', 2, None, '___sec18'),
              (' Software engineering ', 1, 'decay:softeng', 'decay:softeng'),
              (' Making a module ', 2, None, '___sec20'),
              (' Sketch of the module ', 2, None, '___sec21'),
              (' Test block ', 2, None, '___sec22'),
              (' Extended test block ', 2, None, '___sec23'),
              (' Prefixing imported functions by the module name ',
               2,
               None,
               '___sec24'),
              (' Downside of module prefix notation ', 2, None, '___sec25'),
              (' Doctests ', 2, None, '___sec26'),
              (' Running doctests ', 2, None, '___sec27'),
              (' Unit testing with nose ', 2, None, '___sec28'),
              (' Basic use of nose ', 2, None, '___sec29'),
              (' Example on a nose test in the source code ',
               2,
               None,
               '___sec30'),
              (' Example on a nose test in a separate file ',
               2,
               None,
               '___sec31'),
              (' The habit of writing nose tests ', 2, None, '___sec32'),
              (' Purpose of a test function: raise AssertionError if failure ',
               2,
               None,
               '___sec33'),
              (' Advantages of nose ', 2, None, '___sec34'),
              (' Demonstrating nose (ideas) ', 2, None, '___sec35'),
              (' Demonstrating nose (code) ', 2, None, '___sec36'),
              (' Floats as test results require careful comparison ',
               2,
               None,
               '___sec37'),
              (' Test of wrong use ', 2, None, '___sec38'),
              (' Test of convergence rates ', 2, None, '___sec39'),
              (' Classical unit testing with unittest ', 2, None, '___sec40'),
              (' Basic use of unittest ', 2, None, '___sec41'),
              (' Demonstration of unittest ', 2, None, '___sec42'),
              (' Implementing simple problem and solver classes ',
               1,
               'decay:classes',
               'decay:classes'),
              (' What to learn ', 2, None, '___sec44'),
              (' The problem class ', 2, None, '___sec45'),
              (' Improved problem class ', 2, None, '___sec46'),
              (' The solver class ', 2, None, '___sec47'),
              (' The visualizer class ', 2, None, '___sec48'),
              (' Combing the classes ', 2, None, '___sec49'),
              (' Implementing more advanced problem and solver classes ',
               1,
               'decay:classes2',
               'decay:classes2'),
              (' A generic class for parameters ', 2, None, '___sec51'),
              (' The problem class ', 2, None, '___sec52'),
              (' The solver class ', 2, None, '___sec53'),
              (' The visualizer class ', 2, None, '___sec54'),
              (' Performing scientific experiments ',
               1,
               'decay:experiments',
               'decay:experiments'),
              (' Model problem and numerical solution method ',
               2,
               None,
               '___sec56'),
              (' Plan for the experiments ', 2, None, '___sec57'),
              (' Typical plot summarizing the results ', 2, None, '___sec58'),
              (' Script code ', 2, None, '___sec59'),
              (' Comments to the code ', 2, None, '___sec60'),
              (' Interpreting output from other programs ',
               2,
               None,
               '___sec61'),
              (' Code for grabbing output from another program ',
               2,
               None,
               '___sec62'),
              (' Code for interpreting the grabbed output ',
               2,
               None,
               '___sec63'),
              (' Making a report ',
               2,
               'decay:exper:report',
               'decay:exper:report'),
              (' Publishing a complete project ',
               2,
               'decay:exper:github',
               'decay:exper:github')]}
end of tocinfo -->

<body>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
     equationNumbers: {  autoNumber: "AMS"  },
     extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js", "color.js"]
  }
});
</script>
<script type="text/javascript"
 src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<!-- newcommands_keep.tex -->
$$
\newcommand{\uex}{{u_{\small\mbox{e}}}}
\newcommand{\tp}{\thinspace .}
$$




    
<!-- ------------------- main content ---------------------- -->



<center><h1>Study Guide: Scientific software engineering for a simple ODE problem</h1></center>  <!-- document title -->

<p>
<!-- author(s): Hans Petter Langtangen -->

<center>
<b>Hans Petter Langtangen</b> [1, 2]
</center>


<p>
<!-- institution(s) -->

<center>[1] <b>Center for Biomedical Computing, Simula Research Laboratory</b></center>
<center>[2] <b>Department of Informatics, University of Oslo</b></center>
<p>
<center><h4>Sep 25, 2014</h4></center> <!-- date -->
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Table of contents</h2>

<p>
<a href="#decay:GUI"> Creating user interfaces </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec1"> Accessing command-line arguments </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec2"> Reading a sequence of command-line arguments </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec3"> Implementation </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec4"> Working with an argument parser </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec5"> Reading option-values pairs </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec6"> A graphical user interface </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec7"> The Parampool package </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec8"> Making a compute function </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec9"> The hard part of the compute function: the HTML code </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec10"> How to embed a PNG plot in HTML code </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec11"> Generating the user interface </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec12"> Running the web application </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec13"> More advanced use </a><br>
<a href="#decay:convrates"> Computing convergence rates </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec15"> Estimating the convergence rate \( r \) </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec16"> Implementation </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec17"> Execution </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec18"> Debugging via convergence rates </a><br>
<a href="#decay:softeng"> Software engineering </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec20"> Making a module </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec21"> Sketch of the module </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec22"> Test block </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec23"> Extended test block </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec24"> Prefixing imported functions by the module name </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec25"> Downside of module prefix notation </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec26"> Doctests </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec27"> Running doctests </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec28"> Unit testing with nose </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec29"> Basic use of nose </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec30"> Example on a nose test in the source code </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec31"> Example on a nose test in a separate file </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec32"> The habit of writing nose tests </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec33"> Purpose of a test function: raise AssertionError if failure </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec34"> Advantages of nose </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec35"> Demonstrating nose (ideas) </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec36"> Demonstrating nose (code) </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec37"> Floats as test results require careful comparison </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec38"> Test of wrong use </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec39"> Test of convergence rates </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec40"> Classical unit testing with unittest </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec41"> Basic use of unittest </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec42"> Demonstration of unittest </a><br>
<a href="#decay:classes"> Implementing simple problem and solver classes </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec44"> What to learn </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec45"> The problem class </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec46"> Improved problem class </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec47"> The solver class </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec48"> The visualizer class </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec49"> Combing the classes </a><br>
<a href="#decay:classes2"> Implementing more advanced problem and solver classes </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec51"> A generic class for parameters </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec52"> The problem class </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec53"> The solver class </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec54"> The visualizer class </a><br>
<a href="#decay:experiments"> Performing scientific experiments </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec56"> Model problem and numerical solution method </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec57"> Plan for the experiments </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec58"> Typical plot summarizing the results </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec59"> Script code </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec60"> Comments to the code </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec61"> Interpreting output from other programs </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec62"> Code for grabbing output from another program </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec63"> Code for interpreting the grabbed output </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:exper:report"> Making a report </a><br>
&nbsp; &nbsp; &nbsp; <a href="#decay:exper:github"> Publishing a complete project </a><br>
</p>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h1>Creating user interfaces <a name="decay:GUI"></a></h1>

<ul>
 <p><li> Never edit the program to change input!</li>
 <p><li> Set input data on the command line or in a graphical user interface</li>
 <p><li> How is explained next</li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Accessing command-line arguments  <a name="___sec1"></a></h2>

<ul>
 <p><li> All command-line arguments are available in <code>sys.argv</code></li>
 <p><li> <code>sys.argv[0]</code> is the program</li>
 <p><li> <code>sys.argv[1:]</code> holds the command-line arguments</li>
 <p><li> Method 1: fixed sequence of parameters on the command line</li>
 <p><li> Method 2: <code>--option value</code> pairs on the command line (with default values)</li>
</ul>

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python myprog.py 1.5 2 0.5 0.8 0.4
Terminal&gt; python myprog.py --I 1.5 --a 2 --dt 0.8 0.4
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Reading a sequence of command-line arguments  <a name="___sec2"></a></h2>

<p>
The program <a href="http://tinyurl.com/nm5587k/softeng1/decay_plot.py" target="_self"><tt>decay_plot.py</tt></a>
needs this input:

<ul>
 <p><li> \( I \)</li>
 <p><li> \( a \)</li>
 <p><li> \( T \)</li>
 <p><li> an option to turn the plot on or off (<code>makeplot</code>)</li>
 <p><li> a list of \( \Delta t \) values</li>
</ul>

Give these on the command line in correct sequence

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python decay_cml.py 1.5 2 0.5 0.8 0.4
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Implementation  <a name="___sec3"></a></h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">read_command_line</span>():
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(sys<span style="color: #666666">.</span>argv) <span style="color: #666666">&lt;</span> <span style="color: #666666">6</span>:
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Usage: </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> I a T on/off dt1 dt2 dt3 ...&#39;</span> <span style="color: #666666">%</span> \ 
              sys<span style="color: #666666">.</span>argv[<span style="color: #666666">0</span>]; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)  <span style="color: #408080; font-style: italic"># abort</span>

    I <span style="color: #666666">=</span> <span style="color: #008000">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>])
    a <span style="color: #666666">=</span> <span style="color: #008000">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">2</span>])
    T <span style="color: #666666">=</span> <span style="color: #008000">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">3</span>])
    makeplot <span style="color: #666666">=</span> sys<span style="color: #666666">.</span>argv[<span style="color: #666666">4</span>] <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #BA2121">&#39;on&#39;</span>, <span style="color: #BA2121">&#39;True&#39;</span>)
    dt_values <span style="color: #666666">=</span> [<span style="color: #008000">float</span>(arg) <span style="color: #008000; font-weight: bold">for</span> arg <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv[<span style="color: #666666">5</span>:]]

    <span style="color: #008000; font-weight: bold">return</span> I, a, T, makeplot, dt_values
</pre></div>
<p>
Note:

<ul>
  <p><li> <code>sys.argv[i]</code> is <em>always a string</em></li>
  <p><li> Must explicitly convert to (e.g.) <code>float</code> for computations</li>
  <p><li> List comprehensions make lists: <code>[expression for e in somelist]</code></li>
</ul>

Complete program: <a href="http://tinyurl.com/nm5587k/softeng1/decay_cml.py" target="_self"><tt>decay_cml.py</tt></a>.

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Working with an argument parser  <a name="___sec4"></a></h2>

<p>
Set option-value pairs on the command line if the default value is not
suitable:
<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python decay_argparse.py --I 1.5 --a 2 --dt 0.8 0.4
</pre></div>
<p>
Code:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>():
    <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">argparse</span>
    parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser()
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--I&#39;</span>, <span style="color: #BA2121">&#39;--initial_condition&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
                        default<span style="color: #666666">=1.0</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;initial condition, u(0)&#39;</span>,
                        metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;I&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--a&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
                        default<span style="color: #666666">=1.0</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;coefficient in ODE&#39;</span>,
                        metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;a&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--T&#39;</span>, <span style="color: #BA2121">&#39;--stop_time&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
                        default<span style="color: #666666">=1.0</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;end time of simulation&#39;</span>,
                        metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;T&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--makeplot&#39;</span>, action<span style="color: #666666">=</span><span style="color: #BA2121">&#39;store_true&#39;</span>,
                        help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;display plot or not&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--dt&#39;</span>, <span style="color: #BA2121">&#39;--time_step_values&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
                        default<span style="color: #666666">=</span>[<span style="color: #666666">1.0</span>], help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time step values&#39;</span>,
                        metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;dt&#39;</span>, nargs<span style="color: #666666">=</span><span style="color: #BA2121">&#39;+&#39;</span>, dest<span style="color: #666666">=</span><span style="color: #BA2121">&#39;dt_values&#39;</span>)
    <span style="color: #008000; font-weight: bold">return</span> parser
</pre></div>
<p>
(<code>metavar</code> is the symbol used in help output)

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Reading option-values pairs  <a name="___sec5"></a></h2>

<p>
<code>argparse.ArgumentParser</code> parses the command-line arguments:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">read_command_line</span>():
    parser <span style="color: #666666">=</span> define_command_line_options()
    args <span style="color: #666666">=</span> parser<span style="color: #666666">.</span>parse_args()
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;I={}, a={}, T={}, makeplot={}, dt_values={}&#39;</span><span style="color: #666666">.</span>format(
        args<span style="color: #666666">.</span>I, args<span style="color: #666666">.</span>a, args<span style="color: #666666">.</span>T, args<span style="color: #666666">.</span>makeplot, args<span style="color: #666666">.</span>dt_values)
    <span style="color: #008000; font-weight: bold">return</span> args<span style="color: #666666">.</span>I, args<span style="color: #666666">.</span>a, args<span style="color: #666666">.</span>T, args<span style="color: #666666">.</span>makeplot, args<span style="color: #666666">.</span>dt_values
</pre></div>
<p>
Complete program: <a href="http://tinyurl.com/nm5587k/softeng1/decay_argparse.py" target="_self"><tt>decay_argparse.py</tt></a>.

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>A graphical user interface  <a name="___sec6"></a></h2>

<p>
<center><p><img src="fig-softeng1/decay_GUI.png" align="bottom" width=800></p></center>

<p>
Normally very much programming required - and much competence on
graphical user interfaces.

<p>
Here: use a tool to automatically create it in a few minutes (!)

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>The Parampool package  <a name="___sec7"></a></h2>

<ul>
 <p><li> <a href="https://github.com/hplgit/parampool" target="_self">Parampool</a> is a package
   for handling a large pool of input parameters in simulation programs</li>
 <p><li> Parampool can automatically create a sophisticated web-based
   graphical user interface (GUI) to set parameters and view solutions</li>
</ul>

<div class="alert alert-block alert-warning alert-text-normal">
<b>Remark.</b>
<p>
The forthcoming material aims at those with particular interest in
equipping their programs with a GUI - others can safely skip it.
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Making a compute function  <a name="___sec8"></a></h2>

<ul>
 <p><li> Key concept: a <em>compute function</em> that takes all input data as arguments
   and returning HTML code for viewing the results (e.g., plots and numbers)</li>
 <p><li> What we have: <a href="http://tinyurl.com/nm5587k/softeng1/decay_plot.py" target="_self"><tt>decay_plot.py</tt></a></li>
 <p><li> <code>main</code> function carries out simulations and plotting for a
   series of \( \Delta t \) values</li>
 <p><li> Goal: steer and view these experiments from a web GUI</li>
 <p><li> What to do:</li>

<ul>
   <p><li> create a compute function</li>
   <p><li> call <code>parampool</code> functionality</li>
</ul>

</ul>

The compute function <code>main_GUI</code>:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main_GUI</span>(I<span style="color: #666666">=1.0</span>, a<span style="color: #666666">=.2</span>, T<span style="color: #666666">=4.0</span>,
         dt_values<span style="color: #666666">=</span>[<span style="color: #666666">1.25</span>, <span style="color: #666666">0.75</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">0.1</span>],
         theta_values<span style="color: #666666">=</span>[<span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>]):
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>The hard part of the compute function: the HTML code  <a name="___sec9"></a></h2>

<ul>
 <p><li> The results are to be displayed in a web page</li>
 <p><li> Only you know what to display in your problem</li>
 <p><li> Therefore, you need to specify the HTML code</li>
</ul>

Suppose <code>explore</code> solves the problem, makes a plot, computes the
error <em>and</em> returns appropriate HTML code with the plot. Embed
error and plots in a table:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main_GUI</span>(I<span style="color: #666666">=1.0</span>, a<span style="color: #666666">=.2</span>, T<span style="color: #666666">=4.0</span>,
         dt_values<span style="color: #666666">=</span>[<span style="color: #666666">1.25</span>, <span style="color: #666666">0.75</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">0.1</span>],
         theta_values<span style="color: #666666">=</span>[<span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>]):
    <span style="color: #408080; font-style: italic"># Build HTML code for web page. Arrange plots in columns</span>
    <span style="color: #408080; font-style: italic"># corresponding to the theta values, with dt down the rows</span>
    theta2name <span style="color: #666666">=</span> {<span style="color: #666666">0</span>: <span style="color: #BA2121">&#39;FE&#39;</span>, <span style="color: #666666">1</span>: <span style="color: #BA2121">&#39;BE&#39;</span>, <span style="color: #666666">0.5</span>: <span style="color: #BA2121">&#39;CN&#39;</span>}
    html_text <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;&lt;table&gt;</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span>
    <span style="color: #008000; font-weight: bold">for</span> dt <span style="color: #AA22FF; font-weight: bold">in</span> dt_values:
        html_text <span style="color: #666666">+=</span> <span style="color: #BA2121">&#39;&lt;tr&gt;</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span>
        <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> theta_values:
            E, html <span style="color: #666666">=</span> explore(I, a, T, dt, theta, makeplot<span style="color: #666666">=</span><span style="color: #008000">True</span>)
            html_text <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;&quot;&quot;</span>
<span style="color: #BA2121">&lt;td&gt;</span>
<span style="color: #BA2121">&lt;center&gt;&lt;b&gt;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">, dt=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, error: </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&lt;/b&gt;&lt;/center&gt;&lt;br&gt;</span>
<span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"></span>
<span style="color: #BA2121">&lt;/td&gt;</span>
<span style="color: #BA2121">&quot;&quot;&quot;</span> <span style="color: #666666">%</span> (theta2name[theta], dt, E, html)
        html_text <span style="color: #666666">+=</span> <span style="color: #BA2121">&#39;&lt;/tr&gt;</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span>
    html_text <span style="color: #666666">+=</span> <span style="color: #BA2121">&#39;&lt;/table&gt;</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span>
    <span style="color: #008000; font-weight: bold">return</span> html_text
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>How to embed a PNG plot in HTML code  <a name="___sec10"></a></h2>

<p>
In <code>explore</code>:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>
<span style="color: #666666">...</span>
<span style="color: #408080; font-style: italic"># plot</span>
plt<span style="color: #666666">.</span>plot(t, u, r<span style="color: #666666">-</span><span style="color: #BA2121">&#39;)</span>
plt<span style="color: #666666">.</span>xlabel(<span style="color: #BA2121">&#39;t&#39;</span>)
plt<span style="color: #666666">.</span>ylabel(<span style="color: #BA2121">&#39;u&#39;</span>)
<span style="color: #666666">...</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">parampool.utils</span> <span style="color: #008000; font-weight: bold">import</span> save_png_to_str
html_text <span style="color: #666666">=</span> save_png_to_str(plt, plotwidth<span style="color: #666666">=400</span>)
</pre></div>
<p>
If you know HTML, you can return more sophisticated layout etc.

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Generating the user interface  <a name="___sec11"></a></h2>

<p>
Make a file <code>decay_GUI_generate.py</code>:

<p>

<!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">parampool.generator.flask</span> <span style="color: #008000; font-weight: bold">import</span> generate
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">decay_GUI</span> <span style="color: #008000; font-weight: bold">import</span> main
generate(main,
         output_controller<span style="color: #666666">=</span><span style="color: #BA2121">&#39;decay_GUI_controller.py&#39;</span>,
         output_template<span style="color: #666666">=</span><span style="color: #BA2121">&#39;decay_GUI_view.py&#39;</span>,
         output_model<span style="color: #666666">=</span><span style="color: #BA2121">&#39;decay_GUI_model.py&#39;</span>)
</pre></div>
<p>
Running <code>decay_GUI_generate.py</code> results in

<ol>
 <p><li> <code>decay_GUI_model.py</code> defines HTML widgets to be used to set
    input data in the web interface,</li>
 <p><li> <code>templates/decay_GUI_views.py</code> defines the layout of the web page,</li>
 <p><li> <code>decay_GUI_controller.py</code> runs the web application.</li>
</ol>

Good news: we only need to run <code>decay_GUI_controller.py</code>
and there is no need to look into any of these files!

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Running the web application  <a name="___sec12"></a></h2>

<p>
Start the GUI

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python decay_GUI_controller.py
</pre></div>
<p>
Open a web browser at <code>127.0.0.1:5000</code>

<p>
<center><p><img src="fig-softeng1/decay_GUI.png" align="bottom" width=800></p></center>

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>More advanced use  <a name="___sec13"></a></h2>

<ul>
 <p><li> The compute function can have arguments of type float, int, string,
   list, dict, numpy array, filename (file upload)</li>
 <p><li> Alternative: specify a hierarchy of input parameters with name,
   default value, data type, widget type, unit (m, kg, s), validity check</li>
 <p><li> The generated web GUI can have user accounts with login and storage
   of results in a database</li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h1>Computing convergence rates <a name="decay:convrates"></a></h1>

<p>
Frequent assumption on the relation between the numerical error \( E \) and
some discretization parameter \( \Delta t \):

$$
\begin{equation}
E = C\Delta t^r,
\label{decay:E:dt}
\end{equation}
$$


<ul>
 <p><li> Unknown: \( C \) and \( r \).</li>
 <p><li> Goal: estimate \( r \) (and \( C \)) from numerical experiments</li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Estimating the convergence rate \( r \)  <a name="___sec15"></a></h2>

<p>
Perform numerical experiments: \( (\Delta t_i, E_i) \), \( i=0,\ldots,m-1 \).
Two methods for finding \( r \) (and \( C \)):

<ol>
 <p><li> Take the logarithm of \eqref{decay:E:dt}, \( \ln E = r\ln \Delta t + \ln C \),
    and fit a straight line to the data points \( (\Delta t_i, E_i) \),
    \( i=0,\ldots,m-1 \).</li>
 <p><li> Consider two consecutive experiments, \( (\Delta t_i, E_i) \) and
    \( (\Delta t_{i-1}, E_{i-1}) \). Dividing the equation
    \( E_{i-1}=C\Delta t_{i-1}^r \) by \( E_{i}=C\Delta t_{i}^r \) and solving
    for \( r \) yields</li>
</ol>

$$
\begin{equation}
r_{i-1} = \frac{\ln (E_{i-1}/E_i)}{\ln (\Delta t_{i-1}/\Delta t_i)}
\label{decay:conv:rate}
\end{equation}
$$

for \( i=1,=\ldots,m-1 \).

<p>
Method 2 is best.

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Implementation  <a name="___sec16"></a></h2>

<p>
Compute \( r_0, r_1, \ldots, r_{m-2} \):

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">math</span> <span style="color: #008000; font-weight: bold">import</span> log

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>():
    I, a, T, makeplot, dt_values <span style="color: #666666">=</span> read_command_line()
    r <span style="color: #666666">=</span> {}  <span style="color: #408080; font-style: italic"># estimated convergence rates</span>
    <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>:
        E_values <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> dt <span style="color: #AA22FF; font-weight: bold">in</span> dt_values:
            E <span style="color: #666666">=</span> explore(I, a, T, dt, theta, makeplot<span style="color: #666666">=</span><span style="color: #008000">False</span>)
            E_values<span style="color: #666666">.</span>append(E)

        <span style="color: #408080; font-style: italic"># Compute convergence rates</span>
        m <span style="color: #666666">=</span> <span style="color: #008000">len</span>(dt_values)
        r[theta] <span style="color: #666666">=</span> [log(E_values[i<span style="color: #666666">-1</span>]<span style="color: #666666">/</span>E_values[i])<span style="color: #666666">/</span>
                    log(dt_values[i<span style="color: #666666">-1</span>]<span style="color: #666666">/</span>dt_values[i])
                    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">1</span>, m, <span style="color: #666666">1</span>)]

    <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> r:
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">Pairwise convergence rates for theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">:&#39;</span> <span style="color: #666666">%</span> theta
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39; &#39;</span><span style="color: #666666">.</span>join([<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%.2f</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> r_ <span style="color: #008000; font-weight: bold">for</span> r_ <span style="color: #AA22FF; font-weight: bold">in</span> r[theta]])
    <span style="color: #008000; font-weight: bold">return</span> r
</pre></div>
<p>
Complete program: <a href="https://github.com/hplgit/INF5620/blob/gh-pages/src/decay/decay_convrate.py" target="_self"><tt>decay_convrate.py</tt></a>.

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Execution  <a name="___sec17"></a></h2>

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python decay_convrate.py --dt 0.5 0.25 0.1 0.05 0.025 0.01
...
Pairwise convergence rates for theta=0:
1.33 1.15 1.07 1.03 1.02

Pairwise convergence rates for theta=0.5:
2.14 2.07 2.03 2.01 2.01

Pairwise convergence rates for theta=1:
0.98 0.99 0.99 1.00 1.00
</pre></div>
<p>
<div class="alert alert-block alert-notice alert-text-normal">
<b>Strong verification method.</b>
<p>
Verify that \( r \) has the expected value!
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Debugging via convergence rates  <a name="___sec18"></a></h2>

<p>
Potential bug: missing <code>a</code> in the denominator,

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt)<span style="color: #666666">*</span>u[n]
</pre></div>
<p>
Running <code>decay_convrate.py</code> gives same rates.

<p>
Why? The value of \( a \)... (\( a=1 \))

<p>
0 and 1 are <em>bad values</em> in tests!

<p>
Better:
<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python decay_convrate.py --a 2.1 --I 0.1  \ 
          --dt 0.5 0.25 0.1 0.05 0.025 0.01
...
Pairwise convergence rates for theta=0:
1.49 1.18 1.07 1.04 1.02

Pairwise convergence rates for theta=0.5:
-1.42 -0.22 -0.07 -0.03 -0.01

Pairwise convergence rates for theta=1:
0.21 0.12 0.06 0.03 0.01
</pre></div>
<p>
Forward Euler works...because \( \theta=0 \) hides the bug.

<p>
This bug gives \( r\approx 0 \):

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> ((<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)<span style="color: #666666">*</span>u[n]
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h1>Software engineering <a name="decay:softeng"></a></h1>

<p>
Goal: make more professional numerical software.

<p>
Topics:

<ul>
  <p><li> How to make modules (reusable libraries)</li>
  <p><li> Testing frameworks (doctest, nose, unittest)</li>
  <p><li> Implementation with classes</li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Making a module  <a name="___sec20"></a></h2>

<ul>
 <p><li> Previous programs: much repetitive code (esp. <code>solver</code>)</li>
 <p><li> DRY (Don't Repeat Yourself) principle: no copies of code</li>
 <p><li> A change needs to be done in one <em>and only one</em> place</li>
 <p><li> Module = just a file with functions (reused through <code>import</code>)</li>
 <p><li> Let's make a module by putting these functions in a file:</li>

<ul>
   <p><li> <code>solver</code></li>
   <p><li> <code>verify_three_steps</code></li>
   <p><li> <code>verify_discrete_solution</code></li>
   <p><li> <code>explore</code></li>
   <p><li> <code>define_command_line_options</code></li>
   <p><li> <code>read_command_line</code></li>
   <p><li> <code>main</code> (with convergence rates)</li>
   <p><li> <code>verify_convergence_rate</code></li>
</ul>

</ul>

Module name: <code>decay_mod</code>, filename: <code>decay_mod.py</code>.

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Sketch of the module  <a name="___sec21"></a></h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, a, T, dt, theta):
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">verify_three_steps</span>():
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">verify_exact_discrete_solution</span>():
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">u_exact</span>(t, I, a):
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">explore</span>(I, a, T, dt, theta<span style="color: #666666">=0.5</span>, makeplot<span style="color: #666666">=</span><span style="color: #008000">True</span>):
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>():
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">read_command_line</span>(use_argparse<span style="color: #666666">=</span><span style="color: #008000">True</span>):
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>():
    <span style="color: #666666">...</span>
</pre></div>
<p>
That is! It's a module <code>decay_mod</code> in file <code>decay_mod.py</code>.

<p>
Usage in some other program:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">decay_mod</span> <span style="color: #008000; font-weight: bold">import</span> solver
u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=1.0</span>, a<span style="color: #666666">=3.0</span>, T<span style="color: #666666">=3</span>, dt<span style="color: #666666">=0.01</span>, theta<span style="color: #666666">=0.5</span>)
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Test block  <a name="___sec22"></a></h2>

<p>
At the end of a module it is common to include a <em>test block</em>:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    main()
</pre></div>
<p>
Note:

<ul>
 <p><li> If <code>decay_mod</code> is imported, <code>__name__</code> is <code>decay_mod</code>.</li>
 <p><li> If <code>decay_mod.py</code> is run, <code>__name__</code> is <code>__main__</code>.</li>
 <p><li> Use test block for testing, demo, user interface, ...</li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Extended test block  <a name="___sec23"></a></h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&#39;verify&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv:
        <span style="color: #008000; font-weight: bold">if</span> verify_three_steps() <span style="color: #AA22FF; font-weight: bold">and</span> verify_discrete_solution():
            <span style="color: #008000; font-weight: bold">pass</span> <span style="color: #408080; font-style: italic"># ok</span>
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Bug in the implementation!&#39;</span>
    <span style="color: #008000; font-weight: bold">elif</span> <span style="color: #BA2121">&#39;verify_rates&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv:
        sys<span style="color: #666666">.</span>argv<span style="color: #666666">.</span>remove(<span style="color: #BA2121">&#39;verify_rates&#39;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #BA2121">&#39;--dt&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv:
            <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Must assign several dt values&#39;</span>
            sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)  <span style="color: #408080; font-style: italic"># abort</span>
        <span style="color: #008000; font-weight: bold">if</span> verify_convergence_rate():
            <span style="color: #008000; font-weight: bold">pass</span>
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Bug in the implementation!&#39;</span>
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #408080; font-style: italic"># Perform simulations</span>
        main()
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Prefixing imported functions by the module name  <a name="___sec24"></a></h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
</pre></div>
<p>
This imports a large number of names (<code>sin</code>, <code>exp</code>, <code>linspace</code>, <code>plot</code>, ...).

<p>
Confusion: is a function from <code>numpy</code>? Or <code>matplotlib.pyplot</code>?

<p>
Alternative (recommended) import:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span>
</pre></div>
<p>
Now we need to prefix functions with module name:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">t <span style="color: #666666">=</span> numpy<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, Nt<span style="color: #666666">+1</span>)
u_e <span style="color: #666666">=</span> I<span style="color: #666666">*</span>numpy<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
matplotlib<span style="color: #666666">.</span>pyplot<span style="color: #666666">.</span>plot(t, u_e)
</pre></div>
<p>
Common standard:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>

t <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, Nt<span style="color: #666666">+1</span>)
u_e <span style="color: #666666">=</span> I<span style="color: #666666">*</span>np<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
plt<span style="color: #666666">.</span>plot(t, u_e)
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Downside of module prefix notation  <a name="___sec25"></a></h2>

<p>
A math line like \( e^{-at}\sin(2\pi t) \) gets
cluttered with module names,
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">numpy<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)<span style="color: #666666">*</span>numpy<span style="color: #666666">.</span>sin(<span style="color: #666666">2</span>(numpy<span style="color: #666666">.</span>pi<span style="color: #666666">*</span>t)
<span style="color: #408080; font-style: italic"># or</span>
np<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)<span style="color: #666666">*</span>np<span style="color: #666666">.</span>sin(<span style="color: #666666">2*</span>np<span style="color: #666666">.</span>pi<span style="color: #666666">*</span>t)
</pre></div>
<p>
Solution (much used in this course): do two imports

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> exp, sin, pi
<span style="color: #666666">...</span>
t <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, Nt<span style="color: #666666">+1</span>)
u_e <span style="color: #666666">=</span> exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)<span style="color: #666666">*</span>sin(<span style="color: #666666">2*</span>pi<span style="color: #666666">*</span>t)
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Doctests  <a name="___sec26"></a></h2>

<p>
Doc strings can be equipped with interactive Python sessions for
demonstrating usage and <em>automatic testing</em> of functions.

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, a, T, dt, theta):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.</span>


<span style="color: #BA2121; font-style: italic">    &gt;&gt;&gt; u, t = solver(I=0.8, a=1.2, T=4, dt=0.5, theta=0.5)</span>
<span style="color: #BA2121; font-style: italic">    &gt;&gt;&gt; for t_n, u_n in zip(t, u):</span>
<span style="color: #BA2121; font-style: italic">    ...     print &#39;t=%.1f, u=%.14f&#39; % (t_n, u_n)</span>
<span style="color: #BA2121; font-style: italic">    t=0.0, u=0.80000000000000</span>
<span style="color: #BA2121; font-style: italic">    t=0.5, u=0.43076923076923</span>
<span style="color: #BA2121; font-style: italic">    t=1.0, u=0.23195266272189</span>
<span style="color: #BA2121; font-style: italic">    t=1.5, u=0.12489758761948</span>
<span style="color: #BA2121; font-style: italic">    t=2.0, u=0.06725254717972</span>
<span style="color: #BA2121; font-style: italic">    t=2.5, u=0.03621291001985</span>
<span style="color: #BA2121; font-style: italic">    t=3.0, u=0.01949925924146</span>
<span style="color: #BA2121; font-style: italic">    t=3.5, u=0.01049960113002</span>
<span style="color: #BA2121; font-style: italic">    t=4.0, u=0.00565363137770</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #666666">...</span>
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Running doctests  <a name="___sec27"></a></h2>

<p>
Automatic check that the code reproduces the doctest output:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal<span style="color: #666666">&gt;</span> python <span style="color: #666666">-</span>m doctest decay_mod_doctest<span style="color: #666666">.</span>py
</pre></div>
<p>
Report in case of failure:

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python -m doctest decay_mod_doctest.py
********************************************************
File &quot;decay_mod_doctest.py&quot;, line 12, in decay_mod_doctest....
Failed example:
    for t_n, u_n in zip(t, u):
        print &#39;t=%.1f, u=%.14f&#39; % (t_n, u_n)
Expected:
    t=0.0, u=0.80000000000000
    t=0.5, u=0.43076923076923
    t=1.0, u=0.23195266272189
    t=1.5, u=0.12489758761948
    t=2.0, u=0.06725254717972
Got:
    t=0.0, u=0.80000000000000
    t=0.5, u=0.43076923076923
    t=1.0, u=0.23195266272189
    t=1.5, u=0.12489758761948
    t=2.0, u=0.06725254718756
********************************************************
1 items had failures:
   1 of   2 in decay_mod_doctest.solver
***Test Failed*** 1 failures.
</pre></div>
<p>
<div class="alert alert-block alert-warning alert-text-normal">
<b>Floats are difficult to compare.</b>
<p>
Limit the number of digits in the output in doctests! Otherwise,
round-off errors on a different machine may ruin the test.
</div>


<p>
Complete program: <a href="http://tinyurl.com/nm5587k/decay/decay_mod_doctest.py" target="_self"><tt>decay_mod_doctest.py</tt></a>.

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Unit testing with nose  <a name="___sec28"></a></h2>

<ul>
 <p><li> Nose is a very user-friendly testing framework</li>
 <p><li> Based on <em>unit testing</em></li>
 <p><li> Identify (small) units of code and test each unit</li>
 <p><li> Nose automates running all tests</li>
 <p><li> Good habit: run all tests after (small) edits of a code</li>
 <p><li> Even better habit: write tests <em>before</em> the code (!)</li>
 <p><li> Remark: unit testing in scientific computing is not yet well established</li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Basic use of nose  <a name="___sec29"></a></h2>

<ol>
 <p><li> Implement tests in <em>test functions</em> with names starting with <code>test_</code>.</li>
 <p><li> Test functions cannot have arguments.</li>
 <p><li> Test functions perform assertions on computed results
    using <code>assert</code> functions from the <code>nose.tools</code> module.</li>
 <p><li> Test functions can be in the source code files or be
    collected in separate files <code>test*.py</code>.</li>
</ol>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Example on a nose test in the source code  <a name="___sec30"></a></h2>

<p>
Very simple module <code>mymod</code> (in file <code>mymod.py</code>):

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">double</span>(n):
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">2*</span>n
</pre></div>
<p>
Write test function in <code>mymod.py</code>:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">double</span>(n):
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">2*</span>n

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">nose.tools</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">nt</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_double</span>():
    result <span style="color: #666666">=</span> double(<span style="color: #666666">4</span>)
    nt<span style="color: #666666">.</span>assert_equal(result, <span style="color: #666666">8</span>)
</pre></div>
<p>
Running

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; nosetests -s mymod
</pre></div>
<p>
makes the <code>nose</code> tool run all <code>test_*()</code> functions in <code>mymod.py</code>.

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Example on a nose test in a separate file  <a name="___sec31"></a></h2>

<p>
Write the test in a separate file, say <code>test_mymod.py</code>:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">nose.tools</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">nt</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">mymod</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_double</span>():
    result <span style="color: #666666">=</span> mymod<span style="color: #666666">.</span>double(<span style="color: #666666">4</span>)
    nt<span style="color: #666666">.</span>assert_equal(result, <span style="color: #666666">8</span>)
</pre></div>
<p>
Running

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; nosetests -s
</pre></div>
<p>
makes the <code>nose</code> tool run all <code>test_*()</code> functions in all files
<code>test*.py</code> in the current directory and in all subdirectories (recursevely)
with names <code>tests</code> or <code>*_tests</code>.

<p>
<div class="alert alert-block alert-notice alert-text-normal">
<b>Tip.</b>
<p>
Start with test functions in the source code file. When the file
contains many tests, or when you have many source code files,
move tests to separate files.
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>The habit of writing nose tests  <a name="___sec32"></a></h2>

<ul>
 <p><li> Put <code>test_*()</code> functions in the module</li>
 <p><li> When you get many <code>test_*()</code> functions, collect them in
   <code>tests/test*.py</code></li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Purpose of a test function: raise AssertionError if failure  <a name="___sec33"></a></h2>

<p>
Alternative ways of raising AssertionError if <code>result</code> is not <code>8</code>:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">nose.tools</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">nt</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_double</span>():
    result <span style="color: #666666">=</span> <span style="color: #666666">...</span>

    nt<span style="color: #666666">.</span>assert_equal(result, <span style="color: #666666">8</span>)    <span style="color: #408080; font-style: italic"># alternative 1</span>

    <span style="color: #008000; font-weight: bold">assert</span> result <span style="color: #666666">==</span> <span style="color: #666666">8</span>            <span style="color: #408080; font-style: italic"># alternative 2</span>

    <span style="color: #008000; font-weight: bold">if</span> result <span style="color: #666666">!=</span> <span style="color: #666666">8</span>:               <span style="color: #408080; font-style: italic"># alternative 3</span>
        <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #D2413A; font-weight: bold">AssertionError</span>()
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Advantages of nose  <a name="___sec34"></a></h2>

<ul>
  <p><li> Easier to use than other test frameworks</li>
  <p><li> Tests are written and collected in a <em>compact</em> and structured way</li>
  <p><li> Large collections of tests, scattered throughout a directory tree
    can be executed with one command (<code>nosetests -s</code>)</li>
  <p><li> Nose is a much-adopted standard</li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Demonstrating nose (ideas)  <a name="___sec35"></a></h2>

<p>
Aim: test function <code>solver</code> for \( u'=-au \), \( u(0)=I \).

<p>
We design three unit tests:

<ol>
 <p><li> A comparison between the computed \( u^n \) values and the
    exact discrete solution</li>
 <p><li> A comparison between the computed \( u^n \) values and precomputed
    verified reference values</li>
 <p><li> A comparison between observed and expected convergence rates</li>
</ol>

These tests follow very closely the previous <code>verify*</code> functions.

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Demonstrating nose (code)  <a name="___sec36"></a></h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">nose.tools</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">nt</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">decay_mod_unittest</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">decay_mod</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_discrete_solution</span>(n, I, a, theta, dt):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return exact discrete solution of the theta scheme.&quot;&quot;&quot;</span>
    dt <span style="color: #666666">=</span> <span style="color: #008000">float</span>(dt)  <span style="color: #408080; font-style: italic"># avoid integer division</span>
    factor <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)
    <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>factor<span style="color: #666666">**</span>n

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_exact_discrete_solution</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Compare result from solver against</span>
<span style="color: #BA2121; font-style: italic">    formula for the discrete solution.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    theta <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>; a <span style="color: #666666">=</span> <span style="color: #666666">2</span>; I <span style="color: #666666">=</span> <span style="color: #666666">0.1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">0.8</span>
    N <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #666666">8/</span>dt)  <span style="color: #408080; font-style: italic"># no of steps</span>
    u, t <span style="color: #666666">=</span> decay_mod<span style="color: #666666">.</span>solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, T<span style="color: #666666">=</span>N<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)
    u_de <span style="color: #666666">=</span> np<span style="color: #666666">.</span>array([exact_discrete_solution(n, I, a, theta, dt)
                     <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(N<span style="color: #666666">+1</span>)])
    diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u_de <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()
    nt<span style="color: #666666">.</span>assert_almost_equal(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Floats as test results require careful comparison  <a name="___sec37"></a></h2>

<ul>
 <p><li> Round-off errors make exact comparison of floats unreliable</li>
 <p><li> <code>nt.assert_almost_equal</code>: compare two floats to some digits
   or precision</li>
</ul>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_solver</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Compare result from solver against</span>
<span style="color: #BA2121; font-style: italic">    precomputed arrays for theta=0, 0.5, 1.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    I<span style="color: #666666">=0.8</span>; a<span style="color: #666666">=1.2</span>; T<span style="color: #666666">=4</span>; dt<span style="color: #666666">=0.5</span>  <span style="color: #408080; font-style: italic"># fixed parameters</span>
    precomputed <span style="color: #666666">=</span> {
        <span style="color: #BA2121">&#39;t&#39;</span>: np<span style="color: #666666">.</span>array([ <span style="color: #666666">0.</span> ,  <span style="color: #666666">0.5</span>,  <span style="color: #666666">1.</span> ,  <span style="color: #666666">1.5</span>,  <span style="color: #666666">2.</span> ,  <span style="color: #666666">2.5</span>,
                        <span style="color: #666666">3.</span> ,  <span style="color: #666666">3.5</span>,  <span style="color: #666666">4.</span> ]),
        <span style="color: #666666">0.5</span>: np<span style="color: #666666">.</span>array(
            [ <span style="color: #666666">0.8</span>       ,  <span style="color: #666666">0.43076923</span>,  <span style="color: #666666">0.23195266</span>, <span style="color: #666666">0.12489759</span>,
              <span style="color: #666666">0.06725255</span>,  <span style="color: #666666">0.03621291</span>,  <span style="color: #666666">0.01949926</span>, <span style="color: #666666">0.0104996</span> ,
              <span style="color: #666666">0.00565363</span>]),
        <span style="color: #666666">0</span>: <span style="color: #666666">...</span>,
        <span style="color: #666666">1</span>: <span style="color: #666666">...</span>
        }
    <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>:
        u, t <span style="color: #666666">=</span> decay_mod<span style="color: #666666">.</span>solver(I, a, T, dt, theta<span style="color: #666666">=</span>theta)
        diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u <span style="color: #666666">-</span> precomputed[theta])<span style="color: #666666">.</span>max()
        <span style="color: #408080; font-style: italic"># Precomputed numbers are known to 8 decimal places</span>
        nt<span style="color: #666666">.</span>assert_almost_equal(diff, <span style="color: #666666">0</span>, places<span style="color: #666666">=8</span>,
                               msg<span style="color: #666666">=</span><span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> theta)
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Test of wrong use  <a name="___sec38"></a></h2>

<ul>
 <p><li> Find input data that may cause trouble and test such cases</li>
 <p><li> Here: the formula for \( u^{n+1} \) may involve integer division</li>
</ul>

Example:
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">theta <span style="color: #666666">=</span> <span style="color: #666666">1</span>; a <span style="color: #666666">=</span> <span style="color: #666666">1</span>; I <span style="color: #666666">=</span> <span style="color: #666666">1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">2</span>
</pre></div>
<p>
may lead to integer division:
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">(<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)  <span style="color: #408080; font-style: italic"># becomes 1</span>
(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)      <span style="color: #408080; font-style: italic"># becomes 2</span>
(<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)  <span style="color: #408080; font-style: italic"># becomes 0 (!)</span>
</pre></div>
<p>
Test that <code>solver</code> does not suffer from such integer division:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_potential_integer_division</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Choose variables that can trigger integer division.&quot;&quot;&quot;</span>
    theta <span style="color: #666666">=</span> <span style="color: #666666">1</span>; a <span style="color: #666666">=</span> <span style="color: #666666">1</span>; I <span style="color: #666666">=</span> <span style="color: #666666">1</span>; dt <span style="color: #666666">=</span> <span style="color: #666666">2</span>
    N <span style="color: #666666">=</span> <span style="color: #666666">4</span>
    u, t <span style="color: #666666">=</span> decay_mod<span style="color: #666666">.</span>solver(I<span style="color: #666666">=</span>I, a<span style="color: #666666">=</span>a, T<span style="color: #666666">=</span>N<span style="color: #666666">*</span>dt, dt<span style="color: #666666">=</span>dt, theta<span style="color: #666666">=</span>theta)
    u_de <span style="color: #666666">=</span> np<span style="color: #666666">.</span>array([exact_discrete_solution(n, I, a, theta, dt)
                     <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(N<span style="color: #666666">+1</span>)])
    diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u_de <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()
    nt<span style="color: #666666">.</span>assert_almost_equal(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Test of convergence rates  <a name="___sec39"></a></h2>

<p>
Convergence rate tests are very common for differential equation solvers.

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_convergence_rates</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Compare empirical convergence rates to exact ones.&quot;&quot;&quot;</span>
    <span style="color: #408080; font-style: italic"># Set command-line arguments directly in sys.argv</span>
    <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span>
    sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>:] <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;--I 0.8 --a 2.1 --T 5 &#39;</span>\ 
                   <span style="color: #BA2121">&#39;--dt 0.4 0.2 0.1 0.05 0.025&#39;</span><span style="color: #666666">.</span>split()
    r <span style="color: #666666">=</span> decay_mod<span style="color: #666666">.</span>main()
    <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> r:
        nt<span style="color: #666666">.</span>assert_true(r[theta])  <span style="color: #408080; font-style: italic"># check for non-empty list</span>

    expected_rates <span style="color: #666666">=</span> {<span style="color: #666666">0</span>: <span style="color: #666666">1</span>, <span style="color: #666666">1</span>: <span style="color: #666666">1</span>, <span style="color: #666666">0.5</span>: <span style="color: #666666">2</span>}
    <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> r:
        r_final <span style="color: #666666">=</span> r[theta][<span style="color: #666666">-1</span>]
        <span style="color: #408080; font-style: italic"># Compare to 1 decimal place</span>
        nt<span style="color: #666666">.</span>assert_almost_equal(expected_rates[theta], r_final,
                               places<span style="color: #666666">=1</span>, msg<span style="color: #666666">=</span><span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> theta)
</pre></div>
<p>
Complete program: <a href="http://tinyurl.com/nm5587k/decay/tests/test_decay_nose.py" target="_self"><tt>test_decay_nose.py</tt></a>.

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Classical unit testing with unittest  <a name="___sec40"></a></h2>

<ul>
 <p><li> <code>unittest</code> is a Python module mimicing the classical JUnit
   class-based unit testing framework from Java</li>
 <p><li> This is how unit testing is normally done</li>
 <p><li> Requires knowledge of object-oriented programming</li>
</ul>

<div class="alert alert-block alert-warning alert-text-normal">
<b>Remark.</b>
<p>
You will probably not use it, but you're not educated unless
you know what unit testing with classes is.
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Basic use of unittest  <a name="___sec41"></a></h2>

<p>
Write file <code>test_mymod.py</code>:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">unittest</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">mymod</span>

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">TestMyCode</span>(unittest<span style="color: #666666">.</span>TestCase):
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_double</span>(<span style="color: #008000">self</span>):
        result <span style="color: #666666">=</span> mymod<span style="color: #666666">.</span>double(<span style="color: #666666">4</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>assertEqual(result, <span style="color: #666666">8</span>)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    unittest<span style="color: #666666">.</span>main()
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Demonstration of unittest  <a name="___sec42"></a></h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">unittest</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">decay_mod_unittest</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">decay</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_discrete_solution</span>(n, I, a, theta, dt):
    factor <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> (<span style="color: #666666">1-</span>theta)<span style="color: #666666">*</span>a<span style="color: #666666">*</span>dt)<span style="color: #666666">/</span>(<span style="color: #666666">1</span> <span style="color: #666666">+</span> theta<span style="color: #666666">*</span>dt<span style="color: #666666">*</span>a)
    <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>factor<span style="color: #666666">**</span>n

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">TestDecay</span>(unittest<span style="color: #666666">.</span>TestCase):

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_exact_discrete_solution</span>(<span style="color: #008000">self</span>):
        <span style="color: #666666">...</span>
        diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u_de <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>assertAlmostEqual(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_solver</span>(<span style="color: #008000">self</span>):
        <span style="color: #666666">...</span>
        <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">0</span>, <span style="color: #666666">0.5</span>, <span style="color: #666666">1</span>:
            <span style="color: #666666">...</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>assertAlmostEqual(diff, <span style="color: #666666">0</span>, places<span style="color: #666666">=8</span>,
                                   msg<span style="color: #666666">=</span><span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> theta)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_potential_integer_division</span>():
        <span style="color: #666666">...</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>assertAlmostEqual(diff, <span style="color: #666666">0</span>, delta<span style="color: #666666">=1E-14</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_convergence_rates</span>(<span style="color: #008000">self</span>):
        <span style="color: #666666">...</span>
        <span style="color: #008000; font-weight: bold">for</span> theta <span style="color: #AA22FF; font-weight: bold">in</span> r:
            <span style="color: #666666">...</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>assertAlmostEqual(<span style="color: #666666">...</span>)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    unittest<span style="color: #666666">.</span>main()
</pre></div>
<p>
<!-- @@@CODE src-softeng1/tests/test_decay_unittest.py fromto: def test_conv@ -->

<p>
Complete program: <a href="http://tinyurl.com/nm5587k/decay/tests/test_decay_nose.py" target="_self"><tt>test_decay_unittest.py</tt></a>.

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h1>Implementing simple problem and solver classes <a name="decay:classes"></a></h1>

<ul>
 <p><li> So far: programs are built of Python functions</li>
 <p><li> New focus: alternative implementations using classes</li>
 <p><li> Class-based implementations are very popular,
   especially in business/adm applications</li>
 <p><li> Class-based implementations scales better to large and
   complex scientific applications</li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2>What to learn  <a name="___sec44"></a></h2>

<p>
Tasks:

<ul>
 <p><li> Explain basic use of classes to build a differential equation solver</li>
 <p><li> Introduce concepts that make such programs easily scale to
   more complex applications</li>
 <p><li> Demonstrate the advantage of using classes</li>
</ul>

Ideas:

<ul>
 <p><li> Classes for Problem, Solver, and Visualizer</li>
 <p><li> Problem: all the physics information about the problem</li>
 <p><li> Solver: all the numerics information + numerical computations</li>
 <p><li> Visualizer: plot the solution and other quantities</li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2>The problem class  <a name="___sec45"></a></h2>

<ul>
 <p><li> Model problem: \( u'=-au \), \( u(0)=I \), for \( t\in (0,T] \).</li>
 <p><li> Class <code>Problem</code> stores the physical parameters \( a \), \( I \), \( T \)</li>
 <p><li> May also offer other data, e.g., \( \uex(t)=Ie^{-at} \)</li>
</ul>

Implementation:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> exp

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Problem</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, I<span style="color: #666666">=1</span>, a<span style="color: #666666">=1</span>, T<span style="color: #666666">=10</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>T, <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a <span style="color: #666666">=</span> I, <span style="color: #008000">float</span>(a), T

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">u_exact</span>(<span style="color: #008000">self</span>, t):
        I, a <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a     <span style="color: #408080; font-style: italic"># extract local variables</span>
        <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>
<p>
Basic usage:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">problem <span style="color: #666666">=</span> Problem(T<span style="color: #666666">=5</span>)
problem<span style="color: #666666">.</span>T <span style="color: #666666">=</span> <span style="color: #666666">8</span>
problem<span style="color: #666666">.</span>dt <span style="color: #666666">=</span> <span style="color: #666666">1.5</span>
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Improved problem class  <a name="___sec46"></a></h2>

<p>
More flexible input from the command line:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Problem</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, I<span style="color: #666666">=1</span>, a<span style="color: #666666">=1</span>, T<span style="color: #666666">=10</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>T, <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a <span style="color: #666666">=</span> I, <span style="color: #008000">float</span>(a), T

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>(<span style="color: #008000">self</span>, parser<span style="color: #666666">=</span><span style="color: #008000">None</span>):
        <span style="color: #008000; font-weight: bold">if</span> parser <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
            <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">argparse</span>
            parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser()

        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--I&#39;</span>, <span style="color: #BA2121">&#39;--initial_condition&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
            default<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>I, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;initial condition, u(0)&#39;</span>,
            metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;I&#39;</span>)
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--a&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>, default<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>a,
            help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;coefficient in ODE&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;a&#39;</span>)
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--T&#39;</span>, <span style="color: #BA2121">&#39;--stop_time&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>, default<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>T,
            help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;end time of simulation&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;T&#39;</span>)
        <span style="color: #008000; font-weight: bold">return</span> parser

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">init_from_command_line</span>(<span style="color: #008000">self</span>, args):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a, <span style="color: #008000">self</span><span style="color: #666666">.</span>T <span style="color: #666666">=</span> args<span style="color: #666666">.</span>I, args<span style="color: #666666">.</span>a, args<span style="color: #666666">.</span>T

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(<span style="color: #008000">self</span>, t):
        I, a <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>a
        <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>
<ul>
 <p><li> Can utilize user's <code>ArgumentParser</code>, or make one</li>
 <p><li> <code>None</code> is used to indicate a non-initialized variable</li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2>The solver class  <a name="___sec47"></a></h2>

<ul>
 <p><li> Store numerical data \( \Delta t \), \( \theta \)</li>
 <p><li> Compute solution and quantities derived from the solution</li>
</ul>

Implementation:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Solver</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, problem, dt<span style="color: #666666">=0.1</span>, theta<span style="color: #666666">=0.5</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>problem <span style="color: #666666">=</span> problem
        <span style="color: #008000">self</span><span style="color: #666666">.</span>dt, <span style="color: #008000">self</span><span style="color: #666666">.</span>theta <span style="color: #666666">=</span> <span style="color: #008000">float</span>(dt), theta

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>(<span style="color: #008000">self</span>, parser):
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--dt&#39;</span>, <span style="color: #BA2121">&#39;--time_step_value&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
            default<span style="color: #666666">=0.5</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time step value&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;dt&#39;</span>)
        parser<span style="color: #666666">.</span>add_argument(
            <span style="color: #BA2121">&#39;--theta&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>, default<span style="color: #666666">=0.5</span>,
            help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time discretization parameter&#39;</span>, metavar<span style="color: #666666">=</span><span style="color: #BA2121">&#39;dt&#39;</span>)
        <span style="color: #008000; font-weight: bold">return</span> parser

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">init_from_command_line</span>(<span style="color: #008000">self</span>, args):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>dt, <span style="color: #008000">self</span><span style="color: #666666">.</span>theta <span style="color: #666666">=</span> args<span style="color: #666666">.</span>dt, args<span style="color: #666666">.</span>theta

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solve</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">decay_mod</span> <span style="color: #008000; font-weight: bold">import</span> solver
        <span style="color: #008000">self</span><span style="color: #666666">.</span>u, <span style="color: #008000">self</span><span style="color: #666666">.</span>t <span style="color: #666666">=</span> solver(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>I, <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>a, <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>T,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>dt, <span style="color: #008000">self</span><span style="color: #666666">.</span>theta)
</pre></div>
<p>
Note: reuse of the numerical algorithm from the <code>decay_mod</code> module
(i.e., the class is a wrapper of the procedural implementation).

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>The visualizer class  <a name="___sec48"></a></h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Visualizer</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, problem, solver):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>problem, <span style="color: #008000">self</span><span style="color: #666666">.</span>solver <span style="color: #666666">=</span> problem, solver

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">plot</span>(<span style="color: #008000">self</span>, include_exact<span style="color: #666666">=</span><span style="color: #008000">True</span>, plt<span style="color: #666666">=</span><span style="color: #008000">None</span>):
        <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">        Add solver.u curve to the plotting object plt,</span>
<span style="color: #BA2121; font-style: italic">        and include the exact solution if include_exact is True.</span>
<span style="color: #BA2121; font-style: italic">        This plot function can be called several times (if</span>
<span style="color: #BA2121; font-style: italic">        the solver object has computed new solutions).</span>
<span style="color: #BA2121; font-style: italic">        &quot;&quot;&quot;</span>
        <span style="color: #008000; font-weight: bold">if</span> plt <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
            <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">scitools.std</span>  <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span> <span style="color: #408080; font-style: italic"># can use matplotlib as well</span>

        plt<span style="color: #666666">.</span>plot(<span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>t, <span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>u, <span style="color: #BA2121">&#39;--o&#39;</span>)
        plt<span style="color: #666666">.</span>hold(<span style="color: #BA2121">&#39;on&#39;</span>)
        theta2name <span style="color: #666666">=</span> {<span style="color: #666666">0</span>: <span style="color: #BA2121">&#39;FE&#39;</span>, <span style="color: #666666">1</span>: <span style="color: #BA2121">&#39;BE&#39;</span>, <span style="color: #666666">0.5</span>: <span style="color: #BA2121">&#39;CN&#39;</span>}
        name <span style="color: #666666">=</span> theta2name<span style="color: #666666">.</span>get(<span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>theta, <span style="color: #BA2121">&#39;&#39;</span>)
        legends <span style="color: #666666">=</span> [<span style="color: #BA2121">&#39;numerical </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> name]
        <span style="color: #008000; font-weight: bold">if</span> include_exact:
            t_e <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>T, <span style="color: #666666">1001</span>)
            u_e <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>exact_solution(t_e)
            plt<span style="color: #666666">.</span>plot(t_e, u_e, <span style="color: #BA2121">&#39;b-&#39;</span>)
            legends<span style="color: #666666">.</span>append(<span style="color: #BA2121">&#39;exact&#39;</span>)
        plt<span style="color: #666666">.</span>legend(legends)
        plt<span style="color: #666666">.</span>xlabel(<span style="color: #BA2121">&#39;t&#39;</span>)
        plt<span style="color: #666666">.</span>ylabel(<span style="color: #BA2121">&#39;u&#39;</span>)
        plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&#39;theta=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, dt=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span>
                  (<span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>theta, <span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>dt))
        plt<span style="color: #666666">.</span>savefig(<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (name, <span style="color: #008000">self</span><span style="color: #666666">.</span>solver<span style="color: #666666">.</span>dt))
        <span style="color: #008000; font-weight: bold">return</span> plt
</pre></div>
<p>
Remark: The <code>plt</code> object in <code>plot</code> adds a new curve to a plot,
which enables comparing different solutions from different
runs of <code>Solver.solve</code>

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Combing the classes  <a name="___sec49"></a></h2>

<p>
Let <code>Problem</code>, <code>Solver</code>, and <code>Visualizer</code> play together:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>():
    problem <span style="color: #666666">=</span> Problem()
    solver <span style="color: #666666">=</span> Solver(problem)
    viz <span style="color: #666666">=</span> Visualizer(problem, solver)

    <span style="color: #408080; font-style: italic"># Read input from the command line</span>
    parser <span style="color: #666666">=</span> problem<span style="color: #666666">.</span>define_command_line_options()
    parser <span style="color: #666666">=</span> solver<span style="color: #666666">.</span> define_command_line_options(parser)
    args <span style="color: #666666">=</span> parser<span style="color: #666666">.</span>parse_args()
    problem<span style="color: #666666">.</span>init_from_command_line(args)
    solver<span style="color: #666666">.</span> init_from_command_line(args)

    <span style="color: #408080; font-style: italic"># Solve and plot</span>
    solver<span style="color: #666666">.</span>solve()
    <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>
    <span style="color: #408080; font-style: italic">#import scitools.std as plt</span>
    plt <span style="color: #666666">=</span> viz<span style="color: #666666">.</span>plot(plt<span style="color: #666666">=</span>plt)
    E <span style="color: #666666">=</span> solver<span style="color: #666666">.</span>error()
    <span style="color: #008000; font-weight: bold">if</span> E <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">None</span>:
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Error: </span><span style="color: #BB6688; font-weight: bold">%.4E</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> E
    plt<span style="color: #666666">.</span>show()
</pre></div>
<p>
Complete program: <a href="http://tinyurl.com/nm5587k/decay/decay_class.py" target="_self"><tt>decay_class.py</tt></a>.

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h1>Implementing more advanced problem and solver classes <a name="decay:classes2"></a></h1>

<ul>
 <p><li> The previous <code>Problem</code> and <code>Solver</code> classes soon contain
   much repetitive code when the number of parameters increases</li>
 <p><li> Much of such code can be parameterized and be made more compact</li>
 <p><li> Idea: collect all parameters in a dictionary <code>self.prms</code>,
   with two associated dictionaries <code>self.types</code> and
   <code>self.help</code> for holding associated object types and help strings</li>
 <p><li> Collect common code in class <code>Parameters</code></li>
 <p><li> Let <code>Problem</code>, <code>Solver</code>, and maybe <code>Visualizer</code> be subclasses
   of class <code>Parameters</code>, basically defining <code>self.prms</code>, <code>self.types</code>,
   <code>self.help</code></li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2>A generic class for parameters  <a name="___sec51"></a></h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Parameters</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">set</span>(<span style="color: #008000">self</span>, <span style="color: #666666">**</span>parameters):
        <span style="color: #008000; font-weight: bold">for</span> name <span style="color: #AA22FF; font-weight: bold">in</span> parameters:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>prms[name] <span style="color: #666666">=</span> parameters[name]

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">get</span>(<span style="color: #008000">self</span>, name):
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>prms[name]

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">define_command_line_options</span>(<span style="color: #008000">self</span>, parser<span style="color: #666666">=</span><span style="color: #008000">None</span>):
        <span style="color: #008000; font-weight: bold">if</span> parser <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
            <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">argparse</span>
            parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser()

        <span style="color: #008000; font-weight: bold">for</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>prms:
            tp <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>types[name] <span style="color: #008000; font-weight: bold">if</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>types <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000">str</span>
            help <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>help[name] <span style="color: #008000; font-weight: bold">if</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>help <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000">None</span>
            parser<span style="color: #666666">.</span>add_argument(
                <span style="color: #BA2121">&#39;--&#39;</span> <span style="color: #666666">+</span> name, default<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>get(name), metavar<span style="color: #666666">=</span>name,
                <span style="color: #008000">type</span><span style="color: #666666">=</span>tp, help<span style="color: #666666">=</span>help)

        <span style="color: #008000; font-weight: bold">return</span> parser

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">init_from_command_line</span>(<span style="color: #008000">self</span>, args):
        <span style="color: #008000; font-weight: bold">for</span> name <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>prms:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>prms[name] <span style="color: #666666">=</span> <span style="color: #008000">getattr</span>(args, name)
</pre></div>
<p>
Slightly more advanced version in <a href="http://tinyurl.com/nm5587k/decay/class_decay_verf1.py" target="_self"><tt>class_decay_verf1.py</tt></a>.

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>The problem class  <a name="___sec52"></a></h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Problem</span>(Parameters):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Physical parameters for the problem u&#39;=-a*u, u(0)=I,</span>
<span style="color: #BA2121; font-style: italic">    with t in [0,T].</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>prms <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(I<span style="color: #666666">=1</span>, a<span style="color: #666666">=1</span>, T<span style="color: #666666">=10</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>types <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(I<span style="color: #666666">=</span><span style="color: #008000">float</span>, a<span style="color: #666666">=</span><span style="color: #008000">float</span>, T<span style="color: #666666">=</span><span style="color: #008000">float</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>help <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(I<span style="color: #666666">=</span><span style="color: #BA2121">&#39;initial condition, u(0)&#39;</span>,
                         a<span style="color: #666666">=</span><span style="color: #BA2121">&#39;coefficient in ODE&#39;</span>,
                         T<span style="color: #666666">=</span><span style="color: #BA2121">&#39;end time of simulation&#39;</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">exact_solution</span>(<span style="color: #008000">self</span>, t):
        I, a <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;I&#39;</span>), <span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;a&#39;</span>)
        <span style="color: #008000; font-weight: bold">return</span> I<span style="color: #666666">*</span>np<span style="color: #666666">.</span>exp(<span style="color: #666666">-</span>a<span style="color: #666666">*</span>t)
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>The solver class  <a name="___sec53"></a></h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Solver</span>(Parameters):
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, problem):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>problem <span style="color: #666666">=</span> problem
        <span style="color: #008000">self</span><span style="color: #666666">.</span>prms <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(dt<span style="color: #666666">=0.5</span>, theta<span style="color: #666666">=0.5</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>types <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(dt<span style="color: #666666">=</span><span style="color: #008000">float</span>, theta<span style="color: #666666">=</span><span style="color: #008000">float</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>help <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(dt<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time step value&#39;</span>,
                         theta<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time discretization parameter&#39;</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solve</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">decay_mod</span> <span style="color: #008000; font-weight: bold">import</span> solver
        <span style="color: #008000">self</span><span style="color: #666666">.</span>u, <span style="color: #008000">self</span><span style="color: #666666">.</span>t <span style="color: #666666">=</span> solver(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;I&#39;</span>),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;a&#39;</span>),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;T&#39;</span>),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;dt&#39;</span>),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;theta&#39;</span>))

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">error</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">try</span>:
            u_e <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>exact_solution(<span style="color: #008000">self</span><span style="color: #666666">.</span>t)
            e <span style="color: #666666">=</span> u_e <span style="color: #666666">-</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>u
            E <span style="color: #666666">=</span> np<span style="color: #666666">.</span>sqrt(<span style="color: #008000">self</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;dt&#39;</span>)<span style="color: #666666">*</span>np<span style="color: #666666">.</span>sum(e<span style="color: #666666">**2</span>))
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">AttributeError</span>:
            E <span style="color: #666666">=</span> <span style="color: #008000">None</span>
        <span style="color: #008000; font-weight: bold">return</span> E
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>The visualizer class  <a name="___sec54"></a></h2>

<ul>
 <p><li> No parameters needed (for this simple problem), no need to inherit
   class <code>Parameters</code></li>
 <p><li> Same code as previously shown class <code>Visualizer</code></li>
 <p><li> Same code as previously shown for combining <code>Problem</code>, <code>Solver</code>, and
   <code>Visualizer</code></li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h1>Performing scientific experiments <a name="decay:experiments"></a></h1>

<p>
Goal: explore the behavior of a numerical
method for a differential equation and show how scientific experiments
can be set up and reported.

<p>
Tasks:

<ul>
  <p><li> Write scripts to automate experiments</li>
  <p><li> Generate scientific reports from scripts</li>
</ul>

Tools to learn:

<ul>
  <p><li> <code>os.system</code> for running other programs</li>
  <p><li> <code>subprocess</code> for running other programs and extracting the output</li>
  <p><li> List comprehensions</li>
  <p><li> Formats for scientific reports: HTML w/MathJax, LaTeX, Sphinx, DocOnce</li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Model problem and numerical solution method  <a name="___sec56"></a></h2>

<p>
Problem:

$$
\begin{equation}
u'(t) = -au(t),\quad u(0)=I,\ 0 < t \leq T,
\label{decay:experiments:model}
\end{equation}
$$


<p>
Solution method (\( \theta \)-rule):

$$
u^{n+1} = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a\Delta t}u^n,
\quad u^0=I\tp
$$


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Plan for the experiments  <a name="___sec57"></a></h2>

<ul>
 <p><li> Plot \( u^n \) against \( \uex = Ie^{-at} \) for
   various choices of the parameters
   \( I \), \( a \), \( \Delta t \), and \( \theta \)</li>
 <p><li> How does the discrete solution compare with the exact solution
   when \( \Delta t \) is varied and \( \theta=0,0.5,1 \)?</li>
 <p><li> Use the <a href="http://tinyurl.com/nm5587k/softeng1/decay_mod.py" target="_self"><tt>decay_mod.py</tt></a> module (little modification of the plotting, see <a href="http://tinyurl.com/nm5587k/softeng1/experiments/decay_mod.py" target="_self"><tt>experiments/decay_mod.py</tt></a>)</li>
 <p><li> Make separate program for running (automating) the experiments (<em>script</em>)</li>

<ol>
   <p><li> <code>python decay_mod.py --I 1 --a 2 --makeplot --T 5 --dt 0.5 0.25 0.1 0.05</code></li>
   <p><li> Combine generated figures <code>FE_*.png</code>, <code>BE_*.png</code>, and <code>CN_*.png</code>
      to new figures with multiple plots</li>
   <p><li> Run script as <code>python decay_exper0.py 0.5 0.25 0.1 0.05</code> (\( \Delta t \) values on the command line)</li>
</ol>

</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Typical plot summarizing the results  <a name="___sec58"></a></h2>

<p>
<center><p><img src="fig-softeng1/BE4a.png" align="bottom" width=800,></p></center>

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Script code  <a name="___sec59"></a></h2>

<p>
Typical <em>script</em> (small administering program) for running the experiments:

<p>

<!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">os</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">sys</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">run_experiments</span>(I<span style="color: #666666">=1</span>, a<span style="color: #666666">=2</span>, T<span style="color: #666666">=5</span>):
    <span style="color: #408080; font-style: italic"># The command line must contain dt values</span>
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(sys<span style="color: #666666">.</span>argv) <span style="color: #666666">&gt;</span> <span style="color: #666666">1</span>:
        dt_values <span style="color: #666666">=</span> [<span style="color: #008000">float</span>(arg) <span style="color: #008000; font-weight: bold">for</span> arg <span style="color: #AA22FF; font-weight: bold">in</span> sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>:]]
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Usage: </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> dt1 dt2 dt3 ...&#39;</span> <span style="color: #666666">%</span>  sys<span style="color: #666666">.</span>argv[<span style="color: #666666">0</span>]
        sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)  <span style="color: #408080; font-style: italic"># abort</span>

    <span style="color: #408080; font-style: italic"># Run module file as a stand-alone application</span>
    cmd <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;python decay_mod.py --I </span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121"> --a </span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121"> --makeplot --T </span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> \
          (I, a, T)
    dt_values_str <span style="color: #666666">=</span> <span style="color: #BA2121">&#39; &#39;</span><span style="color: #666666">.</span>join([<span style="color: #008000">str</span>(v) <span style="color: #008000; font-weight: bold">for</span> v <span style="color: #AA22FF; font-weight: bold">in</span> dt_values])
    cmd <span style="color: #666666">+=</span> <span style="color: #BA2121">&#39; --dt </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> dt_values_str
    <span style="color: #008000; font-weight: bold">print</span> cmd
    failure <span style="color: #666666">=</span> os<span style="color: #666666">.</span>system(cmd)
    <span style="color: #008000; font-weight: bold">if</span> failure:
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Command failed:&#39;</span>, cmd; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)

    <span style="color: #408080; font-style: italic"># Combine images into rows with 2 plots in each row</span>
    image_commands <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> method <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #BA2121">&#39;BE&#39;</span>, <span style="color: #BA2121">&#39;CN&#39;</span>, <span style="color: #BA2121">&#39;FE&#39;</span>:
        pdf_files <span style="color: #666666">=</span> <span style="color: #BA2121">&#39; &#39;</span><span style="color: #666666">.</span>join([<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">.pdf&#39;</span> <span style="color: #666666">%</span> (method, dt)
                              <span style="color: #008000; font-weight: bold">for</span> dt <span style="color: #AA22FF; font-weight: bold">in</span> dt_values])
        png_files <span style="color: #666666">=</span> <span style="color: #BA2121">&#39; &#39;</span><span style="color: #666666">.</span>join([<span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">_</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (method, dt)
                              <span style="color: #008000; font-weight: bold">for</span> dt <span style="color: #AA22FF; font-weight: bold">in</span> dt_values])
        image_commands<span style="color: #666666">.</span>append(
            <span style="color: #BA2121">&#39;montage -background white -geometry 100%&#39;</span> <span style="color: #666666">+</span>
            <span style="color: #BA2121">&#39; -tile 2x </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (png_files, method))
        image_commands<span style="color: #666666">.</span>append(
            <span style="color: #BA2121">&#39;convert -trim </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.png </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> (method, method))
        image_commands<span style="color: #666666">.</span>append(
            <span style="color: #BA2121">&#39;convert </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.png -transparent white </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span>
            (method, method))
        image_commands<span style="color: #666666">.</span>append(
            <span style="color: #BA2121">&#39;pdftk </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> output tmp.pdf&#39;</span> <span style="color: #666666">%</span> pdf_files)
        num_rows <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #008000">round</span>(<span style="color: #008000">len</span>(dt_values)<span style="color: #666666">/2.0</span>))
        image_commands<span style="color: #666666">.</span>append(
            <span style="color: #BA2121">&#39;pdfnup --nup 2x</span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121"> tmp.pdf&#39;</span> <span style="color: #666666">%</span> num_rows)
        image_commands<span style="color: #666666">.</span>append(
            <span style="color: #BA2121">&#39;pdfcrop tmp-nup.pdf </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">.pdf&#39;</span> <span style="color: #666666">%</span> method)

    <span style="color: #008000; font-weight: bold">for</span> cmd <span style="color: #AA22FF; font-weight: bold">in</span> image_commands:
        <span style="color: #008000; font-weight: bold">print</span> cmd
        failure <span style="color: #666666">=</span> os<span style="color: #666666">.</span>system(cmd)
        <span style="color: #008000; font-weight: bold">if</span> failure:
            <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Command failed:&#39;</span>, cmd; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)

    <span style="color: #408080; font-style: italic"># Remove the files generated above and by decay_mod.py</span>
    <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">glob</span> <span style="color: #008000; font-weight: bold">import</span> glob
    filenames <span style="color: #666666">=</span> glob(<span style="color: #BA2121">&#39;*_*.png&#39;</span>) <span style="color: #666666">+</span> glob(<span style="color: #BA2121">&#39;*_*.pdf&#39;</span>) <span style="color: #666666">+</span> \
                glob(<span style="color: #BA2121">&#39;*_*.eps&#39;</span>) <span style="color: #666666">+</span> glob(<span style="color: #BA2121">&#39;tmp*.pdf&#39;</span>)
    <span style="color: #008000; font-weight: bold">for</span> filename <span style="color: #AA22FF; font-weight: bold">in</span> filenames:
        os<span style="color: #666666">.</span>remove(filename)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    run_experiments()
</pre></div>
<p>
Complete program: <a href="http://tinyurl.com/nm5587k/softeng1/experiments/decay_exper0.py" target="_self"><tt>experiments/decay_exper0.py</tt></a>.

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Comments to the code  <a name="___sec60"></a></h2>

<p>
Many useful constructs in the previous script:

<ul>
 <p><li> <code>[float(arg) for arg in sys.argv[1:]]</code> builds a list of real numbers
   from all the command-line arguments</li>
 <p><li> <code>failure = os.system(cmd)</code> runs an operating system command
   (e.g., another program)</li>
 <p><li> <code>sys.exit(1)</code> aborts the program</li>
 <p><li> <code>['%s_%s.png' % (method, dt) for dt in dt_values]</code> builds a list of
   filenames from a list of numbers (<code>dt_values</code>)</li>
 <p><li> All <code>montage</code> commands for creating composite figures are stored in a
   list and thereafter executed in a loop</li>
 <p><li> <code>glob.glob('*_*.png')</code> returns a list of the names of all files in the
   current folder where the filename matches the <em>Unix wildcard notation</em>
   <code>*_*.png</code> (meaning "any text, underscore, any text, and then `.png`")</li>
 <p><li> <code>os.remove(filename)</code> removes the file with name <code>filename</code></li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Interpreting output from other programs  <a name="___sec61"></a></h2>

<p>
In <code>decay_exper0.py</code> we run a program (<code>os.system</code>) and
want to grab the output, e.g.,

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python decay_plot_mpl.py
0.0   0.40:    2.105E-01
0.0   0.04:    1.449E-02
0.5   0.40:    3.362E-02
0.5   0.04:    1.887E-04
1.0   0.40:    1.030E-01
1.0   0.04:    1.382E-02
</pre></div>
<p>
Tasks:

<ul>
  <p><li> read the output from the <code>decay_mod.py</code> program</li>
  <p><li> interpret this output and store the \( E \) values in arrays for each
    \( \theta \) value</li>
  <p><li> plot \( E \) versus \( \Delta t \), for each \( \theta \), in a log-log plot</li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Code for grabbing output from another program  <a name="___sec62"></a></h2>

<p>
Use the <code>subprocess</code> module to grab output:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">    <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">subprocess</span> <span style="color: #008000; font-weight: bold">import</span> Popen, PIPE, STDOUT
    p <span style="color: #666666">=</span> Popen(cmd, shell<span style="color: #666666">=</span><span style="color: #008000">True</span>, stdout<span style="color: #666666">=</span>PIPE, stderr<span style="color: #666666">=</span>STDOUT)
    output, dummy <span style="color: #666666">=</span> p<span style="color: #666666">.</span>communicate()
    failure <span style="color: #666666">=</span> p<span style="color: #666666">.</span>returncode
    <span style="color: #008000; font-weight: bold">if</span> failure:
        <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Command failed:&#39;</span>, cmd; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Code for interpreting the grabbed output  <a name="___sec63"></a></h2>

<ul>
 <p><li> Run through the <code>output</code> string, line by line</li>
 <p><li> If the current line prints \( \theta \), \( \Delta t \), and \( E \),
   split the line into these three pieces and store the data</li>
 <p><li> Store data in a dictionary <code>errors</code> with keys <code>dt</code> and
   the three \( \theta \) values</li>
</ul>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">errors <span style="color: #666666">=</span> {<span style="color: #BA2121">&#39;dt&#39;</span>: dt_values, <span style="color: #666666">1</span>: [], <span style="color: #666666">0</span>: [], <span style="color: #666666">0.5</span>: []}
<span style="color: #008000; font-weight: bold">for</span> line <span style="color: #AA22FF; font-weight: bold">in</span> output<span style="color: #666666">.</span>splitlines():
    words <span style="color: #666666">=</span> line<span style="color: #666666">.</span>split()
    <span style="color: #008000; font-weight: bold">if</span> words[<span style="color: #666666">0</span>] <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #BA2121">&#39;0.0&#39;</span>, <span style="color: #BA2121">&#39;0.5&#39;</span>, <span style="color: #BA2121">&#39;1.0&#39;</span>):  <span style="color: #408080; font-style: italic"># line with E?</span>
        <span style="color: #408080; font-style: italic"># typical line: 0.0   1.25:    7.463E+00</span>
        theta <span style="color: #666666">=</span> <span style="color: #008000">float</span>(words[<span style="color: #666666">0</span>])
        E <span style="color: #666666">=</span> <span style="color: #008000">float</span>(words[<span style="color: #666666">2</span>])
        errors[theta]<span style="color: #666666">.</span>append(E)
</pre></div>
<p>
Next: plot \( E \) versus \( \Delta t \) for \( \theta=0,0.5,1 \)

<p>
Complete program: <a href="http://tinyurl.com/nm5587k/softeng1/experiments/decay_exper1.py" target="_self"><tt>experiments/decay_exper1.py</tt></a>.
Fine recipe for

<ul>
  <p><li> how to run other programs</li>
  <p><li> how to extract and interpret output from other programs</li>
  <p><li> how to automate many manual steps in creating simulations and figures</li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Making a report <a name="decay:exper:report"></a></h2>

<ul>
 <p><li> Scientific investigations are best documented in a report!</li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/sphinx-cloud/" target="_self">A sample report</a></li>
 <p><li> How can we write such a report?</li>
 <p><li> First problem: what format should I write in?</li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report_html.html" target="_self">Plain HTML</a>, generated by <a href="http://tinyurl.com/nm5587k/softeng1/experiments/decay_exper1_html.py" target="_self"><tt>decay_exper1_html.py</tt></a></li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report_html_mathjax.html" target="_self">HTML with MathJax</a>, generated by <a href="http://tinyurl.com/nm5587k/softeng1/experiments/decay_exper1_html.py" target="_self"><tt>decay_exper1_mathjax.py</tt></a></li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report.pdf" target="_self">LaTeX PDF</a>, based on <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report.tex.html" target="_self">LaTeX source</a></li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/sphinx-cloud/index.html" target="_self">Sphinx HTML</a>, based on <a href="http://hplgit.github.com/INF5620/doc/writing_reports/report_sphinx.rst.html" target="_self">reStructuredText</a></li>
 <p><li> Markdown, MediaWiki, ...</li>
 <p><li> <a href="https://github.com/hplgit/doconce" target="_self">DocOnce</a> can generate LaTeX, HTML w/MathJax, Sphinx, Markdown, MediaWiki, ... (<a href="http://hplgit.github.com/INF5620/doc/writing_reports/report.do.txt.html" target="_self">DocOnce source</a> for the examples above, and Python program for <a href="http://tinyurl.com/nm5587k/softeng1/experiments/decay_exper1_do.py" target="_self">generating the DocOnce source</a>)</li>
 <p><li> <a href="http://hplgit.github.com/INF5620/doc/writing_reports/" target="_self">Examples on different report formats</a></li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Publishing a complete project <a name="decay:exper:github"></a></h2>

<ul>
 <p><li> Make folder (directory) tree</li>
 <p><li> Keep track of all files via a <em>version control system</em> (Mercurial, Git, ...)</li>
 <p><li> Publish as private or public repository</li>
 <p><li> Utilize Bitbucket, Googlecode, GitHub, or similar</li>
 <p><li> See the <a href="http://hplgit.github.com/teamods/bitgit/html/" target="_self">intro to such tools</a></li>
</ul>


<!-- ------------------- end of main content --------------- -->


</body>
</html>
    

